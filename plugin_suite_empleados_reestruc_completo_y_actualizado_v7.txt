=================================================================
CONTEXTO COMPLETO DEL PLUGIN: suite vendedores restruturado V7
Arquitectura basada en WordPress (MVC y POO)
=================================================================

--- INICIO DEL ARCHIVO: suite-empleados.php ---
<?php
/**
 * Plugin Name: Suite de Empleados (ERP Intranet)
 * Plugin URI: https://mitiendaunit.com/intranet_1
 * Description: Sistema modular V8.0 para gesti√≥n de Inventario, CRM, Log√≠stica, Gamificaci√≥n y Cerebro de Demanda (IA). Arquitectura MVC.
 * Version: 8.0.0
 * Author: DevOps Team & RV Automation Technology
 * Text Domain: suite-empleados
 * License: GPLv2 or later
 */

// 1. SEGURIDAD: Evitar acceso directo
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// 2. CONSTANTES DEL SISTEMA
define( 'SUITE_VERSION', '8.0.0' );
define( 'SUITE_PATH', plugin_dir_path( __FILE__ ) );
define( 'SUITE_URL', plugin_dir_url( __FILE__ ) );

/**
 * 3. INICIALIZADOR DEL SISTEMA (Orquestador MVC)
 * Se engancha a 'plugins_loaded' para asegurar que el core de WP est√© listo.
 */
function suite_empleados_init() {
    
    // --- A. CARGA DE DEPENDENCIAS (REQUIRE_ONCE) ---
    // [Error 1.1 Corregido]: Rutas apuntando a los nombres reales de los archivos.

    // Core
    require_once SUITE_PATH . 'includes/Core/class-activator.php';
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';

    // Modelos (Capa de Base de Datos y L√≥gica de Negocio)
    require_once SUITE_PATH . 'includes/Models/class-suite-model-base.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-client.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-quote.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-inventory.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-commission.php';

    // Controladores Base
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-controller.php';

    // Controladores AJAX (M√≥dulos de la UI)
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-client.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-quotes.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-kanban.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-commissions.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-logistics.php';

    // Controladores API REST (Data Lake y Machine Learning)
    require_once SUITE_PATH . 'includes/Controllers/Api/class-suite-api-stats.php';

    // Controlador del Administrador / Frontend (Shortcodes y Vistas)
    require_once SUITE_PATH . 'includes/Controllers/Admin/class-suite-shortcode-controller.php';


    // --- B. INSTANCIACI√ìN DE CONTROLADORES (Encendiendo los motores) ---

    // M√≥dulo de Clientes (CRM) - [Las 5 nuevas clases divididas]
    new Suite_Ajax_Client_Search();
    new Suite_Ajax_Client_Add();
    new Suite_Ajax_Client_Import();
    new Suite_Ajax_Client_Delete();
    new Suite_Ajax_Client_Profile();

    // M√≥dulo de Cotizaciones
    new Suite_Ajax_Quote_Save();
    new Suite_Ajax_Quote_History();
    new Suite_Ajax_Quote_Status();

    // M√≥dulo 1: Tablero Kanban (Pedidos)
    new Suite_Ajax_Kanban_Data();
    new Suite_Ajax_Kanban_Status();

    // M√≥dulo 3: Log√≠stica y Despacho
    new Suite_Ajax_Upload_POD();
    new Suite_Ajax_Print_Picking();

    // M√≥dulo 4: Dashboard de Comisiones y Gamificaci√≥n
    new Suite_Ajax_Dashboard_Stats();

    // M√≥dulo 5: Cerebro de Demanda (REST API)
    new Suite_API_Stats();

    // Gestor de la Vista Principal (Shortcode y encolado de assets)
    new Suite_Shortcode_Controller();
}
add_action( 'plugins_loaded', 'suite_empleados_init' );


/**
 * 4. ACTIVACI√ìN DEL PLUGIN
 * Crea las tablas, define roles usando dbDelta y programa Cron Jobs.
 */
function suite_plugin_activate() {
    // 1. Instalaci√≥n de BD y Roles
    require_once SUITE_PATH . 'includes/Core/class-activator.php';
    if ( class_exists( 'Suite_Activator' ) && method_exists( 'Suite_Activator', 'activate' ) ) {
        Suite_Activator::activate();
    } elseif ( function_exists( 'suite_install_db' ) ) {
        suite_install_db(); 
    }

    // 2. Programaci√≥n de Tareas Autom√°ticas (Data Lake)
    // [Error 3.1 Corregido]: El Cron ahora se registra ESTRICTAMENTE UNA VEZ en la activaci√≥n.
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';
    if ( class_exists( 'Suite_Cron_Jobs' ) ) {
        $cron_jobs = new Suite_Cron_Jobs();
        $cron_jobs->schedule_events();
    }
}
register_activation_hook( __FILE__, 'suite_plugin_activate' );


/**
 * 5. DESACTIVACI√ìN DEL PLUGIN
 * Limpia los Cron Jobs activos para no dejar basura en la memoria de WordPress.
 */
function suite_plugin_deactivate() {
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';
    if ( class_exists( 'Suite_Cron_Jobs' ) ) {
        $cron_jobs = new Suite_Cron_Jobs();
        $cron_jobs->clear_events();
    }
}
register_deactivation_hook( __FILE__, 'suite_plugin_deactivate' );
--- FIN DEL ARCHIVO: suite-empleados.php ---

--- INICIO DEL ARCHIVO: assets/css/suite-styles.css ---
/* CSS Stylesheet: assets/css/suite-styles.css */
--- FIN DEL ARCHIVO: assets/css/suite-styles.css ---

--- INICIO DEL ARCHIVO: assets/js/main.js ---
/* JS Module: assets/js/main.js */
--- FIN DEL ARCHIVO: assets/js/main.js ---

--- INICIO DEL ARCHIVO: assets/js/core/api.js ---
/**
 * SuiteAPI - Orquestador de Peticiones AJAX
 * * Centraliza las llamadas al servidor, inyectando autom√°ticamente 
 * credenciales de seguridad (Nonces) y enrutamiento (URL).
 */
const SuiteAPI = (function($) {
    'use strict';

    // Variables privadas extra√≠das de la localizaci√≥n de WP
    const apiUrl = suite_vars.ajax_url;
    const sysNonce = suite_vars.nonce;

    /**
     * Interceptor Global de Errores
     * Captura expiraci√≥n de sesi√≥n (401) o fallos de permisos (403)
     */
    const handleAjaxError = function(error, reject) {
        if (error.status === 401 || error.status === 403) {
            alert('üîí Su sesi√≥n ha expirado o fue cerrada por seguridad. Por favor, recargue la p√°gina e inicie sesi√≥n nuevamente.');
        }
        reject(error);
    };

    /**
     * Petici√≥n POST est√°ndar para JSON
     * * @param {string} action - El nombre del hook de WP (ej. 'suite_search_client_ajax')
     * @param {object} data - Datos a enviar
     * @returns {Promise}
     */
    const post = function(action, data = {}) {
        return new Promise((resolve, reject) => {
            // Inyecci√≥n autom√°tica de par√°metros obligatorios
            const payload = {
                ...data,
                action: action,
                nonce: sysNonce
            };

            $.post(apiUrl, payload)
                .done(response => resolve(response))
                .fail(error => handleAjaxError(error, reject)); // <-- Interceptor inyectado
        });
    };

    /**
     * Petici√≥n POST para subir archivos (FormData)
     * Utilizado para la importaci√≥n de CSV o futuras subidas de fotos (POD)
     * * @param {string} action - El nombre del hook de WP
     * @param {FormData} formData - Objeto FormData instanciado
     * @returns {Promise}
     */
    const postForm = function(action, formData) {
        return new Promise((resolve, reject) => {
            // Inyecci√≥n en FormData
            formData.append('action', action);
            formData.append('nonce', sysNonce);

            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: formData,
                processData: false, // Vital para que jQuery no procese el archivo
                contentType: false, // Vital para que el navegador asigne el boundary multipart
                success: response => resolve(response),
                error: error => handleAjaxError(error, reject) // <-- Interceptor inyectado
            });
        });
    };

    // API P√∫blica Revelada
    return {
        post: post,
        postForm: postForm
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/core/api.js ---

--- INICIO DEL ARCHIVO: assets/js/core/state.js ---
/**
 * SuiteState - Manejador de Estado Inmutable (Store)
 * 
 * Centraliza los datos financieros y el carrito de compras.
 * Previene la manipulaci√≥n directa desde el objeto global window.
 */
const SuiteState = (function() {
    'use strict';

    // ==========================================
    // VARIABLES PRIVADAS (El "Estado")
    // ==========================================
    let cart = [];
    let totalUSD = 0.00;
    let totalBS = 0.00;
    let tasaBCV = 1.00; // Se actualizar√° al inicializar la app

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================
    
    /**
     * Recalcula los totales matem√°ticos cada vez que el carrito cambia.
     * Mantiene la l√≥gica financiera blindada.
     */
    const calculateTotals = function() {
        totalUSD = cart.reduce((sum, item) => {
            let qty = parseInt(item.qty) || 0;
            let price = parseFloat(item.price) || 0;
            return sum + (qty * price);
        }, 0);

        totalBS = totalUSD * tasaBCV;
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Retorna una COPIA INMUTABLE del carrito.
         * Si alguien muta este array externamente, no afectar√° al original.
         * @returns {Array}
         */
        getCart: function() {
            return [...cart]; 
        },

        /**
         * A√±ade un producto al carrito y recalcula.
         * Si el SKU ya existe, suma la cantidad en lugar de duplicar la fila.
         * @param {Object} item 
         */
        addItem: function(item) {
            // Normalizar datos: Prohibir cantidades negativas o cero
            item.qty = Math.max(1, parseInt(item.qty) || 1);
            item.price = Math.max(0, parseFloat(item.price) || 0.00);

            const existingIndex = cart.findIndex(i => i.sku === item.sku);
            if (existingIndex > -1) {
                cart[existingIndex].qty += item.qty;
            } else {
                cart.push(item);
            }
            calculateTotals();
        },

        /**
         * Actualiza un campo espec√≠fico de una fila (ej. cantidad o precio editado).
         * @param {number} index - √çndice en el array
         * @param {string} field - 'qty' o 'price'
         * @param {number|string} value - Nuevo valor
         */
        updateItem: function(index, field, value) {
            if (cart[index]) {
                if (field === 'qty') {
                    cart[index][field] = Math.max(1, parseInt(value) || 1);
                } else {
                    cart[index][field] = Math.max(0, parseFloat(value) || 0);
                }
                calculateTotals();
            }
        },

        /**
         * Elimina un producto del carrito.
         * @param {number} index 
         */
        removeItem: function(index) {
            if (cart[index]) {
                cart.splice(index, 1);
                calculateTotals();
            }
        },

        /**
         * Vac√≠a el carrito por completo (√∫til al guardar con √©xito).
         */
        clearCart: function() {
            cart = [];
            calculateTotals();
        },

        /**
         * Actualiza la tasa BCV del d√≠a.
         * @param {number} tasa 
         */
        setTasa: function(tasa) {
            tasaBCV = parseFloat(tasa) || 1;
            calculateTotals();
        },

        /**
         * Devuelve un snapshot de los totales financieros formateados.
         * @returns {Object}
         */
        getTotals: function() {
            return {
                usd: totalUSD.toFixed(2),
                bs: totalBS.toFixed(2),
                tasa: tasaBCV.toFixed(2)
            };
        }
    };
})();
--- FIN DEL ARCHIVO: assets/js/core/state.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/commissions.js ---
/**
 * SuiteCommissions - M√≥dulo del Dashboard Financiero y Gamificaci√≥n
 * 
 * Se encarga de solicitar las estad√≠sticas mensuales del vendedor y 
 * actualizar los l√≠deres de los premios en la vista.
 */
const SuiteCommissions = (function($) {
    'use strict';

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================

    const renderDashboard = function(data) {
        // 1. Rendimiento Personal
        $('#dash-mes-actual').text(data.mes_evaluado);
        $('#dash-comision-actual').text('$' + data.comision_actual);

        // 2. L√≠der "Pez Gordo" (Dinero)
        const pezGordo = data.gamificacion.pez_gordo;
        if (pezGordo) {
            $('#pez-gordo-name').text('üëë ' + pezGordo.display_name);
            $('#pez-gordo-amount').text('$' + pezGordo.total_vendido);
        } else {
            $('#pez-gordo-name').text('A√∫n sin ventas');
            $('#pez-gordo-amount').text('$0.00');
        }

        // 3. L√≠der "Deja pa' los dem√°s" (Cantidad)
        const dejaPa = data.gamificacion.deja_pa_los_demas;
        if (dejaPa) {
            $('#deja-pa-name').text('üöÄ ' + dejaPa.display_name);
            $('#deja-pa-count').text(dejaPa.cantidad_ventas + ' ventas cerradas');
        } else {
            $('#deja-pa-name').text('A√∫n sin ventas');
            $('#deja-pa-count').text('0 ventas');
        }
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Llama a la API para obtener la data fresca y pinta la interfaz
         */
        loadDashboard: function() {
            // Mostrar estado de carga visual sutil
            $('#dash-comision-actual').css('opacity', '0.5');

            SuiteAPI.post('suite_get_dashboard_stats').then(res => {
                if (res.success) {
                    renderDashboard(res.data);
                } else {
                    console.error("Error cargando comisiones:", res.data);
                }
            }).catch(err => {
                console.error("Error de red al cargar dashboard de comisiones.");
            }).finally(() => {
                $('#dash-comision-actual').css('opacity', '1');
            });
        },

        init: function() {
            // Se puede cargar autom√°ticamente, o esperar a que el usuario haga clic en la pesta√±a
            // Lo dejamos listo para ser invocado por el controlador de pesta√±as.
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/commissions.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/crm.js ---
/**
 * SuiteCRM - M√≥dulo de Gesti√≥n de Clientes
 * 
 * Controla la vista del directorio de clientes, inicializaci√≥n de DataTables,
 * perfiles modales y creaci√≥n manual.
 */
const SuiteCRM = (function($) {
    'use strict';

    // Variables Privadas
    let cliTable = null;
    const dtLanguage = { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json", "lengthMenu": "_MENU_" };

    /**
     * Limpia el RIF en tiempo real (Regla de negocio: Anti-duplicados) [1, 2]
     */
    const cleanRifInput = function(input) {
        let raw = $(input).val().toUpperCase();
        let clean = raw.replace(/[^A-Z0-9]/g, '');

        if (raw !== clean) { $(input).val(clean); }

        if (clean.length > 0) {
            if (!/^[VEJGPC]/.test(clean)) {
                $(input).css('border', '2px solid red').attr('title', 'Formato inv√°lido (Ej: J123456789)');
            } else {
                $(input).css('border', '').attr('title', '');
            }
        }
        return clean;
    };

    /**
     * Inicializa la Tabla de Clientes (DataTables) [3, 4]
     */
    const initDataTable = function() {
        if ($('#clientsTable').length && !$.fn.DataTable.isDataTable('#clientsTable')) {
            
            // Permisos visuales basados en el rol (Extra√≠do de suite_vars)
            let tableDom = suite_vars.is_admin ? 'Blrtip' : 'lrtip';
            let tableButtons = suite_vars.is_admin ? [
                { extend: 'excelHtml5', text: 'Excel', className: 'btn-modern-action small' },
                { extend: 'csvHtml5', text: 'CSV', className: 'btn-modern-action small' }
            ] : [];

            cliTable = $('#clientsTable').DataTable({
                paging: true,
                pageLength: 25,
                responsive: true,
                dom: tableDom,
                buttons: tableButtons,
                language: dtLanguage
            });

            // Buscador personalizado
            $('#clients-table-search').on('keyup', function() { 
                cliTable.search(this.value).draw(); 
            });
        }
    };

    /**
     * Maneja los eventos DOM del m√≥dulo CRM [5-8]
     */
    const bindEvents = function() {
        
        // 1. Limpieza de RIFs en todos los inputs relevantes
        $(document).on('input blur', '#cli-rif, #prof-rif, #new-cli-rif', function() {
            cleanRifInput(this);
        });

        // 2. Crear Cliente Manual
        $('#btn-create-client').on('click', function() {
            const rif = $('#new-cli-rif').val();
            const nombre = $('#new-cli-nombre').val();

            if (!rif || !nombre) return alert('RIF y Nombre son requeridos');

            const data = {
                rif: rif,
                nombre: nombre,
                direccion: $('#new-cli-dir').val(),
                telefono: $('#new-cli-tel').val(),
                email: $('#new-cli-email').val(),
                ciudad: $('#new-cli-ciudad').val(),
                estado: $('#new-cli-estado').val()
            };

            // USO DE LA NUEVA API
            SuiteAPI.post('suite_add_client_manual', data).then(res => {
                if (res.success) {
                    alert('Cliente creado exitosamente');
                    location.reload();
                } else {
                    alert(res.data.message || res.data); // Compatibilidad de errores
                }
            }).catch(() => alert('Error de conexi√≥n con el servidor.'));
        });

        // 3. Importar CSV de Clientes
        $('#btn-run-import-cli').on('click', function() {
            const fileInput = $('#csv-clients-file').prop('files');
            if (!fileInput) return alert('Selecciona un archivo CSV primero');

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            const fd = new FormData();
            fd.append('csv_file', fileInput);

            // USO DE LA NUEVA API (Formulario M√∫ltiple)
            SuiteAPI.postForm('suite_import_clients_csv', fd).then(res => {
                if (res.success) {
                    alert(res.data);
                    location.reload();
                } else {
                    alert(res.data.message || res.data);
                    btn.prop('disabled', false).text('Procesar');
                }
            }).catch(() => {
                alert('Error al subir el archivo');
                btn.prop('disabled', false).text('Procesar');
            });
        });

        // 4. Actualizar Perfil del Cliente
        $('#btn-update-profile').on('click', function() {
            const btn = $(this);
            btn.text('Guardando...');

            const data = {
                is_update_only: true, // Flag vital para el backend
                id: $('#prof-id').val(),
                rif: $('#prof-rif').val(),
                nombre: $('#prof-nombre').val(),
                telefono: $('#prof-tel').val(),
                email: $('#prof-email').val(),
                direccion: $('#prof-dir').val(),
                ciudad: $('#prof-ciudad').val(),
                estado: $('#prof-estado').val(),
                contacto: $('#prof-contacto').val(),
                notas: $('#prof-notas').val()
            };

            SuiteAPI.post('suite_save_quote_crm', data).then(res => {
                btn.text('Guardar Cambios');
                if (res.success) {
                    alert('Perfil Actualizado Correctamente');
                } else {
                    alert(res.data.message || res.data);
                }
            });
        });

        // 5. Borrar Cliente
        $('#btn-delete-profile').on('click', function() {
            if (!confirm('¬øEst√° seguro de que desea eliminar este cliente? Se mantendr√° el registro financiero en sus cotizaciones previas.')) return;
            
            const id = $('#prof-id').val();

            SuiteAPI.post('suite_delete_client', { id: id }).then(res => {
                if (res.success) {
                    alert('Cliente eliminado');
                    location.reload();
                } else {
                    alert(res.data.message || res.data);
                }
            });
        });
    };

    /**
     * Carga el perfil completo de un cliente y abre el modal [5, 9, 10]
     * Expuesto p√∫blicamente para ser llamado desde los botones de la tabla
     * 
     * @param {number} id - ID del cliente
     */
    const openProfile = function(id) {
        $('#prof-history-body').html('<tr><td colspan="4" class="text-center">Cargando datos...</td></tr>');
        $('#prof-id').val(id);

        SuiteAPI.post('suite_get_client_profile', { id: id }).then(res => {
            if (res.success) {
                const c = res.data.cliente;
                const s = res.data.stats;
                const h = res.data.history;

                // Llenar formulario
                $('#prof-nombre').val(c.nombre_razon);
                $('#prof-rif').val(c.rif_ci);
                $('#prof-tel').val(c.telefono);
                $('#prof-email').val(c.email);
                $('#prof-dir').val(c.direccion);
                $('#prof-ciudad').val(c.ciudad);
                $('#prof-estado').val(c.estado);
                $('#prof-contacto').val(c.contacto_persona);
                $('#prof-notas').val(c.notas || '');

                // Llenar KPIs
                $('#kpi-total').text('$' + s.total);
                $('#kpi-count').text(s.count);
                $('#kpi-last').text(s.last);

                // Llenar Historial de Compras
                let hHtml = '';
                if (h.length > 0) {
                    h.forEach(r => {
                        hHtml += `
                            <tr>
                                <td>${r.fecha}</td>
                                <td><strong>${r.codigo}</strong></td>
                                <td>$${r.total}</td>
                                <td><a href="${suite_vars.ajax_url}?action=suite_print_quote&id=${r.id}" target="_blank">üìÑ Imprimir</a></td>
                            </tr>`;
                    });
                } else {
                    hHtml = '<tr><td colspan="4" class="text-center text-gray-500">Sin compras registradas.</td></tr>';
                }
                
                $('#prof-history-body').html(hHtml);

                // Mostrar Modal (Asumimos que openModal es global o lo manejamos aqu√≠)
                if (typeof window.openModal === 'function') {
                    window.openModal('modal-client-profile');
                } else {
                    $('#modal-client-profile').fadeIn();
                }
            } else {
                alert(res.data.message || res.data);
            }
        });
    };

    /**
     * B√∫squeda predictiva expuesta para el cotizador (SuiteQuoter)
     * 
     * @param {string} term - T√©rmino de b√∫squeda
     * @returns {Promise} - Devuelve la promesa pura
     */
    const searchClient = function(term) {
        return SuiteAPI.post('suite_search_client_ajax', { term: term });
    };

    // API P√∫blica Revelada
    return {
        init: function() {
            initDataTable();
            bindEvents();
        },
        openProfile: openProfile,
        searchClient: searchClient,
        cleanRif: cleanRifInput // Expuesto por si otros m√≥dulos (Cotizador) lo necesitan
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/crm.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/kanban.js ---
/**
 * SuiteKanban - M√≥dulo visual y l√≥gico del Tablero de Pedidos
 * 
 * Gestiona la carga de tarjetas y los eventos Drag & Drop (SortableJS).
 * Intercepta el cierre de ventas (M√≥dulo 4) para recolectar datos de comisi√≥n.
 */
const SuiteKanban = (function($) {
    'use strict';

    // Variable temporal para retener la tarjeta en memoria mientras se llena el modal
    let pendingDrop = null;

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================

    const buildCardHTML = function(order) {
        let waBtnHtml = '';
        if (order.wa_phone) {
            let msg = encodeURIComponent(`Hola ${order.cliente_nombre}, le contactamos respecto a su pedido ${order.codigo_cotizacion}: ${suite_vars.ajax_url}?action=suite_print_quote&id=${order.id}`);
            waBtnHtml = `<a href="https://api.whatsapp.com/send?phone=${order.wa_phone}&text=${msg}" target="_blank" class="kanban-wa-btn">üì± WA</a>`;
        }

        return `
            <div class="kanban-card" data-id="${order.id}">
                <div class="kanban-card-title">#${order.codigo_cotizacion}</div>
                <div class="kanban-card-client" title="${order.cliente_nombre}">üë§ ${order.cliente_nombre || 'Sin Nombre'}</div>
                
                <div class="kanban-card-footer">
                    <strong style="color: #059669; font-size:14px;">$${order.total_fmt}</strong>
                    <div style="display:flex; gap: 8px;">
                        ${waBtnHtml}
                        <a href="${suite_vars.ajax_url}?action=suite_print_quote&id=${order.id}" target="_blank" class="btn-modern-action" style="padding: 4px; font-size:11px;">üñ®Ô∏è</a>
                    </div>
                </div>
            </div>
        `;
    };

    /**
     * Helper para devolver una tarjeta exactamente a su posici√≥n original
     * si el usuario cancela el drag & drop o falla el servidor.
     */
    const revertCard = function(itemEl, fromCol, oldIndex) {
        // Al usar el oldIndex, buscamos el elemento que AHORA ocupa ese √≠ndice.
        // Insertando el itemEl antes de ese nodo, vuelve exactamente a su lugar original.
        const referenceNode = fromCol.children[oldIndex] || null;
        fromCol.insertBefore(itemEl, referenceNode);
    };

    const initSortableColumns = function() {
        const columns = document.querySelectorAll('.kanban-column-body');
        
        columns.forEach(col => {
            new Sortable(col, {
                group: 'kanban', 
                animation: 150,
                ghostClass: 'kanban-ghost',
                onEnd: function (evt) {
                    const itemEl = evt.item;  
                    const toCol = evt.to;     
                    const fromCol = evt.from; 
                    const oldIndex = evt.oldIndex; // <-- Capturamos la posici√≥n original exacta
                    
                    if (toCol === fromCol) return; 

                    const quoteId = itemEl.getAttribute('data-id');
                    const newStatus = toCol.getAttribute('data-status');

                    // ----------------------------------------------------
                    // INTERCEPTOR M√ìDULO 4: Cierre de Venta
                    // ----------------------------------------------------
                    if (newStatus === 'pagado') {
                        // 1. Guardar contexto en memoria para no perder la tarjeta
                        pendingDrop = { quoteId, itemEl, fromCol, toCol, oldIndex };
                        
                        // 2. Limpiar modal anterior y setear ID oculto
                        $('#modal-cierre-venta input, #modal-cierre-venta select').val('');
                        $('#cierre-quote-id').val(quoteId);
                        
                        // 3. Abrir Modal (No enviamos AJAX a√∫n)
                        $('#modal-cierre-venta').fadeIn();
                    } else {
                        // Si es otro estado (ej. de Pagado a Despachado), enviar directo
                        updateCounters();
                        updateOrderStatus(quoteId, newStatus, itemEl, fromCol, oldIndex);
                    }
                },
            });
        });
    };

    /**
     * Env√≠a un cambio de estado normal (Sin modal) a la base de datos
     */
    const updateOrderStatus = function(quoteId, newStatus, itemEl, originalCol, oldIndex) {
        SuiteAPI.post('suite_change_status_ajax', { 
            id: quoteId, 
            estado: newStatus 
        }).then(res => {
            if (!res.success) {
                alert('‚ùå Error: ' + (res.data.message || res.data));
                revertCard(itemEl, originalCol, oldIndex); // Revertir UI
                updateCounters();
            }
        }).catch(() => {
            alert('‚ùå Fallo de conexi√≥n al actualizar el pedido.');
            revertCard(itemEl, originalCol, oldIndex); // Revertir UI
            updateCounters();
        });
    };

    const updateCounters = function() {
        $('.kanban-column-body').each(function() {
            let status = $(this).data('status');
            let count = $(this).children('.kanban-card').length;
            $('#count-' + status).text(count);
        });
    };

    // ==========================================
    // LISTENERS DEL MODAL DE CIERRE DE VENTA
    // ==========================================
    const bindModalEvents = function() {
        
        // 1. Cerrar o cancelar Modal (Bot√≥n "X" o click por fuera)
        $('#close-modal-cierre').on('click', function() {
            if (pendingDrop) {
                // Al cancelar, la tarjeta se devuelve a su posici√≥n milim√©tricamente exacta
                revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                pendingDrop = null;
                updateCounters();
            }
            $('#modal-cierre-venta').fadeOut();
        });

        // 2. Procesar Formulario
        $('#btn-confirmar-pago').on('click', function(e) {
            e.preventDefault();
            if (!pendingDrop) return;

            // Recolectar datos (NOTA: Se removi√≥ la propiedad 'action' redundante)
            const payload = {
                id: pendingDrop.quoteId,
                estado: 'pagado',
                canal_venta: $('#cierre-canal').val(),
                metodo_pago: $('#cierre-pago').val(),
                metodo_entrega: $('#cierre-entrega').val(),
                recibo_loyverse: $('#cierre-loyverse').val().trim(),
                url_captura: $('#cierre-captura').val().trim()
            };

            // Validar obligatorios
            if (!payload.canal_venta || !payload.metodo_pago || !payload.metodo_entrega || !payload.recibo_loyverse) {
                return alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios (*).');
            }

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            // Enviar al Backend
            SuiteAPI.post('suite_change_status_ajax', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Pago procesado y comisi√≥n registrada.'));
                    $('#modal-cierre-venta').fadeOut();
                    pendingDrop = null; // Liberar memoria, la tarjeta se queda en 'Pagado'
                    updateCounters();
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                    revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                    pendingDrop = null;
                    $('#modal-cierre-venta').fadeOut();
                    updateCounters();
                }
            }).catch(() => {
                alert('‚ùå Error de red. La operaci√≥n fue cancelada.');
                revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                pendingDrop = null;
                $('#modal-cierre-venta').fadeOut();
                updateCounters();
            }).finally(() => {
                btn.prop('disabled', false).text('Confirmar y Procesar Pago');
            });
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        loadBoard: function() {
            $('.kanban-column-body').empty().html('<div class="text-center text-gray-400 py-4">Cargando...</div>');

            SuiteAPI.post('suite_get_kanban_data').then(res => {
                if (res.success) {
                    const data = res.data;
                    $('.kanban-column-body').empty(); 
                    
                    const columnasPermitidas = ['emitida', 'proceso', 'pagado', 'despachado'];
                    
                    columnasPermitidas.forEach(status => {
                        let colHtml = '';
                        if (data[status] && data[status].length > 0) {
                            data[status].forEach(order => {
                                colHtml += buildCardHTML(order);
                            });
                        }
                        $('#kb-col-' + status).html(colHtml);
                    });

                    updateCounters();
                } else {
                    alert('Error al cargar pedidos: ' + res.data);
                }
            });
        },

        init: function() {
            if (typeof Sortable === 'undefined') {
                console.error("SortableJS no est√° cargado.");
                return;
            }
            
            initSortableColumns();
            bindModalEvents();
            this.loadBoard();
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/kanban.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/logistics.js ---
/**
 * SuiteLogistics - M√≥dulo del Panel de Almac√©n y Despacho
 * 
 * Gestiona la apertura de modales de log√≠stica y la subida segura
 * de comprobantes de entrega (POD) mediante FormData.
 */
const SuiteLogistics = (function($) {
    'use strict';

    let currentQuoteId = null;

    // ==========================================
    // M√âTODOS PRIVADOS Y EVENT LISTENERS
    // ==========================================

    const bindEvents = function() {
        
        // Procesar subida del comprobante
        $('#btn-procesar-despacho').on('click', function(e) {
            e.preventDefault();

            const fileInput = $('#log-pod-file').prop('files');
            if (!fileInput || fileInput.length === 0) {
                return alert('‚ö†Ô∏è Por favor, selecciona una imagen o archivo PDF como comprobante.');
            }

            const btn = $(this);
            btn.prop('disabled', true).text('Subiendo Archivo...');

            // Instanciar FormData para env√≠o de archivos (Multipart)
            const fd = new FormData();
            fd.append('pod_file', fileInput);
            fd.append('quote_id', currentQuoteId);

            SuiteAPI.postForm('suite_upload_pod', fd).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Pedido marcado como despachado.'));
                    
                    // Cerrar Modal
                    $('#modal-confirmar-despacho').fadeOut();
                    
                    // Efecto visual: Eliminar la fila de la tabla suavemente
                    $('#log-row-' + currentQuoteId).fadeOut('slow', function() { 
                        $(this).remove(); 
                        
                        // Si la tabla queda vac√≠a, podr√≠amos mostrar un mensaje, 
                        // pero con recargar la vista del Kanban en background es suficiente.
                        if (typeof SuiteKanban !== 'undefined') {
                            SuiteKanban.loadBoard();
                        }
                    });

                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(err => {
                alert('‚ùå Error de conexi√≥n al subir el archivo.');
            }).finally(() => {
                btn.prop('disabled', false).text('Subir y Marcar Despachado');
            });
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Abre el modal y guarda el ID del pedido en memoria
         * @param {number} id - ID del pedido
         */
        openModal: function(id) {
            currentQuoteId = id;
            $('#log-pod-file').val(''); // Limpiar input residual
            $('#modal-confirmar-despacho').fadeIn();
        },

        init: function() {
            bindEvents();
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/logistics.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/marketing.js ---
/**
 * SuiteMarketing - M√≥dulo de Data Analytics (BI)
 * 
 * Se conecta al endpoint REST de la Suite y renderiza gr√°ficos 
 * interactivos con Chart.js
 */
const SuiteMarketing = (function($) {
    'use strict';

    // Instancias globales para poder destruirlas y repintarlas
    let chartCanales = null;
    let chartTendencias = null;

    // ==========================================
    // M√âTODOS DE PROCESAMIENTO DE DATOS
    // ==========================================

    const processDoughnutData = function(rawData) {
        const aglomerado = {};
        
        // Sumar Volumen USD agrupado estrictamente por Canal
        rawData.forEach(item => {
            const canal = item.canal_venta || 'No Definido';
            if (!aglomerado[canal]) aglomerado[canal] = 0;
            aglomerado[canal] += parseFloat(item.volumen_usd);
        });

        return {
            labels: Object.keys(aglomerado),
            values: Object.values(aglomerado)
        };
    };

    const processLineData = function(rawData) {
        const aglomerado = {};
        
        // Sumar Cantidad de Operaciones agrupado estrictamente por Fecha
        rawData.forEach(item => {
            const fecha = item.fecha; // Formato YYYY-MM-DD
            if (!aglomerado[fecha]) aglomerado[fecha] = 0;
            aglomerado[fecha] += parseInt(item.cantidad_operaciones);
        });

        // Ordenar fechas cronol√≥gicamente
        const fechasOrdenadas = Object.keys(aglomerado).sort();
        const valoresOrdenados = fechasOrdenadas.map(f => aglomerado[f]);

        return {
            labels: fechasOrdenadas,
            values: valoresOrdenados
        };
    };

    // ==========================================
    // RENDERIZADO DE CHART.JS
    // ==========================================

    const renderCharts = function(data) {
        // Destruir gr√°ficos previos si el usuario hace clic en "Refrescar"
        if (chartCanales) chartCanales.destroy();
        if (chartTendencias) chartTendencias.destroy();

        // --- 1. GR√ÅFICO DE DONA (Canales) ---
        const dData = processDoughnutData(data);
        const ctxCanales = document.getElementById('chart-canales-venta').getContext('2d');
        
        chartCanales = new Chart(ctxCanales, {
            type: 'doughnut',
            data: {
                labels: dData.labels,
                datasets: [{
                    data: dData.values,
                    backgroundColor: [
                        '#0073aa', // Azul WP
                        '#10b981', // Verde √âxito
                        '#f59e0b', // Naranja/Amarillo
                        '#8b5cf6', // P√∫rpura
                        '#dc2626', // Rojo RV
                        '#64748b'  // Gris
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 13 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // --- 2. GR√ÅFICO DE L√çNEAS (Tendencias) ---
        const lData = processLineData(data);
        const ctxTendencias = document.getElementById('chart-tendencia-ventas').getContext('2d');

        chartTendencias = new Chart(ctxTendencias, {
            type: 'line',
            data: {
                labels: lData.labels,
                datasets: [{
                    label: 'Operaciones Cerradas',
                    data: lData.values,
                    borderColor: '#dc2626', // Rojo corporativo
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#dc2626',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.3 // Hace que la l√≠nea sea curva y suave
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
                }
            }
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        loadDashboard: function() {
            // Utilizamos la ruta absoluta al endpoint REST de WordPress
            const restUrl = '/wp-json/suite/v1/ventas-vs-alcance';

            // Usamos jQuery AJAX para aprovechar las cookies de sesi√≥n nativas de WP
            $.ajax({
                url: restUrl,
                method: 'GET',
                success: function(res) {
                    if (res.success && res.data) {
                        renderCharts(res.data);
                    }
                },
                error: function(err) {
                    if(err.status === 401 || err.status === 403) {
                        alert('üîí Acceso Denegado: Su rol no tiene permisos para ver anal√≠ticas.');
                    } else {
                        $('#chart-canales-venta').parent().html('<p style="color:red;">Error al cargar datos.</p>');
                        $('#chart-tendencia-ventas').parent().html('<p style="color:red;">Error al cargar datos.</p>');
                    }
                }
            });
        },

        init: function() {
            // Listo para ser llamado por el enrutador de pesta√±as
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/marketing.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/quoter.js ---
/**
 * SuiteQuoter - M√≥dulo UI del Cotizador y Punto de Venta (POS)
 * 
 * Conecta el DOM del HTML con el Manejador de Estado (SuiteState).
 */
const SuiteQuoter = (function($) {
    'use strict';

    let searchTimeout = null;

    // ==========================================
    // M√âTODOS VISUALES (Render)
    // ==========================================

    /**
     * Lee el Estado Inmutable y repinta la tabla del carrito.
     */
    const renderCart = function() {
        const cart = SuiteState.getCart();
        const totals = SuiteState.getTotals();
        const tbody = $('#pos-cart-body');
        let html = '';

        if (cart.length === 0) {
            html = '<tr><td colspan="6" class="text-center text-gray-500 py-4">El carrito est√° vac√≠o. Busque un producto para comenzar.</td></tr>';
        } else {
            cart.forEach((item, index) => {
                let subtotal = (item.qty * item.price).toFixed(2);
                html += `
                <tr class="cart-item-row">
                    <td class="font-mono text-sm">${item.sku}</td>
                    <td class="font-bold">${item.name}</td>
                    <td class="text-center">
                        <input type="number" min="1" class="cart-input-qty" data-index="${index}" value="${item.qty}" style="width: 70px; text-align: center;">
                    </td>
                    <td class="text-center">
                        $<input type="number" step="0.01" min="0" class="cart-input-price" data-index="${index}" value="${item.price.toFixed(2)}" style="width: 90px; text-align: right;">
                    </td>
                    <td class="text-right font-bold text-green-700">$${subtotal}</td>
                    <td class="text-center">
                        <button type="button" class="btn-remove-item" data-index="${index}" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 16px;">‚ùå</button>
                    </td>
                </tr>`;
            });
        }

        tbody.html(html);

        // Actualizar UI de Totales
        $('#pos-total-usd').text(`$${totals.usd}`);
        $('#pos-total-bs').text(`Bs ${totals.bs}`);
    };

    // ==========================================
    // EVENT LISTENERS (Delegaci√≥n de eventos)
    // ==========================================

    const bindEvents = function() {
        
        // 1. Delegaci√≥n para Inputs Din√°micos (Cantidades y Precios en el carrito)
        $('#pos-cart-body').on('change input', '.cart-input-qty', function() {
            let index = $(this).data('index');
            let val = $(this).val();
            SuiteState.updateItem(index, 'qty', val);
            renderCart(); // Repintar tras el cambio
        });

        $('#pos-cart-body').on('change', '.cart-input-price', function() {
            let index = $(this).data('index');
            let val = $(this).val();
            SuiteState.updateItem(index, 'price', val);
            renderCart();
        });

        // 2. Delegaci√≥n para Bot√≥n de Eliminar Item
        $('#pos-cart-body').on('click', '.btn-remove-item', function(e) {
            e.preventDefault();
            let index = $(this).data('index');
            SuiteState.removeItem(index);
            renderCart();
        });

        // 3. B√∫squeda de Productos (Predictivo con Debounce)
        $('#pos-product-search').on('keyup', function() {
            clearTimeout(searchTimeout);
            let term = $(this).val().trim();
            let resultsBox = $('#pos-search-results');

            if (term.length < 3) {
                resultsBox.hide().empty();
                return;
            }

            searchTimeout = setTimeout(() => {
                resultsBox.show().html('<div class="p-2 text-gray-500">Buscando...</div>');
                
                // Asumiendo que migraremos este endpoint en la pr√≥xima sesi√≥n (Inventory)
                SuiteAPI.post('suite_search_inventory', { term: term }).then(res => {
                    if (res.success && res.data.length > 0) {
                        let listHTML = '';
                        res.data.forEach(prod => {
                            // Usamos data-attributes para almacenar la data pura y evitar errores de parseo
                            listHTML += `
                            <div class="search-result-item p-2 hover:bg-gray-100 cursor-pointer border-b" 
                                 data-sku="${prod.sku}" 
                                 data-name="${prod.nombre}" 
                                 data-price="${prod.precio}">
                                <strong>${prod.sku}</strong> - ${prod.nombre} <span class="float-right text-green-600">$${prod.precio}</span>
                            </div>`;
                        });
                        resultsBox.html(listHTML);
                    } else {
                        resultsBox.html('<div class="p-2 text-red-500">No se encontraron productos.</div>');
                    }
                }).catch(() => {
                    resultsBox.html('<div class="p-2 text-red-500">‚ùå Error de conexi√≥n al buscar. Intente nuevamente.</div>');
                });
            }, 400); // 400ms delay para no saturar el servidor
        });

        // 4. Seleccionar Producto del Predictivo
        $(document).on('click', '.search-result-item', function() {
            let el = $(this);
            SuiteState.addItem({
                sku: el.data('sku'),
                name: el.data('name'),
                price: parseFloat(el.data('price')),
                qty: 1
            });
            
            // Limpiar buscador UI
            $('#pos-product-search').val('');
            $('#pos-search-results').hide().empty();
            renderCart();
        });

        // 5. Agregar √çtem Manualmente (Productos no catalogados)
        $('#btn-add-manual-item').on('click', function(e) {
            e.preventDefault();
            let desc = $('#manual-item-desc').val().trim();
            let price = $('#manual-item-price').val();
            let qty = $('#manual-item-qty').val() || 1;

            if (!desc || !price) return alert('Descripci√≥n y Precio son obligatorios.');

            SuiteState.addItem({
                sku: 'GENERICO',
                name: desc,
                price: parseFloat(price),
                qty: parseInt(qty)
            });

            // Limpiar UI manual
            $('#manual-item-desc, #manual-item-price').val('');
            $('#manual-item-qty').val('1');
            renderCart();
        });

        // 6. Guardar Cotizaci√≥n (Punto Cr√≠tico Financiero)
        $('#btn-save-quote').on('click', function(e) {
            e.preventDefault();
            
            const cart = SuiteState.getCart();
            if (cart.length === 0) {
                return alert('‚ö†Ô∏è No puede guardar una cotizaci√≥n vac√≠a.');
            }

            const clientData = {
                rif: $('#cli-rif').val().trim(),
                nombre: $('#cli-nombre').val().trim(),
                direccion: $('#cli-dir').val().trim(),
                telefono: $('#cli-tel').val().trim(),
                email: $('#cli-email').val().trim(),
                ciudad: $('#cli-ciudad').val().trim(),
                estado: $('#cli-estado').val().trim(),
                contacto: $('#cli-contacto').val().trim(),
                notas: $('#cli-notas').val().trim()
            };

            // Validar que se seleccion√≥ un cliente (o se escribi√≥)
            if (!clientData.rif || !clientData.nombre) {
                return alert('‚ö†Ô∏è Debe ingresar o seleccionar los datos del cliente (Raz√≥n Social y RIF).');
            }

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            const payload = {
                rif: clientData.rif,
                nombre: clientData.nombre,
                direccion: clientData.direccion,
                telefono: clientData.telefono,
                email: clientData.email,
                ciudad: clientData.ciudad,
                estado: clientData.estado,
                contacto: clientData.contacto,
                notas: clientData.notas,
                items: cart, // El servidor recibir√° el array estructurado
                moneda: $('#pos-moneda').val(),
                tasa: SuiteState.getTotals().tasa,
                validez: $('#pos-validez').val() || 15
            };

            // USO DE LA NUEVA API
            SuiteAPI.post('suite_save_quote_crm', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ Cotizaci√≥n generada con √©xito. C√≥digo: ' + res.data.id);
                    
                    // Abrir PDF en nueva pesta√±a (usamos el ID interno provisto por el backend)
                    window.open(suite_vars.ajax_url + '?action=suite_print_quote&id=' + res.data.internal_id, '_blank');
                    
                    // Resetear App Visual
                    SuiteState.clearCart();
                    renderCart();
                    $('#cli-form-wrapper input, #cli-form-wrapper textarea').val(''); // Limpiar form cliente
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(() => {
                alert('‚ùå Error cr√≠tico de conexi√≥n al generar la cotizaci√≥n.');
            }).finally(() => {
                btn.prop('disabled', false).text('Guardar Cotizaci√≥n / Pedido');
            });
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        init: function() {
            // Leer tasa inicial desde un input oculto en el HTML o variable global
            let initialTasa = $('#hidden-tasa-bcv').val();
            if (initialTasa) {
                SuiteState.setTasa(initialTasa);
            }
            
            bindEvents();
            renderCart(); // Render inicial (vac√≠o)
        },
        renderCart: renderCart // Se expone por si otros m√≥dulos necesitan forzar un repintado
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/quoter.js ---

--- INICIO DEL ARCHIVO: includes/Controllers/Admin/class-suite-shortcode-controller.php ---
<?php
/**
 * Controlador de Interfaz: Renderizado de la App y Encolado de Assets
 *
 * Clase responsable de inyectar el sistema en el frontend mediante shortcodes,
 * verificar permisos (Role-Level Security) y orquestar las dependencias JavaScript (ES6).
 *
 * @package SuiteEmpleados\Controllers\Admin
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Shortcode_Controller {

    /**
     * Constructor: Engancha los m√©todos a los hooks de WordPress.
     */
    public function __construct() {
        // Encolar scripts en el frontend
        add_action( 'wp_enqueue_scripts', [ $this, 'enqueue_assets' ] );
        // Registrar el shortcode [suite_empleados_v8]
        add_shortcode( 'suite_empleados_v8', [ $this, 'render_app' ] );
    }

    /**
     * Encola los estilos, librer√≠as externas y m√≥dulos JS en el orden correcto.
     */
    public function enqueue_assets() {
        global $post;

        // Validar que estamos en la p√°gina del shortcode antes de cargar assets
        if ( is_a( $post, 'WP_Post' ) && has_shortcode( $post->post_content, 'suite_empleados_v8' ) ) {
            
            // 1. Estilos Cl√°sicos (CSS Actual)
            wp_enqueue_style( 'suite-styles', SUITE_URL . 'assets/css/suite-styles.css', [], SUITE_VERSION );

            // 2. Librer√≠as Externas v√≠a CDN
            wp_enqueue_style( 'dt-css', 'https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/datatables.min.css' );
            wp_enqueue_script( 'dt-js', 'https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/datatables.min.js', ['jquery'], '1.13.6', true );
            wp_enqueue_script( 'sortable-js', 'https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js', [], null, true );
            wp_enqueue_script( 'chart-js', 'https://cdn.jsdelivr.net/npm/chart.js', [], null, true );

            // 3. Arquitectura Core JS (Dependencias base)
            wp_enqueue_script( 'suite-api-js', SUITE_URL . 'assets/js/core/api.js', ['jquery'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-state-js', SUITE_URL . 'assets/js/core/state.js', [], SUITE_VERSION, true );
            
            // 4. M√≥dulos Funcionales (Dependen del Core)
            wp_enqueue_script( 'suite-crm-js', SUITE_URL . 'assets/js/modules/crm.js', ['suite-api-js', 'dt-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-quoter-js', SUITE_URL . 'assets/js/modules/quoter.js', ['suite-api-js', 'suite-state-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-kanban-js', SUITE_URL . 'assets/js/modules/kanban.js', ['suite-api-js', 'sortable-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-commissions-js', SUITE_URL . 'assets/js/modules/commissions.js', ['suite-api-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-logistics-js', SUITE_URL . 'assets/js/modules/logistics.js', ['suite-api-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-marketing-js', SUITE_URL . 'assets/js/modules/marketing.js', ['suite-api-js', 'chart-js'], SUITE_VERSION, true );

            // 5. Orquestador Principal (Carga al final)
            wp_enqueue_script( 'suite-main-js', SUITE_URL . 'assets/js/main.js', [
                'suite-crm-js', 
                'suite-quoter-js', 
                'suite-kanban-js', 
                'suite-commissions-js', 
                'suite-logistics-js', 
                'suite-marketing-js'
            ], SUITE_VERSION, true );

            // 6. Variables Globales de Entorno e Inyecci√≥n de Nonce de Seguridad
            wp_localize_script( 'suite-api-js', 'suite_vars', [
                'ajax_url' => admin_url( 'admin-ajax.php' ),
                'nonce'    => wp_create_nonce( 'suite_quote_nonce' ),
                'is_admin' => current_user_can( 'manage_options' )
            ] );
        }
    }

    /**
     * Renderiza el contenido del shortcode.
     */
    public function render_app( $atts ) {
        
        // --- 1. BARRERA DE AUTENTICACI√ìN ---
        if ( ! is_user_logged_in() ) {
            return '<div style="padding:20px; text-align:center; font-family:sans-serif;">üîí Inicie sesi√≥n para acceder a la Intranet de RV Tech.</div>';
        }

        // --- 2. CONTROL DE ROLES (RBAC) ---
        $user = wp_get_current_user();
        $roles = (array) $user->roles;
        
        $es_admin     = current_user_can( 'manage_options' );
        $es_logistica = in_array( 'suite_logistica', $roles );
        $es_vendedor  = in_array( 'suite_vendedor', $roles );
        $es_marketing = in_array( 'suite_marketing', $roles );

        // Si no tiene ning√∫n rol permitido, se bloquea el renderizado por completo
        if ( ! $es_admin && ! $es_logistica && ! $es_vendedor && ! $es_marketing ) {
            return '<div style="padding:20px; text-align:center; color:#dc2626; font-family:sans-serif;">‚õî Acceso Denegado. Contacte al administrador.</div>';
        }

        // --- 3. PRE-CARGA DE DATOS PARA LAS VISTAS ---
        $clientes = [];
        $pedidos_logistica = [];

        // Datos para el CRM
        if ( $es_admin || $es_vendedor || $es_logistica ) {
            $clientModel = new Suite_Model_Client();
            $clientes    = $clientModel->get_all( 200 );
        }

        // Datos para Almac√©n (Log√≠stica)
        if ( $es_admin || $es_logistica ) {
            $quoteModel = new Suite_Model_Quote();
            $kanban_data = $quoteModel->get_kanban_orders( null, true );
            $pedidos_logistica = isset( $kanban_data['pagado'] ) ? $kanban_data['pagado'] : [];
        }

        // --- 4. RENDERIZADO DEL HTML Y COMPONENTES ---
        ob_start();

        echo '<div class="suite-wrap">';
        
        // A. MEN√ö DE PESTA√ëAS (Renderizado din√°mico basado en permisos)
        echo '<div class="suite-tabs-modern">';
        
        // Pesta√±as Operativas Generales (Ventas y Administraci√≥n)
        if ( $es_admin || $es_vendedor || $es_logistica ) {
            echo '<button class="tab-btn active" onclick="openSuiteTab(event, \'TabCli\')">üë• Clientes</button>';
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabPos\')">üìù Cotizador</button>';
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabKanban\')">üì¶ Pedidos</button>';
        }
        
        // Comisiones (Ventas)
        if ( $es_admin || $es_vendedor ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabComisiones\')">üèÜ Comisiones</button>';
        }
        
        // Pesta√±a Protegida: Log√≠stica
        if ( $es_admin || $es_logistica ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabLogistica\')" style="color:#0369a1; font-weight:bold;">üöö Log√≠stica</button>';
        }
        
        // Pesta√±a Protegida: BI & Marketing
        if ( $es_admin || $es_marketing ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabMarketing\')" style="color:#dc2626; font-weight:bold;">üìà BI & Marketing</button>';
        }
        
        echo '</div>'; // Fin men√∫ de pesta√±as

        // B. CARGA DE VISTAS (Inyecci√≥n de plantillas limpia y ordenada)
        if ( $es_admin || $es_vendedor || $es_logistica ) {
            require SUITE_PATH . 'views/app/tab-clientes.php';
            require SUITE_PATH . 'views/app/tab-cotizador.php';
            require SUITE_PATH . 'views/app/tab-kanban.php';
        }
        
        if ( $es_admin || $es_vendedor ) {
            require SUITE_PATH . 'views/app/tab-comisiones.php';
        }

        if ( $es_admin || $es_logistica ) {
            require SUITE_PATH . 'views/app/tab-logistica.php';
        }
        
        if ( $es_admin || $es_marketing ) {
            require SUITE_PATH . 'views/app/tab-marketing.php';
        }

        // C. INYECCI√ìN DEL MOTOR JAVASCRIPT UNIFICADO
        // Se inicializan din√°micamente solo los m√≥dulos que el usuario haya descargado (seg√∫n permisos)
        ?>
        <script>
            jQuery(document).ready(function($){
                
                // 1. INICIALIZACI√ìN SEGURA DE M√ìDULOS (Patr√≥n Factory)
                if (typeof SuiteCRM !== "undefined") SuiteCRM.init();
                if (typeof SuiteQuoter !== "undefined") SuiteQuoter.init();
                if (typeof SuiteKanban !== "undefined") SuiteKanban.init();
                if (typeof SuiteCommissions !== "undefined") SuiteCommissions.init();
                if (typeof SuiteLogistics !== "undefined") SuiteLogistics.init();
                if (typeof SuiteMarketing !== "undefined") SuiteMarketing.init();

                // 2. ENRUTADOR DE PESTA√ëAS (Manejo de estado visual y recargas as√≠ncronas)
                window.openSuiteTab = function(evt, name) {
                    
                    // Resetear la vista actual
                    $(".suite-tab-content").removeClass("active").hide();
                    $(".tab-btn").removeClass("active");
                    
                    // Activar la nueva pesta√±a
                    $("#" + name).fadeIn().addClass("active");
                    evt.currentTarget.classList.add("active");
                    
                    // Disparar las recargas de datos contextuales seg√∫n la pesta√±a que se abra
                    if (name === "TabKanban" && typeof SuiteKanban !== "undefined") {
                        SuiteKanban.loadBoard();
                    }
                    if (name === "TabComisiones" && typeof SuiteCommissions !== "undefined") {
                        SuiteCommissions.loadDashboard();
                    }
                    if (name === "TabMarketing" && typeof SuiteMarketing !== "undefined") {
                        SuiteMarketing.loadDashboard();
                    }
                };

            });
        </script>
        <?php

        echo '</div>'; // Fin .suite-wrap

        return ob_get_clean();
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Admin/class-suite-shortcode-controller.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-client.php ---
<?php
/**
 * Controlador AJAX: Clientes (CRM)
 *
 * Maneja las peticiones del frontend relacionadas con los clientes (B√∫squeda, 
 * Creaci√≥n, Importaci√≥n, Perfiles y Eliminaci√≥n).
 * Hereda las validaciones de seguridad de Suite_AJAX_Controller.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. B√∫squeda predictiva de clientes
 */
class Suite_Ajax_Client_Search extends Suite_AJAX_Controller {
    protected $action_name = 'suite_search_client_ajax';
    protected $required_capability = 'read';

    protected function process() {
        $term = isset( $_POST['term'] ) ? sanitize_text_field( $_POST['term'] ) : '';
        if ( empty( $term ) ) {
            $this->send_success( [] );
        }

        $clientModel = new Suite_Model_Client();
        $resultados = $clientModel->search_clients( $term );
        $this->send_success( $resultados );
    }
}

/**
 * 2. Creaci√≥n manual de un cliente nuevo
 */
class Suite_Ajax_Client_Add extends Suite_AJAX_Controller {
    protected $action_name = 'suite_add_client_manual';
    protected $required_capability = 'read';

    protected function process() {
        $rif    = isset( $_POST['rif'] ) ? sanitize_text_field( $_POST['rif'] ) : '';
        $nombre = isset( $_POST['nombre'] ) ? sanitize_text_field( $_POST['nombre'] ) : '';

        if ( empty( $rif ) || empty( $nombre ) ) {
            $this->send_error( 'El RIF y el Nombre son obligatorios.' );
        }

        $clientModel = new Suite_Model_Client();
        
        $data = [
            'rif_ci'       => strtoupper( preg_replace( '/[^A-Z0-9]/', '', $rif ) ),
            'nombre_razon' => $nombre,
            'direccion'    => isset( $_POST['direccion'] ) ? sanitize_textarea_field( $_POST['direccion'] ) : '',
            'telefono'     => isset( $_POST['telefono'] ) ? sanitize_text_field( $_POST['telefono'] ) : '',
            'email'        => isset( $_POST['email'] ) ? sanitize_email( $_POST['email'] ) : '',
            'ciudad'       => isset( $_POST['ciudad'] ) ? sanitize_text_field( $_POST['ciudad'] ) : '',
            'estado'       => isset( $_POST['estado'] ) ? sanitize_text_field( $_POST['estado'] ) : '',
        ];

        $inserted = $clientModel->insert( $data );

        if ( $inserted ) {
            $this->send_success( [ 'message' => 'Cliente creado exitosamente.', 'id' => $inserted ] );
        } else {
            $this->send_error( 'Fallo al crear el cliente. Es posible que el RIF ya exista.' );
        }
    }
}

/**
 * 3. Importaci√≥n masiva de clientes v√≠a CSV
 */
class Suite_Ajax_Client_Import extends Suite_AJAX_Controller {
    protected $action_name = 'suite_import_clients_csv';
    protected $required_capability = 'read';

    protected function process() {
        if ( empty( $_FILES['csv_file'] ) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK ) {
            $this->send_error( 'No se ha subido ning√∫n archivo o el archivo es inv√°lido.' );
        }

        $file = $_FILES['csv_file']['tmp_name'];
        $clientModel = new Suite_Model_Client();
        $inserted_count = 0;
        $row = 0;

        if ( ( $handle = fopen( $file, 'r' ) ) !== false ) {
            while ( ( $data = fgetcsv( $handle, 1000, ',' ) ) !== false ) {
                $row++;
                // Ignorar la cabecera
                if ( $row === 1 ) continue;

                // Acceso seguro a los √≠ndices del array fgetcsv
                $nombre = sanitize_text_field( isset($data[0]) ? $data[0] : '' );
                $rif    = sanitize_text_field( isset($data[1]) ? $data[1] : '' );

                if ( empty( $nombre ) || empty( $rif ) ) continue;

                $insert_data = [
                    'nombre_razon' => $nombre,
                    'rif_ci'       => strtoupper( preg_replace( '/[^A-Z0-9]/', '', $rif ) ),
                    'telefono'     => sanitize_text_field( isset($data[2]) ? $data[2] : '' ),
                    'email'        => sanitize_email( isset($data[3]) ? $data[3] : '' ),
                    'direccion'    => sanitize_textarea_field( isset($data[4]) ? $data[4] : '' ),
                ];

                if ( $clientModel->insert( $insert_data ) ) {
                    $inserted_count++;
                }
            }
            fclose( $handle );
            $this->send_success( "Importaci√≥n completada. Se a√±adieron {$inserted_count} clientes nuevos." );
        } else {
            $this->send_error( 'No se pudo leer el archivo CSV.' );
        }
    }
}

/**
 * 4. Eliminaci√≥n de un cliente
 */
class Suite_Ajax_Client_Delete extends Suite_AJAX_Controller {
    protected $action_name = 'suite_delete_client';
    protected $required_capability = 'read';

    protected function process() {
        global $wpdb;
        $id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        
        if ( ! $id ) {
            $this->send_error( 'ID de cliente inv√°lido.' );
        }

        // BARRERA DE INTEGRIDAD REFERENCIAL
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';
        $tiene_compras = $wpdb->get_var( $wpdb->prepare( "SELECT COUNT(id) FROM {$tabla_cot} WHERE cliente_id = %d", $id ) );

        if ( $tiene_compras > 0 ) {
            $this->send_error( 'Protecci√≥n Contable: No puede eliminar un cliente con historial de compras. Edite sus datos si es necesario.', 403 );
        }

        $clientModel = new Suite_Model_Client();
        $deleted = $clientModel->delete( $id );

        if ( $deleted ) {
            $this->send_success( 'Cliente eliminado correctamente.' );
        } else {
            $this->send_error( 'No se pudo eliminar el cliente.' );
        }
    }
}

/**
 * 5. Obtener el Perfil y KPIs de un cliente
 */
class Suite_Ajax_Client_Profile extends Suite_AJAX_Controller {
    protected $action_name = 'suite_get_client_profile';
    protected $required_capability = 'read';

    protected function process() {
        $id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        
        if ( ! $id ) {
            $this->send_error( 'ID de cliente inv√°lido.' );
        }

        $clientModel = new Suite_Model_Client();
        
        $cliente = $clientModel->get( $id );
        if ( ! $cliente ) {
            $this->send_error( 'El cliente no existe.', 404 );
        }

        $stats = $clientModel->get_client_stats( $id );
        $history = $clientModel->get_client_history( $id );

        // Formateo de las fechas de KPIs (Blindado para retrocompatibilidad y objetos nulos)
        $stats_fmt = [
            'total' => isset( $stats->total ) ? number_format( floatval( $stats->total ), 2 ) : '0.00',
            'count' => isset( $stats->count ) ? intval( $stats->count ) : 0,
            'first' => !empty( $stats->first ) ? date( 'd/m/Y', strtotime( $stats->first ) ) : '-',
            'last'  => !empty( $stats->last ) ? date( 'd/m/Y', strtotime( $stats->last ) ) : '-',
        ];

        // Formateo visual del historial
        $history_fmt = [];
        if ( ! empty( $history ) ) {
            foreach ( $history as $h ) {
                $history_fmt[] = [
                    'id'     => $h->id,
                    'fecha'  => date( 'd/m/Y', strtotime( $h->fecha ) ),
                    'codigo' => $h->codigo,
                    'total'  => number_format( floatval( $h->total ), 2 ),
                    'estado' => $h->estado,
                ];
            }
        }

        $this->send_success( [
            'cliente' => $cliente,
            'stats'   => $stats_fmt,
            'history' => $history_fmt
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-client.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-commissions.php ---
<?php
/**
 * Controlador AJAX: Dashboard Financiero y Gamificaci√≥n (M√≥dulo 4)
 *
 * Sirve los datos estad√≠sticos de comisiones y premios para la vista del vendedor.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Ajax_Dashboard_Stats extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_dashboard_stats';
    
    // Todos los empleados pueden ver las estad√≠sticas
    protected $required_capability = 'read'; 

    protected function process() {
        $vendedor_id = get_current_user_id();
        
        // Determinar mes y a√±o actual
        $mes  = (int) date('m');
        $anio = (int) date('Y');

        global $wpdb;
        $tabla_ledger = $wpdb->prefix . 'suite_comisiones_ledger';

        // 1. Obtener la comisi√≥n acumulada del vendedor solicitante en el mes actual
        $sql_comision = $wpdb->prepare(
            "SELECT SUM(comision_ganada_usd) 
             FROM {$tabla_ledger} 
             WHERE vendedor_id = %d 
             AND MONTH(created_at) = %d 
             AND YEAR(created_at) = %d",
            $vendedor_id, $mes, $anio
        );
        $comision_mes = floatval( $wpdb->get_var( $sql_comision ) );

        // 2. Obtener el ranking de Gamificaci√≥n desde el Modelo
        $commission_model = new Suite_Model_Commission();
        $gamification = $commission_model->get_gamification_winners( $mes, $anio );

        // Formateo visual para el frontend
        if ( $gamification['pez_gordo'] ) {
            $gamification['pez_gordo']->total_vendido = number_format( floatval( $gamification['pez_gordo']->total_vendido ), 2 );
        }
        
        // 3. Devolver los datos listos para pintar
        $this->send_success( [
            'mes_evaluado'    => date_i18n( 'F Y' ),
            'comision_actual' => number_format( $comision_mes, 2 ),
            'gamificacion'    => $gamification
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-commissions.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-controller.php ---
<?php
/**
 * Clase Abstracta: Controlador AJAX Base
 *
 * Centraliza la seguridad, el registro de hooks y las respuestas estandarizadas
 * para todas las peticiones AJAX del sistema.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

abstract class Suite_AJAX_Controller {

    /**
     * El nombre de la acci√≥n AJAX (Ej. 'suite_search_client_ajax')
     * @var string
     */
    protected $action_name;

    /**
     * El permiso m√≠nimo requerido para ejecutar esta acci√≥n.
     * @var string
     */
    protected $required_capability = 'read'; // Por defecto, cualquier usuario logueado en la intranet

    /**
     * Constructor.
     * Registra din√°micamente el hook wp_ajax bas√°ndose en $action_name.
     */
    public function __construct() {
        if ( empty( $this->action_name ) ) {
            // Evitar registro si la clase hija no defini√≥ el nombre de la acci√≥n
            return;
        }

        // Registrar el endpoint (Solo para usuarios logueados)
        add_action( 'wp_ajax_' . $this->action_name, [ $this, 'handle_request' ] );
    }

    /**
     * Manejador principal de la petici√≥n.
     * Ejecuta las barreras de seguridad antes de procesar la l√≥gica.
     */
    public function handle_request() {
        // 1. Barrera CSRF: Validaci√≥n de Nonce Estricto (Retrocompatibilidad)
        if ( ! check_ajax_referer( 'suite_quote_nonce', 'nonce', false ) ) {
            $this->send_error( 'Fallo de seguridad CSRF o sesi√≥n caducada.', 403 );
        }

        // 2. Barrera de Permisos: Verificaci√≥n del Rol del Usuario
        if ( ! current_user_can( $this->required_capability ) ) {
            $this->send_error( 'Privilegios insuficientes para realizar esta acci√≥n.', 401 );
        }

        // 3. Ejecutar la l√≥gica de negocio espec√≠fica de la clase hija
        $this->process();
    }

    /**
     * M√©todo abstracto que las clases hijas DEBEN implementar.
     * Aqu√≠ es donde ir√° la l√≥gica real (ej. buscar cliente, guardar cotizaci√≥n).
     */
    abstract protected function process();

    /**
     * Helper para enviar una respuesta exitosa estandarizada.
     *
     * @param mixed $data Los datos a devolver (Array, Objeto, String).
     */
    protected function send_success( $data = [] ) {
        wp_send_json_success( $data );
    }

    /**
     * Helper para enviar una respuesta de error estandarizada.
     *
     * @param string $message Mensaje de error para el frontend.
     * @param int    $code    C√≥digo HTTP simulado.
     */
    protected function send_error( $message, $code = 400 ) {
        wp_send_json_error( [
            'message' => $message,
            'code'    => $code
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-controller.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-kanban.php ---
<?php
/**
 * Controlador AJAX: Tablero Kanban (M√≥dulo 1)
 *
 * Contiene los manejadores para poblar las columnas del Kanban 
 * y actualizar los estados tras un evento Drag & Drop.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Endpoint para obtener todos los pedidos y poblar el Tablero Kanban
 */
class Suite_Ajax_Kanban_Data extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_kanban_data';
    protected $required_capability = 'read';

    protected function process() {
        $user_id = get_current_user_id();
        $user = wp_get_current_user();
        
        // Row-Level Security (Control de Accesos M√≥dulo 2)
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        $tiene_acceso_global = ( $is_admin || $is_logistica );

        $quote_model = new Suite_Model_Quote();
        
        // Invocar m√©todo del modelo agrupando por columnas
        $kanban_data = $quote_model->get_kanban_orders( $user_id, $tiene_acceso_global );

        $this->send_success( $kanban_data );
    }
}

/**
 * Endpoint para procesar el Drop de una tarjeta en una nueva columna
 */
class Suite_Ajax_Kanban_Status extends Suite_AJAX_Controller {

    protected $action_name = 'suite_update_kanban_status';
    protected $required_capability = 'read';

    protected function process() {
        // 1. Recibir datos del Frontend (Drag & Drop)
        $quote_id   = isset( $_POST['quote_id'] ) ? intval( $_POST['quote_id'] ) : 0;
        $new_status = isset( $_POST['status'] ) ? sanitize_text_field( $_POST['status'] ) : '';

        if ( ! $quote_id || empty( $new_status ) ) {
            $this->send_error( 'Par√°metros insuficientes para mover la tarjeta.' );
        }

        // TODO: [M√≥dulo 2 - Seguridad] 
        // Implementar Candado de Inmutabilidad aqu√≠:
        // Si la cotizaci√≥n ya estaba en "pagado" y el usuario no es Admin/Supervisor, 
        // bloquear el retroceso a "emitida".

        // 2. Instanciar y actualizar
        $quote_model = new Suite_Model_Quote();
        $updated = $quote_model->update_order_status( $quote_id, $new_status );

        // 3. Respuesta
        if ( $updated ) {
            $this->send_success( [ 'message' => 'El pedido fue movido correctamente a ' . strtoupper( $new_status ) ] );
        } else {
            $this->send_error( 'Fallo al mover el pedido. Es posible que ya estuviese en ese estado.' );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-kanban.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-logistics.php ---
<?php
/**
 * Controlador AJAX: Log√≠stica y Despacho (M√≥dulo 3)
 *
 * Maneja la subida del comprobante de entrega (Proof of Delivery) 
 * y la impresi√≥n blindada de Hojas de Picking para el almac√©n.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Endpoint 1: Subida de Gu√≠a / Foto de Entrega (Proof of Delivery)
 */
class Suite_Ajax_Upload_POD extends Suite_AJAX_Controller {

    protected $action_name = 'suite_upload_pod';
    protected $required_capability = 'read';

    protected function process() {
        // 1. SEGURIDAD: Control Estricto de Rol (Solo Log√≠stica y Admin)
        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );

        if ( ! $is_admin && ! $is_logistica ) {
            if ( function_exists('suite_record_log') ) {
                suite_record_log( 'violacion_acceso', "Intento de escalada de privilegios en POD por el usuario " . get_current_user_id() );
            }
            $this->send_error( 'Acceso Denegado: Solo el personal de almac√©n/log√≠stica puede confirmar despachos.', 403 );
        }

        $quote_id = isset( $_POST['quote_id'] ) ? intval( $_POST['quote_id'] ) : 0;
        
        if ( ! $quote_id ) {
            $this->send_error( 'ID de pedido inv√°lido.', 400 );
        }

        // Validar que se envi√≥ un archivo
        if ( empty( $_FILES['pod_file'] ) ) {
            $this->send_error( 'No se recibi√≥ ning√∫n archivo.', 400 );
        }

        $file = $_FILES['pod_file'];

        // 2. CANDADO DE INMUTABILIDAD
        global $wpdb;
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';
        $current_status = $wpdb->get_var( $wpdb->prepare( "SELECT estado FROM {$tabla_cot} WHERE id = %d", $quote_id ) );

        if ( strtolower( $current_status ) === 'despachado' ) {
            $this->send_error( 'El pedido ya se encuentra despachado.', 403 );
        }

        // Configurar el entorno para la subida nativa de WP
        if ( ! function_exists( 'wp_handle_upload' ) ) {
            require_once( ABSPATH . 'wp-admin/includes/file.php' );
        }

        $upload_overrides = [ 'test_form' => false ];
        $movefile = wp_handle_upload( $file, $upload_overrides );

        if ( $movefile && ! isset( $movefile['error'] ) ) {
            $file_url = $movefile['url'];

            // Actualizar la base de datos
            $wpdb->update(
                $tabla_cot,
                [ 
                    'pod_url' => escapeshellurl( $file_url ), // sanitizamos URL
                    'estado'  => 'despachado' 
                ],
                [ 'id' => $quote_id ],
                [ '%s', '%s' ],
                [ '%d' ]
            );

            // DESCUENTO DE INVENTARIO LOG√çSTICO (Si aplica en tu flujo)
            $quote_model = new Suite_Model_Quote();
            $quote_model->process_inventory_discount( $quote_id );

            $this->send_success( [
                'message' => 'Comprobante subido y pedido despachado correctamente.',
                'url'     => $file_url
            ] );
        } else {
            // PREVENCI√ìN INFO DISCLOSURE: Loguear internamente, pero mostrar un mensaje gen√©rico al usuario
            error_log( 'Suite ERP Upload Error: ' . $movefile['error'] );
            $this->send_error( 'Error de servidor al procesar el archivo. Contacte a soporte t√©cnico.', 500 );
        }
    }
}

/**
 * Endpoint 2: Impresi√≥n de Hoja de Picking (Sin Precios)
 */
class Suite_Ajax_Print_Picking extends Suite_AJAX_Controller {

    protected $action_name = 'suite_print_picking';
    protected $required_capability = 'read';

    public function handle_request() {
        if ( ! isset( $_GET['nonce'] ) || ! wp_verify_nonce( $_GET['nonce'], 'suite_quote_nonce' ) ) {
            wp_die( 'Enlace caducado o inv√°lido por seguridad (CSRF).', 'Acceso Denegado', [ 'response' => 403 ] );
        }
        
        $this->process();
    }

    protected function process() {
        // SEGURIDAD: Control Estricto de Rol para Log√≠stica
        $user = wp_get_current_user();
        $roles = (array) $user->roles;
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', $roles );

        if ( ! $is_admin && ! $is_logistica ) {
            wp_die( 'Privilegios insuficientes. Se requiere el rol de Log√≠stica para generar hojas de picking.', 'Acceso Denegado', [ 'response' => 403 ] );
        }

        global $wpdb;
        $quote_id = isset( $_GET['id'] ) ? intval( $_GET['id'] ) : 0;
        
        if ( ! $quote_id ) wp_die( 'ID de pedido inv√°lido.' );

        $quote_model = new Suite_Model_Quote();
        $cot = $quote_model->get( $quote_id );
        
        if ( ! $cot ) wp_die( 'Pedido no encontrado en la base de datos.' );

        $table_items = $wpdb->prefix . 'suite_cotizaciones_items';
        $items = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM {$table_items} WHERE cotizacion_id = %d", $quote_id ) );

        // RENDER DE VISTA DE IMPRESI√ìN (SOLO HTML CORREGIDO)
        ?>
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Picking_#<?php echo esc_attr( $cot->codigo_cotizacion ); ?></title>
            <style>
                body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 20px; color: #111827; }
                .header { text-align: center; border-bottom: 3px solid #0f172a; padding-bottom: 15px; margin-bottom: 25px; }
                .header h2 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
                .header h3 { margin: 5px 0 0 0; font-size: 18px; color: #475569; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                .info-box { border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; }
                .info-box p { margin: 5px 0; font-size: 14px; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; font-size: 14px; }
                th { background-color: #f8fafc; text-transform: uppercase; font-size: 12px; color: #64748b; }
                .qty-box { font-size: 18px; font-weight: bold; text-align: center; }
                .check-box { width: 40px; text-align: center; }
                .footer-signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 50px; }
                .sign-line { border-top: 1px dashed #94a3b8; padding-top: 10px; text-align: center; font-size: 13px; font-weight: bold; color: #475569; }
                @media print { body { -webkit-print-color-adjust: exact; } }
            </style>
        </head>
        <body onload="window.print()">
            <div class="header">
                <h2>üì¶ HOJA DE PICKING Y DESPACHO</h2>
                <h3>Orden / Pedido: #<?php echo esc_html( $cot->codigo_cotizacion ); ?></h3>
            </div>
            
            <div class="info-grid">
                <div class="info-box">
                    <p><strong>Destinatario:</strong> <?php echo esc_html( $cot->cliente_nombre ); ?></p>
                    <p><strong>RIF / DNI:</strong> <?php echo esc_html( $cot->cliente_rif ); ?></p>
                    <p><strong>M√©todo Entrega:</strong> <?php echo esc_html( $cot->metodo_entrega ? $cot->metodo_entrega : 'N/A' ); ?></p>
                </div>
                <div class="info-box">
                    <p><strong>Fecha Generaci√≥n:</strong> <?php echo date('d/m/Y h:i A'); ?></p>
                    <p><strong>Direcci√≥n:</strong></p>
                    <p style="margin-top: 2px; color: #334155; font-style: italic;">
                        <?php echo nl2br( esc_html( $cot->direccion_entrega ) ); ?>
                    </p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">SKU</th>
                        <th style="width: 60%;">Descripci√≥n del Producto (Ubicaci√≥n)</th>
                        <th style="width: 15%; text-align: center;">Cantidad</th>
                        <th class="check-box">Verif.</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ( $items as $item ) : ?>
                    <tr>
                        <td style="font-family: monospace; font-size: 15px;"><strong><?php echo esc_html( $item->sku ); ?></strong></td>
                        <td><?php echo esc_html( $item->producto_nombre ); ?></td>
                        <td class="qty-box"><?php echo intval( $item->cantidad ); ?></td>
                        <td class="check-box"><div style="width:20px; height:20px; border: 2px solid #ccc; margin: 0 auto;"></div></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <div class="footer-signatures">
                <div class="sign-line">Preparado y Embalado por (Firma)</div>
                <div class="sign-line">Despachado / Entregado por (Firma)</div>
            </div>
        </body>
        </html>
        <?php
        exit;
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-logistics.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-quotes.php ---
<?php
/**
 * Controlador AJAX: Cotizador y Venta (M√≥dulo 2: Seguridad Aplicada)
 *
 * Contiene los manejadores para guardar cotizaciones, consultar el historial 
 * y cambiar estados (con candado de inmutabilidad y protecci√≥n IDOR).
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. Endpoint para Guardar Cotizaciones y Actualizar Clientes
 */
class Suite_Ajax_Quote_Save extends Suite_AJAX_Controller {

    protected $action_name = 'suite_save_quote_crm'; 
    protected $required_capability = 'read';

    protected function process() {
        // 1. Recibir datos del frontend
        $client_data = [
            'rif_ci'           => isset( $_POST['rif'] ) ? $_POST['rif'] : '',
            'nombre_razon'     => sanitize_text_field( $_POST['nombre'] ),
            'direccion'        => sanitize_textarea_field( $_POST['direccion'] ),
            'telefono'         => sanitize_text_field( $_POST['telefono'] ),
            'email'            => sanitize_email( $_POST['email'] ),
            'ciudad'           => sanitize_text_field( $_POST['ciudad'] ),
            'estado'           => sanitize_text_field( $_POST['estado'] ),
            'contacto_persona' => sanitize_text_field( $_POST['contacto'] ),
            'notas'            => sanitize_textarea_field( $_POST['notas'] )
        ];

        // 2. MODO ACTUALIZACI√ìN DE PERFIL
        $is_update_only = isset( $_POST['is_update_only'] ) && $_POST['is_update_only'] == 'true';
        if ( $is_update_only ) {
            $client_id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
            if ( $client_id > 0 ) {
                $client_model = new Suite_Model_Client();
                $client_model->update( $client_id, $client_data );
                $this->send_success( [ 'message' => 'Perfil actualizado correctamente.' ] );
            }
            $this->send_error( 'ID de cliente inv√°lido.' );
            return;
        }

        // 3. MODO CREAR COTIZACI√ìN
        $items = isset( $_POST['items'] ) && is_array( $_POST['items'] ) ? $_POST['items'] : [];
        if ( empty( $items ) ) {
            $this->send_error( 'El carrito no puede estar vac√≠o.' );
        }

        // M√ìDULO 2: SEGURIDAD - CONTROL DE PRECIOS M√çNIMOS (MIDDLEWARE OPTIMIZADO N+1)
        global $wpdb;
        $tabla_inv = $wpdb->prefix . 'suite_inventario_cache';
        $is_admin = current_user_can( 'manage_options' );

        // Si es admin, nos saltamos la validaci√≥n en BD para ahorrar recursos
        if ( ! $is_admin && ! empty( $items ) ) {
            $skus_a_verificar = [];
            foreach ( $items as $item ) {
                $sku = sanitize_text_field( $item['sku'] );
                if ( ! in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                    $skus_a_verificar[] = $sku;
                }
            }

            if ( ! empty( $skus_a_verificar ) ) {
                // 1. Pre-cargar precios permitidos con un solo query (IN)
                $placeholders = implode( ',', array_fill( 0, count( $skus_a_verificar ), '%s' ) );
                $sql_precios = $wpdb->prepare( "SELECT sku, precio FROM {$tabla_inv} WHERE sku IN ($placeholders)", ...$skus_a_verificar );
                // Usamos OBJECT_K para que el array resultante tenga los SKUs como llaves
                $resultados_precios = $wpdb->get_results( $sql_precios, OBJECT_K );

                // 2. Validar precios en memoria
                foreach ( $items as $item ) {
                    $sku = strtoupper( sanitize_text_field( $item['sku'] ) );

                    if ( isset( $resultados_precios[$sku] ) ) {
                        $minimum_price = floatval( $resultados_precios[$sku]->precio );
                        $selling_price = floatval( $item['price'] );

                        if ( $selling_price < $minimum_price ) {
                            $precio_fmt = number_format( $minimum_price, 2 );
                            $this->send_error( "El precio del producto '{$item['name']}' ({$sku}) est√° por debajo del m√≠nimo permitido (\${$precio_fmt}). Requiere autorizaci√≥n de un supervisor.", 403 );
                        }
                    }
                }
            }
        }

        $meta = [
            'vendedor_id' => get_current_user_id(),
            'tasa'        => floatval( $_POST['tasa'] ),
            'validez'     => intval( $_POST['validez'] ),
            'moneda'      => sanitize_text_field( $_POST['moneda'] )
        ];

        // 4. Instanciar Modelo y Guardar
        $quote_model = new Suite_Model_Quote();
        $result = $quote_model->create_quote( $client_data, $items, $meta );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message(), 500 );
        }

        $this->send_success( $result );
    }
}

/**
 * 2. Endpoint para Listar el Historial de Cotizaciones
 */
class Suite_Ajax_Quote_History extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_history_ajax';
    protected $required_capability = 'read';

    protected function process() {
        $user_id = get_current_user_id();
        $user = wp_get_current_user();
        
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        $tiene_acceso_global = ( $is_admin || $is_logistica );

        $quote_model = new Suite_Model_Quote();
        $history = $quote_model->get_vendor_history( $user_id, 50, $tiene_acceso_global );

        foreach ( $history as $r ) {
            $r->fecha_fmt = date( 'd/m/Y', strtotime( $r->fecha_emision ) );
            $r->total_fmt = number_format( floatval( $r->total_usd ), 2 );
            $r->cliente_nombre = empty( $r->cliente_nombre ) ? 'N/A' : esc_html( $r->cliente_nombre );

            $raw_tel = isset( $r->cliente_telefono ) ? $r->cliente_telefono : '';
            $wa_phone = preg_replace( '/[^0-9]/', '', $raw_tel );
            
            if ( strlen( $wa_phone ) === 11 && strpos( $wa_phone, '0' ) === 0 ) {
                $wa_phone = '58' . substr( $wa_phone, 1 );
            } elseif ( strlen( $wa_phone ) === 10 ) {
                $wa_phone = '58' . $wa_phone;
            }
            $r->wa_phone = $wa_phone;

            if ( empty( $r->estado ) ) {
                $r->estado = 'emitida';
            }
            $r->can_change_status = $tiene_acceso_global;
        }

        $this->send_success( $history );
    }
}

/**
 * 3. Endpoint para Cambiar el Estado de una Cotizaci√≥n (Manual / Kanban)
 * Modificado para M√≥dulo 4: Recibe comprobantes y dispara comisiones.
 */
class Suite_Ajax_Quote_Status extends Suite_AJAX_Controller {

    protected $action_name = 'suite_change_status_ajax'; 
    protected $required_capability = 'read';

    protected function process() {
        $quote_id   = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        $new_status = isset( $_POST['estado'] ) ? strtolower( sanitize_text_field( $_POST['estado'] ) ) : '';

        if ( ! $quote_id || empty( $new_status ) ) {
            $this->send_error( 'Datos insuficientes para cambiar el estado.' );
        }

        $quote_model = new Suite_Model_Quote();
        $current_order = $quote_model->get( $quote_id );

        if ( ! $current_order ) {
            $this->send_error( 'La cotizaci√≥n no existe.', 404 );
        }

        $is_admin = current_user_can( 'manage_options' );

        // 1. SEGURIDAD: PREVENCI√ìN DE IDOR
        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        $is_owner = ( intval( $current_order->vendedor_id ) === get_current_user_id() );

        // 1. SEGURIDAD: PREVENCI√ìN DE IDOR (Con Bypass para Log√≠stica)
        if ( ! $is_admin && ! $is_owner ) {
            // Permitir SOLO si es Log√≠stica y est√° intentando mover a 'despachado'
            if ( ! ( $is_logistica && $new_status === 'despachado' ) ) {
                if ( function_exists('suite_record_log') ) {
                    suite_record_log( 'violacion_idor', "Usuario " . get_current_user_id() . " intent√≥ modificar el pedido #{$quote_id}." );
                }
                $this->send_error( 'Acceso Denegado: No tiene permisos para modificar un pedido que no le pertenece.', 403 );
            }
        }

        $current_status = strtolower( $current_order->estado );
        $protected_statuses = [ 'pagado', 'despachado' ];

        // 2. CANDADO DE INMUTABILIDAD
        if ( in_array( $current_status, $protected_statuses ) && ! $is_admin ) {
            $this->send_error( 'Candado de Inmutabilidad üîí: Este pedido ya ha sido procesado y no puede ser modificado.', 403 );
        }

        $estados_validos = ['emitida', 'proceso', 'pagado', 'anulado', 'despachado'];
        if ( ! in_array( $new_status, $estados_validos ) ) {
            $this->send_error( 'Estado no v√°lido.', 400 );
        }

        // 3. M√ìDULO 4: CAPTURAR DATOS DE CIERRE DE VENTA
        if ( $new_status === 'pagado' ) {
            $extra_data = [
                'canal_venta'      => isset($_POST['canal_venta']) ? sanitize_text_field($_POST['canal_venta']) : '',
                'metodo_pago'      => isset($_POST['metodo_pago']) ? sanitize_text_field($_POST['metodo_pago']) : '',
                'metodo_entrega'   => isset($_POST['metodo_entrega']) ? sanitize_text_field($_POST['metodo_entrega']) : '',
                'url_captura_pago' => isset($_POST['url_captura']) ? esc_url_raw($_POST['url_captura']) : '',
                'recibo_loyverse'  => isset($_POST['recibo_loyverse']) ? sanitize_text_field($_POST['recibo_loyverse']) : '',
            ];
            $quote_model->update( $quote_id, $extra_data );
        }

        // 4. CAMBIAR ESTADO
        $result = $quote_model->update_order_status( $quote_id, $new_status );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message(), 500 );
        }

        if ( $result ) {
            // 5. DISPARAR COMISI√ìN AUTOM√ÅTICA
            if ( $new_status === 'pagado' && $current_status !== 'pagado' ) {
                $commission_model = new Suite_Model_Commission();
                $commission_model->calculate_and_save_commission(
                    $quote_id,
                    $current_order->vendedor_id,
                    $current_order->total_usd
                );
            }

            $this->send_success( [ 'message' => 'Estado actualizado a ' . strtoupper( $new_status ) ] );
        } else {
            $this->send_error( 'Error al actualizar la base de datos o el estado ya era el mismo.' );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-quotes.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/class-api-stats.php ---
<?php
/**
 * Archivo: includes/Controllers/Api/class-api-stats.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Controllers/Api/class-api-stats.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/class-suite-api-stats.php ---
<?php
/**
 * Controlador API REST: Estad√≠sticas, Marketing e Inteligencia Artificial
 *
 * Expone endpoints estandarizados para integraciones con PowerBI, Python (Pandas/Prophet)
 * y herramientas de an√°lisis de Marketing.
 *
 * @package SuiteEmpleados\Controllers\Api
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_API_Stats {

    /**
     * Registra las rutas REST al inicializar la API
     */
    public function __construct() {
        add_action( 'rest_api_init', [ $this, 'register_routes' ] );
    }

    /**
     * Define el namespace y los endpoints
     */
    public function register_routes() {
        $namespace = 'suite/v1';

        // Endpoint 1: Rendimiento de Canales de Venta (Marketing)
        register_rest_route( $namespace, '/ventas-vs-alcance', [
            'methods'             => WP_REST_Server::READABLE, // GET
            'callback'            => [ $this, 'get_ventas_vs_alcance' ],
            'permission_callback' => [ $this, 'check_permissions' ]
        ] );

        // Endpoint 2: Exportaci√≥n de Series de Tiempo para Machine Learning (Prophet)
        register_rest_route( $namespace, '/export-prophet', [
            'methods'             => WP_REST_Server::READABLE, // GET
            'callback'            => [ $this, 'export_prophet_data' ],
            'permission_callback' => [ $this, 'check_permissions' ]
        ] );
    }

    /**
     * Middleware de Seguridad: Control de Accesos
     * Solo permite a Administradores o al nuevo rol 'suite_marketing'
     *
     * @return bool|WP_Error
     */
    public function check_permissions() {
        if ( ! is_user_logged_in() ) {
            return new WP_Error( 'rest_unauthorized', 'Debe iniciar sesi√≥n para acceder a la API.', [ 'status' => 401 ] );
        }

        $user = wp_get_current_user();
        $roles = (array) $user->roles;

        if ( in_array( 'administrator', $roles ) || in_array( 'suite_marketing', $roles ) ) {
            return true;
        }

        return new WP_Error( 'rest_forbidden', 'Acceso denegado. Se requiere rol de Marketing o Administrador.', [ 'status' => 403 ] );
    }

    /**
     * Endpoint: Agrupa las ventas cerradas por Fecha y Canal de Venta (√öltimos 30 d√≠as)
     * Ideal para graficar en Chart.js o cruzar con inversi√≥n publicitaria (CPA/ROAS).
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function get_ventas_vs_alcance( $request ) {
        global $wpdb;
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';

        // Consulta SQL para agrupar ventas efectivas
        $sql = "
            SELECT 
                DATE(fecha_emision) as fecha, 
                canal_venta, 
                COUNT(id) as cantidad_operaciones, 
                SUM(total_usd) as volumen_usd
            FROM {$tabla_cot}
            WHERE estado IN ('pagado', 'despachado') 
            AND fecha_emision >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
            GROUP BY DATE(fecha_emision), canal_venta
            ORDER BY fecha ASC
        ";

        $resultados = $wpdb->get_results( $sql );

        // Formatear nulos a canales "No Definidos" y castear tipos para JSON
        foreach ( $resultados as $r ) {
            $r->canal_venta = empty( $r->canal_venta ) ? 'Org√°nico / No definido' : $r->canal_venta;
            $r->cantidad_operaciones = intval( $r->cantidad_operaciones );
            $r->volumen_usd = floatval( $r->volumen_usd );
        }

        return rest_ensure_response( [
            'success' => true,
            'periodo' => '√öltimos 30 d√≠as',
            'data'    => $resultados
        ] );
    }

    /**
     * Endpoint: Extrae el Data Lake para Pandas / Facebook Prophet
     * Usa la nomenclatura estricta 'ds' (Datestamp) e 'y' (Variable objetivo)
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function export_prophet_data( $request ) {
        global $wpdb;
        $tabla_historico = $wpdb->prefix . 'suite_inventario_historico';

        // Facebook Prophet requiere obligatoriamente que la fecha se llame 'ds'
        // y la m√©trica a predecir se llame 'y'. En este caso, predeciremos la ca√≠da de stock (demanda).
        $sql = "
            SELECT 
                fecha_snapshot as ds, 
                stock_disponible as y, 
                sku, 
                precio, 
                categoria
            FROM {$tabla_historico}
            ORDER BY ds ASC, sku ASC
        ";

        $resultados = $wpdb->get_results( $sql );

        // Casteo estricto para que Pandas no falle al procesar JSON
        foreach ( $resultados as $r ) {
            $r->y = intval( $r->y );
            $r->precio = floatval( $r->precio );
        }

        return rest_ensure_response( [
            'success' => true,
            'model'   => 'Facebook Prophet Compatible',
            'data'    => $resultados
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Api/class-suite-api-stats.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-activator.php ---
<?php
// SEGURIDAD: Evitar acceso directo
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Funci√≥n de Instalaci√≥n de Base de Datos
 * Crea las tablas cr√≠ticas: Inventario, Clientes, Cotizaciones, Items, etc.
 */
if ( ! function_exists( 'suite_install_db' ) ) {
    function suite_install_db() {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();

        require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );

        // 1. Tabla Inventario (Cache)
        $sql_inventario = "CREATE TABLE {$wpdb->prefix}suite_inventario_cache (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            sku VARCHAR(100) NOT NULL,
            nombre_producto VARCHAR(255),
            stock_gale INT DEFAULT 0,
            stock_mille INT DEFAULT 0,
            stock_transito INT DEFAULT 0,
            status_alerta VARCHAR(50),
            velocidad_ventas FLOAT DEFAULT 0,
            precio DECIMAL(10,2) DEFAULT 0,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY idx_sku (sku)
        ) $charset_collate;";

        // 2. Tabla Clientes (CRM)
        $sql_clientes = "CREATE TABLE {$wpdb->prefix}suite_clientes (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            nombre_razon VARCHAR(255) NOT NULL,
            rif_ci VARCHAR(50) NOT NULL,
            direccion TEXT,
            ciudad VARCHAR(100),
            estado VARCHAR(100),
            telefono VARCHAR(50),
            email VARCHAR(100),
            contacto_persona VARCHAR(150),
            notas TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY idx_rif (rif_ci)
        ) $charset_collate;";

        // 3. Tabla Cotizaciones
        $sql_cotizaciones = "CREATE TABLE {$wpdb->prefix}suite_cotizaciones (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            codigo_cotizacion VARCHAR(20) NOT NULL,
            cliente_nombre VARCHAR(255),
            cliente_rif VARCHAR(50),
            cliente_id bigint(20) NOT NULL DEFAULT 0,
            direccion_entrega TEXT,
            fecha_emision DATETIME DEFAULT CURRENT_TIMESTAMP,
            validez_dias INT DEFAULT 10,
            moneda VARCHAR(5) DEFAULT 'USD',
            vendedor_id bigint(20),
            total_bs DECIMAL(15,2),
            total_usd DECIMAL(15,2),
            tasa_bcv DECIMAL(10,2),
            estado VARCHAR(20) DEFAULT 'emitida',
            canal_venta VARCHAR(100),
            metodo_pago VARCHAR(100),
            metodo_entrega VARCHAR(100),
            url_captura_pago TEXT,
            recibo_loyverse VARCHAR(100),
            pod_url TEXT,
            PRIMARY KEY (id)
        ) $charset_collate;";

        // 4. Tabla Libro Mayor de Comisiones (Ledger)
        $sql_comisiones = "CREATE TABLE {$wpdb->prefix}suite_comisiones_ledger (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            quote_id bigint(20) NOT NULL,
            vendedor_id bigint(20) NOT NULL,
            monto_base_usd DECIMAL(15,2) DEFAULT 0,
            comision_ganada_usd DECIMAL(15,2) DEFAULT 0,
            estado_pago VARCHAR(20) DEFAULT 'pendiente',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_vendedor (vendedor_id)
        ) $charset_collate;";

        // 5. Tabla Gamificaci√≥n y Premios
        $sql_premios = "CREATE TABLE {$wpdb->prefix}suite_premios_mensuales (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            vendedor_id bigint(20) NOT NULL,
            mes INT NOT NULL,
            anio INT NOT NULL,
            premio_nombre VARCHAR(100) NOT NULL,
            monto_premio DECIMAL(10,2) DEFAULT 0,
            asignado_manualmente TINYINT(1) DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_mes_anio (mes, anio)
        ) $charset_collate;";

        // 6. Tabla Items (Detalle)
        $sql_items = "CREATE TABLE {$wpdb->prefix}suite_cotizaciones_items (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            cotizacion_id bigint(20) NOT NULL,
            sku VARCHAR(100),
            producto_nombre VARCHAR(255),
            cantidad INT,
            precio_unitario_usd DECIMAL(15,2),
            tiempo_entrega VARCHAR(100),
            subtotal_usd DECIMAL(15,2),
            PRIMARY KEY (id),
            KEY idx_cotizacion (cotizacion_id)
        ) $charset_collate;";

        // 7. Tabla de Auditor√≠a (Logs)
        $sql_logs = "CREATE TABLE {$wpdb->prefix}suite_logs (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            usuario_id bigint(20) NOT NULL,
            accion VARCHAR(50) NOT NULL,
            detalle TEXT,
            ip VARCHAR(45),
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_usuario (usuario_id)
        ) $charset_collate;";

        // 8. Tabla Data Lake / Inventario Hist√≥rico (M√≥dulo 5 - IA)
        $sql_historico = "CREATE TABLE {$wpdb->prefix}suite_inventario_historico (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            fecha_snapshot DATE NOT NULL,
            sku VARCHAR(100) NOT NULL,
            stock_disponible INT DEFAULT 0,
            precio DECIMAL(10,2) DEFAULT 0,
            categoria VARCHAR(100) DEFAULT 'General',
            PRIMARY KEY (id),
            KEY idx_fecha (fecha_snapshot),
            KEY idx_sku (sku)
        ) $charset_collate;";

        // --- EJECUCI√ìN √öNICA DE DB-DELTA ---
        dbDelta( $sql_inventario );
        dbDelta( $sql_clientes );
        dbDelta( $sql_cotizaciones );
        dbDelta( $sql_items );
        dbDelta( $sql_comisiones );
        dbDelta( $sql_premios );
        dbDelta( $sql_logs );
        dbDelta( $sql_historico ); // Data Lake agregado correctamente

        // Ajuste de Auto-Increment para Cotizaciones (Inicio en 15000)
        $count = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->prefix}suite_cotizaciones" );
        if ( $count == 0 ) {
            $wpdb->query( "ALTER TABLE {$wpdb->prefix}suite_cotizaciones AUTO_INCREMENT = 15000" );
        }

        // --- CREACI√ìN DE ROLES (Ejecutar una vez) ---
        add_role('suite_vendedor', 'Vendedor Suite', array('read' => true, 'suite_access' => true));
        add_role('suite_logistica', 'Log√≠stica Suite', array('read' => true, 'suite_access' => true));
        add_role('suite_marketing', 'Marketing y An√°lisis', array('read' => true, 'suite_access' => true));

        $admin = get_role('administrator');
        if ( $admin ) {
            $admin->add_cap('suite_access'); // Asegurar que admin tenga acceso
        }
    }
}
--- FIN DEL ARCHIVO: includes/Core/class-activator.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-logger.php ---
<?php
/**
 * Archivo: includes/Core/class-logger.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Core/class-logger.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-security.php ---
<?php
/**
 * Archivo: includes/Core/class-security.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Core/class-security.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-suite-cron-jobs.php ---
<?php
/**
 * Clase Gestora de Tareas Programadas (Cron Jobs)
 * 
 * M√≥dulo 5: Data Lake y Cerebro de Demanda.
 * Recopila series de tiempo (Time Series) para modelos predictivos.
 *
 * @package SuiteEmpleados\Core
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Cron_Jobs {

    /**
     * Constructor: Engancha los m√©todos a los hooks de WP-Cron
     */
    public function __construct() {
        add_action( 'suite_daily_inventory_snapshot', [ $this, 'take_inventory_snapshot' ] );
    }

    /**
     * Registra el evento recurrente en WordPress.
     * Debe llamarse durante el init del plugin.
     */
    public function schedule_events() {
        if ( ! wp_next_scheduled( 'suite_daily_inventory_snapshot' ) ) {
            // Programar para que corra diariamente. 'midnight' asegura que la foto
            // sea consistente a nivel estad√≠stico (cierre del d√≠a).
            wp_schedule_event( strtotime( 'midnight' ), 'daily', 'suite_daily_inventory_snapshot' );
        }
    }

    /**
     * Limpia los eventos al desactivar el plugin.
     */
    public function clear_events() {
        $timestamp = wp_next_scheduled( 'suite_daily_inventory_snapshot' );
        if ( $timestamp ) {
            wp_unschedule_event( $timestamp, 'suite_daily_inventory_snapshot' );
        }
    }

    /**
     * ETL (Extract, Transform, Load) Diario.
     * Lee el stock actual e inserta el snapshot en el Data Lake.
     */
    public function take_inventory_snapshot() {
        global $wpdb;

        $tabla_cache     = $wpdb->prefix . 'suite_inventario_cache';
        $tabla_historico = $wpdb->prefix . 'suite_inventario_historico';
        $hoy             = date( 'Y-m-d' );

        // 1. Control de Idempotencia: Evitar snapshots duplicados si el cron se dispara doble
        $existe_hoy = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$tabla_historico} WHERE fecha_snapshot = %s",
            $hoy
        ) );

        if ( $existe_hoy > 0 ) {
            return; 
        }

        // 2. Extraer el inventario por lotes (Chunking) para evitar Memory Leaks
        $limit = 500;
        $offset = 0;

        while ( true ) {
            $inventario = $wpdb->get_results( $wpdb->prepare(
                "SELECT sku, stock_gale, precio FROM {$tabla_cache} LIMIT %d OFFSET %d",
                $limit, $offset
            ) );

            if ( empty( $inventario ) ) {
                break; // Fin de los registros
            }

            // 3. Transformaci√≥n y Carga en Base de Datos
            foreach ( $inventario as $item ) {
                $sku = strtoupper( sanitize_text_field( $item->sku ) );

                $categoria = 'General';
                if ( strpos( $sku, 'UT' ) === 0 ) {
                    $categoria = 'UNI-T';
                } elseif ( strpos( $sku, 'HM' ) === 0 || strpos( $sku, 'HIK' ) === 0 || strpos( $sku, 'DS' ) === 0 ) {
                    $categoria = 'HIKMICRO';
                } elseif ( strpos( $sku, 'RV' ) === 0 ) {
                    $categoria = 'RV TECH';
                }

                $wpdb->insert(
                    $tabla_historico,
                    [
                        'fecha_snapshot'   => $hoy,
                        'sku'              => $sku,
                        'stock_disponible' => intval( $item->stock_gale ),
                        'precio'           => floatval( $item->precio ),
                        'categoria'        => $categoria
                    ],
                    [ '%s', '%s', '%d', '%f', '%s' ]
                );
            }
            // Avanzar al siguiente lote liberando memoria
            $offset += $limit;
        }

        // 4. Auditor√≠a
        if ( function_exists( 'suite_record_log' ) ) {
            suite_record_log( 'cron_snapshot_ia', "Time Series generada exitosamente para la fecha: {$hoy}" );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Core/class-suite-cron-jobs.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-base.php ---
<?php
/**
 * Clase Abstracta: Modelo Base de Base de Datos
 *
 * Centraliza la interacci√≥n con $wpdb, proporcionando m√©todos CRUD
 * blindados contra inyecciones SQL y estandarizados para todos los m√≥dulos.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

abstract class Suite_Model_Base {

    /**
     * Instancia global de WordPress DB
     * @var wpdb
     */
    protected $wpdb;

    /**
     * Nombre completo de la tabla (incluyendo el prefijo wp_)
     * @var string
     */
    protected $table_name;

    /**
     * Llave primaria de la tabla (por defecto 'id')
     * @var string
     */
    protected $primary_key = 'id';

    /**
     * Constructor. Inicializa la conexi√≥n a DB y define el nombre de la tabla.
     */
    public function __construct() {
        global $wpdb;
        $this->wpdb = $wpdb;
        
        // $this->set_table_name() debe ser definido obligatoriamente por la clase hija
        $this->table_name = $this->wpdb->prefix . $this->set_table_name();
    }

    /**
     * Define el nombre de la tabla sin el prefijo de WordPress.
     * Ej: return 'suite_clientes';
     *
     * @return string
     */
    abstract protected function set_table_name();

    /**
     * Obtiene un registro espec√≠fico por su ID.
     *
     * @param int $id El ID del registro.
     * @return object|null Objeto con los datos o null si no existe.
     */
    public function get( $id ) {
        $sql = $this->wpdb->prepare( 
            "SELECT * FROM {$this->table_name} WHERE {$this->primary_key} = %d", 
            intval( $id ) 
        );
        return $this->wpdb->get_row( $sql );
    }

    /**
     * Obtiene una lista de registros con l√≠mite y offset (paginaci√≥n b√°sica).
     *
     * @param int $limit L√≠mite de resultados.
     * @param int $offset Punto de inicio.
     * @return array Array de objetos.
     */
    public function get_all( $limit = 100, $offset = 0 ) {
        $sql = $this->wpdb->prepare( 
            "SELECT * FROM {$this->table_name} ORDER BY {$this->primary_key} DESC LIMIT %d OFFSET %d", 
            intval( $limit ), 
            intval( $offset ) 
        );
        return $this->wpdb->get_results( $sql );
    }

    /**
     * Inserta un nuevo registro de forma segura.
     *
     * @param array $data Array asociativo [ 'columna' => 'valor' ].
     * @return int|false El ID insertado o false en caso de error.
     */
    public function insert( $data ) {
        $inserted = $this->wpdb->insert( $this->table_name, $data );
        if ( $inserted ) {
            return $this->wpdb->insert_id;
        }
        return false;
    }

    /**
     * Actualiza un registro existente de forma segura.
     *
     * @param int   $id   El ID del registro a actualizar.
     * @param array $data Array asociativo [ 'columna' => 'valor' ].
     * @return bool True si se actualiz√≥, false en caso de error.
     */
    public function update( $id, $data ) {
        $updated = $this->wpdb->update( 
            $this->table_name, 
            $data, 
            [ $this->primary_key => intval( $id ) ] 
        );
        
        // $updated devuelve false en error, o el n√∫mero de filas afectadas (puede ser 0 si los datos eran id√©nticos)
        return $updated !== false;
    }

    /**
     * Elimina un registro por su ID de forma segura.
     *
     * @param int $id El ID del registro a eliminar.
     * @return bool True en √©xito, false en error.
     */
    public function delete( $id ) {
        $deleted = $this->wpdb->delete( 
            $this->table_name, 
            [ $this->primary_key => intval( $id ) ] 
        );
        return $deleted !== false;
    }

}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-base.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-client.php ---
<?php
/**
 * Modelo de Base de Datos: Clientes (CRM)
 *
 * Maneja las consultas espec√≠ficas de la tabla suite_clientes.
 * Hereda de Suite_Model_Base los m√©todos gen√©ricos (get, get_all, insert, update, delete).
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Client extends Suite_Model_Base {

    /**
     * Define el nombre de la tabla sin el prefijo wp_
     * (Requerido obligatoriamente por la clase abstracta Suite_Model_Base)
     *
     * @return string
     */
    protected function set_table_name() {
        // Al retornar esto, la clase base armar√°: wp_suite_clientes [4]
        return 'suite_clientes';
    }

    /**
     * Busca clientes por Nombre/Raz√≥n Social o por RIF/CI.
     * Aplica la limpieza h√≠brida de caracteres para evitar fallos por guiones.
     *
     * @param string $term T√©rmino de b√∫squeda introducido por el vendedor.
     * @return array Array de objetos con los resultados (L√≠mite 10).
     */
    public function search_clients( $term ) {
        // 1. Limpiamos el t√©rmino para la b√∫squeda de RIF (ej. "J-505" -> "J505") [1, 5]
        $term_clean = strtoupper( preg_replace( '/[^A-Z0-9]/', '', $term ) );
        
        // 2. Mantenemos el original para buscar por Raz√≥n Social [1]
        $term_name  = $term;

        $sql = $this->wpdb->prepare(
            "SELECT * FROM {$this->table_name}
            WHERE nombre_razon LIKE %s
            OR rif_ci LIKE %s
            LIMIT 10",
            '%' . $this->wpdb->esc_like( $term_name ) . '%',
            '%' . $this->wpdb->esc_like( $term_clean ) . '%'
        );

        return $this->wpdb->get_results( $sql );
    }

    /**
     * Obtiene los KPIs y estad√≠sticas de compras de un cliente espec√≠fico.
     * Cruza la informaci√≥n con la tabla wp_suite_cotizaciones.
     *
     * @param int $client_id ID del cliente en la base de datos.
     * @return object|null Objeto con los totales (total, count, first, last).
     */
    public function get_client_stats( $client_id ) {
        $tabla_cotizaciones = $this->wpdb->prefix . 'suite_cotizaciones'; [6, 7]

        $sql = $this->wpdb->prepare( 
            "SELECT 
                SUM(total_usd) as total, 
                COUNT(id) as count, 
                MIN(fecha_emision) as first, 
                MAX(fecha_emision) as last 
            FROM {$tabla_cotizaciones} 
            WHERE cliente_id = %d", 
            intval( $client_id ) 
        );

        return $this->wpdb->get_row( $sql ); [2]
    }

    /**
     * Obtiene el historial reciente de cotizaciones/compras de un cliente.
     *
     * @param int $client_id ID del cliente en la base de datos.
     * @return array Array de objetos con las √∫ltimas 10 cotizaciones.
     */
    public function get_client_history( $client_id ) {
        $tabla_cotizaciones = $this->wpdb->prefix . 'suite_cotizaciones'; [6, 7]

        $sql = $this->wpdb->prepare( 
            "SELECT 
                id, 
                codigo_cotizacion as codigo, 
                fecha_emision as fecha, 
                total_usd as total, 
                estado 
            FROM {$tabla_cotizaciones} 
            WHERE cliente_id = %d 
            ORDER BY id DESC 
            LIMIT 10", 
            intval( $client_id ) 
        );

        return $this->wpdb->get_results( $sql ); [3]
    }

}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-client.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-commission.php ---
<?php
/**
 * Modelo de Base de Datos: Comisiones, Metas y Gamificaci√≥n (M√≥dulo 4)
 *
 * Maneja el c√°lculo inmutable del 1.5% de comisi√≥n y determina a los 
 * ganadores de los premios mensuales ("Pez Gordo", "Deja pa' los dem√°s").
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Commission extends Suite_Model_Base {

    /**
     * Define la tabla principal del modelo (Ledger de Comisiones)
     */
    protected function set_table_name() {
        return 'suite_comisiones_ledger';
    }

    /**
     * Calcula y registra la comisi√≥n de una venta cerrada.
     * Esta funci√≥n debe ser llamada desde update_order_status() cuando un pedido pase a 'pagado'.
     *
     * @param int   $quote_id    ID de la cotizaci√≥n
     * @param int   $vendedor_id ID del vendedor
     * @param float $total_usd   Monto total de la venta en d√≥lares
     * @return int|false         ID del registro o false si falla
     */
    public function calculate_and_save_commission( $quote_id, $vendedor_id, $total_usd ) {
        // Regla de Negocio: Comisi√≥n Fija del 1.5%
        $porcentaje = 0.015;
        $comision   = floatval( $total_usd ) * $porcentaje;

        // Evitar registrar comisiones en $0
        if ( $comision <= 0 ) {
            return false; 
        }

        // Registrar en el Ledger como pendiente de liquidaci√≥n
        return $this->insert( [
            'quote_id'            => intval( $quote_id ),
            'vendedor_id'         => intval( $vendedor_id ),
            'monto_base_usd'      => floatval( $total_usd ),
            'comision_ganada_usd' => $comision,
            'estado_pago'         => 'pendiente'
        ] );
    }

    /**
     * Analiza la base de datos para determinar los ganadores de la Gamificaci√≥n.
     * Solo cuenta ventas efectivamente cerradas ('pagado', 'despachado').
     *
     * @param int $mes  Mes a evaluar (1-12)
     * @param int $anio A√±o a evaluar (ej. 2024)
     * @return array    Array asociativo con los datos de los ganadores
     */
    public function get_gamification_winners( $mes, $anio ) {
        $tabla_cot  = $this->wpdb->prefix . 'suite_cotizaciones';
        $tabla_user = $this->wpdb->prefix . 'users';

        // 1. Ganador "Pez Gordo" ($20): Mayor volumen acumulado en d√≥lares
        $pez_gordo = $this->wpdb->get_row( $this->wpdb->prepare( "
            SELECT c.vendedor_id, u.display_name, SUM(c.total_usd) as total_vendido
            FROM {$tabla_cot} c
            INNER JOIN {$tabla_user} u ON c.vendedor_id = u.ID
            WHERE MONTH(c.fecha_emision) = %d AND YEAR(c.fecha_emision) = %d
            AND c.estado IN ('pagado', 'despachado')
            GROUP BY c.vendedor_id
            ORDER BY total_vendido DESC
            LIMIT 1
        ", intval( $mes ), intval( $anio ) ) );

        // 2. Ganador "Deja pa' los dem√°s" ($20): Mayor cantidad de ventas cerradas
        $deja_pa_los_demas = $this->wpdb->get_row( $this->wpdb->prepare( "
            SELECT c.vendedor_id, u.display_name, COUNT(c.id) as cantidad_ventas
            FROM {$tabla_cot} c
            INNER JOIN {$tabla_user} u ON c.vendedor_id = u.ID
            WHERE MONTH(c.fecha_emision) = %d AND YEAR(c.fecha_emision) = %d
            AND c.estado IN ('pagado', 'despachado')
            GROUP BY c.vendedor_id
            ORDER BY cantidad_ventas DESC
            LIMIT 1
        ", intval( $mes ), intval( $anio ) ) );

        return [
            'pez_gordo'         => $pez_gordo,
            'deja_pa_los_demas' => $deja_pa_los_demas
        ];
    }

    /**
     * Asignaci√≥n manual de un premio por parte del Administrador (Ej: "Dale play").
     *
     * @param int    $vendedor_id   ID del vendedor premiado
     * @param string $premio_nombre Nombre del premio (Ej: "Dale play")
     * @param float  $monto         Monto en d√≥lares a premiar (Ej: 10.00)
     * @param int    $mes           Mes correspondiente
     * @param int    $anio          A√±o correspondiente
     * @return int|false
     */
    public function assign_manual_prize( $vendedor_id, $premio_nombre, $monto, $mes, $anio ) {
        $tabla_premios = $this->wpdb->prefix . 'suite_premios_mensuales';

        $inserted = $this->wpdb->insert( $tabla_premios, [
            'vendedor_id'          => intval( $vendedor_id ),
            'mes'                  => intval( $mes ),
            'anio'                 => intval( $anio ),
            'premio_nombre'        => sanitize_text_field( $premio_nombre ),
            'monto_premio'         => floatval( $monto ),
            'asignado_manualmente' => 1
        ] );

        return $inserted ? $this->wpdb->insert_id : false;
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-commission.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-inventory.php ---
<?php
/**
 * Modelo de Base de Datos: Inventario y Log√≠stica (M√≥dulo 3)
 *
 * Maneja las consultas de la tabla suite_inventario_cache.
 * Provee m√©todos para el descuento de stock y reservas temporales.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Inventory extends Suite_Model_Base {

    /**
     * Define el nombre de la tabla (sin el prefijo wp_)
     */
    protected function set_table_name() {
        return 'suite_inventario_cache';
    }

    /**
     * Descuenta el stock f√≠sico de los productos vendidos.
     * Por defecto, descuenta del almac√©n principal (stock_gale).
     *
     * @param array $items Array asociativo con 'sku' y 'cantidad'
     * @return void
     */
    public function discount_stock( $items ) {
        if ( empty( $items ) || ! is_array( $items ) ) {
            return;
        }

        foreach ( $items as $item ) {
            $sku = isset( $item['sku'] ) ? sanitize_text_field( $item['sku'] ) : '';
            $qty = isset( $item['cantidad'] ) ? intval( $item['cantidad'] ) : 0;

            // Ignorar productos manuales o gen√©ricos que no est√°n en el cat√°logo
            if ( empty( $sku ) || $qty <= 0 || in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                continue;
            }

            // Consulta directa para restar el stock at√≥micamente a nivel de base de datos
            // Esto previene condiciones de carrera si dos usuarios compran al mismo exacto milisegundo
            $sql = $this->wpdb->prepare(
                "UPDATE {$this->table_name} 
                 SET stock_gale = stock_gale - %d 
                 WHERE sku = %s",
                $qty,
                $sku
            );

            $this->wpdb->query( $sql );
            
            // Log de auditor√≠a (Opcional, si tienes suite_record_log global)
            if ( function_exists('suite_record_log') ) {
                suite_record_log('descuento_inventario', "Se descontaron {$qty} unidades del SKU: {$sku}");
            }
        }
    }

    /**
     * Reserva stock temporalmente (Hard Commit) para clientes "En Espera de Pago".
     * TODO: [M√≥dulo 3 - Log√≠stica] Requiere la creaci√≥n de la tabla wp_suite_reservas.
     *
     * @param string $sku   El c√≥digo del producto
     * @param int    $qty   Cantidad a reservar
     * @param int    $hours Tiempo de vida de la reserva en horas
     * @return bool
     */
    public function reserve_stock_temporal( $sku, $qty, $hours = 24 ) {
        /*
        $expiration = date('Y-m-d H:i:s', strtotime("+{$hours} hours"));
        
        return $this->wpdb->insert( $this->wpdb->prefix . 'suite_reservas', [
            'sku'        => sanitize_text_field($sku),
            'cantidad'   => intval($qty),
            'expira_en'  => $expiration
        ] );
        */
        
        return true; // Placeholder hasta construir la tabla
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-inventory.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-quote.php ---
<?php
/**
 * Modelo de Base de Datos: Cotizaciones y Pedidos
 *
 * Maneja transacciones de ventas, Kanban y reglas de inmutabilidad.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Quote extends Suite_Model_Base {

    protected function set_table_name() {
        return 'suite_cotizaciones';
    }

    /**
     * Crea una cotizaci√≥n completa usando Transacciones SQL Seguras y 
     * validaci√≥n cruzada de precios para evitar vulnerabilidades.
     */
    public function create_quote( $client_data, $items, $meta ) {
        // 1. Iniciar Transacci√≥n
        $this->wpdb->query( 'START TRANSACTION' );

        try {
            // --- GESTI√ìN DEL CLIENTE ---
            $client_model = new Suite_Model_Client();
            
            $rif_limpio = strtoupper( preg_replace( '/[^A-Z0-9]/', '', $client_data['rif_ci'] ) );
            if ( empty( $rif_limpio ) ) throw new Exception( 'El RIF proporcionado no es v√°lido.' );
            $client_data['rif_ci'] = $rif_limpio;

            $existing_client = $this->wpdb->get_row( $this->wpdb->prepare( "SELECT id FROM {$this->wpdb->prefix}suite_clientes WHERE rif_ci = %s", $rif_limpio ) );

            $cliente_id = 0;
            if ( $existing_client ) {
                $cliente_id = $existing_client->id;
            } else {
                $cliente_id = $client_model->insert( $client_data );
                if ( ! $cliente_id ) throw new Exception( 'Fallo al registrar el nuevo cliente.' );
            }

            // --- GENERACI√ìN DE C√ìDIGO ---
            $hoy_start = date( 'Y-m-d 00:00:00' ); 
            $hoy_end   = date( 'Y-m-d 23:59:59' );
            $count = $this->wpdb->get_var( "SELECT COUNT(*) FROM {$this->table_name} WHERE fecha_emision BETWEEN '$hoy_start' AND '$hoy_end'" );
            $codigo = date( 'Y' ) . str_pad( $count + 1, 2, '0', STR_PAD_LEFT ) . date( 'd' ) . date( 'm' );

            // --- INSERCI√ìN CABECERA ---
            $quote_id = $this->insert( [
                'codigo_cotizacion' => $codigo,
                'cliente_id'        => $cliente_id,
                'cliente_nombre'    => $client_data['nombre_razon'],
                'cliente_rif'       => $rif_limpio,
                'direccion_entrega' => $client_data['direccion'],
                'vendedor_id'       => $meta['vendedor_id'],
                'tasa_bcv'          => floatval( $meta['tasa'] ),
                'validez_dias'      => intval( $meta['validez'] ),
                'moneda'            => sanitize_text_field( $meta['moneda'] ),
                'total_usd'         => 0, // Se actualizar√° luego del loop
                'fecha_emision'     => current_time( 'mysql' ),
                'estado'            => 'emitida'
            ] );

            if ( ! $quote_id ) throw new Exception( 'Fallo al generar la cabecera.' );

            // --- INSERCI√ìN DETALLE (Optimizaci√≥n N+1) ---
            $total_usd = 0;
            $table_items = $this->wpdb->prefix . 'suite_cotizaciones_items';
            $table_inv   = $this->wpdb->prefix . 'suite_inventario_cache';

            // 1. Pre-cargar todos los precios en 1 sola consulta
            $skus_a_buscar = [];
            foreach ( $items as $item ) {
                if ( ! in_array( strtoupper( $item['sku'] ), ['MANUAL', 'GENERICO'] ) ) {
                    $skus_a_buscar[] = sanitize_text_field( $item['sku'] );
                }
            }
            
            $precios_db = [];
            if ( ! empty( $skus_a_buscar ) ) {
                $placeholders = implode( ',', array_fill( 0, count( $skus_a_buscar ), '%s' ) );
                $sql_precios = $this->wpdb->prepare( "SELECT sku, precio FROM {$table_inv} WHERE sku IN ($placeholders)", ...$skus_a_buscar );
                $resultados_precios = $this->wpdb->get_results( $sql_precios );
                foreach ( $resultados_precios as $rp ) {
                    $precios_db[ strtoupper($rp->sku) ] = floatval( $rp->precio );
                }
            }

            // 2. Procesar inserciones en memoria
            foreach ( $items as $item ) {
                $sku = sanitize_text_field( $item['sku'] );
                $qty = intval( $item['qty'] );
                $safe_price = floatval( $item['price'] ); // Fallback

                if ( ! in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                    if ( isset( $precios_db[ strtoupper($sku) ] ) ) {
                        $safe_price = $precios_db[ strtoupper($sku) ];
                    } else {
                        throw new Exception( "El producto con SKU '{$sku}' no existe en el cat√°logo." );
                    }
                }

                $sub = $qty * $safe_price;
                $total_usd += $sub;

                $this->wpdb->insert( $table_items, [
                    'cotizacion_id'       => $quote_id,
                    'sku'                 => $sku,
                    'producto_nombre'     => sanitize_text_field( $item['name'] ),
                    'cantidad'            => $qty,
                    'precio_unitario_usd' => $safe_price,
                    'tiempo_entrega'      => isset( $item['time'] ) ? sanitize_text_field( $item['time'] ) : 'Inmediata',
                    'subtotal_usd'        => $sub
                ] );
            }

            // --- ACTUALIZAR TOTALES ---
            $this->update( $quote_id, [
                'total_usd' => $total_usd,
                'total_bs'  => $total_usd * floatval( $meta['tasa'] )
            ] );

            $this->wpdb->query( 'COMMIT' );
            return [ 'id' => $codigo, 'internal_id' => $quote_id ];

        } catch ( Exception $e ) {
            $this->wpdb->query( 'ROLLBACK' );
            return new WP_Error( 'db_error', $e->getMessage() );
        }
    }

    /**
     * Obtiene el historial de cotizaciones (Tabla)
     */
    public function get_vendor_history( $user_id, $limit = 50, $is_admin = false ) {
        $tabla_cli = $this->wpdb->prefix . 'suite_clientes';
        $sql = "SELECT c.*, cli.telefono as cliente_telefono, cli.nombre_razon as cliente_nombre_real 
                FROM {$this->table_name} c 
                LEFT JOIN {$tabla_cli} cli ON c.cliente_id = cli.id";
        
        if ( ! $is_admin ) $sql .= $this->wpdb->prepare( " WHERE c.vendedor_id = %d", $user_id );
        
        $sql .= $this->wpdb->prepare( " ORDER BY c.id DESC LIMIT %d", $limit );
        return $this->wpdb->get_results( $sql );
    }

    /**
     * Obtiene los pedidos agrupados por estado (Kanban)
     */
    public function get_kanban_orders( $vendedor_id = null, $is_admin = false ) {
        $tabla_cli = $this->wpdb->prefix . 'suite_clientes';
        
        $sql = "SELECT c.id, c.codigo_cotizacion, c.total_usd, c.fecha_emision, c.estado, c.vendedor_id, cli.nombre_razon AS cliente_nombre 
                FROM {$this->table_name} c 
                LEFT JOIN {$tabla_cli} cli ON c.cliente_id = cli.id";
        
        if ( ! $is_admin && $vendedor_id ) $sql .= $this->wpdb->prepare( " WHERE c.vendedor_id = %d", intval( $vendedor_id ) );
        $sql .= " ORDER BY c.fecha_emision DESC LIMIT 200";
        
        $resultados = $this->wpdb->get_results( $sql );
        
        $kanban_data = [ 'emitida' => [], 'proceso' => [], 'pagado' => [], 'despachado' => [] ];
        
        foreach ( $resultados as $row ) {
            $estado = empty( $row->estado ) ? 'emitida' : strtolower( $row->estado );
            if ( ! isset( $kanban_data[ $estado ] ) ) $kanban_data[ $estado ] = [];

            $row->total_fmt = number_format( floatval( $row->total_usd ), 2 );
            $row->fecha_fmt = date( 'd/m', strtotime( $row->fecha_emision ) );

            // PREVENCI√ìN XSS: Escapar variables sensibles antes de enviarlas al JSON de Vue/Vanilla JS
            $row->cliente_nombre    = esc_html( $row->cliente_nombre );
            $row->codigo_cotizacion = esc_html( $row->codigo_cotizacion );

            $kanban_data[ $estado ][] = $row;
        }

        return $kanban_data;
    }

    /**
     * M√ìDULO 2 Y 3: Inmutabilidad y Descuento de Inventario
     * Actualiza el estado del pedido y ejecuta reglas de negocio financieras y log√≠sticas.
     */
    public function update_order_status( $quote_id, $new_status ) {
        $new_status = strtolower( sanitize_text_field( $new_status ) );
        
        // 1. Obtener estado actual del pedido
        $current_order = $this->get( $quote_id );
        if ( ! $current_order ) {
            return new WP_Error( 'not_found', 'El pedido no existe.' );
        }

        $current_status = strtolower( $current_order->estado );
        $protected_statuses = [ 'pagado', 'despachado' ];

        // 2. CANDADO DE INMUTABILIDAD (M√≥dulo 2)
        $is_admin = current_user_can( 'manage_options' );
        if ( in_array( $current_status, $protected_statuses ) && ! $is_admin ) {
            return new WP_Error( 'immutable_lock', 'Candado de Inmutabilidad: Este pedido ya ha sido procesado (Pagado/Enviado) y no puede ser modificado por su nivel de acceso.' );
        }

        // 3. Actualizar el estado en Base de Datos de forma AT√ìMICA (Bloqueo Optimista)
        $sql_update = $this->wpdb->prepare(
            "UPDATE {$this->table_name} SET estado = %s WHERE id = %d AND estado = %s",
            $new_status, intval($quote_id), $current_status
        );
        $filas_afectadas = $this->wpdb->query( $sql_update );

        // Si filas_afectadas es 0, otro proceso ya cambi√≥ el estado en este milisegundo (Race Condition)
        if ( ! $filas_afectadas ) {
            return new WP_Error( 'race_condition', 'Conflicto de concurrencia: El pedido ya fue procesado por otro usuario.' );
        }

        // 4. DESCUENTO DE INVENTARIO (M√≥dulo 3)
        if ( in_array( $new_status, $protected_statuses ) && ! in_array( $current_status, $protected_statuses ) ) {
            $this->process_inventory_discount( $quote_id );
        }

        return true;
    }

    /**
     * M√ìDULO 3: Helper para el descuento de inventario.
     */
    private function process_inventory_discount( $quote_id ) {
        // 1. Obtener los √≠tems de este pedido
        $table_items = $this->wpdb->prefix . 'suite_cotizaciones_items';
        $items = $this->wpdb->get_results( $this->wpdb->prepare(
            "SELECT sku, cantidad FROM {$table_items} WHERE cotizacion_id = %d",
            $quote_id
        ), ARRAY_A );

        if ( empty( $items ) ) return;

        // 2. Instanciar el modelo de Inventario y descontar
        $inventory_model = new Suite_Model_Inventory();
        $inventory_model->discount_stock( $items );
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-quote.php ---

--- INICIO DEL ARCHIVO: views/app/tab-clientes.php ---
<?php
/**
 * Vista: Pesta√±a de Clientes (CRM) y Modales
 * 
 * Espera recibir las variables:
 * @var array $clientes Array de objetos con los datos de los clientes.
 * @var bool  $es_admin Booleano que indica si el usuario tiene privilegios de administrador.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<!-- ========================================================= -->
<!-- 1. PESTA√ëA PRINCIPAL (TABLA DE CLIENTES)                  -->
<!-- ========================================================= -->
<div id="TabCli" class="suite-tab-content active"> <!-- Le a√±adimos 'active' temporalmente para la prueba -->
    
    <!-- Barra de Herramientas Superior -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; position:relative;">
        
        <!-- Buscador DataTables -->
        <div style="width: 320px; position:relative;">
            <span class="dashicons dashicons-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></span>
            <input type="text" id="clients-table-search" placeholder="Buscar cliente por RIF o Nombre..." style="width:100%; padding: 10px 15px 10px 45px; border-radius: 8px; border: 1px solid #cbd5e1;">
        </div>
        
        <!-- Botones de Acci√≥n (Solo Admin) -->
        <?php if ( $es_admin ) : ?>
            <div>
                <!-- Nota: openModal asumimos que vive en main.js o lo dejamos como helper global en UI -->
                <button class="btn-modern-action" onclick="jQuery('#modal-add-client').fadeIn();">‚ûï Nuevo Cliente</button>
                <button class="btn-modern-action" onclick="jQuery('#modal-import-clients').fadeIn();">üì• Importar CSV</button>
            </div>
        <?php endif; ?>
    </div>

    <!-- Contenedor de la Tabla -->
    <div class="suite-table-responsive">
        <table id="clientsTable" class="suite-modern-table display nowrap">
            <thead>
                <tr>
                    <th>RIF</th>
                    <th>Nombre / Raz√≥n Social</th>
                    <th>Contacto</th>
                    <th>Ubicaci√≥n</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <?php if ( isset( $clientes ) && ! empty( $clientes ) ) : ?>
                    <?php foreach ( $clientes as $c ) : ?>
                        <tr>
                            <td class="font-mono"><?php echo esc_html( $c->rif_ci ); ?></td>
                            <td><strong><?php echo esc_html( $c->nombre_razon ); ?></strong></td>
                            <td>
                                <?php echo esc_html( $c->telefono ); ?><br>
                                <small style="color: #64748b;"><?php echo esc_html( $c->email ); ?></small>
                            </td>
                            <td><?php echo esc_html( $c->ciudad ); ?></td>
                            <td>
                                <!-- USO DE LA NUEVA ARQUITECTURA JS -->
                                <button class="btn-modern-action small" onclick="SuiteCRM.openProfile(<?php echo intval( $c->id ); ?>)">
                                    üìÇ Expediente
                                </button>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php else : ?>
                    <tr>
                        <td colspan="5" class="text-center">No hay clientes registrados en la base de datos.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- ========================================================= -->
<!-- 2. MODALES ESPEC√çFICOS DEL CRM                            -->
<!-- ========================================================= -->

<!-- Modal: Crear Nuevo Cliente -->
<div id="modal-add-client" class="suite-modal">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('.suite-modal').fadeOut();">√ó</span>
        <h3 style="margin-top:0; color:#0f172a;">‚ûï Nuevo Cliente</h3>
        
        <div class="form-group-row">
            <div style="flex:1">
                <label>RIF/CI *</label>
                <input type="text" id="new-cli-rif" class="widefat" placeholder="Ej: J123456789">
            </div>
            <div style="flex:2">
                <label>Nombre/Raz√≥n Social *</label>
                <input type="text" id="new-cli-nombre" class="widefat">
            </div>
        </div>
        
        <div class="form-group-row">
            <div style="flex:1"><label>Tel√©fono</label><input type="text" id="new-cli-tel" class="widefat"></div>
            <div style="flex:1"><label>Email</label><input type="email" id="new-cli-email" class="widefat"></div>
        </div>
        
        <label>Direcci√≥n</label>
        <input type="text" id="new-cli-dir" class="widefat">
        
        <div class="form-group-row">
            <div style="flex:1"><label>Ciudad</label><input type="text" id="new-cli-ciudad" class="widefat"></div>
            <div style="flex:1"><label>Estado</label><input type="text" id="new-cli-estado" class="widefat"></div>
        </div>
        
        <button class="btn-save-big" id="btn-create-client" style="margin-top:15px;">Guardar Cliente</button>
    </div>
</div>

<!-- Modal: Importar Clientes Masivamente -->
<div id="modal-import-clients" class="suite-modal">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('.suite-modal').fadeOut();">√ó</span>
        <h3 style="margin-top:0; color:#0f172a;">üì• Importar Clientes</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Orden exacto del CSV: <strong>Nombre, RIF, Tel√©fono, Email, Direcci√≥n</strong>
        </p>
        <input type="file" id="csv-clients-file" accept=".csv" class="widefat" style="padding:10px; background:#f8fafc;">
        <button class="btn-save-big" id="btn-run-import-cli" style="margin-top:10px;">Procesar Importaci√≥n</button>
    </div>
</div>

<!-- Modal: Expediente / Perfil de Cliente -->
<div id="modal-client-profile" class="suite-modal">
    <div class="suite-modal-content large">
        <div class="modal-header-fixed">
            <h3 style="margin:0; font-size:20px; color:#0f172a;">üìÇ Expediente Cliente</h3>
            <span class="close-modal" onclick="jQuery('.suite-modal').fadeOut();">√ó</span>
        </div>
        <div class="modal-body-scroll">
            
            <!-- Izquierda: Formulario de Datos -->
            <div class="profile-left">
                <input type="hidden" id="prof-id">
                <label>Raz√≥n Social</label>
                <input type="text" id="prof-nombre" class="widefat">
                
                <div class="form-group-row">
                    <div style="flex:1"><label>RIF/CI</label><input type="text" id="prof-rif" class="widefat"></div>
                    <div style="flex:1"><label>Tel√©fono</label><input type="text" id="prof-tel" class="widefat"></div>
                </div>
                
                <label>Email</label>
                <input type="text" id="prof-email" class="widefat">
                
                <label>Direcci√≥n</label>
                <input type="text" id="prof-dir" class="widefat">
                
                <div class="form-group-row">
                    <div style="flex:1"><label>Ciudad</label><input type="text" id="prof-ciudad" class="widefat"></div>
                    <div style="flex:1"><label>Estado</label><input type="text" id="prof-estado" class="widefat"></div>
                </div>
                
                <label>Contacto Persona</label>
                <input type="text" id="prof-contacto" class="widefat">
                
                <label>üìù Notas Internas</label>
                <textarea id="prof-notas" class="widefat" rows="3"></textarea>
                
                <button class="btn-save-big" id="btn-update-profile" style="margin-bottom:10px; background-color:#0f172a;">Guardar Cambios</button>
                <?php if ( $es_admin ) : ?>
                <button class="btn-modern-action" id="btn-delete-profile" style="width:100%; justify-content:center; color:#dc2626; border-color:#fca5a5; background:#fef2f2;">üóëÔ∏è Eliminar Cliente</button>
                <?php endif; ?>
            </div>
            
            <!-- Derecha: KPIs e Historial -->
            <div class="profile-right">
                <div class="kpi-row">
                    <div class="kpi-card"><small>Total Gastado</small><strong id="kpi-total">$0.00</strong></div>
                    <div class="kpi-card"><small>Cotizaciones</small><strong id="kpi-count">0</strong></div>
                    <div class="kpi-card"><small>√öltima Compra</small><strong id="kpi-last">-</strong></div>
                </div>
                
                <h4>üìú Historial de Cotizaciones</h4>
                <div class="history-container">
                    <div class="history-scroll suite-table-responsive" style="border:none;">
                        <table class="suite-modern-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>C√≥digo</th>
                                    <th>Total</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <!-- JS inyectar√° las filas aqu√≠ -->
                            <tbody id="prof-history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-clientes.php ---

--- INICIO DEL ARCHIVO: views/app/tab-comisiones.php ---
<?php
/**
 * Vista: Dashboard de Comisiones y Gamificaci√≥n (M√≥dulo 4)
 * 
 * Muestra las ganancias en tiempo real del vendedor y el ranking 
 * de los premios mensuales para fomentar la competencia.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<div id="TabComisiones" class="suite-tab-content" style="display: none;">
    
    <!-- 1. CABECERA: RENDIMIENTO PERSONAL -->
    <div style="background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 40px 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
        <h2 style="color: #0f172a; margin-top: 0; margin-bottom: 5px; font-size: 24px;">Mi Rendimiento</h2>
        <p style="color: #64748b; font-size: 14px; margin-top: 0;">Comisi√≥n acumulada del mes (<span id="dash-mes-actual">Cargando...</span>)</p>
        
        <div id="dash-comision-actual" style="font-size: 56px; font-weight: 900; color: #10b981; margin: 15px 0; letter-spacing: -2px;">
            $0.00
        </div>
        
        <div style="display: inline-block; background: #f8fafc; padding: 6px 12px; border-radius: 20px; font-size: 12px; color: #475569; border: 1px solid #e2e8f0;">
            ‚ÑπÔ∏è Tasa base: <strong>1.5%</strong> calculado sobre ventas facturadas y despachadas.
        </div>
    </div>

    <!-- 2. SECCI√ìN: GAMIFICACI√ìN Y PREMIOS -->
    <h3 style="border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; color: #111827; display: flex; align-items: center; gap: 10px;">
        üèÜ Premios del Mes
    </h3>
    
    <div class="kpi-row" style="display: flex; flex-wrap: wrap; gap: 20px;">
        
        <!-- Tarjeta 1: Pez Gordo -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #f59e0b; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">ü¶à Pez Gordo</h4>
                <span class="pill-warn" style="font-size: 12px; font-weight: bold;">Premio: $20</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Al vendedor con mayor volumen ($) facturado.</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                <small style="color: #94a3b8; text-transform: uppercase; font-weight: bold; font-size: 10px;">L√≠der Actual</small>
                <strong id="pez-gordo-name" style="font-size: 18px; display: block; color: #1e293b; margin-top: 4px;">Calculando...</strong>
                <span id="pez-gordo-amount" style="color: #059669; font-weight: 800; font-size: 15px;">$0.00</span>
            </div>
        </div>

        <!-- Tarjeta 2: Deja pa' los dem√°s -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #3b82f6; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">üèÉ Deja pa' los dem√°s</h4>
                <span class="pill-info" style="font-size: 12px; font-weight: bold; background: #dbeafe; color: #1d4ed8;">Premio: $20</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Al vendedor con mayor cantidad de ventas (N¬∞).</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                <small style="color: #94a3b8; text-transform: uppercase; font-weight: bold; font-size: 10px;">L√≠der Actual</small>
                <strong id="deja-pa-name" style="font-size: 18px; display: block; color: #1e293b; margin-top: 4px;">Calculando...</strong>
                <span id="deja-pa-count" style="color: #2563eb; font-weight: 800; font-size: 15px;">0 ventas</span>
            </div>
        </div>

        <!-- Tarjeta 3: Dale Play -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #8b5cf6; text-align: left; background: #faf5ff;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">‚ñ∂Ô∏è Dale Play</h4>
                <span style="font-size: 12px; font-weight: bold; background: #ede9fe; color: #6d28d9; padding: 4px 10px; border-radius: 99px;">Premio: $10</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Por proactividad y cumplimiento en proyectos.</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd6fe; text-align: center;">
                <span style="font-size: 32px; display: block; margin-bottom: 5px;">üéØ</span>
                <strong style="color: #5b21b6; font-size: 13px;">Asignaci√≥n Manual (Admin)</strong>
                <p style="font-size: 11px; color: #7c3aed; margin-top: 2px;">Evaluado a fin de mes seg√∫n Kanban de Proyectos.</p>
            </div>
        </div>

    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-comisiones.php ---

--- INICIO DEL ARCHIVO: views/app/tab-cotizador.php ---
<?php
/**
 * Vista: Pesta√±a del Cotizador (Punto de Venta)
 * 
 * Contiene la interfaz de b√∫squeda, carrito de compras y datos de facturaci√≥n.
 * El estado (State) es manejado 100% por assets/js/core/state.js
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// Opcional: Obtener la tasa BCV guardada en la base de datos (Options)
$tasa_bcv_actual = get_option( 'suite_tasa_bcv', 1.00 );
?>

<div id="TabPos" class="suite-tab-content" style="display: none;">
    
    <!-- Input oculto para inicializar la tasa en el JS (State) -->
    <input type="hidden" id="hidden-tasa-bcv" value="<?php echo esc_attr( $tasa_bcv_actual ); ?>">

    <div style="display: flex; flex-wrap: wrap; gap: 30px;">
        
        <!-- ========================================================= -->
        <!-- COLUMNA IZQUIERDA: B√öSQUEDA Y CARRITO                     -->
        <!-- ========================================================= -->
        <div style="flex: 1; min-width: 60%;">
            
            <!-- Barra de B√∫squeda de Productos -->
            <div class="pos-search-box spotlight-wrapper" style="margin-bottom: 20px; position: relative;">
                <span class="dashicons dashicons-search search-icon"></span>
                <input type="text" id="pos-product-search" placeholder="Buscar producto por SKU o Nombre..." autocomplete="off">
                <!-- Dropdown de resultados predictivos -->
                <div id="pos-search-results" class="pos-dropdown" style="display: none; position: absolute; width: 100%;"></div>
            </div>

            <!-- Botonera y Agregar Manual -->
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="manual-item-desc" placeholder="Descripci√≥n producto manual" style="flex: 2; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                <input type="number" id="manual-item-price" placeholder="Precio ($)" step="0.01" style="width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                <input type="number" id="manual-item-qty" placeholder="Cant." value="1" min="1" style="width: 70px; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
                <button id="btn-add-manual-item" class="btn-modern-action" style="white-space: nowrap;">‚ûï Manual</button>
            </div>

            <!-- Tabla del Carrito -->
            <div class="suite-table-responsive">
                <table class="suite-modern-table" style="min-width: 100%;">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-center">Precio Unitario</th>
                            <th class="text-right">Total</th>
                            <th class="text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="pos-cart-body">
                        <!-- JS inyectar√° las filas del carrito aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- COLUMNA DERECHA: DATOS DEL CLIENTE Y TOTALES              -->
        <!-- ========================================================= -->
        <div class="pos-right" style="width: 350px; flex-shrink: 0;">
            
            <div id="cli-form-wrapper" style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                
                <h3 style="margin-top: 0 !important;">Datos del Cliente</h3>
                
                <div class="spotlight-wrapper" style="position: relative;">
                    <span class="dashicons dashicons-search search-icon"></span>
                    <input type="text" id="cli-rif" class="widefat" placeholder="RIF (Ej: J123456789)" style="padding-left: 45px !important;" autocomplete="off">
                </div>
                
                <input type="text" id="cli-nombre" class="widefat" placeholder="Nombre o Raz√≥n Social *">
                <input type="text" id="cli-tel" class="widefat" placeholder="Tel√©fono de Contacto">
                <input type="email" id="cli-email" class="widefat" placeholder="Correo Electr√≥nico">
                
                <div class="form-group-row">
                    <div style="flex:1"><input type="text" id="cli-ciudad" class="widefat" placeholder="Ciudad"></div>
                    <div style="flex:1"><input type="text" id="cli-estado" class="widefat" placeholder="Estado"></div>
                </div>

                <textarea id="cli-dir" class="widefat" placeholder="Direcci√≥n Fiscal o de Entrega" rows="2"></textarea>
                
                <!-- Campos ocultos/opcionales para estructura completa -->
                <input type="hidden" id="cli-contacto">
                <input type="hidden" id="cli-notas">

                <h3 style="margin-top: 20px !important;">Configuraci√≥n</h3>
                
                <div class="form-group-row">
                    <div style="flex:1">
                        <label>Moneda Impresi√≥n</label>
                        <select id="pos-moneda" class="widefat">
                            <option value="USD">USD ($)</option>
                            <option value="BS">Bol√≠vares (Bs)</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Validez (D√≠as)</label>
                        <input type="number" id="pos-validez" class="widefat" value="15" min="1">
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #cbd5e1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #64748b; font-weight: 600;">Subtotal / Total:</span>
                        <strong id="pos-total-usd" style="font-size: 20px; color: #0f172a;">$0.00</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: #94a3b8;">Ref. BCV</span>
                        <strong id="pos-total-bs" style="font-size: 14px; color: #475569;">Bs 0.00</strong>
                    </div>
                </div>

                <button id="btn-save-quote" class="btn-save-big" style="margin-top: 20px;">
                    üíæ Guardar Cotizaci√≥n
                </button>
            </div>

        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-cotizador.php ---

--- INICIO DEL ARCHIVO: views/app/tab-historial.php ---
<?php
/**
 * Archivo: views/app/tab-historial.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/app/tab-historial.php ---

--- INICIO DEL ARCHIVO: views/app/tab-kanban.php ---
<?php
/**
 * Vista: Tablero Kanban de Pedidos (M√≥dulo 1)
 * 
 * Contiene la interfaz interactiva Drag & Drop para la gesti√≥n visual de cotizaciones y pedidos.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<style>
    /* Estilos espec√≠ficos del Kanban */
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        align-items: start;
        margin-top: 15px;
    }
    .kanban-column-wrapper {
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        max-height: 80vh;
    }
    .kanban-column-header {
        padding: 15px;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 700;
        color: #0f172a;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* Acentos de color por columna */
    .col-emitida .kanban-column-header { border-bottom-color: #f59e0b; }
    .col-proceso .kanban-column-header { border-bottom-color: #3b82f6; }
    .col-pagado .kanban-column-header { border-bottom-color: #10b981; }
    .col-despachado .kanban-column-header { border-bottom-color: #8b5cf6; }

    .kanban-column-body {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 150px;
    }
    .kanban-card {
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        cursor: grab;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .kanban-card:active {
        cursor: grabbing;
    }
    .kanban-ghost {
        opacity: 0.4;
        background: #e2e8f0;
    }
    .kanban-card-title {
        font-size: 15px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
    }
    .kanban-card-client {
        font-size: 13px;
        color: #475569;
        margin-bottom: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px dashed #e2e8f0;
        padding-top: 10px;
        margin-top: 10px;
    }
    .kanban-wa-btn {
        background: #25d366;
        color: #fff !important;
        font-size: 11px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: background 0.2s;
    }
    .kanban-wa-btn:hover { background: #1ebc59; }
</style>

<div id="TabKanban" class="suite-tab-content" style="display: none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
        <h2>üì¶ Portal de Pedidos</h2>
        <button class="btn-modern-action" onclick="SuiteKanban.loadBoard()">üîÑ Refrescar Tablero</button>
    </div>

    <div class="kanban-board">
        
        <!-- Columna 1: Pendientes -->
        <div class="kanban-column-wrapper col-emitida">
            <div class="kanban-column-header">
                <span>üü° Pendiente</span>
                <span class="count-badge pill-neutral" id="count-emitida">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-emitida" data-status="emitida">
                <!-- JS insertar√° tarjetas aqu√≠ -->
            </div>
        </div>

        <!-- Columna 2: En Proceso -->
        <div class="kanban-column-wrapper col-proceso">
            <div class="kanban-column-header">
                <span>üîµ En Proceso</span>
                <span class="count-badge pill-neutral" id="count-proceso">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-proceso" data-status="proceso"></div>
        </div>

        <!-- Columna 3: Facturado / Pagado -->
        <div class="kanban-column-wrapper col-pagado">
            <div class="kanban-column-header">
                <span>üü¢ Facturado</span>
                <span class="count-badge pill-neutral" id="count-pagado">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-pagado" data-status="pagado"></div>
        </div>

        <!-- Columna 4: Despachado -->
        <div class="kanban-column-wrapper col-despachado">
            <div class="kanban-column-header">
                <span>üü£ Enviado</span>
                <span class="count-badge pill-neutral" id="count-despachado">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-despachado" data-status="despachado"></div>
        </div>

    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: CIERRE DE VENTA (M√ìDULO 4 - COMISIONES Y LOG√çSTICA)-->
<!-- ========================================================= -->
<div id="modal-cierre-venta" class="suite-modal">
    <div class="suite-modal-content">
        <!-- El ID del bot√≥n de cierre es clave para el JS -->
        <span class="close-modal" id="close-modal-cierre">√ó</span>
        
        <h3 style="margin-top:0; color:#0f172a;">üí∞ Procesar Pago y Comisi√≥n</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Complete los datos operativos para registrar su comisi√≥n y autorizar el despacho.
        </p>

        <!-- Guardamos el ID del pedido arrastrado -->
        <input type="hidden" id="cierre-quote-id">

        <div class="form-group-row">
            <div style="flex:1">
                <label>Canal de Venta *</label>
                <select id="cierre-canal" class="widefat">
                    <option value="">Seleccione...</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Tienda Fisica">Tienda F√≠sica</option>
                    <option value="Llamada">Llamada Telef√≥nica</option>
                    <option value="Referido">Referido Comercial</option>
                </select>
            </div>
            <div style="flex:1">
                <label>M√©todo de Pago *</label>
                <select id="cierre-pago" class="widefat">
                    <option value="">Seleccione...</option>
                    <option value="Zelle">Zelle</option>
                    <option value="Efectivo USD">Efectivo USD</option>
                    <option value="Punto de Venta">Punto de Venta (Bs)</option>
                    <option value="Pago Movil">Pago M√≥vil</option>
                    <option value="Cashea">Cashea</option>
                    <option value="Transferencia">Transferencia USD/Bs</option>
                </select>
            </div>
        </div>

        <label>M√©todo de Entrega *</label>
        <select id="cierre-entrega" class="widefat">
            <option value="">Seleccione...</option>
            <option value="Retiro en Tienda">Retiro en Tienda</option>
            <option value="Delivery">Delivery (Caracas)</option>
            <option value="Encomienda MRW">Encomienda Nacional (MRW)</option>
            <option value="Encomienda Tealca">Encomienda Nacional (Tealca)</option>
            <option value="Encomienda Zoom">Encomienda Nacional (Zoom)</option>
        </select>

        <label>N¬∞ de Recibo Loyverse *</label>
        <input type="text" id="cierre-loyverse" class="widefat" placeholder="Ej: 1-1005 (Obligatorio)">

        <label>Link de Captura de Pago / Soporte</label>
        <input type="url" id="cierre-captura" class="widefat" placeholder="https://drive.google.com/... o Imgur">

        <button class="btn-save-big" id="btn-confirmar-pago" style="margin-top:15px; background-color: #10b981;">
            Confirmar y Procesar Pago
        </button>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-kanban.php ---

--- INICIO DEL ARCHIVO: views/app/tab-logistica.php ---
<?php
/**
 * Vista: Panel de Log√≠stica y Despacho (M√≥dulo 3)
 * 
 * Muestra √∫nicamente los pedidos con estado 'pagado' listos para ser embalados y despachados.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<div id="TabLogistica" class="suite-tab-content" style="display: none;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2 style="margin:0; color:#0f172a;">üöö Panel de Log√≠stica y Despacho</h2>
        <p style="color:#64748b; margin:0;">Pedidos facturados esperando recolecci√≥n o env√≠o.</p>
    </div>

    <!-- Tabla de Pedidos Pendientes de Despacho -->
    <div class="suite-table-responsive">
        <table class="suite-modern-table" id="logisticsTable">
            <thead>
                <tr>
                    <th>Orden</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>M√©todo Entrega</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <?php if ( ! empty( $pedidos_logistica ) ) : ?>
                    <?php foreach ( $pedidos_logistica as $p ) : ?>
                    <tr id="log-row-<?php echo intval( $p->id ); ?>">
                        <td><strong style="font-family: monospace; font-size: 14px;">#<?php echo esc_html( $p->codigo_cotizacion ); ?></strong></td>
                        <td><?php echo date( 'd/m/Y', strtotime( $p->fecha_emision ) ); ?></td>
                        <td><?php echo esc_html( $p->cliente_nombre ); ?></td>
                        <td>
                            <span class="pill-neutral" style="background: #e0f2fe; color: #0369a1;">
                                <?php echo esc_html( ! empty( $p->metodo_entrega ) ? $p->metodo_entrega : 'Por definir' ); ?>
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <!-- Bot√≥n Hoja de Picking (Impresi√≥n protegida) -->
                                <a href="<?php echo esc_url( admin_url( 'admin-ajax.php?action=suite_print_picking&id=' . $p->id . '&nonce=' . wp_create_nonce('suite_quote_nonce') ) ); ?>" 
                                   target="_blank" class="btn-modern-action small" style="color: #475569;">
                                   üñ®Ô∏è Hoja de Picking
                                </a>
                                
                                <!-- Bot√≥n Confirmar Despacho (Abre Modal) -->
                                <button class="btn-modern-action small" style="background: #ecfdf5; border-color: #a7f3d0; color: #059669;" 
                                        onclick="SuiteLogistics.openModal(<?php echo intval( $p->id ); ?>)">
                                    üì¶ Confirmar Despacho
                                </button>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px 0; color: #94a3b8;">
                            üéâ No hay pedidos pendientes por despachar en este momento.
                        </td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: CONFIRMACI√ìN DE DESPACHO / SUBIDA DE POD           -->
<!-- ========================================================= -->
<div id="modal-confirmar-despacho" class="suite-modal">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('#modal-confirmar-despacho').fadeOut();">√ó</span>
        
        <h3 style="margin-top:0; color:#0f172a;">üì¶ Confirmar Despacho</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Sube la foto de la gu√≠a de encomienda o el comprobante de entrega firmado (Proof of Delivery).
        </p>

        <input type="file" id="log-pod-file" class="widefat" accept="image/*,.pdf" style="padding: 15px; background: #f8fafc;">
        
        <button id="btn-procesar-despacho" class="btn-save-big" style="margin-top:15px; background-color: #3b82f6;">
            Subir y Marcar Despachado
        </button>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-logistica.php ---

--- INICIO DEL ARCHIVO: views/app/tab-marketing.php ---
<?php
/**
 * Vista: Cerebro de Demanda y Marketing (M√≥dulo 5)
 * 
 * Muestra visualizaciones de BI (Business Intelligence) utilizando Chart.js 
 * y aliment√°ndose del Data Lake (REST API).
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<div id="TabMarketing" class="suite-tab-content" style="display: none;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
        <div>
            <h2 style="margin:0; color:#0f172a; font-size: 24px; font-weight: 800;">üìà Cerebro de Demanda (BI & Marketing)</h2>
            <p style="color:#64748b; margin-top:5px; font-size: 14px;">An√°lisis de ventas efectivas e impacto publicitario (√öltimos 30 d√≠as).</p>
        </div>
        <button class="btn-modern-action" onclick="SuiteMarketing.loadDashboard()">üîÑ Refrescar Datos</button>
    </div>

    <!-- Grid de Gr√°ficos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        
        <!-- Tarjeta 1: Gr√°fico Doughnut (Canales de Venta) -->
        <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <h3 style="margin-top: 0; color: #1e293b; font-size: 15px; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                Distribuci√≥n por Canal de Venta (Volumen USD)
            </h3>
            <div style="position: relative; height: 320px; width: 100%; margin-top: 15px;">
                <canvas id="chart-canales-venta"></canvas>
            </div>
        </div>

        <!-- Tarjeta 2: Gr√°fico Lineal (Tendencia de Operaciones) -->
        <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <h3 style="margin-top: 0; color: #1e293b; font-size: 15px; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                Tendencia de Cierres de Venta en el Tiempo
            </h3>
            <div style="position: relative; height: 320px; width: 100%; margin-top: 15px;">
                <canvas id="chart-tendencia-ventas"></canvas>
            </div>
        </div>

    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-marketing.php ---

--- INICIO DEL ARCHIVO: views/components/modal-cliente.php ---
<?php
/**
 * Archivo: views/components/modal-cliente.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/components/modal-cliente.php ---

--- INICIO DEL ARCHIVO: views/components/table-skeleton.php ---
<?php
/**
 * Archivo: views/components/table-skeleton.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/components/table-skeleton.php ---

--- INICIO DEL ARCHIVO: views/pdf/layout-cotizacion.php ---
<?php
/**
 * Archivo: views/pdf/layout-cotizacion.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/pdf/layout-cotizacion.php ---

