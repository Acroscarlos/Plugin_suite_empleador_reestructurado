=================================================================
CONTEXTO COMPLETO DEL PLUGIN: https://mitiendaunit.com/erp_vendedores/
Arquitectura basada en WordPress (MVC y POO)
=================================================================

--- INICIO DEL ARCHIVO: index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: index.php ---

--- INICIO DEL ARCHIVO: suite-empleados.php ---
<?php
/**
 * Plugin Name: Suite de Empleados (ERP Intranet)
 * Plugin URI: https://mitiendaunit.com/intranet_1
 * Description: Sistema modular V8.0 para gesti√≥n de Inventario, CRM, Log√≠stica, Gamificaci√≥n y Cerebro de Demanda (IA). Arquitectura MVC.
 * Version: 8.0.0
 * Author: DevOps Team & RV Automation Technology
 * Text Domain: suite-empleados
 * License: GPLv2 or later
 */

// 1. SEGURIDAD: Evitar acceso directo
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// 2. CONSTANTES DEL SISTEMA
define( 'SUITE_VERSION', '8.0.0' );
define( 'SUITE_PATH', plugin_dir_path( __FILE__ ) );
define( 'SUITE_URL', plugin_dir_url( __FILE__ ) );

/**
 * 3. INICIALIZADOR DEL SISTEMA (Orquestador MVC)
 * Se engancha a 'plugins_loaded' para asegurar que el core de WP est√© listo.
 */
function suite_empleados_init() {
    
    // --- A. CARGA DE DEPENDENCIAS (REQUIRE_ONCE) ---
    // [Error 1.1 Corregido]: Rutas apuntando a los nombres reales de los archivos.

    // Core
    require_once SUITE_PATH . 'includes/Core/class-activator.php';
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';

    // Modelos (Capa de Base de Datos y L√≥gica de Negocio)
    require_once SUITE_PATH . 'includes/Models/class-suite-model-base.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-client.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-quote.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-inventory.php';
    require_once SUITE_PATH . 'includes/Models/class-suite-model-commission.php';
	require_once SUITE_PATH . 'includes/Models/class-suite-model-roles.php';    
    require_once SUITE_PATH . 'includes/Models/class-suite-model-employee.php'; 
	require_once SUITE_PATH . 'includes/Models/class-suite-model-product.php';


    // Controladores Base
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-controller.php';

    // Controladores AJAX (M√≥dulos de la UI)
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-client.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-quotes.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-kanban.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-commissions.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-logistics.php';
	require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-employees.php';
    require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-roles.php';
	require_once SUITE_PATH . 'includes/Controllers/Ajax/class-suite-ajax-products.php';
    // Controladores API REST (Data Lake y Machine Learning)
    require_once SUITE_PATH . 'includes/Controllers/Api/class-suite-api-stats.php';
	// Controladores de la API REST
	require_once SUITE_PATH . 'includes/Controllers/Api/class-suite-api-sync.php';

    // Controlador del Administrador / Frontend (Shortcodes y Vistas)
    require_once SUITE_PATH . 'includes/Controllers/Admin/class-suite-shortcode-controller.php';


    // --- B. INSTANCIACI√ìN DE CONTROLADORES (Encendiendo los motores) ---

    // M√≥dulo de Clientes (CRM) - [Las 5 nuevas clases divididas]
    new Suite_Ajax_Client_Search();
    new Suite_Ajax_Client_Add();
    new Suite_Ajax_Client_Import();
    new Suite_Ajax_Client_Delete();
    new Suite_Ajax_Client_Profile();
	new Suite_Ajax_Log_Export();

    // M√≥dulo de Cotizaciones
    new Suite_Ajax_Quote_Save();
    new Suite_Ajax_Quote_History();
    new Suite_Ajax_Quote_Status();
	new Suite_Ajax_Print_Quote();
	new Suite_Ajax_Get_Products();
	new Suite_Ajax_Quote_Details();
	
	
    // M√≥dulo 1: Tablero Kanban (Pedidos)
    new Suite_Ajax_Kanban_Data();
    new Suite_Ajax_Kanban_Status();

    // M√≥dulo 3: Log√≠stica y Despacho
    new Suite_Ajax_Upload_POD();
    new Suite_Ajax_Print_Picking();

    // M√≥dulo 4: Dashboard de Comisiones y Gamificaci√≥n
    new Suite_Ajax_Dashboard_Stats();
	new Suite_Ajax_Freeze_Commissions();

    // M√≥dulo 5: Cerebro de Demanda (REST API)
    new Suite_API_Stats();
	new Suite_API_Sync();
	
	// M√≥dulo 6:--- NUEVO M√ìDULO: GESTI√ìN DE EQUIPO Y ROLES (RBAC) ---
    new Suite_Ajax_Employee_List();
    new Suite_Ajax_Employee_Save();
    new Suite_Ajax_Employee_Delete();
    new Suite_Ajax_Role_List();
    new Suite_Ajax_Role_Save();
    new Suite_Ajax_Role_Delete();

    // Gestor de la Vista Principal (Shortcode y encolado de assets)
    new Suite_Shortcode_Controller();
}
add_action( 'plugins_loaded', 'suite_empleados_init' );


/**
 * 4. ACTIVACI√ìN DEL PLUGIN
 * Crea las tablas, define roles usando dbDelta y programa Cron Jobs.
 */
function suite_plugin_activate() {
    // 1. Instalaci√≥n de BD y Roles
    require_once SUITE_PATH . 'includes/Core/class-activator.php';
    if ( class_exists( 'Suite_Activator' ) && method_exists( 'Suite_Activator', 'activate' ) ) {
        Suite_Activator::activate();
    } elseif ( function_exists( 'suite_install_db' ) ) {
        suite_install_db(); 
    }

    // 2. Programaci√≥n de Tareas Autom√°ticas (Data Lake)
    // [Error 3.1 Corregido]: El Cron ahora se registra ESTRICTAMENTE UNA VEZ en la activaci√≥n.
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';
    if ( class_exists( 'Suite_Cron_Jobs' ) ) {
        $cron_jobs = new Suite_Cron_Jobs();
        $cron_jobs->schedule_events();
    }
}
register_activation_hook( __FILE__, 'suite_plugin_activate' );


/**
 * 5. DESACTIVACI√ìN DEL PLUGIN
 * Limpia los Cron Jobs activos para no dejar basura en la memoria de WordPress.
 */
function suite_plugin_deactivate() {
    require_once SUITE_PATH . 'includes/Core/class-suite-cron-jobs.php';
    if ( class_exists( 'Suite_Cron_Jobs' ) ) {
        $cron_jobs = new Suite_Cron_Jobs();
        $cron_jobs->clear_events();
    }
}
register_deactivation_hook( __FILE__, 'suite_plugin_deactivate' );
--- FIN DEL ARCHIVO: suite-empleados.php ---

--- INICIO DEL ARCHIVO: assets/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: assets/index.php ---

--- INICIO DEL ARCHIVO: assets/css/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: assets/css/index.php ---

--- INICIO DEL ARCHIVO: assets/css/suite-styles.css ---
/* ==========================================
   MODALES, PESTA√ëAS Y FORMULARIOS
   ========================================== */
.suite-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
}

.suite-modal-content {
    background-color: #ffffff;
    padding: 25px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-height: 90vh;
    overflow-y: auto;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    font-weight: bold;
    color: #64748b;
    cursor: pointer;
    transition: color 0.2s;
}

.close-modal:hover {
    color: #0f172a;
}

.suite-tabs-modern {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 20px;
    background: #f8fafc;
    padding: 10px 10px 0 10px;
    border-radius: 8px 8px 0 0;
}

.tab-btn {
    padding: 12px 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    color: #64748b;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s;
}

.tab-btn:hover {
    background: #f1f5f9;
    color: #334155;
}

.tab-btn.active {
    background: #ffffff;
    color: #0073aa;
    border: 1px solid #e2e8f0;
    border-bottom: 2px solid #ffffff;
    margin-bottom: -2px;
}

.form-group-row {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 15px;
}
.form-group-row > div {
    flex: 1;
}
--- FIN DEL ARCHIVO: assets/css/suite-styles.css ---

--- INICIO DEL ARCHIVO: assets/js/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: assets/js/index.php ---

--- INICIO DEL ARCHIVO: assets/js/main.js ---
/* JS Module: assets/js/main.js */
--- FIN DEL ARCHIVO: assets/js/main.js ---

--- INICIO DEL ARCHIVO: assets/js/core/api.js ---
/**
 * SuiteAPI - Orquestador de Peticiones AJAX
 * * Centraliza las llamadas al servidor, inyectando autom√°ticamente 
 * credenciales de seguridad (Nonces) y enrutamiento (URL).
 */
const SuiteAPI = (function($) {
    'use strict';

    // Variables privadas extra√≠das de la localizaci√≥n de WP
    const apiUrl = suite_vars.ajax_url;
    const sysNonce = suite_vars.nonce;

    /**
     * Interceptor Global de Errores
     * Captura expiraci√≥n de sesi√≥n (401) o fallos de permisos (403)
     */
    const handleAjaxError = function(error, reject) {
        if (error.status === 401 || error.status === 403) {
            alert('üîí Su sesi√≥n ha expirado o fue cerrada por seguridad. Por favor, recargue la p√°gina e inicie sesi√≥n nuevamente.');
        }
        reject(error);
    };

    /**
     * Petici√≥n POST est√°ndar para JSON
     * * @param {string} action - El nombre del hook de WP (ej. 'suite_search_client_ajax')
     * @param {object} data - Datos a enviar
     * @returns {Promise}
     */
    const post = function(action, data = {}) {
        return new Promise((resolve, reject) => {
            // Inyecci√≥n autom√°tica de par√°metros obligatorios
            const payload = {
                ...data,
                action: action,
                nonce: sysNonce
            };

            $.post(apiUrl, payload)
                .done(response => resolve(response))
                .fail(error => handleAjaxError(error, reject)); // <-- Interceptor inyectado
        });
    };

    /**
     * Petici√≥n POST para subir archivos (FormData)
     * Utilizado para la importaci√≥n de CSV o futuras subidas de fotos (POD)
     * * @param {string} action - El nombre del hook de WP
     * @param {FormData} formData - Objeto FormData instanciado
     * @returns {Promise}
     */
    const postForm = function(action, formData) {
        return new Promise((resolve, reject) => {
            // Inyecci√≥n en FormData
            formData.append('action', action);
            formData.append('nonce', sysNonce);

            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: formData,
                processData: false, // Vital para que jQuery no procese el archivo
                contentType: false, // Vital para que el navegador asigne el boundary multipart
                success: response => resolve(response),
                error: error => handleAjaxError(error, reject) // <-- Interceptor inyectado
            });
        });
    };

    // API P√∫blica Revelada
    return {
        post: post,
        postForm: postForm
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/core/api.js ---

--- INICIO DEL ARCHIVO: assets/js/core/state.js ---
/**
 * SuiteState - Manejador de Estado Inmutable (Store)
 * 
 * Centraliza los datos financieros y el carrito de compras.
 * Previene la manipulaci√≥n directa desde el objeto global window.
 */
const SuiteState = (function() {
    'use strict';

    // ==========================================
    // VARIABLES PRIVADAS (El "Estado")
    // ==========================================
    let cart = [];
    let totalUSD = 0.00;
    let totalBS = 0.00;
    let tasaBCV = 1.00; // Se actualizar√° al inicializar la app

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================
    
    /**
     * Recalcula los totales matem√°ticos cada vez que el carrito cambia.
     * Mantiene la l√≥gica financiera blindada.
     */
    const calculateTotals = function() {
        totalUSD = cart.reduce((sum, item) => {
            let qty = parseInt(item.qty) || 0;
            let price = parseFloat(item.price) || 0;
            return sum + (qty * price);
        }, 0);

        totalBS = totalUSD * tasaBCV;
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Retorna una COPIA INMUTABLE del carrito.
         * Si alguien muta este array externamente, no afectar√° al original.
         * @returns {Array}
         */
        getCart: function() {
            return [...cart]; 
        },

        /**
         * A√±ade un producto al carrito y recalcula.
         * Si el SKU ya existe, suma la cantidad en lugar de duplicar la fila.
         * @param {Object} item 
         */
        addItem: function(item) {
            // Normalizar datos: Prohibir cantidades negativas o cero
            item.qty = Math.max(1, parseInt(item.qty) || 1);
            item.price = Math.max(0, parseFloat(item.price) || 0.00);

            const existingIndex = cart.findIndex(i => i.sku === item.sku);
            if (existingIndex > -1) {
                cart[existingIndex].qty += item.qty;
            } else {
                cart.push(item);
            }
            calculateTotals();
        },

        /**
         * Actualiza un campo espec√≠fico de una fila (ej. cantidad o precio editado).
         * @param {number} index - √çndice en el array
         * @param {string} field - 'qty' o 'price'
         * @param {number|string} value - Nuevo valor
         */
        updateItem: function(index, field, value) {
            if (cart[index]) {
                if (field === 'qty') {
                    cart[index][field] = Math.max(1, parseInt(value) || 1);
                } else {
                    cart[index][field] = Math.max(0, parseFloat(value) || 0);
                }
                calculateTotals();
            }
        },

        /**
         * Elimina un producto del carrito.
         * @param {number} index 
         */
        removeItem: function(index) {
            if (cart[index]) {
                cart.splice(index, 1);
                calculateTotals();
            }
        },

        /**
         * Vac√≠a el carrito por completo (√∫til al guardar con √©xito).
         */
        clearCart: function() {
            cart = [];
            calculateTotals();
        },

        /**
         * Actualiza la tasa BCV del d√≠a.
         * @param {number} tasa 
         */
        setTasa: function(tasa) {
            tasaBCV = parseFloat(tasa) || 1;
            calculateTotals();
        },

        /**
         * Devuelve un snapshot de los totales financieros formateados.
         * @returns {Object}
         */
        getTotals: function() {
            return {
                usd: totalUSD.toFixed(2),
                bs: totalBS.toFixed(2),
                tasa: tasaBCV.toFixed(2)
            };
        }
    };
})();
--- FIN DEL ARCHIVO: assets/js/core/state.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/commissions.js ---
/**
 * SuiteCommissions - M√≥dulo del Dashboard Financiero y Gamificaci√≥n
 * 
 * Se encarga de solicitar las estad√≠sticas mensuales del vendedor y 
 * actualizar los l√≠deres de los premios en la vista.
 */
const SuiteCommissions = (function($) {
    'use strict';

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================

    const renderDashboard = function(data) {
        // 1. Rendimiento Personal
        $('#dash-mes-actual').text(data.mes_evaluado);
        $('#dash-comision-actual').text('$' + data.comision_actual);

        // 2. L√≠der "Pez Gordo" (Dinero)
        const pezGordo = data.gamificacion.pez_gordo;
        if (pezGordo) {
            $('#pez-gordo-name').text('üëë ' + pezGordo.display_name);
            $('#pez-gordo-amount').text('$' + pezGordo.total_vendido);
        } else {
            $('#pez-gordo-name').text('A√∫n sin ventas');
            $('#pez-gordo-amount').text('$0.00');
        }

        // 3. L√≠der "Deja pa' los dem√°s" (Cantidad)
        const dejaPa = data.gamificacion.deja_pa_los_demas;
        if (dejaPa) {
            $('#deja-pa-name').text('üöÄ ' + dejaPa.display_name);
            $('#deja-pa-count').text(dejaPa.cantidad_ventas + ' ventas cerradas');
        } else {
            $('#deja-pa-name').text('A√∫n sin ventas');
            $('#deja-pa-count').text('0 ventas');
        }
    };

	
	// ==========================================
    // EVENT LISTENERS
    // ==========================================
    const bindEvents = function() {
        
        // Acci√≥n de Cierre de Mes (Exclusiva de Gerencia)
        $('#btn-cierre-mes').on('click', function(e) {
            e.preventDefault();
            
            // 1. Confirmaci√≥n de Doble V√≠a (Seguridad Anti-Errores)
            const seguro = confirm('‚ö†Ô∏è ATENCI√ìN: Esta acci√≥n es IRREVERSIBLE.\n\nTodos los registros "pendientes" en el Ledger de Comisiones pasar√°n a "pagado" y se congelar√°n.\n\n¬øEst√° absolutamente seguro de proceder con el Cierre Contable de Mes?');
            
            if (!seguro) return;

            const btn = $(this);
            btn.prop('disabled', true).text('‚è≥ Procesando Cierre...');

            // Formatear fecha actual de corte segura para MySQL (YYYY-MM-DD HH:mm:ss)
            const fechaCorte = new Date().toISOString().slice(0, 19).replace('T', ' ');

            // 2. Disparar el Endpoint AJAX
            SuiteAPI.post('suite_freeze_commissions', {
                fecha_corte: fechaCorte
            }).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || res.data));
                    location.reload(); // Recarga agresiva para repintar la Billetera a 0
                } else {
                    alert('‚ùå Error de validaci√≥n: ' + (res.data.message || res.data));
                    btn.prop('disabled', false).text('üîí Ejecutar Cierre de Mes');
                }
            }).catch(err => {
                alert('‚ùå Ocurri√≥ un error cr√≠tico de red al intentar congelar el Ledger.');
                btn.prop('disabled', false).text('üîí Ejecutar Cierre de Mes');
            });
        });
        
    };
	
	
    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Llama a la API para obtener la data fresca y pinta la interfaz
         */
        loadDashboard: function() {
            // Mostrar estado de carga visual sutil
            $('#dash-comision-actual').css('opacity', '0.5');

            SuiteAPI.post('suite_get_dashboard_stats').then(res => {
                if (res.success) {
                    renderDashboard(res.data);
                } else {
                    console.error("Error cargando comisiones:", res.data);
                }
            }).catch(err => {
                console.error("Error de red al cargar dashboard de comisiones.");
            }).finally(() => {
                $('#dash-comision-actual').css('opacity', '1');
            });
        },

        init: function() {
			bindEvents();
            
			// Se puede cargar autom√°ticamente, o esperar a que el usuario haga clic en la pesta√±a
            // Lo dejamos listo para ser invocado por el controlador de pesta√±as.
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/commissions.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/crm.js ---
/**
 * SuiteCRM - M√≥dulo de Gesti√≥n de Clientes
 * 
 * Controla la vista del directorio de clientes, inicializaci√≥n de DataTables,
 * perfiles modales y creaci√≥n manual.
 */
const SuiteCRM = (function($) {
    'use strict';

    // Variables Privadas
    let cliTable = null;
    const dtLanguage = { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json", "lengthMenu": "_MENU_" };

    /**
     * Limpia el RIF en tiempo real (Regla de negocio: Anti-duplicados) [1, 2]
     */
    const cleanRifInput = function(input) {
        let raw = $(input).val().toUpperCase();
        let clean = raw.replace(/[^A-Z0-9]/g, '');

        if (raw !== clean) { $(input).val(clean); }

        if (clean.length > 0) {
            if (!/^[VEJGPC]/.test(clean)) {
                $(input).css('border', '2px solid red').attr('title', 'Formato inv√°lido (Ej: J123456789)');
            } else {
                $(input).css('border', '').attr('title', '');
            }
        }
        return clean;
    };

	/**
     * Inicializa la Tabla de Clientes (DataTables) [3, 4]
     */
    const initDataTable = function() {
        if ($('#clientsTable').length && !$.fn.DataTable.isDataTable('#clientsTable')) {
            
			// ---------------------------------------------------------
            // INICIO DE LA CORRECCI√ìN QUIR√öRGICA: SEGURIDAD Y LOGS
            // ---------------------------------------------------------

            // Leemos la variable global de permisos (o suite_vars.is_admin como fallback)
            const canExportData = suite_vars.can_export || suite_vars.is_admin;
            let tableDom = canExportData ? 'Blrtip' : 'lrtip'; // Oculta botones si no hay permisos

            // Array de botones con Secuestro de Clic (Interceptor)
            let tableButtons = canExportData ? [
                { 
                    extend: 'excelHtml5', 
                    text: 'Excel', 
                    className: 'btn-modern-action small',
                    action: function (e, dt, node, config) {
                        let btnInstance = this;
                        
                        // 1. Llamada a la API para registrar el Log
                        SuiteAPI.post('suite_log_export', { tabla: 'Clientes (Excel)' }).then(res => {
                            if (res.success) {
                                // 2. Ejecutamos la acci√≥n nativa de DataTables para descargar
                                $.fn.dataTable.ext.buttons.excelHtml5.action.call(btnInstance, e, dt, node, config);
                            }
                        }).catch(err => {
                            alert('‚ö†Ô∏è Acci√≥n bloqueada: No se pudo registrar la auditor√≠a de seguridad.');
                        });
                    }
                },
                { 
                    extend: 'csvHtml5', 
                    text: 'CSV', 
                    className: 'btn-modern-action small',
                    action: function (e, dt, node, config) {
                        let btnInstance = this;
                        
                        SuiteAPI.post('suite_log_export', { tabla: 'Clientes (CSV)' }).then(res => {
                            if (res.success) {
                                $.fn.dataTable.ext.buttons.csvHtml5.action.call(btnInstance, e, dt, node, config);
                            }
                        }).catch(err => {
                            alert('‚ö†Ô∏è Acci√≥n bloqueada: No se pudo registrar la auditor√≠a de seguridad.');
                        });
                    },
                    exportOptions: {
                        format: {
                            body: function (data, row, column, node) {
                                // L√≥gica para limpiar acentos intacta
                                return data ? data.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : data;
                            }
                        }
                    }
                }
            ] : [];

            cliTable = $('#clientsTable').DataTable({
                paging: true,
                pageLength: 25,
                responsive: true,
                dom: tableDom,
                buttons: tableButtons,
                language: dtLanguage
            });

            // Buscador personalizado
            $('#clients-table-search').on('keyup', function() { 
                cliTable.search(this.value).draw(); 
            });
        }
    };

    /**
     * Maneja los eventos DOM del m√≥dulo CRM [5-8]
     */
    const bindEvents = function() {
        
        // 1. Limpieza de RIFs en todos los inputs relevantes
        $(document).on('input blur', '#cli-rif, #prof-rif, #new-cli-rif', function() {
            cleanRifInput(this);
        });

        // 2. Crear Cliente Manual
        $('#btn-create-client').on('click', function() {
            const rif = $('#new-cli-rif').val();
            const nombre = $('#new-cli-nombre').val();

            if (!rif || !nombre) return alert('RIF y Nombre son requeridos');

            const data = {
                rif: rif,
                nombre: nombre,
                direccion: $('#new-cli-dir').val(),
                telefono: $('#new-cli-tel').val(),
                email: $('#new-cli-email').val(),
                ciudad: $('#new-cli-ciudad').val(),
                estado: $('#new-cli-estado').val()
            };

            // USO DE LA NUEVA API
            SuiteAPI.post('suite_add_client_manual', data).then(res => {
                if (res.success) {
                    alert('Cliente creado exitosamente');
                    location.reload();
                } else {
                    alert(res.data.message || res.data); // Compatibilidad de errores
                }
            }).catch(() => alert('Error de conexi√≥n con el servidor.'));
        });

        // 3. Importar CSV de Clientes
        $('#btn-run-import-cli').on('click', function() {
            const fileInput = $('#csv-clients-file').prop('files');
            if (!fileInput) return alert('Selecciona un archivo CSV primero');

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            const fd = new FormData();
            fd.append('csv_file', fileInput);

            // USO DE LA NUEVA API (Formulario M√∫ltiple)
            SuiteAPI.postForm('suite_import_clients_csv', fd).then(res => {
                if (res.success) {
                    alert(res.data);
                    location.reload();
                } else {
                    alert(res.data.message || res.data);
                    btn.prop('disabled', false).text('Procesar');
                }
            }).catch(() => {
                alert('Error al subir el archivo');
                btn.prop('disabled', false).text('Procesar');
            });
        });

        // 4. Actualizar Perfil del Cliente
        $('#btn-update-profile').on('click', function() {
            const btn = $(this);
            btn.text('Guardando...');

            const data = {
                is_update_only: true, // Flag vital para el backend
                id: $('#prof-id').val(),
                rif: $('#prof-rif').val(),
                nombre: $('#prof-nombre').val(),
                telefono: $('#prof-tel').val(),
                email: $('#prof-email').val(),
                direccion: $('#prof-dir').val(),
                ciudad: $('#prof-ciudad').val(),
                estado: $('#prof-estado').val(),
                contacto: $('#prof-contacto').val(),
                notas: $('#prof-notas').val()
            };

            SuiteAPI.post('suite_save_quote_crm', data).then(res => {
                btn.text('Guardar Cambios');
                if (res.success) {
                    alert('Perfil Actualizado Correctamente');
                } else {
                    alert(res.data.message || res.data);
                }
            });
        });

        // 5. Borrar Cliente
        $('#btn-delete-profile').on('click', function() {
            if (!confirm('¬øEst√° seguro de que desea eliminar este cliente? Se mantendr√° el registro financiero en sus cotizaciones previas.')) return;
            
            const id = $('#prof-id').val();

            SuiteAPI.post('suite_delete_client', { id: id }).then(res => {
                if (res.success) {
                    alert('Cliente eliminado');
                    location.reload();
                } else {
                    alert(res.data.message || res.data);
                }
            });
        });
    };

    /**
     * Carga el perfil completo de un cliente y abre el modal [5, 9, 10]
     * Expuesto p√∫blicamente para ser llamado desde los botones de la tabla
     * 
     * @param {number} id - ID del cliente
     */
    const openProfile = function(id) {
        $('#prof-history-body').html('<tr><td colspan="4" class="text-center">Cargando datos...</td></tr>');
        $('#prof-id').val(id);

        SuiteAPI.post('suite_get_client_profile', { id: id }).then(res => {
            if (res.success) {
                const c = res.data.cliente;
                const s = res.data.stats;
                const h = res.data.history;

                // Llenar formulario
                $('#prof-nombre').val(c.nombre_razon);
                $('#prof-rif').val(c.rif_ci);
                $('#prof-tel').val(c.telefono);
                $('#prof-email').val(c.email);
                $('#prof-dir').val(c.direccion);
                $('#prof-ciudad').val(c.ciudad);
                $('#prof-estado').val(c.estado);
                $('#prof-contacto').val(c.contacto_persona);
                $('#prof-notas').val(c.notas || '');

                // Llenar KPIs
                $('#kpi-total').text('$' + s.total);
                $('#kpi-count').text(s.count);
                $('#kpi-last').text(s.last);

				// Llenar Historial de Compras
				let hHtml = '';
				if (h.length > 0) {
					h.forEach(r => {
						hHtml += `
							<tr>
								<td>${r.fecha}</td>
								<td><strong>${r.codigo}</strong></td>
								<td class="text-green">$${r.total}</td>
								<td>
									<a href="${suite_vars.ajax_url}?action=suite_print_quote&id=${r.id}&nonce=${suite_vars.nonce}" target="_blank" class="btn-modern-action small">üìÑ Imprimir</a>
								</td>
							</tr>
						`;
					});
				} else {
					hHtml = '<tr><td colspan="4" class="text-center text-gray-500 py-4">Sin compras registradas.</td></tr>';
				}
                
                $('#prof-history-body').html(hHtml);

                // Mostrar Modal (Asumimos que openModal es global o lo manejamos aqu√≠)
                if (typeof window.openModal === 'function') {
                    window.openModal('modal-client-profile');
                } else {
                    $('#modal-client-profile').fadeIn();
                }
            } else {
                alert(res.data.message || res.data);
            }
        });
    };

    /**
     * B√∫squeda predictiva expuesta para el cotizador (SuiteQuoter)
     * 
     * @param {string} term - T√©rmino de b√∫squeda
     * @returns {Promise} - Devuelve la promesa pura
     */
    const searchClient = function(term) {
        return SuiteAPI.post('suite_search_client_ajax', { term: term });
    };

    // API P√∫blica Revelada
    return {
        init: function() {
            initDataTable();
            bindEvents();
        },
        openProfile: openProfile,
        searchClient: searchClient,
        cleanRif: cleanRifInput // Expuesto por si otros m√≥dulos (Cotizador) lo necesitan
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/crm.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/employees.js ---
/**
 * SuiteEmployees - M√≥dulo de Gesti√≥n de Empleados y Roles (RBAC)
 * 
 * Se encarga de inicializar las tablas de usuarios y perfiles,
 * renderizar la matriz din√°mica de capacidades y procesar el CRUD.
 */
const SuiteEmployees = (function($) {
    'use strict';

    // ==========================================
    // VARIABLES PRIVADAS
    // ==========================================
    let empTable = null;
    let roleTable = null;
    let currentCapabilitiesDict = {}; // Almacena el diccionario devuelto por el Backend

    const dtLanguage = { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json", "lengthMenu": "_MENU_" };

    // ==========================================
    // M√âTODOS PRIVADOS (Renders y Utilidades)
    // ==========================================

    /**
     * Inicializa las tablas de DataTables
     */
    const initTables = function() {
        if ($('#employeesTable').length && !$.fn.DataTable.isDataTable('#employeesTable')) {
            empTable = $('#employeesTable').DataTable({
                responsive: true,
                language: dtLanguage,
                dom: 'lrtip', // Sin botones de exportaci√≥n por defecto
                pageLength: 25
            });
        }

        if ($('#rolesTable').length && !$.fn.DataTable.isDataTable('#rolesTable')) {
            roleTable = $('#rolesTable').DataTable({
                responsive: true,
                language: dtLanguage,
                dom: 'lrtip',
                pageLength: 25
            });
        }
    };

    /**
     * Dibuja la matriz de Checkboxes agrupada por m√≥dulos
     */
    const renderCapabilitiesMatrix = function() {
        const container = $('#role-capabilities-matrix');
        let html = '';

        for (const [group, caps] of Object.entries(currentCapabilitiesDict)) {
            html += `<div class="cap-group"><h4>M√≥dulo: ${group}</h4>`;
            
            for (const [capKey, capLabel] of Object.entries(caps)) {
                html += `
                    <label class="cap-item">
                        <input type="checkbox" name="role_caps[]" value="${capKey}"> 
                        ${capLabel}
                    </label>
                `;
            }
            html += `</div>`;
        }
        
        container.html(html);
    };

    /**
     * Limpia los campos del Modal de Empleados para crear uno nuevo
     */
    const resetEmployeeModal = function() {
        $('#emp-modal-title').text('A√±adir Empleado');
        $('#emp-id').val('0');
        $('#emp-first-name, #emp-last-name, #emp-email, #emp-phone, #emp-password').val('');
        $('#emp-role').val('');
    };

    /**
     * Limpia los campos del Modal de Roles para crear uno nuevo
     */
    const resetRoleModal = function() {
        $('#role-modal-title').text('Crear Nuevo Perfil');
        $('#role-key-hidden, #role-display-name, #role-key').val('');
        
        // Desbloquea el Key (Solo se bloquea al editar para evitar inconsistencias)
        $('#role-key').prop('readonly', false).css('background-color', '#fff');
        
        // Desmarca todos los checks
        $('input[name="role_caps[]"]').prop('checked', false);
    };

    // ==========================================
    // CARGA DE DATOS (AJAX)
    // ==========================================

	const loadEmployees = function() {
        if (!empTable) return;
        
        SuiteAPI.post('suite_get_employees').then(res => {
            if (res.success && res.data) {
                empTable.clear();
                
                res.data.forEach(e => {
                    // Determinar el rol principal y estilos visuales
                    // CORRECCI√ìN: Extraemos el √≠ndice [0] si es array para garantizar que roleKey sea un texto puro
                    let roleKey = (Array.isArray(e.roles) && e.roles.length > 0) ? e.roles[0] : (e.roles ? Object.keys(e.roles)[0] : 'N/A');
                    let roleDisplay = (typeof roleKey === 'string') ? roleKey.replace('suite_', '').toUpperCase() : 'N/A';
                    let badgeClass = roleKey === 'administrator' ? 'pill-critico' : 'pill-neutral';

                    // Convertimos la data a Base64 para pasarla segura al bot√≥n OnClick
                    let safeData = btoa(unescape(encodeURIComponent(JSON.stringify(e))));
                    
                    let btnEdit = `<button class="btn-modern-action small" onclick="SuiteEmployees.editEmployee('${safeData}')">‚úèÔ∏è Editar</button>`;
                    let btnDel = `<button class="btn-modern-action small" style="color:#dc2626; border-color:#fca5a5;" onclick="SuiteEmployees.deleteEmployee(${e.id})">üóëÔ∏è Borrar</button>`;
                    
                    empTable.row.add([
                        `<strong>${e.nombre}</strong>`,
                        e.email,
                        e.telefono,
                        `<span class="status-pill ${badgeClass}">${roleDisplay}</span>`,
                        `<div style="display:flex; gap:8px;">${btnEdit} ${btnDel}</div>`
                    ]);
                });
                
                empTable.draw();
            }
        });
    };
	
	
    const loadRoles = function() {
        if (!roleTable) return;

        SuiteAPI.post('suite_get_roles').then(res => {
            if (res.success && res.data) {
                
                const roles = res.data.roles;
                currentCapabilitiesDict = res.data.diccionario;

                roleTable.clear();
                
                // Limpiar y preparar el selector de roles del modal de Empleados
                const selectRole = $('#emp-role');
                selectRole.empty().append('<option value="">Seleccione un rol...</option>');

                // Procesamos cada Rol devuelto
                for (const [key, roleData] of Object.entries(roles)) {
                    let name = roleData.name;
                    let caps = roleData.capabilities; // Objeto { 'read': true, 'suite_view_crm': true }
                    
                    // Extraer solo las capabilities de la Suite para pintar los badges visuales
                    let activeCaps = Object.keys(caps).filter(c => caps[c] && c.startsWith('suite_'));
                    let capsBadges = `<div class="role-tags-container">` + activeCaps.map(c => `<span>${c}</span>`).join('') + `</div>`;

                    let safeData = btoa(unescape(encodeURIComponent(JSON.stringify({key: key, name: name, activeCaps: activeCaps}))));

                    let btnEdit = `<button class="btn-modern-action small" onclick="SuiteEmployees.editRole('${safeData}')">‚úèÔ∏è Editar</button>`;
                    let btnDel = '';
                    
                    // Protecci√≥n frontend para no mostrar bot√≥n de borrado en roles cr√≠ticos
                    if (!['administrator', 'subscriber', 'editor'].includes(key)) {
                        btnDel = `<button class="btn-modern-action small" style="color:#dc2626; border-color:#fca5a5;" onclick="SuiteEmployees.deleteRole('${key}')">üóëÔ∏è Borrar</button>`;
                    }

                    roleTable.row.add([
                        `<strong>${name}</strong><br><small class="font-mono text-gray-500">${key}</small>`,
                        capsBadges || '<small class="text-gray-400">Sin permisos de Suite</small>',
                        `<div style="display:flex; gap:8px;">${btnEdit} ${btnDel}</div>`
                    ]);

                    // A√±adir la opci√≥n al desplegable
                    selectRole.append(`<option value="${key}">${name}</option>`);
                }
                
                roleTable.draw();
                renderCapabilitiesMatrix(); // Pintamos la matriz de Checkboxes
            }
        });
    };

    // ==========================================
    // LISTENERS DE FORMULARIOS (Guardar)
    // ==========================================

    const bindEvents = function() {

        // Interceptar botones HTML originales "Nuevo" para limpiar formularios
        $('button[onclick*="#modal-employee"]').on('click', resetEmployeeModal);
        $('button[onclick*="#modal-role"]').on('click', resetRoleModal);

        // Guardar Empleado
        $('#btn-save-employee').on('click', function(e) {
            e.preventDefault();
            const btn = $(this);
            
            const payload = {
                id: $('#emp-id').val(),
                first_name: $('#emp-first-name').val().trim(),
                last_name: $('#emp-last-name').val().trim(),
                email: $('#emp-email').val().trim(),
                telefono: $('#emp-phone').val().trim(),
                password: $('#emp-password').val(),
                role: $('#emp-role').val()
            };

            if (!payload.email || !payload.role) {
                return alert('‚ö†Ô∏è El Correo Electr√≥nico y el Rol son obligatorios.');
            }

            btn.prop('disabled', true).text('Procesando...');

            SuiteAPI.post('suite_save_employee', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Empleado guardado con √©xito.'));
                    $('#modal-employee').fadeOut();
                    loadEmployees();
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(() => {
                alert('‚ùå Error de red al intentar guardar el empleado.');
            }).finally(() => {
                btn.prop('disabled', false).text('üíæ Guardar Empleado');
            });
        });

        // Guardar Rol y Permisos
        $('#btn-save-role').on('click', function(e) {
            e.preventDefault();
            const btn = $(this);

            // Recolectar checkboxes marcados
            const caps = [];
            $('input[name="role_caps[]"]:checked').each(function() {
                caps.push($(this).val());
            });

            // Usamos el hidden_key como fallback, o el input visible si es nuevo
            const hiddenKey = $('#role-key-hidden').val();
            const roleKey = hiddenKey ? hiddenKey : $('#role-key').val().trim().toLowerCase();

            const payload = {
                role_key: roleKey,
                display_name: $('#role-display-name').val().trim(),
                capabilities: caps
            };

            if (!payload.role_key || !payload.display_name) {
                return alert('‚ö†Ô∏è El Nombre y el Identificador (Key) son obligatorios.');
            }

            btn.prop('disabled', true).text('Procesando...');

            SuiteAPI.post('suite_save_role', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ Rol guardado y permisos aplicados con √©xito.');
                    $('#modal-role').fadeOut();
                    loadRoles(); // Recarga la tabla y el select del otro modal
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(() => {
                alert('‚ùå Error de red al intentar guardar el rol.');
            }).finally(() => {
                btn.prop('disabled', false).text('üõ°Ô∏è Guardar Perfil y Permisos');
            });
        });
    };

    // ==========================================
    // API P√öBLICA (Revelado)
    // ==========================================
    return {
        init: function() {
            initTables();
            bindEvents();
            
            // Retraso ligero para permitir que la vista principal renderice
            setTimeout(() => {
                loadRoles(); // Cargar roles primero, ya que alimenta el Select de Empleados
                loadEmployees();
            }, 300);
        },

        // Expuestos para ser llamados desde los botones din√°micos en las Tablas
		editEmployee: function(base64Data) {
            const data = JSON.parse(decodeURIComponent(escape(atob(base64Data))));
            
            $('#emp-modal-title').text('Editar Empleado');
            $('#emp-id').val(data.id);
            
            // Tratar de separar el nombre (Fase 1-C no retorna First/Last individualmente por compatibilidad)
            let parts = data.nombre.split(' ');
            // CORRECCI√ìN: Asignamos parts[0] para asegurar que tome solo el primer string y no el array completo
            $('#emp-first-name').val(parts[0] || '');
            $('#emp-last-name').val(parts.slice(1).join(' ') || '');
            
            $('#emp-email').val(data.email);
            $('#emp-phone').val(data.telefono !== '-' ? data.telefono : '');
            $('#emp-password').val(''); // Se deja vac√≠o para no alterar
            
            // Seleccionar rol en el dropdown
            // CORRECCI√ìN: Extraemos el √≠ndice [0] del array para que jQuery seleccione correctamente el <option>
            let rKey = (Array.isArray(data.roles) && data.roles.length > 0) ? data.roles[0] : (data.roles ? Object.keys(data.roles)[0] : '');
            $('#emp-role').val(rKey);

            $('#modal-employee').fadeIn();
        },

        deleteEmployee: function(id) {
            if (!confirm('¬øEst√° seguro de eliminar a este empleado? Perder√° el acceso al ERP inmediatamente.')) return;
            
            SuiteAPI.post('suite_delete_employee', { id: id }).then(res => {
                if (res.success) {
                    alert('‚úÖ Empleado eliminado.');
                    loadEmployees();
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            });
        },

        editRole: function(base64Data) {
            const data = JSON.parse(decodeURIComponent(escape(atob(base64Data))));
            
            $('#role-modal-title').text('Editar Perfil');
            $('#role-key-hidden').val(data.key);
            
            // Bloqueamos el input del Key porque WP no permite renombrarlo de forma trivial
            $('#role-key').val(data.key).prop('readonly', true).css('background-color', '#f1f5f9');
            $('#role-display-name').val(data.name);

            // Desmarcar todos y marcar solo los activos
            $('input[name="role_caps[]"]').prop('checked', false);
            if (data.activeCaps) {
                data.activeCaps.forEach(cap => {
                    $(`input[name="role_caps[]"][value="${cap}"]`).prop('checked', true);
                });
            }

            $('#modal-role').fadeIn();
        },

        deleteRole: function(key) {
            if (!confirm('¬øEliminar este perfil? Si existen usuarios asignados a este rol, perder√°n su nivel de acceso.')) return;
            
            SuiteAPI.post('suite_delete_role', { role_key: key }).then(res => {
                if (res.success) {
                    alert('‚úÖ Perfil eliminado.');
                    loadRoles();
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            });
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/employees.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/historial.js ---
/**
 * SuiteHistorial - M√≥dulo de Historial de Cotizaciones
 * Permite buscar, imprimir, enviar por WA y CLONAR pedidos hacia el Cotizador.
 */
const SuiteHistorial = (function($) {
    'use strict';
    let table = null;

    const initTable = function() {
        if ($('#historyTable').length && !$.fn.DataTable.isDataTable('#historyTable')) {
            table = $('#historyTable').DataTable({
                responsive: true,
                language: { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" },
                order: [[0, 'desc']] // Ordenar por fecha de m√°s reciente a antiguo
            });
        }
    };

    const loadHistory = function() {
        if (!table) return;
        
        SuiteAPI.post('suite_get_history_ajax').then(res => {
            if (res.success && res.data) {
                table.clear();
                
                res.data.forEach(r => {
                    let badgeClass = (r.estado === 'pagado' || r.estado === 'despachado') ? 'pill-critico' : 'pill-neutral';
                    
                    // Bot√≥n WhatsApp
                    let waBtn = '';
                    if (r.wa_phone) {
                        let msg = encodeURIComponent(`Hola ${r.cliente_nombre}, le enviamos su cotizaci√≥n ${r.codigo_cotizacion}: ${suite_vars.ajax_url}?action=suite_print_quote&id=${r.id}`);
                        waBtn = `<a href="https://api.whatsapp.com/send?phone=${r.wa_phone}&text=${msg}" target="_blank" class="btn-modern-action small" style="color:#10b981; border-color:#a7f3d0;" title="WhatsApp">üì± WA</a>`;
                    }

                    // Bot√≥n Imprimir PDF
                    let printBtn = `<a href="${suite_vars.ajax_url}?action=suite_print_quote&id=${r.id}&nonce=${suite_vars.nonce}" target="_blank" class="btn-modern-action small" style="color:#475569;" title="Imprimir PDF">üñ®Ô∏è</a>`;

                    // Bot√≥n Clonar (La acci√≥n estrella)
                    let cloneBtn = `<button class="btn-modern-action small btn-clone-quote" data-id="${r.id}" style="color:#0073aa; border-color:#bae6fd;" title="Clonar al Cotizador">üîÑ Clonar</button>`;

                    table.row.add([
                        r.fecha_fmt,
                        `<strong>#${r.codigo_cotizacion}</strong>`,
                        r.cliente_nombre,
                        `$${r.total_fmt}`,
                        `<span class="status-pill ${badgeClass}">${r.estado.toUpperCase()}</span>`,
                        `<div style="display:flex; gap:5px;">${printBtn} ${waBtn} ${cloneBtn}</div>`
                    ]);
                });
                
                table.draw();
            }
        });
    };

    const bindEvents = function() {
        // Evento Delegado: CLONAR COTIZACI√ìN
        $('#historyTable').on('click', '.btn-clone-quote', function(e) {
            e.preventDefault();
            const quoteId = $(this).data('id');
            const btn = $(this);
            
            if (!confirm('¬øDesea clonar esta cotizaci√≥n? Los datos actuales del cotizador se sobrescribir√°n.')) return;
            
            btn.prop('disabled', true).text('‚è≥...');

            SuiteAPI.post('suite_get_quote_details_ajax', { id: quoteId }).then(res => {
                if (res.success) {
                    const data = res.data;
                    
                    // 1. Inyectar Cliente en el formulario del Cotizador
                    if (data.cliente) {
                        const c = data.cliente;
                        const prefix = c.rif_ci.charAt(0).toUpperCase();
                        const number = c.rif_ci.substring(1);
                        
                        $('#cli-rif-prefix').val(["V","E","J","G","P","C"].includes(prefix) ? prefix : 'V');
                        $('#cli-rif-number').val(number);
                        $('#cli-nombre').val(c.nombre_razon);
                        $('#cli-tel').val(c.telefono);
                        $('#cli-email').val(c.email);
                        $('#cli-dir').val(c.direccion);
                        $('#cli-ciudad').val(c.ciudad);
                        $('#cli-estado').val(c.estado);
                        $('#cli-contacto').val(c.contacto_persona);
                        
                        // NOTA: No bloqueamos el form (lockClientForm) para permitirle modificarlo si gusta
                    }
                    
                    // 2. Mapear y setear el Carrito (Se usa la API p√∫blica de SuiteQuoter)
                    if (data.items) {
                        const newCart = data.items.map(item => ({
                            sku: item.sku,
                            name: item.producto_nombre,
                            price: parseFloat(item.precio_unitario_usd),
                            qty: parseInt(item.cantidad),
                            time: item.tiempo_entrega || 'Inmediata'
                        }));
                        SuiteQuoter.setCart(newCart);
                    }
                    
                    // 3. Redirecci√≥n visual autom√°tica a la Pesta√±a del Cotizador
                    const cotizadorBtn = $('.tab-btn:contains("Cotizador")');
                    if (cotizadorBtn && typeof window.openSuiteTab === 'function') {
                        window.openSuiteTab('TabPos', cotizadorBtn);
                    }

                } else {
                    alert('‚ùå Error al clonar: ' + (res.data.message || res.data));
                }
            }).catch(() => {
                alert('‚ùå Ocurri√≥ un error de red al intentar clonar.');
            }).finally(() => {
                btn.prop('disabled', false).html('üîÑ Clonar');
            });
        });
    };

    return {
        init: function() {
            initTable();
            bindEvents();
            loadHistory();
        },
        refresh: loadHistory
    };
})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/historial.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: assets/js/modules/index.php ---

--- INICIO DEL ARCHIVO: assets/js/modules/kanban.js ---
/**
 * SuiteKanban - M√≥dulo visual y l√≥gico del Tablero de Pedidos
 * 
 * Gestiona la carga de tarjetas y los eventos Drag & Drop (SortableJS).
 * Intercepta el cierre de ventas (M√≥dulo 4) para recolectar datos de comisi√≥n.
 */
const SuiteKanban = (function($) {
    'use strict';

    // Variable temporal para retener la tarjeta en memoria mientras se llena el modal
    let pendingDrop = null;

    // ==========================================
    // M√âTODOS PRIVADOS
    // ==========================================

    const buildCardHTML = function(order) {
        let waBtnHtml = '';
        if (order.wa_phone) {
            let msg = encodeURIComponent(`Hola ${order.cliente_nombre}, le contactamos respecto a su pedido ${order.codigo_cotizacion}: ${suite_vars.ajax_url}?action=suite_print_quote&id=${order.id}`);
            waBtnHtml = `<a href="https://api.whatsapp.com/send?phone=${order.wa_phone}&text=${msg}" target="_blank" class="btn-modern-action" style="padding: 4px; font-size:11px; text-decoration:none;">üì± WA</a>`;
        }

        let mobilePayBtn = '';
		if (order.estado !== 'pagado' && order.estado !== 'despachado' && order.estado !== 'por_enviar') {			
            mobilePayBtn = `<button type="button" class="btn-modern-action trigger-mobile-pay" data-id="${order.id}" data-col="${order.estado}" style="padding: 4px; font-size:11px; background:#10b981; color:white; border:none; cursor:pointer;">üí∞ Pagar</button>`;
        }
		
        let reverseBtn = '';
        if (order.estado === 'despachado' && suite_vars.is_admin) {
            reverseBtn = `<button class="btn-modern-action small trigger-reverse-logistics" data-id="${order.id}" style="color:#dc2626; border-color:#fca5a5; width:100%; margin-top:8px;">üîô Log√≠stica Inversa (Admin)</button>`;
        }
		
        return `
        <div class="kanban-card" data-id="${order.id}">
            <!-- El bot√≥n de Log√≠stica Inversa se a√±ade al final de la tarjeta -->
            <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
                <span style="font-weight:bold; color:#0f172a;">#${order.codigo_cotizacion}</span>
            </div>
            <div style="font-size: 13px; color:#475569; margin-bottom: 10px;">
                üë§ ${order.cliente_nombre || 'Sin Nombre'} <br>
                <span style="font-weight:bold; color:#059669;">$${order.total_fmt}</span>
            </div>
            <div style="display:flex; gap: 5px; flex-wrap:wrap;">
                ${waBtnHtml}
                ${mobilePayBtn}
                <a href="${suite_vars.ajax_url}?action=suite_print_quote&id=${order.id}&nonce=${suite_vars.nonce}" target="_blank" class="btn-modern-action small" style="color:#475569;">üñ®Ô∏è</a>
            </div>
            ${reverseBtn}
        </div>
        `;
    };

    /**
     * Helper para devolver una tarjeta exactamente a su posici√≥n original
     * si el usuario cancela el drag & drop o falla el servidor.
     */
    const revertCard = function(itemEl, fromCol, oldIndex) {
        // Al usar el oldIndex, buscamos el elemento que AHORA ocupa ese √≠ndice.
        // Insertando el itemEl antes de ese nodo, vuelve exactamente a su lugar original.
        const referenceNode = fromCol.children[oldIndex] || null;
        fromCol.insertBefore(itemEl, referenceNode);
    };

    const initSortableColumns = function() {
        const columns = document.querySelectorAll('.kanban-column-body');
        
        columns.forEach(col => {
            new Sortable(col, {
                group: 'kanban', 
                animation: 150,
                ghostClass: 'kanban-ghost',
				onEnd: function (evt) {
                    const itemEl = evt.item;  
                    const toCol = evt.to;     
                    const fromCol = evt.from; 
                    const oldIndex = evt.oldIndex; // <-- Capturamos la posici√≥n original exacta
                    
                    if (toCol === fromCol) return; 

                    const quoteId = itemEl.getAttribute('data-id');
                    const newStatus = toCol.getAttribute('data-status');
                    const oldStatus = fromCol.getAttribute('data-status'); // <-- AGREGADO: Necesario para validar de d√≥nde viene

                    // ----------------------------------------------------
                    // CANDADO M√ìDULO 2: SECUENCIA ESTRICTA DE ESTADOS
                    // ----------------------------------------------------
                    const isMoveValid = function(oldS, newS) {
                        if (oldS === 'emitida' && newS === 'proceso') return true;
                        if (oldS === 'proceso' && (newS === 'emitida' || newS === 'pagado')) return true;
                        if (oldS === 'pagado' && newS === 'por_enviar') return true; // Avanza a Log√≠stica
                        if (oldS === 'por_enviar' && newS === 'pagado') return true; // Excepci√≥n: Retrocede de Log√≠stica a Facturado
                        // 'despachado' est√° prohibido por Drag & Drop (solo desde el panel log√≠stico)
                        return false; 
                    };

                    if (!isMoveValid(oldStatus, newStatus)) {
                        alert('‚õî Movimiento no permitido. Debe respetar la secuencia l√≥gica (Pendiente ‚ÜîÔ∏è En Proceso ‚û°Ô∏è Facturado ‚ÜîÔ∏è Por Enviar).');
                        revertCard(itemEl, fromCol, oldIndex); // Esta funci√≥n ya la tienes en tu JS para devolver la tarjeta
                        return;
                    }

                    // ----------------------------------------------------
                    // INTERCEPTOR M√ìDULO 4: Cierre de Venta
                    // ----------------------------------------------------
                    // PROTECCI√ìN: Solo abrimos el modal si la tarjeta AVANZA desde "proceso" a "pagado"
                    if (newStatus === 'pagado' && oldStatus === 'proceso') {
                        // 1. Guardar contexto en memoria para no perder la tarjeta
                        pendingDrop = { quoteId, itemEl, fromCol, toCol, oldIndex };
                        
                        // 2. Limpiar modal anterior y setear ID oculto
                        $('#modal-cierre-venta input, #modal-cierre-venta select').val('');
						$('#cierre-recibo-prefijo').val('F');
                        $('#cierre-quote-id').val(quoteId);
                        
                        // 3. Abrir Modal (No enviamos AJAX a√∫n)
                        $('#modal-cierre-venta').fadeIn();
                    } else {
                        // Si es otro estado (ej. de Emitida a Proceso, o de Pagado a Por Enviar), enviar directo
                        updateCounters();
                        updateOrderStatus(quoteId, newStatus, itemEl, fromCol, oldIndex);
                    }
                },
            });
        });
    };

    /**
     * Env√≠a un cambio de estado normal (Sin modal) a la base de datos
     */
    const updateOrderStatus = function(quoteId, newStatus, itemEl, originalCol, oldIndex) {
        SuiteAPI.post('suite_change_status_ajax', { 
            id: quoteId, 
            estado: newStatus 
        }).then(res => {
            if (!res.success) {
                alert('‚ùå Error: ' + (res.data.message || res.data));
                revertCard(itemEl, originalCol, oldIndex); // Revertir UI
                updateCounters();
            }
        }).catch(() => {
            alert('‚ùå Fallo de conexi√≥n al actualizar el pedido.');
            revertCard(itemEl, originalCol, oldIndex); // Revertir UI
            updateCounters();
        });
    };

    const updateCounters = function() {
        $('.kanban-column-body').each(function() {
            let status = $(this).data('status');
            let count = $(this).children('.kanban-card').length;
            $('#count-' + status).text(count);
        });
    };

    // ==========================================
    // LISTENERS DEL MODAL DE CIERRE DE VENTA
    // ==========================================
	const bindModalEvents = function() {
        
        // 1. Cerrar o cancelar Modal (Bot√≥n "X" o click por fuera)
        $('#close-modal-cierre').on('click', function() {
            if (pendingDrop) {
                // Al cancelar, la tarjeta se devuelve a su posici√≥n milim√©tricamente exacta
                revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                pendingDrop = null;
                updateCounters();
            }
            $('#modal-cierre-venta').fadeOut();
        });

        // 2. Procesar Formulario
        $('#btn-confirmar-pago').on('click', function(e) {
            e.preventDefault();
            if (!pendingDrop) return;

		// 1. Limpieza y ensamblaje de Factura/Nota de entrega
            const rawNumber = $('#cierre-loyverse').val().replace(/[^0-9]/g, '');
            const prefix = $('#cierre-recibo-prefijo').val();
            const finalReceipt = rawNumber ? (prefix + rawNumber) : '';
			
			const colaboradoresIds = $('#cierre-compartido').val() || [];
			
			
            // Recolectar datos (NOTA: Se removi√≥ la propiedad 'action' redundante)
            const payload = {
                id: pendingDrop.quoteId,
                estado: 'pagado',
                canal_venta: $('#cierre-canal').val(),
                metodo_pago: $('#cierre-pago').val(),
                metodo_entrega: $('#cierre-entrega').val(),
                recibo_loyverse: finalReceipt, // Aqu√≠ inyectamos el recibo ensamblado (Ej: "F1005")
                url_captura: $('#cierre-captura').val().trim(),
				colaboradores: colaboradoresIds 
            };

            // Validar obligatorios (Nota: Validamos !rawNumber para asegurar que escribieron los d√≠gitos)
            if (!payload.canal_venta || !payload.metodo_pago || !payload.metodo_entrega || !rawNumber) {
                return alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios y aseg√∫rese de ingresar el n√∫mero de recibo.');
            }

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            // Enviar al Backend
            SuiteAPI.post('suite_change_status_ajax', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Pago procesado y comisi√≥n registrada.'));
                    $('#modal-cierre-venta').fadeOut();
                    pendingDrop = null; // Liberar memoria, la tarjeta se queda en 'Pagado'
                    updateCounters();
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                    revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                    pendingDrop = null;
                    $('#modal-cierre-venta').fadeOut();
                    updateCounters();
                }
            }).catch(() => {
                alert('‚ùå Error de red. La operaci√≥n fue cancelada.');
                revertCard(pendingDrop.itemEl, pendingDrop.fromCol, pendingDrop.oldIndex);
                pendingDrop = null;
                $('#modal-cierre-venta').fadeOut();
                updateCounters();
            }).finally(() => {
                btn.prop('disabled', false).text('Confirmar y Procesar Pago');
            });
        });

        // 3. Trigger manual (Mobile) para "Pagar" sin arrastrar
        $('#kb-col-emitida, #kb-col-proceso, #kb-col-pagado, #kb-col-despachado').on('click', '.trigger-mobile-pay', function(e) {
            e.preventDefault();
            const quoteId = $(this).data('id');
            const col = $(this).data('col'); // Estado actual (ej: 'emitida')
            
            // Simular el objeto pendingDrop para evitar fallos l√≥gicos
            pendingDrop = { 
                quoteId: quoteId, 
                itemEl: $(this).closest('.kanban-card'), 
                fromCol: document.getElementById('kb-col-' + col), 
                toCol: document.getElementById('kb-col-pagado'), 
                oldIndex: $(this).closest('.kanban-card').index()
            };
            
            // Limpiar y preparar Modal
            $('#modal-cierre-venta input, #modal-cierre-venta select').val('');
			$('#cierre-recibo-prefijo').val('F');
            $('#cierre-quote-id').val(quoteId);
            
            // Mostrar Modal
            $('#modal-cierre-venta').fadeIn();
        });
		
        // 4. TRIGGER EXCLUSIVO ADMIN: LOG√çSTICA INVERSA
        $('#kb-col-despachado').on('click', '.trigger-reverse-logistics', function(e) {
            e.preventDefault();
            
            const quoteId = $(this).data('id');
            const seguro = confirm('‚ö†Ô∏è ATENCI√ìN ADMIN:\n\n¬øEst√° seguro de aplicar Log√≠stica Inversa a este pedido?\nLa orden regresar√° al estado "En Proceso" y se registrar√° la acci√≥n en el log de auditor√≠a.');
            
            if (!seguro) return;
            
            const btn = $(this);
            btn.prop('disabled', true).text('‚è≥ Revirtiendo...');

            SuiteAPI.post('suite_change_status_ajax', {
                id: quoteId,
                estado: 'proceso'
            }).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Log√≠stica Inversa aplicada exitosamente.'));
                    SuiteKanban.loadBoard(); // Refresca las columnas del Kanban
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                    btn.prop('disabled', false).text('üîô Log√≠stica Inversa (Admin)');
                }
            }).catch(() => {
                alert('‚ùå Error de red al intentar revertir el pedido.');
                btn.prop('disabled', false).text('üîô Log√≠stica Inversa (Admin)');
            });
        });
		
		
    };
    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        loadBoard: function() {
            $('.kanban-column-body').empty().html('<div class="text-center text-gray-400 py-4">Cargando...</div>');

            SuiteAPI.post('suite_get_kanban_data').then(res => {
                if (res.success) {
                    const data = res.data;
                    $('.kanban-column-body').empty(); 
                    
                    const columnasPermitidas = ['emitida', 'proceso', 'pagado', 'por_enviar', 'despachado'];
                    
                    columnasPermitidas.forEach(status => {
                        let colHtml = '';
                        if (data[status] && data[status].length > 0) {
                            data[status].forEach(order => {
                                colHtml += buildCardHTML(order);
                            });
                        }
                        $('#kb-col-' + status).html(colHtml);
                    });

                    updateCounters();
                } else {
                    alert('Error al cargar pedidos: ' + res.data);
                }
            });
        },

        init: function() {
            if (typeof Sortable === 'undefined') {
                console.error("SortableJS no est√° cargado.");
                return;
            }
            
            initSortableColumns();
            bindModalEvents();
            this.loadBoard();
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/kanban.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/logistics.js ---
/**
 * SuiteLogistics - M√≥dulo del Panel de Almac√©n y Despacho
 * 
 * Gestiona la apertura de modales de log√≠stica y la subida segura
 * de comprobantes de entrega (POD) mediante FormData.
 */
const SuiteLogistics = (function($) {
    'use strict';

    let currentQuoteId = null;

    // ==========================================
    // M√âTODOS PRIVADOS Y EVENT LISTENERS
    // ==========================================

    const bindEvents = function() {
        
        // Procesar subida del comprobante
		$('#btn-procesar-despacho').on('click', function(e) {
            e.preventDefault();

            const fileInput = $('#log-pod-file').prop('files');
            if (!fileInput || fileInput.length === 0) {
                return alert('‚ö†Ô∏è Por favor, selecciona una imagen o archivo PDF como comprobante.');
            }

            const btn = $(this);
            btn.prop('disabled', true).text('Subiendo Archivo...');

            // Instanciar FormData para env√≠o de archivos (Multipart)
            const fd = new FormData();
            fd.append('pod_file', fileInput[0]); // <--- √öNICA CORRECCI√ìN: Agregar [0] aqu√≠
            fd.append('quote_id', currentQuoteId);

            SuiteAPI.postForm('suite_upload_pod', fd).then(res => {
                if (res.success) {
                    alert('‚úÖ ' + (res.data.message || 'Pedido marcado como despachado.'));
                    
                    // Cerrar Modal
                    $('#modal-confirmar-despacho').fadeOut();
                    
                    // Efecto visual: Eliminar la fila de la tabla suavemente
                    $('#log-row-' + currentQuoteId).fadeOut('slow', function() { 
                        $(this).remove(); 
                        
                        // Si la tabla queda vac√≠a, podr√≠amos mostrar un mensaje, 
                        // pero con recargar la vista del Kanban en background es suficiente.
                        if (typeof SuiteKanban !== 'undefined') {
                            SuiteKanban.loadBoard();
                        }
                    });

                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(err => {
                alert('‚ùå Error de conexi√≥n al subir el archivo.');
            }).finally(() => {
                btn.prop('disabled', false).text('Subir y Marcar Despachado');
            });
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        /**
         * Abre el modal y guarda el ID del pedido en memoria
         * @param {number} id - ID del pedido
         */
        openModal: function(id) {
            currentQuoteId = id;
            $('#log-pod-file').val(''); // Limpiar input residual
            $('#modal-confirmar-despacho').fadeIn();
        },

        init: function() {
            bindEvents();
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/logistics.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/marketing.js ---
/**
 * SuiteMarketing - M√≥dulo de Data Analytics (BI)
 * 
 * Se conecta al endpoint REST de la Suite y renderiza gr√°ficos 
 * interactivos con Chart.js
 */
const SuiteMarketing = (function($) {
    'use strict';

    // Instancias globales para poder destruirlas y repintarlas
    let chartCanales = null;
    let chartTendencias = null;

    // ==========================================
    // M√âTODOS DE PROCESAMIENTO DE DATOS
    // ==========================================

    const processDoughnutData = function(rawData) {
        const aglomerado = {};
        
        // Sumar Volumen USD agrupado estrictamente por Canal
        rawData.forEach(item => {
            const canal = item.canal_venta || 'No Definido';
            if (!aglomerado[canal]) aglomerado[canal] = 0;
            aglomerado[canal] += parseFloat(item.volumen_usd);
        });

        return {
            labels: Object.keys(aglomerado),
            values: Object.values(aglomerado)
        };
    };

    const processLineData = function(rawData) {
        const aglomerado = {};
        
        // Sumar Cantidad de Operaciones agrupado estrictamente por Fecha
        rawData.forEach(item => {
            const fecha = item.fecha; // Formato YYYY-MM-DD
            if (!aglomerado[fecha]) aglomerado[fecha] = 0;
            aglomerado[fecha] += parseInt(item.cantidad_operaciones);
        });

        // Ordenar fechas cronol√≥gicamente
        const fechasOrdenadas = Object.keys(aglomerado).sort();
        const valoresOrdenados = fechasOrdenadas.map(f => aglomerado[f]);

        return {
            labels: fechasOrdenadas,
            values: valoresOrdenados
        };
    };

    // ==========================================
    // RENDERIZADO DE CHART.JS
    // ==========================================

    const renderCharts = function(data) {
        // Destruir gr√°ficos previos si el usuario hace clic en "Refrescar"
        if (chartCanales) chartCanales.destroy();
        if (chartTendencias) chartTendencias.destroy();

        // --- 1. GR√ÅFICO DE DONA (Canales) ---
        const dData = processDoughnutData(data);
        const ctxCanales = document.getElementById('chart-canales-venta').getContext('2d');
        
        chartCanales = new Chart(ctxCanales, {
            type: 'doughnut',
            data: {
                labels: dData.labels,
                datasets: [{
                    data: dData.values,
                    backgroundColor: [
                        '#0073aa', // Azul WP
                        '#10b981', // Verde √âxito
                        '#f59e0b', // Naranja/Amarillo
                        '#8b5cf6', // P√∫rpura
                        '#dc2626', // Rojo RV
                        '#64748b'  // Gris
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 13 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // --- 2. GR√ÅFICO DE L√çNEAS (Tendencias) ---
        const lData = processLineData(data);
        const ctxTendencias = document.getElementById('chart-tendencia-ventas').getContext('2d');

        chartTendencias = new Chart(ctxTendencias, {
            type: 'line',
            data: {
                labels: lData.labels,
                datasets: [{
                    label: 'Operaciones Cerradas',
                    data: lData.values,
                    borderColor: '#dc2626', // Rojo corporativo
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#dc2626',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.3 // Hace que la l√≠nea sea curva y suave
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
                }
            }
        });
    };

    // ==========================================
    // API P√öBLICA (M√©todos Revelados)
    // ==========================================
    return {
        loadDashboard: function() {
            // Utilizamos la ruta din√°mica al endpoint REST de WordPress
            const restUrl = suite_vars.rest_url + 'suite/v1/ventas-vs-alcance';

            // Usamos jQuery AJAX inyectando el Nonce nativo de la API REST
            $.ajax({
                url: restUrl,
                method: 'GET',
                headers: { 
                    'X-WP-Nonce': suite_vars.rest_nonce 
                },
                success: function(res) {
                    if (res.success && res.data) {
                        renderCharts(res.data);
                    }
                },
                error: function(err) {
                    if(err.status === 401 || err.status === 403) {
                        alert('üîí Acceso Denegado: Su rol no tiene permisos para ver anal√≠ticas o su sesi√≥n expir√≥.');
                    } else {
                        $('#chart-canales-venta').parent().html('<div style="padding:20px; color:#dc2626;">Error al cargar datos.</div>');
                        $('#chart-tendencia-ventas').parent().html('<div style="padding:20px; color:#dc2626;">Error al cargar datos.</div>');
                    }
                }
            });
        },

        init: function() {
            // Listo para ser llamado por el enrutador de pesta√±as
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/marketing.js ---

--- INICIO DEL ARCHIVO: assets/js/modules/quoter.js ---
/**
 * SuiteQuoter - M√≥dulo UI del Cotizador y Punto de Venta (POS)
 * Reconstrucci√≥n V11: Mobile-First, RIF At√≥mico y Carrito Independiente.
 */
const SuiteQuoter = (function($) {
    'use strict';

    let searchTimeout = null;
    let clientTimeout = null;
    let localCart = []; // Desacoplado de SuiteState para permitir SKUs duplicados
    let tasaBCV = 1.00;

    // ==========================================
    // M√âTODOS PRIVADOS Y DE RENDERIZADO
    // ==========================================

    const calculateTotals = function() {
        let totalUSD = 0;
        localCart.forEach(item => {
            totalUSD += (parseFloat(item.price) * parseInt(item.qty));
        });
        
        $('#pos-total-usd').text('$' + totalUSD.toFixed(2));
        $('#pos-total-bs').text('Ref. Bs: ' + (totalUSD * tasaBCV).toFixed(2));
    };

    const renderCart = function() {
        const tbody = $('#pos-cart-body');
        let html = '';

        if (localCart.length === 0) {
            html = '<div style="text-align: center; color: #94a3b8; padding: 40px 0;">El carrito est√° vac√≠o. Busque un producto para comenzar.</div>';
        } else {
            localCart.forEach((item, index) => {
                let subtotal = (item.qty * item.price).toFixed(2);
                
                // Estructura de Tarjeta (Card) Responsive
                html += `
                <div class="pos-cart-item" style="display:flex; flex-wrap:wrap; gap:10px; background:#fff; border:1px solid #cbd5e1; padding:15px; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div style="flex: 1 1 100%; margin-bottom: 5px;">
                        <strong style="color:#0073aa; font-family:monospace; font-size:14px;">${item.sku}</strong> 
                        <span style="font-size:14px; color:#1e293b;">${item.name}</span>
                    </div>
                    <div style="flex: 1 1 90px;">
                        <label style="font-size:11px; color:#64748b; display:block; margin-bottom:4px;">Precio ($)</label>
                        <input type="number" step="0.01" class="widefat cart-input-price" data-index="${index}" value="${item.price}" style="margin:0;">
                    </div>
                    <div style="flex: 1 1 70px;">
                        <label style="font-size:11px; color:#64748b; display:block; margin-bottom:4px;">Cant.</label>
                        <input type="number" min="1" class="widefat cart-input-qty" data-index="${index}" value="${item.qty}" style="margin:0;">
                    </div>
                    <div style="flex: 1 1 120px;">
                        <label style="font-size:11px; color:#64748b; display:block; margin-bottom:4px;">Tiempo Entrega</label>
                        <input type="text" class="widefat cart-input-time" data-index="${index}" value="${item.time}" style="margin:0;">
                    </div>
                    <div style="flex: 1 1 80px; text-align:right;">
                        <label style="font-size:11px; color:#64748b; display:block; margin-bottom:4px;">Subtotal</label>
                        <div style="font-size:15px; font-weight:bold; color:#059669; margin-top:8px;">$${subtotal}</div>
                    </div>
                    <div style="flex: 0 0 40px; display:flex; align-items:flex-end; justify-content:center;">
                        <button type="button" class="btn-modern-action btn-remove-item" data-index="${index}" style="color:#dc2626; border-color:#fca5a5; padding:8px 10px;">üóëÔ∏è</button>
                    </div>
                </div>
                `;
            });
        }
        
        tbody.html(html);
        calculateTotals();
    };

    /**
     * Helper para bloquear/desbloquear formulario del cliente
     */
    const lockClientForm = function(lock) {
        if (lock) {
            $('#cli-form-wrapper input:not(#cli-search-predictive)').prop('readonly', true).css('background-color', '#f1f5f9');
            $('#cli-rif-prefix').css('pointer-events', 'none').css('background-color', '#f1f5f9');
            $('#btn-clear-client').fadeIn();
        } else {
            $('#cli-form-wrapper input:not(#cli-search-predictive)').prop('readonly', false).css('background-color', '#fff');
            $('#cli-rif-prefix').css('pointer-events', 'auto').css('background-color', '#fff');
            $('#btn-clear-client').fadeOut();
        }
    };

    // ==========================================
    // EVENT LISTENERS
    // ==========================================
	/**
     * Automatizaci√≥n API Dolar BCV
     */
    const fetchDolarAPI = async function() {
        try {
            const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
            const data = await response.json();
            
            if (data && data.promedio) {
                // 1. Actualizar la variable global del carrito
                tasaBCV = parseFloat(data.promedio);
                
                // 2. Actualizar el input visible para el vendedor
                $('#pos-tasa-bcv').val(tasaBCV.toFixed(4));
                
                // 3. Formatear la fecha (DD/MM/YYYY HH:MM)
                const fecha = new Date(data.fechaActualizacion);
                const fechaFormat = fecha.toLocaleDateString('es-VE') + ' ' + fecha.toLocaleTimeString('es-VE', {hour: '2-digit', minute:'2-digit'});
                
                // 4. Mostrar confirmaci√≥n visual al vendedor
                $('#bcv-update-date').text('‚úÖ BCV: ' + fechaFormat).css('color', '#059669');
                
                // 5. Recalcular los totales en Bs del carrito
                calculateTotals();
            }
        } catch (error) {
            console.error('Error conectando a DolarAPI:', error);
            $('#bcv-update-date').text('‚ùå Error API. Use tasa manual.').css('color', '#dc2626');
        }
    };
	
	
	
    const bindEvents = function() {
        
		// 1. CARACTER√çSTICA: RIF AT√ìMICO Y ESTRICTO
        $('#cli-rif-number').on('input', function() {
            // Bloquea cualquier car√°cter que no sea n√∫mero
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // 1.5 DETECCI√ìN AUTOM√ÅTICA POR RIF (Auto-carga al perder el foco)
        $('#cli-rif-number').on('blur', function() {
            const numeroRif = $(this).val().trim();

            // Validar longitud l√≥gica (mayor a 5 caracteres)
            if (numeroRif.length <= 5) return;

            // Concatenar prefijo y n√∫mero para formar el RIF completo en may√∫sculas
            const prefijo = $('#cli-rif-prefix').val();
            const rifCompleto = (prefijo + numeroRif).toUpperCase();

            // Mostrar un peque√±o indicador visual de b√∫squeda
            const inputField = $(this);
            inputField.css('opacity', '0.6');

            // Consultar a la base de datos (API)
            SuiteAPI.post('suite_search_client_ajax', { term: rifCompleto }).then(res => {
                if (res.success && res.data && res.data.length > 0) {

                    // Buscar coincidencia EXACTA en los resultados devueltos
                    const cliente = res.data.find(c => c.rif_ci.toUpperCase() === rifCompleto);

                    if (cliente) {
                        // Autocompletar campos del formulario
                        $('#cli-nombre').val(cliente.nombre_razon);
                        $('#cli-tel').val(cliente.telefono);
                        $('#cli-email').val(cliente.email);
                        $('#cli-dir').val(cliente.direccion);
                        $('#cli-ciudad').val(cliente.ciudad);
                        $('#cli-estado').val(cliente.estado);
                        $('#cli-contacto').val(cliente.contacto_persona);

                        // Bloquear formulario para prevenir mutaciones indeseadas
                        lockClientForm(true);

                        // Limpiar el buscador predictivo por seguridad
                        $('#cli-search-predictive').val('');
                        $('#cli-search-results').hide().empty();

                        // Mostrar mensaje de √©xito temporal (Feedback sutil)
                        $('#rif-auto-feedback').remove(); // Limpiar si ya existe
                        $('<div id="rif-auto-feedback" style="color: #059669; font-size: 12px; margin-top: 5px; font-weight: bold;">‚úÖ Cliente detectado en la base de datos y cargado autom√°ticamente.</div>')
                            .insertAfter(inputField.parent())
                            .delay(4000)
                            .fadeOut(400, function() { $(this).remove(); });
                    }
                }
            }).catch(err => {
                // Fallo silencioso: Si hay error de red, dejamos que el vendedor siga llenando manual
                console.warn('Auto-detecci√≥n de RIF omitida por error de red.', err);
            }).finally(() => {
                inputField.css('opacity', '1');
            });
        });

        // 2. BUSCADOR PREDICTIVO DE CLIENTES
        $('#cli-search-predictive').on('keyup', function() {
            clearTimeout(clientTimeout);
            let term = $(this).val().trim();
            let resBox = $('#cli-search-results');

            if (term.length < 3) { resBox.hide().empty(); return; }

            clientTimeout = setTimeout(() => {
                resBox.show().html('<div style="padding:10px; color:#64748b;">Buscando cliente...</div>');
                SuiteAPI.post('suite_search_client_ajax', { term: term }).then(res => {
                    if (res.success && res.data.length > 0) {
                        let html = '';
                        res.data.forEach(c => {
                            // Guardamos la data cruda en base64 para evitar rupturas de comillas
                            const safeData = btoa(unescape(encodeURIComponent(JSON.stringify(c))));
                            html += `<div class="pos-item-result cli-result-item" data-client="${safeData}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">
                                        <div class="prod-info"><strong>${c.rif_ci}</strong> ${c.nombre_razon}</div>
                                     </div>`;
                        });
                        resBox.html(html);
                    } else {
                        resBox.html('<div style="padding:10px; color:#64748b;">No se encontraron coincidencias.</div>');
                    }
                });
            }, 400);
        });

        // 3. SELECCIONAR CLIENTE (Auto-completar y Bloquear)
        $(document).on('click', '.cli-result-item', function() {
            const rawData = $(this).data('client');
            const c = JSON.parse(decodeURIComponent(escape(atob(rawData))));
            
            // Separar RIF At√≥mico
            const prefix = c.rif_ci.charAt(0).toUpperCase();
            const number = c.rif_ci.substring(1);
            
            // Validar que el prefijo exista en el select, si no, fallback a 'V'
            if (["V","E","J","G","P","C"].includes(prefix)) {
                $('#cli-rif-prefix').val(prefix);
            } else {
                $('#cli-rif-prefix').val('V');
            }
            
            $('#cli-rif-number').val(number);
            $('#cli-nombre').val(c.nombre_razon);
            $('#cli-tel').val(c.telefono);
            $('#cli-email').val(c.email);
            $('#cli-dir').val(c.direccion);
            $('#cli-ciudad').val(c.ciudad);
            $('#cli-estado').val(c.estado);
            $('#cli-contacto').val(c.contacto_persona);

            // Bloquear formulario y limpiar buscador
            lockClientForm(true);
            $('#cli-search-predictive').val('');
            $('#cli-search-results').hide().empty();
        });

        // 4. LIMPIAR CLIENTE (Desbloquear)
        $('#btn-clear-client').on('click', function() {
            $('#cli-form-wrapper input:not(#cli-search-predictive)').val('');
            $('#cli-rif-prefix').val('J');
            lockClientForm(false);
        });

        // 5. BUSCADOR PREDICTIVO DE PRODUCTOS (Con Placeholders de CSV)
        $('#pos-product-search').on('keyup', function() {
            clearTimeout(searchTimeout);
            let term = $(this).val().trim();
            let resultsBox = $('#pos-search-results');

            if (term.length < 3) { resultsBox.hide().empty(); return; }

            searchTimeout = setTimeout(() => {
                resultsBox.show().html('<div style="padding:10px; color:#64748b;">Buscando cat√°logo...</div>');
                
                SuiteAPI.post('suite_search_pos', { term: term }).then(res => {
                    if (res.success && res.data.length > 0) {
                        let listHTML = '';
                        res.data.forEach(prod => {
                            // Placeholders requeridos (Se nutren del Data Lake / CSV a futuro)
                            let dispGaleria = prod.stock_gale !== undefined ? prod.stock_gale : 'N/D';
                            let stockTotal = prod.stock_total !== undefined ? prod.stock_total : dispGaleria; 
                            
                            listHTML += `
                            <div class="pos-item-result search-result-item" 
                                 data-sku="${prod.sku}" data-name="${prod.nombre}" data-price="${prod.precio}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div class="prod-info">
                                    <strong>${prod.sku}</strong> ${prod.nombre} 
                                    <div style="font-size:11px; color:#64748b; margin-top:4px;">
                                        üì¶ Disp. Galer√≠as: <strong>${dispGaleria}</strong> | Total: <strong>${stockTotal}</strong>
                                    </div>
                                </div>
                                <div class="prod-price" style="font-weight:bold; color:#059669;">$${prod.precio}</div>
                            </div>`;
                        });
                        resultsBox.html(listHTML);
                    } else {
                        resultsBox.html('<div style="padding: 10px;">No se encontraron productos.</div>');
                    }
                }).catch(() => {
                    resultsBox.html('<div style="padding: 10px; color: #dc2626;">‚ùå Error de conexi√≥n al buscar. Intente nuevamente.</div>');
                });
            }, 400);
        });

        // 6. AGREGAR AL CARRITO (Permite duplicados directos)
        $(document).on('click', '.search-result-item', function() {
            let el = $(this);
            localCart.push({
                sku: el.data('sku'),
                name: el.data('name'),
                price: parseFloat(el.data('price')),
                qty: 1,
                time: 'Inmediata'
            });

            $('#pos-product-search').val('');
            $('#pos-search-results').hide().empty();
            renderCart();
        });

        // 7. AGREGAR √çTEM MANUAL
        $('#btn-add-manual-item').on('click', function(e) {
            e.preventDefault();
            let desc = prompt("Ingrese la descripci√≥n del producto manual:");
            if (!desc) return;
            let price = prompt("Ingrese el Precio Unitario ($):");
            if (!price || isNaN(parseFloat(price))) return alert("Precio inv√°lido.");

            localCart.push({
                sku: 'MANUAL',
                name: desc.trim(),
                price: parseFloat(price),
                qty: 1,
                time: 'Inmediata'
            });
            renderCart();
        });

        // 8. DELEGACI√ìN DE EVENTOS DEL CARRITO (Edici√≥n en vivo)
        $('#pos-cart-body').on('change input', '.cart-input-qty', function() {
            let idx = $(this).data('index');
            localCart[idx].qty = Math.max(1, parseInt($(this).val()) || 1);
            renderCart();
        });

        $('#pos-cart-body').on('change', '.cart-input-price', function() {
            let idx = $(this).data('index');
            localCart[idx].price = Math.max(0, parseFloat($(this).val()) || 0);
            renderCart();
        });

        $('#pos-cart-body').on('change input', '.cart-input-time', function() {
            let idx = $(this).data('index');
            localCart[idx].time = $(this).val().trim();
        });

        $('#pos-cart-body').on('click', '.btn-remove-item', function() {
            let idx = $(this).data('index');
            localCart.splice(idx, 1);
            renderCart();
        });

        // 9. EVENTO DE GUARDADO (Punto Cr√≠tico Financiero)
        $('#btn-save-quote').on('click', function(e) {
            e.preventDefault();

            if (localCart.length === 0) return alert('‚ö†Ô∏è No puede guardar una cotizaci√≥n vac√≠a.');

            const numRif = $('#cli-rif-number').val().trim();
            if (!numRif) return alert('‚ö†Ô∏è El n√∫mero de RIF/CI es obligatorio.');

            // Ensamblaje del RIF At√≥mico
            const finalRif = $('#cli-rif-prefix').val() + numRif;
            const finalName = $('#cli-nombre').val().trim();

            if (!finalName) return alert('‚ö†Ô∏è La Raz√≥n Social es obligatoria.');

            const btn = $(this);
            btn.prop('disabled', true).text('Procesando...');

            const payload = {
                rif: finalRif,
                nombre: finalName,
                direccion: $('#cli-dir').val().trim(),
                telefono: $('#cli-tel').val().trim(),
                email: $('#cli-email').val().trim(),
                ciudad: $('#cli-ciudad').val().trim(),
                estado: $('#cli-estado').val().trim(),
                contacto: $('#cli-contacto').val().trim(),
                notas: '', // Si se desea habilitar, agregar input
                items: localCart,
                moneda: $('#pos-moneda').val(),
                tasa: tasaBCV,
                validez: $('#pos-validez').val() || 5
            };

            SuiteAPI.post('suite_save_quote_crm', payload).then(res => {
                if (res.success) {
                    alert('‚úÖ Cotizaci√≥n generada con √©xito. C√≥digo: ' + res.data.id);
                    // Abrir PDF usando el ID interno + Nonce CSRF estricto
                    window.open(suite_vars.ajax_url + '?action=suite_print_quote&id=' + res.data.internal_id + '&nonce=' + suite_vars.nonce, '_blank');
                    
                    // Resetear Interfaz
                    localCart = [];
                    renderCart();
                    $('#btn-clear-client').click(); // Limpia y desbloquea el formulario
                } else {
                    alert('‚ùå Error: ' + (res.data.message || res.data));
                }
            }).catch(() => {
                alert('‚ùå Error cr√≠tico de conexi√≥n al generar la cotizaci√≥n.');
            }).finally(() => {
                btn.prop('disabled', false).text('üíæ Guardar Cotizaci√≥n');
            });
        });
    };

	// ==========================================
    // API P√öBLICA
    // ==========================================
    return {
        init: function() {
            let initialTasa = parseFloat($('#pos-tasa-bcv').val());
            if (initialTasa && !isNaN(initialTasa)) {
                tasaBCV = initialTasa;
            }
            
            // Listener: Recalcular totales si el vendedor cambia la tasa BCV manualmente
            $('#pos-tasa-bcv').on('input change', function() {
                let nuevaTasa = parseFloat($(this).val());
                if (nuevaTasa > 0) {
                    tasaBCV = nuevaTasa;
                    calculateTotals();
                }
            });

            bindEvents();
            renderCart();
            
            // ¬°Disparar el robot del BCV al abrir la pantalla!
            fetchDolarAPI();
        },
        // Expuesto por si se requiere clonar o vaciar desde afuera
        setCart: function(newCart) { 
            localCart = newCart; 
            renderCart(); 
        }
    };

})(jQuery);
--- FIN DEL ARCHIVO: assets/js/modules/quoter.js ---

--- INICIO DEL ARCHIVO: includes/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/index.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Controllers/index.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Admin/class-suite-shortcode-controller.php ---
<?php
/**
 * Controlador de Interfaz: Renderizado de la App y Encolado de Assets
 *
 * Clase responsable de inyectar el sistema en el frontend mediante shortcodes,
 * verificar permisos (Role-Level Security) y orquestar las dependencias JavaScript (ES6).
 *
 * @package SuiteEmpleados\Controllers\Admin
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Shortcode_Controller {

    /**
     * Constructor: Engancha los m√©todos a los hooks de WordPress.
     */
    public function __construct() {
        // Encolar scripts en el frontend
        add_action( 'wp_enqueue_scripts', [ $this, 'enqueue_assets' ] );
        // Registrar el shortcode [suite_empleados_v8]
        add_shortcode( 'suite_empleados_v8', [ $this, 'render_app' ] );
    }

    /**
     * Encola los estilos, librer√≠as externas y m√≥dulos JS en el orden correcto.
     */
    public function enqueue_assets() {
        global $post;

        // Validar que estamos en la p√°gina del shortcode antes de cargar assets
        if ( is_a( $post, 'WP_Post' ) && has_shortcode( $post->post_content, 'suite_empleados_v8' ) ) {
            
            // 1. Estilos Cl√°sicos (CSS Actual)
            wp_enqueue_style( 'suite-styles', SUITE_URL . 'assets/css/suite-styles.css', [], SUITE_VERSION );

            // 2. Librer√≠as Externas v√≠a CDN
            wp_enqueue_style( 'dt-css', 'https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/datatables.min.css' );
            wp_enqueue_script( 'dt-js', 'https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.6/b-2.4.2/b-html5-2.4.2/b-print-2.4.2/r-2.5.0/datatables.min.js', ['jquery'], '1.13.6', true );
            wp_enqueue_script( 'sortable-js', 'https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js', [], null, true );
            wp_enqueue_script( 'chart-js', 'https://cdn.jsdelivr.net/npm/chart.js', [], null, true );

            // 3. Arquitectura Core JS (Dependencias base)
            wp_enqueue_script( 'suite-api-js', SUITE_URL . 'assets/js/core/api.js', ['jquery'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-state-js', SUITE_URL . 'assets/js/core/state.js', [], SUITE_VERSION, true );
            
            // 4. M√≥dulos Funcionales (Dependen del Core)
            wp_enqueue_script( 'suite-crm-js', SUITE_URL . 'assets/js/modules/crm.js', ['suite-api-js', 'dt-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-quoter-js', SUITE_URL . 'assets/js/modules/quoter.js', ['suite-api-js', 'suite-state-js'], SUITE_VERSION, true );
			wp_enqueue_script( 'suite-historial-js', SUITE_URL . 'assets/js/modules/historial.js', ['suite-api-js', 'dt-js', 'suite-quoter-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-kanban-js', SUITE_URL . 'assets/js/modules/kanban.js', ['suite-api-js', 'sortable-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-commissions-js', SUITE_URL . 'assets/js/modules/commissions.js', ['suite-api-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-logistics-js', SUITE_URL . 'assets/js/modules/logistics.js', ['suite-api-js'], SUITE_VERSION, true );
            wp_enqueue_script( 'suite-marketing-js', SUITE_URL . 'assets/js/modules/marketing.js', ['suite-api-js', 'chart-js'], SUITE_VERSION, true );
			wp_enqueue_script( 'suite-employees-js', SUITE_URL . 'assets/js/modules/employees.js', ['suite-api-js', 'dt-js'], SUITE_VERSION, true );

            // 5. Orquestador Principal (Carga al final)
            wp_enqueue_script( 'suite-main-js', SUITE_URL . 'assets/js/main.js', [
                'suite-crm-js', 
                'suite-quoter-js',
				'suite-historial-js',
                'suite-kanban-js', 
                'suite-commissions-js', 
                'suite-logistics-js', 
                'suite-marketing-js',
				'suite-employees-js'
            ], SUITE_VERSION, true );

			
			// 6. Variables Globales de Entorno e Inyecci√≥n de Nonce de Seguridad
            $user_actual = wp_get_current_user();
            $roles_actuales = (array) $user_actual->roles;
            $is_gerente = in_array( 'suite_gerente', $roles_actuales ) || in_array( 'gerente', $roles_actuales );
            $can_export = current_user_can( 'manage_options' ) || $is_gerente;			
			
            wp_localize_script( 'suite-api-js', 'suite_vars', [
                'ajax_url'   => admin_url( 'admin-ajax.php' ),
                'nonce'      => wp_create_nonce( 'suite_quote_nonce' ),
                'is_admin'   => current_user_can( 'manage_options' ),
                'rest_url'   => esc_url_raw( rest_url() ),
                'rest_nonce' => wp_create_nonce( 'wp_rest' ),
				'can_export' => $can_export
            ] );
        }
    }

	/**
     * Renderiza el contenido del shortcode.
     */
    public function render_app( $atts ) {
        
        // --- 1. BARRERA DE AUTENTICACI√ìN ---
        if ( ! is_user_logged_in() ) {
            return '<div style="padding:20px; text-align:center; font-family:sans-serif;">üîí Inicie sesi√≥n para acceder a la Intranet de RV Tech.</div>';
        }

        // --- 2. CONTROL DE ROLES DIN√ÅMICO (RBAC) ---
        // Se abandona el chequeo est√°tico de roles por validaci√≥n de Capacidades (Capabilities)
        $es_admin        = current_user_can( 'manage_options' );
        $can_view_crm    = $es_admin || current_user_can( 'suite_view_crm' );
        $can_view_kanban = $es_admin || current_user_can( 'suite_view_kanban' );
        $can_view_comis  = $es_admin || current_user_can( 'suite_view_commissions' );
        $can_view_logis  = $es_admin || current_user_can( 'suite_view_logistics' );
        $can_view_bi     = $es_admin || current_user_can( 'suite_view_marketing' );
        $can_manage_team = $es_admin || current_user_can( 'suite_manage_team' );

        // Si no tiene ning√∫n permiso, se bloquea el renderizado por completo
        if ( ! $es_admin && ! $can_view_crm && ! $can_view_kanban && ! $can_view_comis && ! $can_view_logis && ! $can_view_bi && ! $can_manage_team ) {
            return '<div style="padding:20px; text-align:center; color:#dc2626; font-family:sans-serif;">‚õî Acceso Denegado. Usted no tiene permisos asignados en el ERP.</div>';
        }

        // --- 3. PRE-CARGA DE DATOS PARA LAS VISTAS ---
        $clientes = [];
        $pedidos_logistica = [];

        // Datos para el CRM
        if ( $can_view_crm || $can_view_logis ) {
            $clientModel = new Suite_Model_Client();
            $clientes    = $clientModel->get_all( 200 );
        }

        // Datos para Almac√©n (Log√≠stica)
        if ( $can_view_logis || $can_view_kanban ) {
            $quoteModel = new Suite_Model_Quote();
            $kanban_data = $quoteModel->get_kanban_orders( null, true );
            $pedidos_logistica = isset( $kanban_data['por_enviar'] ) ? $kanban_data['por_enviar'] : [];
        }

        // --- 4. RENDERIZADO DEL HTML Y COMPONENTES ---
        ob_start();

        echo '<div class="suite-wrap">';
        
        // A. MEN√ö DE PESTA√ëAS (Renderizado din√°mico basado en permisos)
        echo '<div class="suite-tabs-modern">';
        
        // Pesta√±as Operativas Generales (Ventas y Administraci√≥n)
        if ( $can_view_crm ) {
            echo '<button class="tab-btn active" onclick="openSuiteTab(event, \'TabCli\')">üë• Clientes</button>';
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabPos\')">üìù Cotizador</button>';
			echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabHistorial\')">üìú Historial</button>';

        }

        if ( $can_view_kanban ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabKanban\')">üì¶ Pedidos</button>';
        }
        
        // Comisiones (Ventas)
        if ( $can_view_comis ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabComisiones\')">üèÜ Comisiones</button>';
        }
        
        // Pesta√±a Protegida: Log√≠stica
        if ( $can_view_logis ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabLogistica\')" style="color:#0369a1; font-weight:bold;">üöö Log√≠stica</button>';
        }
        
        // Pesta√±a Protegida: BI & Marketing
        if ( $can_view_bi ) {
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabMarketing\')" style="color:#dc2626; font-weight:bold;">üìà BI & Marketing</button>';
        }
		
		// Pesta√±a Protegida: Gesti√≥n de Equipo (RBAC)
        if ( $can_manage_team ) { 
            echo '<button class="tab-btn" onclick="openSuiteTab(event, \'TabEquipo\')" style="color:#0f172a; font-weight:bold;">‚öôÔ∏è Equipo y Accesos</button>';
        }
        
        echo '</div>'; // Fin men√∫ de pesta√±as

        // B. CARGA DE VISTAS (Inyecci√≥n de plantillas limpia y ordenada)
        if ( $can_view_crm ) {
            require SUITE_PATH . 'views/app/tab-clientes.php';
            require SUITE_PATH . 'views/app/tab-cotizador.php';
			require SUITE_PATH . 'views/app/tab-historial.php';
        }

        if ( $can_view_kanban ) {
            require SUITE_PATH . 'views/app/tab-kanban.php';
        }
        
        if ( $can_view_comis ) {
            require SUITE_PATH . 'views/app/tab-comisiones.php';
        }

        if ( $can_view_logis ) {
            require SUITE_PATH . 'views/app/tab-logistica.php';
        }
        
        if ( $can_view_bi ) {
            require SUITE_PATH . 'views/app/tab-marketing.php';
        }

		// Nuevo M√≥dulo de Equipo y Roles (RBAC)
        if ( $can_manage_team ) { 
            require SUITE_PATH . 'views/app/tab-equipo.php';
        }

        // C. INYECCI√ìN DEL MOTOR JAVASCRIPT UNIFICADO
        // Se inicializan din√°micamente solo los m√≥dulos que el usuario haya descargado (seg√∫n permisos)
        ?>
        <script>
            jQuery(document).ready(function($){
                
                // 1. INICIALIZACI√ìN SEGURA DE M√ìDULOS (Patr√≥n Factory)
                if (typeof SuiteCRM !== "undefined") SuiteCRM.init();
                if (typeof SuiteQuoter !== "undefined") SuiteQuoter.init();
                if (typeof SuiteKanban !== "undefined") SuiteKanban.init();
                if (typeof SuiteCommissions !== "undefined") SuiteCommissions.init();
                if (typeof SuiteLogistics !== "undefined") SuiteLogistics.init();
                if (typeof SuiteMarketing !== "undefined") SuiteMarketing.init();
				if (typeof SuiteEmployees !== "undefined") SuiteEmployees.init();
				if (typeof SuiteHistorial !== "undefined") SuiteHistorial.init();

                // 2. ENRUTADOR DE PESTA√ëAS (Manejo de estado visual y recargas as√≠ncronas)
                window.openSuiteTab = function(evt, name) {
                    
                    // Resetear la vista actual
                    $(".suite-tab-content").removeClass("active").hide();
                    $(".tab-btn").removeClass("active");
                    
                    // Activar la nueva pesta√±a
                    $("#" + name).fadeIn().addClass("active");
                    evt.currentTarget.classList.add("active");
                    
                    // Disparar las recargas de datos contextuales seg√∫n la pesta√±a que se abra
                    if (name === "TabKanban" && typeof SuiteKanban !== "undefined") {
                        SuiteKanban.loadBoard();
                    }
                    if (name === "TabComisiones" && typeof SuiteCommissions !== "undefined") {
                        SuiteCommissions.loadDashboard();
                    }
                    if (name === "TabMarketing" && typeof SuiteMarketing !== "undefined") {
                        SuiteMarketing.loadDashboard();
                    }
					if (name === "TabHistorial" && typeof SuiteHistorial !== "undefined") {
                        SuiteHistorial.refresh(); // <--- AGREGADO: Refresca el historial al abrir la pesta√±a
                    }
                };

            });
        </script>
        <?php

        echo '</div>'; // Fin .suite-wrap

        return ob_get_clean();
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Admin/class-suite-shortcode-controller.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Admin/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Controllers/Admin/index.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-client.php ---
<?php
/**
 * Controlador AJAX: Clientes (CRM)
 *
 * Maneja las peticiones del frontend relacionadas con los clientes (B√∫squeda, 
 * Creaci√≥n, Importaci√≥n, Perfiles y Eliminaci√≥n).
 * Hereda las validaciones de seguridad de Suite_AJAX_Controller.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. B√∫squeda predictiva de clientes
 */
class Suite_Ajax_Client_Search extends Suite_AJAX_Controller {
    protected $action_name = 'suite_search_client_ajax';
    protected $required_capability = 'read';

    protected function process() {
        $term = isset( $_POST['term'] ) ? sanitize_text_field( $_POST['term'] ) : '';
        if ( empty( $term ) ) {
            $this->send_success( [] );
        }

        $clientModel = new Suite_Model_Client();
        $resultados = $clientModel->search_clients( $term );
        $this->send_success( $resultados );
    }
}

/**
 * 2. Creaci√≥n manual de un cliente nuevo
 */
class Suite_Ajax_Client_Add extends Suite_AJAX_Controller {
    protected $action_name = 'suite_add_client_manual';
    protected $required_capability = 'read';

    protected function process() {
        $rif    = isset( $_POST['rif'] ) ? sanitize_text_field( $_POST['rif'] ) : '';
        $nombre = isset( $_POST['nombre'] ) ? sanitize_text_field( $_POST['nombre'] ) : '';

        if ( empty( $rif ) || empty( $nombre ) ) {
            $this->send_error( 'El RIF y el Nombre son obligatorios.' );
        }

        $clientModel = new Suite_Model_Client();
        
        $data = [
			'vendedor_id'  => get_current_user_id(), 
            'rif_ci'       => strtoupper( preg_replace( '/[^A-Z0-9]/', '', $rif ) ),
            'nombre_razon' => $nombre,
            'direccion'    => isset( $_POST['direccion'] ) ? sanitize_textarea_field( $_POST['direccion'] ) : '',
            'telefono'     => isset( $_POST['telefono'] ) ? sanitize_text_field( $_POST['telefono'] ) : '',
            'email'        => isset( $_POST['email'] ) ? sanitize_email( $_POST['email'] ) : '',
            'ciudad'       => isset( $_POST['ciudad'] ) ? sanitize_text_field( $_POST['ciudad'] ) : '',
            'estado'       => isset( $_POST['estado'] ) ? sanitize_text_field( $_POST['estado'] ) : '',
        ];

        $inserted = $clientModel->insert( $data );

        if ( $inserted ) {
            $this->send_success( [ 'message' => 'Cliente creado exitosamente.', 'id' => $inserted ] );
        } else {
            $this->send_error( 'Fallo al crear el cliente. Es posible que el RIF ya exista.' );
        }
    }
}

/**
 * 3. Importaci√≥n masiva de clientes v√≠a CSV
 */
class Suite_Ajax_Client_Import extends Suite_AJAX_Controller {
    protected $action_name = 'suite_import_clients_csv';
    protected $required_capability = 'read';

    protected function process() {
        if ( empty( $_FILES['csv_file'] ) || $_FILES['csv_file']['error'] !== UPLOAD_ERR_OK ) {
            $this->send_error( 'No se ha subido ning√∫n archivo o el archivo es inv√°lido.' );
        }

        $file = $_FILES['csv_file']['tmp_name'];
        $clientModel = new Suite_Model_Client();
        $inserted_count = 0;
        $row = 0;

        if ( ( $handle = fopen( $file, 'r' ) ) !== false ) {
            while ( ( $data = fgetcsv( $handle, 1000, ',' ) ) !== false ) {
                $row++;
                // Ignorar la cabecera
                if ( $row === 1 ) continue;

                // Acceso seguro a los √≠ndices del array fgetcsv
                $nombre = sanitize_text_field( isset($data[0]) ? $data[0] : '' );
                $rif    = sanitize_text_field( isset($data[1]) ? $data[1] : '' );

                if ( empty( $nombre ) || empty( $rif ) ) continue;

                $insert_data = [
                    'nombre_razon' => $nombre,
                    'rif_ci'       => strtoupper( preg_replace( '/[^A-Z0-9]/', '', $rif ) ),
                    'telefono'     => sanitize_text_field( isset($data[2]) ? $data[2] : '' ),
                    'email'        => sanitize_email( isset($data[3]) ? $data[3] : '' ),
                    'direccion'    => sanitize_textarea_field( isset($data[4]) ? $data[4] : '' ),
                ];

                if ( $clientModel->insert( $insert_data ) ) {
                    $inserted_count++;
                }
            }
            fclose( $handle );
            $this->send_success( "Importaci√≥n completada. Se a√±adieron {$inserted_count} clientes nuevos." );
        } else {
            $this->send_error( 'No se pudo leer el archivo CSV.' );
        }
    }
}

/**
 * 4. Eliminaci√≥n de un cliente
 */
class Suite_Ajax_Client_Delete extends Suite_AJAX_Controller {
    protected $action_name = 'suite_delete_client';
    protected $required_capability = 'read';

    protected function process() {
        // --- INICIO: MIDDLEWARE ZERO-TRUST (Prohibici√≥n de Hard-Delete) ---
        if ( ! current_user_can( 'manage_options' ) ) {
            $this->send_error( 'Acceso denegado. Solo un administrador puede eliminar registros permanentemente. Por favor, cambie el estado u oculte el registro.', 403 );
            return; // Detenemos la ejecuci√≥n inmediatamente
        }
        // --- FIN: ZERO-TRUST ---

        global $wpdb;
        $id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        
        if ( ! $id ) {
            $this->send_error( 'ID de cliente inv√°lido.' );
        }

        // BARRERA DE INTEGRIDAD REFERENCIAL
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';
        $tiene_compras = $wpdb->get_var( $wpdb->prepare( "SELECT COUNT(id) FROM {$tabla_cot} WHERE cliente_id = %d", $id ) );

        if ( $tiene_compras > 0 ) {
            $this->send_error( 'Protecci√≥n Contable: No puede eliminar un cliente con historial de compras. Edite sus datos si es necesario.', 403 );
        }

        $clientModel = new Suite_Model_Client();
        $deleted = $clientModel->delete( $id );

        if ( $deleted ) {
            $this->send_success( 'Cliente eliminado permanentemente.' );
        } else {
            $this->send_error( 'No se pudo eliminar el cliente.' );
        }
    }
}

/**
 * 5. Obtener el Perfil y KPIs de un cliente
 */
class Suite_Ajax_Client_Profile extends Suite_AJAX_Controller {
    protected $action_name = 'suite_get_client_profile';
    protected $required_capability = 'read';

    protected function process() {
        $id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        
        if ( ! $id ) {
            $this->send_error( 'ID de cliente inv√°lido.' );
        }

        $clientModel = new Suite_Model_Client();
        
        $cliente = $clientModel->get( $id );
        if ( ! $cliente ) {
            $this->send_error( 'El cliente no existe.', 404 );
        }

        $stats = $clientModel->get_client_stats( $id );
        $history = $clientModel->get_client_history( $id );

        // Formateo de las fechas de KPIs (Blindado para retrocompatibilidad y objetos nulos)
        $stats_fmt = [
            'total' => isset( $stats->total ) ? number_format( floatval( $stats->total ), 2 ) : '0.00',
            'count' => isset( $stats->count ) ? intval( $stats->count ) : 0,
            'first' => !empty( $stats->first ) ? date( 'd/m/Y', strtotime( $stats->first ) ) : '-',
            'last'  => !empty( $stats->last ) ? date( 'd/m/Y', strtotime( $stats->last ) ) : '-',
        ];

        // Formateo visual del historial
        $history_fmt = [];
        if ( ! empty( $history ) ) {
            foreach ( $history as $h ) {
                $history_fmt[] = [
                    'id'     => $h->id,
                    'fecha'  => date( 'd/m/Y', strtotime( $h->fecha ) ),
                    'codigo' => $h->codigo,
                    'total'  => number_format( floatval( $h->total ), 2 ),
                    'estado' => $h->estado,
                ];
            }
        }

        $this->send_success( [
            'cliente' => $cliente,
            'stats'   => $stats_fmt,
            'history' => $history_fmt
        ] );
    }
}

/**
 * Controlador AJAX: Registro de Auditor√≠a de Exportaciones
 * 
 * Registra en el log de la base de datos cada vez que un Administrador o Gerente
 * exporta informaci√≥n sensible en formato CSV o Excel.
 */
class Suite_Ajax_Log_Export extends Suite_AJAX_Controller {

    protected $action_name = 'suite_log_export';
    // Se requiere un nivel de acceso base, pero validaremos el rol exacto adentro
    protected $required_capability = 'read'; 

    protected function process() {
        // 1. DOBLE BARRERA DE SEGURIDAD (Zero-Trust)
        $user = wp_get_current_user();
        $roles = (array) $user->roles;
        
        // Comprobar si es Administrador o tiene el rol personalizado de gerente
        $is_admin = current_user_can( 'manage_options' );
        $is_gerente = in_array( 'suite_gerente', $roles ) || in_array( 'gerente', $roles );

        if ( ! $is_admin && ! $is_gerente ) {
            $this->send_error( 'Acceso Denegado. Violaci√≥n de seguridad registrada.', 403 );
        }

        // 2. RECIBIR DATOS
        $tabla = isset( $_POST['tabla'] ) ? sanitize_text_field( $_POST['tabla'] ) : 'Desconocida';
        
        // 3. REGISTRAR EN LA TABLA DE AUDITOR√çA
        global $wpdb;
        $table_logs = $wpdb->prefix . 'suite_logs';
        
        // La fecha y hora ('created_at') se insertan autom√°ticamente por MySQL (CURRENT_TIMESTAMP) [2]
        $wpdb->insert(
            $table_logs,
            [
                'usuario_id' => get_current_user_id(),
                'accion'     => 'exportacion_datos',
                'detalle'    => "Export√≥ la tabla {$tabla} en formato CSV/Excel",
                'ip'         => $_SERVER['REMOTE_ADDR']
            ]
        );

        $this->send_success( 'Auditor√≠a registrada.' );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-client.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-commissions.php ---
<?php
/**
 * Controlador AJAX: Dashboard Financiero y Gamificaci√≥n (M√≥dulo 4)
 *
 * Sirve los datos estad√≠sticos de comisiones y premios para la vista del vendedor.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Ajax_Dashboard_Stats extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_dashboard_stats';
    
    // Todos los empleados pueden ver las estad√≠sticas
    protected $required_capability = 'read'; 

    protected function process() {
        $vendedor_id = get_current_user_id();
        
        // Determinar mes y a√±o actual
        $mes  = (int) date('m');
        $anio = (int) date('Y');

        global $wpdb;
        $tabla_ledger = $wpdb->prefix . 'suite_comisiones_ledger';

        // 1. Obtener la comisi√≥n acumulada del vendedor solicitante en el mes actual
        $sql_comision = $wpdb->prepare(
            "SELECT SUM(comision_ganada_usd) 
             FROM {$tabla_ledger} 
             WHERE vendedor_id = %d 
             AND MONTH(created_at) = %d 
             AND YEAR(created_at) = %d",
            $vendedor_id, $mes, $anio
        );
        $comision_mes = floatval( $wpdb->get_var( $sql_comision ) );

        // 2. Obtener el ranking de Gamificaci√≥n desde el Modelo
        $commission_model = new Suite_Model_Commission();
        $gamification = $commission_model->get_gamification_winners( $mes, $anio );

        // Formateo visual para el frontend
        if ( $gamification['pez_gordo'] ) {
            $gamification['pez_gordo']->total_vendido = number_format( floatval( $gamification['pez_gordo']->total_vendido ), 2 );
        }
        
        // 3. Devolver los datos listos para pintar
        $this->send_success( [
            'mes_evaluado'    => date_i18n( 'F Y' ),
            'comision_actual' => number_format( $comision_mes, 2 ),
            'gamificacion'    => $gamification
        ] );
    }
}


/**
 * Endpoint Exclusivo Administrativo: Cierre de Mes (Freeze de Comisiones)
 * 
 * Convierte el estado 'pendiente' a 'pagado' congelando la modificaci√≥n del
 * Ledger contable.
 * ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-commissions.php
 */
class Suite_Ajax_Freeze_Commissions extends Suite_AJAX_Controller {

    protected $action_name = 'suite_freeze_commissions';
    protected $required_capability = 'read';

    protected function process() {
        // 1. Barrera Zero-Trust (Solo Administradores / Gerentes)
        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' );
        $is_gerente = in_array( 'suite_gerente', (array)$user->roles );

        if ( ! $is_admin && ! $is_gerente ) {
            $this->send_error( 'Acceso Denegado. Funci√≥n financiera exclusiva de gerencia.', 403 );
        }

        // Fecha de corte para evitar liquidar ventas de hoy si el cierre es del mes anterior
        $fecha_corte = isset( $_POST['fecha_corte'] ) ? sanitize_text_field( $_POST['fecha_corte'] ) : current_time('mysql');

        global $wpdb;
        $tabla_ledger = $wpdb->prefix . 'suite_comisiones_ledger';

        // 2. Congelamiento Masivo y At√≥mico (Update Bulk)
        $updated = $wpdb->query(
            $wpdb->prepare(
                "UPDATE {$tabla_ledger} 
                 SET estado_pago = 'pagado' 
                 WHERE estado_pago = 'pendiente' AND created_at <= %s",
                $fecha_corte
            )
        );

        if ( $updated !== false ) {
            // Opcional: Escribir en la tabla Logs de Auditor√≠a
            if ( function_exists('suite_record_log') ) {
                suite_record_log('cierre_mes', "Se ejecut√≥ el Cierre Contable de Comisiones. ({$updated} registros congelados hasta: {$fecha_corte}).");
            }
            $this->send_success( "Cierre de mes ejecutado exitosamente. Se han liquidado y congelado {$updated} comisiones en el sistema." );
        } else {
            $this->send_error( 'Ocurri√≥ un error en la base de datos al intentar congelar el Ledger.', 500 );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-commissions.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-controller.php ---
<?php
/**
 * Clase Abstracta: Controlador AJAX Base
 *
 * Centraliza la seguridad, el registro de hooks y las respuestas estandarizadas
 * para todas las peticiones AJAX del sistema.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

abstract class Suite_AJAX_Controller {

    /**
     * El nombre de la acci√≥n AJAX (Ej. 'suite_search_client_ajax')
     * @var string
     */
    protected $action_name;

    /**
     * El permiso m√≠nimo requerido para ejecutar esta acci√≥n.
     * @var string
     */
    protected $required_capability = 'read'; // Por defecto, cualquier usuario logueado en la intranet

    /**
     * Constructor.
     * Registra din√°micamente el hook wp_ajax bas√°ndose en $action_name.
     */
    public function __construct() {
        if ( empty( $this->action_name ) ) {
            // Evitar registro si la clase hija no defini√≥ el nombre de la acci√≥n
            return;
        }

        // Registrar el endpoint (Solo para usuarios logueados)
        add_action( 'wp_ajax_' . $this->action_name, [ $this, 'handle_request' ] );
    }

    /**
     * Manejador principal de la petici√≥n.
     * Ejecuta las barreras de seguridad antes de procesar la l√≥gica.
     */
    public function handle_request() {
        // 1. Barrera CSRF: Validaci√≥n de Nonce Estricto (Retrocompatibilidad)
        if ( ! check_ajax_referer( 'suite_quote_nonce', 'nonce', false ) ) {
            $this->send_error( 'Fallo de seguridad CSRF o sesi√≥n caducada.', 403 );
        }

        // 2. Barrera de Permisos: Verificaci√≥n del Rol del Usuario
        if ( ! current_user_can( $this->required_capability ) ) {
            $this->send_error( 'Privilegios insuficientes para realizar esta acci√≥n.', 401 );
        }

        // 3. Ejecutar la l√≥gica de negocio espec√≠fica de la clase hija
        $this->process();
    }

    /**
     * M√©todo abstracto que las clases hijas DEBEN implementar.
     * Aqu√≠ es donde ir√° la l√≥gica real (ej. buscar cliente, guardar cotizaci√≥n).
     */
    abstract protected function process();

    /**
     * Helper para enviar una respuesta exitosa estandarizada.
     *
     * @param mixed $data Los datos a devolver (Array, Objeto, String).
     */
    protected function send_success( $data = [] ) {
        wp_send_json_success( $data );
    }

    /**
     * Helper para enviar una respuesta de error estandarizada.
     *
     * @param string $message Mensaje de error para el frontend.
     * @param int    $code    C√≥digo HTTP simulado.
     */
    protected function send_error( $message, $code = 400 ) {
        wp_send_json_error( [
            'message' => $message,
            'code'    => $code
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-controller.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-employees.php ---
<?php
/**
 * Controlador AJAX: Gesti√≥n de Empleados (FASE 2-A)
 *
 * Maneja las operaciones CRUD de los usuarios/empleados del ERP.
 * Implementa seguridad estricta basada en capacidades (Zero-Trust).
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. Obtener lista de todos los empleados
 */
class Suite_Ajax_Employee_List extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_employees';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can('manage_options') && ! current_user_can('suite_manage_team') ) {
            $this->send_error('Acceso denegado', 403);
        }

        $model = new Suite_Model_Employee();
        $employees = $model->get_all_employees();

        $this->send_success( $employees );
    }
}

/**
 * 2. Crear o Editar un Empleado
 */
class Suite_Ajax_Employee_Save extends Suite_AJAX_Controller {

    protected $action_name = 'suite_save_employee';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can('manage_options') && ! current_user_can('suite_manage_team') ) {
            $this->send_error('Acceso denegado', 403);
        }

        // Recibir y mapear los datos del POST
        $data = [
            'ID'         => isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0,
            'email'      => isset( $_POST['email'] ) ? sanitize_email( $_POST['email'] ) : '',
            'password'   => isset( $_POST['password'] ) ? $_POST['password'] : '',
            'first_name' => isset( $_POST['first_name'] ) ? sanitize_text_field( $_POST['first_name'] ) : '',
            'last_name'  => isset( $_POST['last_name'] ) ? sanitize_text_field( $_POST['last_name'] ) : '',
            'role'       => isset( $_POST['role'] ) ? sanitize_text_field( $_POST['role'] ) : '',
            'telefono'   => isset( $_POST['telefono'] ) ? sanitize_text_field( $_POST['telefono'] ) : '',
        ];

        // Validaciones b√°sicas de campos obligatorios
        if ( empty( $data['email'] ) ) {
            $this->send_error( 'El correo electr√≥nico es obligatorio.' );
        }

        $model = new Suite_Model_Employee();
        $result = $model->save_employee( $data );

        // Manejo de errores devueltos por el Modelo
        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message() );
        }

        $this->send_success( [
            'message' => 'Empleado guardado correctamente.',
            'user_id' => $result
        ] );
    }
}

/**
 * 3. Eliminar un Empleado
 */
class Suite_Ajax_Employee_Delete extends Suite_AJAX_Controller {

    protected $action_name = 'suite_delete_employee';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can('manage_options') && ! current_user_can('suite_manage_team') ) {
            $this->send_error('Acceso denegado', 403);
        }

        $id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;

        if ( ! $id ) {
            $this->send_error( 'ID de empleado inv√°lido.' );
        }

        // Prevenci√≥n de auto-eliminaci√≥n
        if ( get_current_user_id() === $id ) {
            $this->send_error( 'Seguridad: No puedes eliminar tu propia cuenta desde el ERP.', 403 );
        }

        $model = new Suite_Model_Employee();
        $result = $model->delete_employee( $id );

        // Manejo de errores devueltos por el Modelo
        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message() );
        }

        $this->send_success( 'Empleado eliminado correctamente.' );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-employees.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-kanban.php ---
<?php
/**
 * Controlador AJAX: Tablero Kanban (M√≥dulo 1)
 *
 * Contiene los manejadores para poblar las columnas del Kanban 
 * y actualizar los estados tras un evento Drag & Drop.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Endpoint para obtener todos los pedidos y poblar el Tablero Kanban
 */
class Suite_Ajax_Kanban_Data extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_kanban_data';
    protected $required_capability = 'read';

	protected function process() {
        $user_id = get_current_user_id();
        $user = wp_get_current_user();
        
        // Row-Level Security (Control de Accesos M√≥dulo 2)
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        // AGREGADO: Validaci√≥n de gerente consultando directamente el objeto $user
        $is_gerente = in_array( 'suite_gerente', (array) $user->roles ) || in_array( 'gerente', (array) $user->roles );
        
        $tiene_acceso_global = ( $is_admin || $is_logistica || $is_gerente );

        $quote_model = new Suite_Model_Quote();
        
        // Invocar m√©todo del modelo agrupando por columnas
        $kanban_data = $quote_model->get_kanban_orders( $user_id, $tiene_acceso_global );

        $this->send_success( $kanban_data );
    }
}

/**
 * Endpoint para procesar el Drop de una tarjeta en una nueva columna
 */
class Suite_Ajax_Kanban_Status extends Suite_AJAX_Controller {

    protected $action_name = 'suite_update_kanban_status';
    protected $required_capability = 'read';

    protected function process() {
        // 1. Recibir datos del Frontend (Drag & Drop)
        $quote_id   = isset( $_POST['quote_id'] ) ? intval( $_POST['quote_id'] ) : 0;
        $new_status = isset( $_POST['status'] ) ? sanitize_text_field( $_POST['status'] ) : '';

        if ( ! $quote_id || empty( $new_status ) ) {
            $this->send_error( 'Par√°metros insuficientes para mover la tarjeta.' );
        }

        // TODO: [M√≥dulo 2 - Seguridad] 
        // Implementar Candado de Inmutabilidad aqu√≠:
        // Si la cotizaci√≥n ya estaba en "pagado" y el usuario no es Admin/Supervisor, 
        // bloquear el retroceso a "emitida".

        // 2. Instanciar y actualizar
        $quote_model = new Suite_Model_Quote();
        $updated = $quote_model->update_order_status( $quote_id, $new_status );

        // 3. Respuesta
        if ( $updated ) {
            $this->send_success( [ 'message' => 'El pedido fue movido correctamente a ' . strtoupper( $new_status ) ] );
        } else {
            $this->send_error( 'Fallo al mover el pedido. Es posible que ya estuviese en ese estado.' );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-kanban.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-logistics.php ---
<?php
/**
 * Controlador AJAX: Log√≠stica y Despacho (M√≥dulo 3)
 *
 * Maneja la subida del comprobante de entrega (Proof of Delivery) 
 * y la impresi√≥n blindada de Hojas de Picking para el almac√©n.
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Endpoint 1: Subida de Gu√≠a / Foto de Entrega (Proof of Delivery)
 */
class Suite_Ajax_Upload_POD extends Suite_AJAX_Controller {

    protected $action_name = 'suite_upload_pod';
    protected $required_capability = 'read';

    protected function process() {
        // 1. SEGURIDAD: Control Estricto de Rol (Solo Log√≠stica y Admin)
        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );

        if ( ! $is_admin && ! $is_logistica ) {
            if ( function_exists('suite_record_log') ) {
                suite_record_log( 'violacion_acceso', "Intento de escalada de privilegios en POD por el usuario " . get_current_user_id() );
            }
            $this->send_error( 'Acceso Denegado: Solo el personal de almac√©n/log√≠stica puede confirmar despachos.', 403 );
        }

        $quote_id = isset( $_POST['quote_id'] ) ? intval( $_POST['quote_id'] ) : 0;
        
        if ( ! $quote_id ) {
            $this->send_error( 'ID de pedido inv√°lido.', 400 );
        }

        // Validar que se envi√≥ un archivo
        if ( empty( $_FILES['pod_file'] ) ) {
            $this->send_error( 'No se recibi√≥ ning√∫n archivo.', 400 );
        }

        $file = $_FILES['pod_file'];

        // 2. CANDADO DE INMUTABILIDAD
        global $wpdb;
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';
        $current_status = $wpdb->get_var( $wpdb->prepare( "SELECT estado FROM {$tabla_cot} WHERE id = %d", $quote_id ) );

        if ( strtolower( $current_status ) === 'despachado' ) {
            $this->send_error( 'El pedido ya se encuentra despachado.', 403 );
        }

        // Configurar el entorno para la subida nativa de WP
        if ( ! function_exists( 'wp_handle_upload' ) ) {
            require_once( ABSPATH . 'wp-admin/includes/file.php' );
        }

        $upload_overrides = [ 'test_form' => false ];
        $movefile = wp_handle_upload( $file, $upload_overrides );

        if ( $movefile && ! isset( $movefile['error'] ) ) {
            $file_url = $movefile['url'];

            // Actualizar la base de datos
            $wpdb->update(
                $tabla_cot,
                [ 
                    'pod_url' => esc_url_raw( $file_url ), // sanitizamos URL
                    'estado'  => 'despachado' 
                ],
                [ 'id' => $quote_id ],
                [ '%s', '%s' ],
                [ '%d' ]
            );

            // DESCUENTO DE INVENTARIO LOG√çSTICO (Si aplica en tu flujo)
            //$quote_model = new Suite_Model_Quote();
            //$quote_model->process_inventory_discount( $quote_id );

            $this->send_success( [
                'message' => 'Comprobante subido y pedido despachado correctamente.',
                'url'     => $file_url
            ] );
        } else {
            // PREVENCI√ìN INFO DISCLOSURE: Loguear internamente, pero mostrar un mensaje gen√©rico al usuario
            error_log( 'Suite ERP Upload Error: ' . $movefile['error'] );
            $this->send_error( 'Error de servidor al procesar el archivo. Contacte a soporte t√©cnico.', 500 );
        }
    }
}

/**
 * Endpoint 2: Impresi√≥n de Hoja de Picking (Sin Precios)
 */
class Suite_Ajax_Print_Picking extends Suite_AJAX_Controller {

    protected $action_name = 'suite_print_picking';
    protected $required_capability = 'read';

    public function handle_request() {
        if ( ! isset( $_GET['nonce'] ) || ! wp_verify_nonce( $_GET['nonce'], 'suite_quote_nonce' ) ) {
            wp_die( 'Enlace caducado o inv√°lido por seguridad (CSRF).', 'Acceso Denegado', [ 'response' => 403 ] );
        }
        
        $this->process();
    }

    protected function process() {
        // SEGURIDAD: Control Estricto de Rol para Log√≠stica
        $user = wp_get_current_user();
        $roles = (array) $user->roles;
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', $roles );

        if ( ! $is_admin && ! $is_logistica ) {
            wp_die( 'Privilegios insuficientes. Se requiere el rol de Log√≠stica para generar hojas de picking.', 'Acceso Denegado', [ 'response' => 403 ] );
        }

        global $wpdb;
        $quote_id = isset( $_GET['id'] ) ? intval( $_GET['id'] ) : 0;
        
        if ( ! $quote_id ) wp_die( 'ID de pedido inv√°lido.' );

        $quote_model = new Suite_Model_Quote();
        $cot = $quote_model->get( $quote_id );
        
        if ( ! $cot ) wp_die( 'Pedido no encontrado en la base de datos.' );

        $table_items = $wpdb->prefix . 'suite_cotizaciones_items';
        $items = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM {$table_items} WHERE cotizacion_id = %d", $quote_id ) );

        // RENDER DE VISTA DE IMPRESI√ìN (SOLO HTML CORREGIDO)
        ?>
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Picking_#<?php echo esc_attr( $cot->codigo_cotizacion ); ?></title>
            <style>
                body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 20px; color: #111827; }
                .header { text-align: center; border-bottom: 3px solid #0f172a; padding-bottom: 15px; margin-bottom: 25px; }
                .header h2 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
                .header h3 { margin: 5px 0 0 0; font-size: 18px; color: #475569; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                .info-box { border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; }
                .info-box p { margin: 5px 0; font-size: 14px; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; font-size: 14px; }
                th { background-color: #f8fafc; text-transform: uppercase; font-size: 12px; color: #64748b; }
                .qty-box { font-size: 18px; font-weight: bold; text-align: center; }
                .check-box { width: 40px; text-align: center; }
                .footer-signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 50px; }
                .sign-line { border-top: 1px dashed #94a3b8; padding-top: 10px; text-align: center; font-size: 13px; font-weight: bold; color: #475569; }
                @media print { body { -webkit-print-color-adjust: exact; } }
            </style>
        </head>
        <body onload="window.print()">
            <div class="header">
                <h2>üì¶ HOJA DE PICKING Y DESPACHO</h2>
                <h3>Orden / Pedido: #<?php echo esc_html( $cot->codigo_cotizacion ); ?></h3>
            </div>
            
            <div class="info-grid">
                <div class="info-box">
                    <p><strong>Destinatario:</strong> <?php echo esc_html( $cot->cliente_nombre ); ?></p>
                    <p><strong>RIF / DNI:</strong> <?php echo esc_html( $cot->cliente_rif ); ?></p>
                    <p><strong>M√©todo Entrega:</strong> <?php echo esc_html( $cot->metodo_entrega ? $cot->metodo_entrega : 'N/A' ); ?></p>
                </div>
                <div class="info-box">
                    <p><strong>Fecha Generaci√≥n:</strong> <?php echo date('d/m/Y h:i A'); ?></p>
                    <p><strong>Direcci√≥n:</strong></p>
                    <p style="margin-top: 2px; color: #334155; font-style: italic;">
                        <?php echo nl2br( esc_html( $cot->direccion_entrega ) ); ?>
                    </p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">SKU</th>
                        <th style="width: 60%;">Descripci√≥n del Producto (Ubicaci√≥n)</th>
                        <th style="width: 15%; text-align: center;">Cantidad</th>
                        <th class="check-box">Verif.</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ( $items as $item ) : ?>
                    <tr>
                        <td style="font-family: monospace; font-size: 15px;"><strong><?php echo esc_html( $item->sku ); ?></strong></td>
                        <td><?php echo esc_html( $item->producto_nombre ); ?></td>
                        <td class="qty-box"><?php echo intval( $item->cantidad ); ?></td>
                        <td class="check-box"><div style="width:20px; height:20px; border: 2px solid #ccc; margin: 0 auto;"></div></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <div class="footer-signatures">
                <div class="sign-line">Preparado y Embalado por (Firma)</div>
                <div class="sign-line">Despachado / Entregado por (Firma)</div>
            </div>
        </body>
        </html>
        <?php
        exit;
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-logistics.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-products.php ---
<?php
/**
 * Controlador AJAX: B√∫squeda de Productos (Cotizador)
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Ajax_Get_Products extends Suite_AJAX_Controller {

    protected $action_name = 'suite_search_pos';
    protected $required_capability = 'read';

    protected function process() {
        $term = isset( $_POST['term'] ) ? sanitize_text_field( $_POST['term'] ) : '';

        // Detenemos peticiones vac√≠as por seguridad y rendimiento
        if ( empty( $term ) || strlen( $term ) < 3 ) {
            $this->send_success( [] );
        }

        // Importante: No es necesario requerir el archivo del modelo aqu√≠ si ya lo cargamos en suite-empleados.php
        $product_model = new Suite_Model_Product();
        $resultados = $product_model->get_products_with_csv_prices( $term );

        $this->send_success( $resultados );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-products.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-quotes.php ---
<?php
/**
 * Controlador AJAX: Cotizador y Venta (M√≥dulo 2: Seguridad Aplicada)
 *
 * Contiene los manejadores para guardar cotizaciones, consultar el historial 
 * y cambiar estados (con candado de inmutabilidad y protecci√≥n IDOR).
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. Endpoint para Guardar Cotizaciones y Actualizar Clientes
 */
class Suite_Ajax_Quote_Save extends Suite_AJAX_Controller {

    protected $action_name = 'suite_save_quote_crm'; 
    protected $required_capability = 'read';

    protected function process() {
        // 1. Recibir datos del frontend
        $client_data = [
			'vendedor_id'      => get_current_user_id(),
            'rif_ci'           => isset( $_POST['rif'] ) ? $_POST['rif'] : '',
            'nombre_razon'     => sanitize_text_field( $_POST['nombre'] ),
            'direccion'        => sanitize_textarea_field( $_POST['direccion'] ),
            'telefono'         => sanitize_text_field( $_POST['telefono'] ),
            'email'            => sanitize_email( $_POST['email'] ),
            'ciudad'           => sanitize_text_field( $_POST['ciudad'] ),
            'estado'           => sanitize_text_field( $_POST['estado'] ),
            'contacto_persona' => sanitize_text_field( $_POST['contacto'] ),
            'notas'            => sanitize_textarea_field( $_POST['notas'] )
        ];

        // 2. MODO ACTUALIZACI√ìN DE PERFIL
        $is_update_only = isset( $_POST['is_update_only'] ) && $_POST['is_update_only'] == 'true';
        if ( $is_update_only ) {
            $client_id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
            if ( $client_id > 0 ) {
                $client_model = new Suite_Model_Client();
                $client_model->update( $client_id, $client_data );
                $this->send_success( [ 'message' => 'Perfil actualizado correctamente.' ] );
            }
            $this->send_error( 'ID de cliente inv√°lido.' );
            return;
        }

        // 3. MODO CREAR COTIZACI√ìN
        $items = isset( $_POST['items'] ) && is_array( $_POST['items'] ) ? $_POST['items'] : [];
        if ( empty( $items ) ) {
            $this->send_error( 'El carrito no puede estar vac√≠o.' );
        }

        // M√ìDULO 2: SEGURIDAD - CONTROL DE PRECIOS M√çNIMOS (MIDDLEWARE OPTIMIZADO N+1)
        global $wpdb;
        $tabla_inv = $wpdb->prefix . 'suite_inventario_cache';
        $is_admin = current_user_can( 'manage_options' );

        // Si es admin, nos saltamos la validaci√≥n en BD para ahorrar recursos
        if ( ! $is_admin && ! empty( $items ) ) {
            $skus_a_verificar = [];
            foreach ( $items as $item ) {
                $sku = sanitize_text_field( $item['sku'] );
                if ( ! in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                    $skus_a_verificar[] = $sku;
                }
            }

            if ( ! empty( $skus_a_verificar ) ) {
                // 1. Pre-cargar precios permitidos con un solo query (IN)
                $placeholders = implode( ',', array_fill( 0, count( $skus_a_verificar ), '%s' ) );
                $sql_precios = $wpdb->prepare( "SELECT sku, precio FROM {$tabla_inv} WHERE sku IN ($placeholders)", ...$skus_a_verificar );
                // Usamos OBJECT_K para que el array resultante tenga los SKUs como llaves
                $resultados_precios = $wpdb->get_results( $sql_precios, OBJECT_K );

                // 2. Validar precios en memoria
                foreach ( $items as $item ) {
                    $sku = strtoupper( sanitize_text_field( $item['sku'] ) );

                    if ( isset( $resultados_precios[$sku] ) ) {
                        $minimum_price = floatval( $resultados_precios[$sku]->precio );
                        $selling_price = floatval( $item['price'] );

                        if ( $selling_price < $minimum_price ) {
                            $precio_fmt = number_format( $minimum_price, 2 );
                            $this->send_error( "El precio del producto '{$item['name']}' ({$sku}) est√° por debajo del m√≠nimo permitido (\${$precio_fmt}). Requiere autorizaci√≥n de un supervisor.", 403 );
                        }
                    }
                }
            }
        }

        $meta = [
            'vendedor_id' => get_current_user_id(),
            'tasa'        => floatval( $_POST['tasa'] ),
            'validez'     => intval( $_POST['validez'] ),
            'moneda'      => sanitize_text_field( $_POST['moneda'] )
        ];

        // 4. Instanciar Modelo y Guardar
        $quote_model = new Suite_Model_Quote();
        $result = $quote_model->create_quote( $client_data, $items, $meta );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message(), 500 );
        }

        $this->send_success( $result );
    }
}

/**
 * 2. Endpoint para Listar el Historial de Cotizaciones
 */
class Suite_Ajax_Quote_History extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_history_ajax';
    protected $required_capability = 'read';

    protected function process() {
        $user_id = get_current_user_id();
        $user = wp_get_current_user();
        
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        $tiene_acceso_global = ( $is_admin || $is_logistica );

        $quote_model = new Suite_Model_Quote();
        $history = $quote_model->get_vendor_history( $user_id, 50, $tiene_acceso_global );

        foreach ( $history as $r ) {
            $r->fecha_fmt = date( 'd/m/Y', strtotime( $r->fecha_emision ) );
            $r->total_fmt = number_format( floatval( $r->total_usd ), 2 );
            $r->cliente_nombre = empty( $r->cliente_nombre ) ? 'N/A' : esc_html( $r->cliente_nombre );

            $raw_tel = isset( $r->cliente_telefono ) ? $r->cliente_telefono : '';
            $wa_phone = preg_replace( '/[^0-9]/', '', $raw_tel );
            
            if ( strlen( $wa_phone ) === 11 && strpos( $wa_phone, '0' ) === 0 ) {
                $wa_phone = '58' . substr( $wa_phone, 1 );
            } elseif ( strlen( $wa_phone ) === 10 ) {
                $wa_phone = '58' . $wa_phone;
            }
            $r->wa_phone = $wa_phone;

            if ( empty( $r->estado ) ) {
                $r->estado = 'emitida';
            }
            $r->can_change_status = $tiene_acceso_global;
        }

        $this->send_success( $history );
    }
}

/**
 * 3. Endpoint para Cambiar el Estado de una Cotizaci√≥n (Manual / Kanban)
 * Modificado para M√≥dulo 4: Recibe comprobantes y dispara comisiones.
 */
class Suite_Ajax_Quote_Status extends Suite_AJAX_Controller {

    protected $action_name = 'suite_change_status_ajax'; 
    protected $required_capability = 'read';

    protected function process() {
        $quote_id   = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;
        $new_status = isset( $_POST['estado'] ) ? strtolower( sanitize_text_field( $_POST['estado'] ) ) : '';

        if ( ! $quote_id || empty( $new_status ) ) {
            $this->send_error( 'Datos insuficientes para cambiar el estado.' );
        }

        $quote_model = new Suite_Model_Quote();
        $current_order = $quote_model->get( $quote_id );

        if ( ! $current_order ) {
            $this->send_error( 'La cotizaci√≥n no existe.', 404 );
        }

        $is_admin = current_user_can( 'manage_options' );

        // 1. SEGURIDAD: PREVENCI√ìN DE IDOR
        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' );
        $is_logistica = in_array( 'suite_logistica', (array) $user->roles );
        $is_owner = ( intval( $current_order->vendedor_id ) === get_current_user_id() );

        // 1. SEGURIDAD: PREVENCI√ìN DE IDOR (Con Bypass para Log√≠stica)
        if ( ! $is_admin && ! $is_owner ) {
            // Permitir SOLO si es Log√≠stica y est√° intentando mover a 'despachado'
            if ( ! ( $is_logistica && $new_status === 'despachado' ) ) {
                if ( function_exists('suite_record_log') ) {
                    suite_record_log( 'violacion_idor', "Usuario " . get_current_user_id() . " intent√≥ modificar el pedido #{$quote_id}." );
                }
                $this->send_error( 'Acceso Denegado: No tiene permisos para modificar un pedido que no le pertenece.', 403 );
            }
        }

        $current_status = strtolower( $current_order->estado );
        $protected_statuses = [ 'pagado', 'despachado' ];

        // 2. CANDADO DE INMUTABILIDAD
        if ( in_array( $current_status, $protected_statuses ) && ! $is_admin ) {
            $this->send_error( 'Candado de Inmutabilidad üîí: Este pedido ya ha sido procesado y no puede ser modificado.', 403 );
        }
		
        // --- INICIO INYECCI√ìN: EVENTO DE LOG√çSTICA INVERSA ---
        if ( $current_status === 'despachado' && $new_status === 'proceso' ) {
            // Re-verificaci√≥n estricta (Zero-Trust)
            if ( ! current_user_can( 'manage_options' ) ) {
                $this->send_error( 'Acceso Denegado. Solo el Administrador puede aplicar Log√≠stica Inversa.', 403 );
            }
            // Registro obligatorio en el historial
            if ( function_exists('suite_record_log') ) {
                suite_record_log( 'logistica_inversa', "Log√≠stica Inversa: El Administrador (ID: " . get_current_user_id() . ") revirti√≥ el pedido #{$quote_id} de 'despachado' a 'proceso'." );
            }
            
            // Nota de Arquitectura: Si el m√≥dulo descuenta inventario f√≠sico al llegar a 'despachado', 
            // este es el punto exacto para invocar una funci√≥n que restaure dicho stock.
        }
        // --- FIN INYECCI√ìN ---

		// CORRECCI√ìN 1: Se agreg√≥ 'por_enviar' al array de estados v√°lidos
        $estados_validos = ['emitida', 'proceso', 'pagado', 'por_enviar', 'anulado', 'despachado'];
        if ( ! in_array( $new_status, $estados_validos ) ) {
            $this->send_error( 'Estado no v√°lido.', 400 );
        }

        // 3. M√ìDULO 4: CAPTURAR DATOS DE CIERRE DE VENTA
        if ( $new_status === 'pagado' ) {
            $recibo = isset($_POST['recibo_loyverse']) ? sanitize_text_field($_POST['recibo_loyverse']) : '';
            
            // CORRECCI√ìN 2: Validar Unicidad del Recibo en la Base de Datos
            if ( ! empty( $recibo ) ) {
                global $wpdb;
                $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';
                
                // Buscamos si el recibo ya existe en OTRO pedido distinto al que estamos procesando
                $existe = $wpdb->get_var( $wpdb->prepare( "SELECT id FROM {$tabla_cot} WHERE recibo_loyverse = %s AND id != %d", $recibo, $quote_id ) );
                
                if ( $existe ) {
                    $this->send_error( 'El n√∫mero de recibo o factura (' . esc_html($recibo) . ') ya est√° asignado al pedido #' . $existe . '. No se permiten duplicados.', 400 );
                    return; // Detenemos la ejecuci√≥n inmediatamente
                }
            }

            $extra_data = [
                'canal_venta'      => isset($_POST['canal_venta']) ? sanitize_text_field($_POST['canal_venta']) : '',
                'metodo_pago'      => isset($_POST['metodo_pago']) ? sanitize_text_field($_POST['metodo_pago']) : '',
                'metodo_entrega'   => isset($_POST['metodo_entrega']) ? sanitize_text_field($_POST['metodo_entrega']) : '',
                'url_captura_pago' => isset($_POST['url_captura']) ? esc_url_raw($_POST['url_captura']) : '',
                'recibo_loyverse'  => $recibo,
            ];
            $quote_model->update( $quote_id, $extra_data );
        }

        // 4. CAMBIAR ESTADO
        $result = $quote_model->update_order_status( $quote_id, $new_status );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message(), 500 );
        }

        if ( $result ) {
			
			// 5. DISPARAR COMISI√ìN AUTOM√ÅTICA
			if ( $new_status === 'pagado' && $current_status !== 'pagado' ) {
				$commission_model = new Suite_Model_Commission();

				// Recepci√≥n y Sanitizaci√≥n Estricta (Casteo de cada elemento a Integer)
				$colaboradores_raw = isset( $_POST['colaboradores'] ) ? $_POST['colaboradores'] : [];
				$colaboradores_clean = is_array( $colaboradores_raw ) ? array_map( 'intval', $colaboradores_raw ) : [];

				$commission_model->calculate_and_save_commission(
					$quote_id,
					$current_order->vendedor_id,
					$current_order->total_usd,
					$colaboradores_clean // <-- 4TO PAR√ÅMETRO INYECTADO
				);
			}

            $this->send_success( [ 'message' => 'Estado actualizado a ' . strtoupper( $new_status ) ] );
        } else {
            $this->send_error( 'Error al actualizar la base de datos o el estado ya era el mismo.' );
        }
    }
}


/**
 * Endpoint para Imprimir Cotizaci√≥n en PDF/HTML (Sustituye a mod-impresion.php)
 */
class Suite_Ajax_Print_Quote extends Suite_AJAX_Controller {

    protected $action_name = 'suite_print_quote';
    protected $required_capability = 'read';

    public function handle_request() {
        if ( ! isset( $_GET['nonce'] ) || ! wp_verify_nonce( $_GET['nonce'], 'suite_quote_nonce' ) ) {
            wp_die( 'Enlace caducado o inv√°lido por seguridad (CSRF).', 'Acceso Denegado', [ 'response' => 403 ] );
        }
        $this->process();
    }

    protected function process() {
        if ( ! current_user_can( 'read' ) ) {
            wp_die( 'Privilegios insuficientes.', 'Acceso Denegado', [ 'response' => 403 ] );
        }

        global $wpdb;
        $id = isset( $_GET['id'] ) ? intval( $_GET['id'] ) : 0;

        // 1. OBTENER DATOS PRINCIPALES
        $cot = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_cotizaciones WHERE id = %d", $id ) );
        if ( ! $cot ) wp_die( 'Cotizaci√≥n no encontrada.', 'Error', [ 'response' => 404 ] );

        $items = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_cotizaciones_items WHERE cotizacion_id = %d", $id ) );

        // 2. OBTENER DATOS EXTENDIDOS DEL CLIENTE
        $cliente_extra = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_clientes WHERE id = %d", $cot->cliente_id ) );

        // 3. DATOS VENDEDOR
        $vendedor = get_userdata( $cot->vendedor_id );
        $vendedor_nombre = $vendedor ? $vendedor->display_name : 'Equipo de Ventas';
        $tel_db = get_user_meta($cot->vendedor_id, 'suite_telefono', true);
        $vendedor_telefono = !empty($tel_db) ? $tel_db : "+58 424-844-2132";

        // 4. L√ìGICA DE MONEDA (USD vs BS)
        $es_bolivares = ( $cot->moneda === 'BS' );
        $simbolo = $es_bolivares ? 'Bs.' : '$';
        $tasa_calc = $es_bolivares ? floatval( $cot->tasa_bcv ) : 1;

        // 5. C√ÅLCULOS TOTALES
        $subtotal_base = floatval( $cot->total_usd ) * $tasa_calc;
        $descuento = 0; 
        $base_imponible = $subtotal_base - $descuento;
        $iva_pct = 0.16;
        $monto_iva = $base_imponible * $iva_pct;
        $total_final = $base_imponible + $monto_iva;

        // Formateo
        $subtotal_fmt = number_format( $subtotal_base, 2 );
        $iva_fmt = number_format( $monto_iva, 2 );
        $total_fmt = number_format( $total_final, 2 );

        // L√ìGICA DE LIMPIEZA DE DATOS
        $validar_dato = function($val) {
            return (!empty($val) && $val !== 'N/A' && $val !== 'N/D');
        };

        $show_dir = $validar_dato($cot->direccion_entrega) ? $cot->direccion_entrega : false;
        
        $ciudad_raw = isset($cliente_extra->ciudad) ? $cliente_extra->ciudad : '';
        $estado_raw = isset($cliente_extra->estado) ? $cliente_extra->estado : '';
        $show_ubicacion = trim("$ciudad_raw $estado_raw");
        if(!$validar_dato($show_ubicacion)) $show_ubicacion = false;

        $show_atencion = (isset($cliente_extra->contacto_persona) && $validar_dato($cliente_extra->contacto_persona)) ? $cliente_extra->contacto_persona : false;
        $tel_raw = (isset($cliente_extra->telefono) && $validar_dato($cliente_extra->telefono)) ? "Telf: " . $cliente_extra->telefono : '';
        $email_raw = (isset($cliente_extra->email) && $validar_dato($cliente_extra->email)) ? "Email: " . $cliente_extra->email : '';
        $show_contacto = trim("$tel_raw $email_raw");
        
        if(empty($tel_raw) && empty($email_raw)) $show_contacto = false;

		// --- INICIO HTML ---
        ?>
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Cotizaci√≥n #<?php echo esc_attr( $cot->codigo_cotizacion ); ?></title>
            <style>
                /* REGLAS MAESTRAS DE IMPRESI√ìN Y COLORES */
                * {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                    color-adjust: exact !important;
                }
                @media print {
                    @page { margin: 1cm; size: letter portrait; }
                    body { margin: 0; padding: 0; }
                }
                
                /* TIPOGRAF√çA √öNICA Y GLOBAL */
                body { 
                    font-family: Arial, Helvetica, sans-serif; 
                    padding: 30px; 
                    color: #555555; 
                    font-size: 12px; 
                    margin: 0;
                }
                
                /* CLASES DE COLORES ESPEC√çFICAS */
                .text-gray { color: #555555 !important; }
                .text-black-bold { color: #000000 !important; font-weight: bold !important; }
                .text-red-bold { color: #d0121b !important; font-weight: bold !important; }
                .bg-red-unit { background-color: #d0121b !important; color: #ffffff !important; }
                
                /* SEPARADORES */
                .separator-red { border: none; border-top: 2px solid #d0121b; margin: 15px 0; }
                .separator-light { border: none; border-top: 1px solid #e5e7eb; margin: 8px 0 12px 0; }
                .separator-elegant { border: none; border-top: 1px solid #d1d5db; margin: 18px 0; }
                
                /* =========================================
                   ENCABEZADO: LOGO (IZQ) / COTIZACI√ìN (DER) 
                   ========================================= */
                .header-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
                .header-table td { vertical-align: top; }
                
                /* IZQUIERDA: LOGO Y EMPRESA */
                .header-left { width: 55%; padding-right: 20px; text-align: left; }
                .empresa-info-container img { height: 60px; margin-bottom: 8px; }
                .empresa-info { font-size: 11px; line-height: 1.4; }
                
                /* DERECHA: COTIZACI√ìN */
                .header-right { width: 45%; text-align: right; }
                .cotizacion-title { 
                    margin: 0 0 5px 0; 
                    font-size: 18px; /* Elegante y proporcionado */
                    letter-spacing: 2px; 
                    font-weight: bold;
                    color: #000;
					text-align: left;
                }
                .separator-header-right { border-bottom: 1px solid #d1d5db; margin: 5px 0 10px auto; width: 100%; }
                
                .cotizacion-datos { border-collapse: collapse; font-size: 12px; text-align: left; width: 100%; }
                .cotizacion-datos td { padding: 3px 0; }
                .cotizacion-datos td:first-child { width: 80px; } 
                
                /* =========================================
                   DATOS DEL CLIENTE
                   ========================================= */
                .client-box { 
                    border: 1px solid #d1d5db; 
                    padding: 15px; 
                    border-radius: 8px; /* Esquinas curvas */
                    margin-bottom: 25px; /* Espaciado antes de la tabla */
                }
                .client-title { font-size: 13px; margin: 0; }
                .client-table { width: 100%; border-collapse: collapse; font-size: 11px; }
                .client-table td { padding: 5px 0; vertical-align: top; border: none; }
                
                /* =========================================
                   TABLA DE PRODUCTOS
                   ========================================= */
                .products-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
                /* Alineaci√≥n forzada a la izquierda */
                .products-table th, .products-table td { padding: 8px; text-align: left !important; }
                .products-table th { font-weight: bold; border: 1px solid #d0121b; } 
                .products-table td { border-bottom: 1px solid #f3f4f6; } 
                
                /* =========================================
                   TOTALES Y FOOTER
                   ========================================= */
                .totales-table { width: 280px; float: right; border-collapse: collapse; font-size: 12px; }
                .totales-table td { padding: 6px 10px; text-align: left; border: none; }
                .totales-table td:last-child { text-align: right; }
                
                /* Fila del Gran Total */
                .grand-total td { 
                    font-size: 16px !important; 
                    font-weight: bold !important; 
                    color: #d0121b !important; 
                    border-top: 1.5px solid #d0121b !important; /* Separador rojo del IVA al Total */
                    padding-top: 10px;
                    margin-top: 5px;
                }
                
                .footer { text-align: center; font-style: italic; font-size: 12px; clear: both; width: 100%; padding-top: 5px; }
            </style>
        </head>
        <body onload="window.print()">
            
            <table class="header-table">
                <tr>
                    <td class="header-left">
                        <div class="empresa-info-container">
                            <img src="https://mitiendaunit.com/wp-content/uploads/2025/09/LOGO-UNI-T-RENOVADO_Mesa-de-trabajo-1-2.png" alt="UNI-T">
                            <div class="empresa-info text-gray">
                                <strong class="text-black-bold">UNI-T VENEZUELA, C.A.</strong><br>
                                C.C. Galerias Avila, nivel Feria, Local F67<br>
                                Caracas, 1010, Venezuela.<br>
                                R.I.F.: J-50174299-5<br>
                                Web: www.mitiendaunit.com
                            </div>
                        </div>
                    </td>

                    <td class="header-right">
                        <h2 class="cotizacion-title">COTIZACI√ìN</h2>
                        <div class="separator-header-right"></div>
                        <table class="cotizacion-datos">
                            <tr>
                                <td class="text-black-bold">N¬∞:</td>
                                <td class="text-red-bold">#<?php echo esc_html( $cot->codigo_cotizacion ); ?></td>
                            </tr>
                            <tr>
                                <td class="text-black-bold">Fecha:</td>
                                <td class="text-gray"><?php echo date( 'd/m/Y', strtotime( $cot->fecha_emision ) ); ?></td>
                            </tr>
                            <tr>
                                <td class="text-black-bold">Validez:</td>
                                <td class="text-gray"><?php echo esc_html( $cot->validez_dias ); ?> D√≠as</td>
                            </tr>
                            <tr>
                                <td class="text-black-bold">Vendedor:</td>
                                <td class="text-gray"><?php echo esc_html( $vendedor_nombre ); ?></td>
                            </tr>
                            <tr>
                                <td class="text-black-bold">Tel√©fono:</td>
                                <td class="text-gray"><?php echo esc_html( $vendedor_telefono ); ?></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <hr class="separator-red">

            <div class="client-box">
                <div class="client-title text-red-bold">DATOS DEL CLIENTE</div>
                <hr class="separator-light">
                <table class="client-table">
                    <tr>
                        <td style="width: 50%;">
                            <strong class="text-black-bold">RAZ√ìN SOCIAL:</strong> 
                            <span class="text-black-bold"><?php echo esc_html( mb_strtoupper( $cot->cliente_nombre, 'UTF-8' ) ); ?></span>
                        </td>
                        <td style="width: 50%;">
                            <strong class="text-black-bold">RIF/CI:</strong> 
                            <span class="text-gray"><?php echo esc_html( mb_strtoupper( $cot->cliente_rif, 'UTF-8' ) ); ?></span>
                        </td>
                    </tr>
                    <?php if ( $show_dir || $show_ubicacion ): ?>
                    <tr>
                        <?php if ( $show_dir ): ?>
                            <td <?php echo !$show_ubicacion ? 'colspan="2"' : ''; ?>>
                                <strong class="text-black-bold">DIRECCI√ìN:</strong> 
                                <span class="text-gray"><?php echo esc_html( mb_strtoupper( $show_dir, 'UTF-8' ) ); ?></span>
                            </td>
                        <?php endif; ?>
                        <?php if ( $show_ubicacion ): ?>
                            <td <?php echo !$show_dir ? 'colspan="2"' : ''; ?>>
                                <strong class="text-black-bold">CIUDAD/ESTADO:</strong> 
                                <span class="text-gray"><?php echo esc_html( mb_strtoupper( $show_ubicacion, 'UTF-8' ) ); ?></span>
                            </td>
                        <?php endif; ?>
                    </tr>
                    <?php endif; ?>
                    <?php if ( $show_contacto ): ?>
                    <tr>
                        <td colspan="2">
                            <strong class="text-black-bold">CONTACTO:</strong> 
                            <span class="text-gray"><?php echo esc_html( mb_strtoupper( $show_contacto, 'UTF-8' ) ); ?></span>
                        </td>
                    </tr>
                    <?php endif; ?>
                </table>
            </div>

            <table class="products-table">
                <thead>
                    <tr>
                        <th class="bg-red-unit" style="width: 33%;">DESCRIPCI√ìN</th>
                        <th class="bg-red-unit" style="width: 20%;">PRECIO POR UNIDAD</th>
                        <th class="bg-red-unit" style="width: 10%;">CANTIDAD</th>
                        <th class="bg-red-unit" style="width: 20%;">TIEMPO DE ENTREGA</th>
                        <th class="bg-red-unit" style="width: 17%;">MONTO</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ( $items as $item ): 
                        $precio_unit = floatval($item->precio_unitario_usd) * $tasa_calc;
                        $subtotal_item = floatval($item->subtotal_usd) * $tasa_calc;
                    ?>
                    <tr>
                        <td>
                            <strong class="text-black-bold"><?php echo esc_html( $item->sku ); ?></strong><br>
                            <span class="text-gray"><?php echo esc_html( mb_strtoupper( $item->producto_nombre, 'UTF-8' ) ); ?></span>
                        </td>
                        <td class="text-gray"><?php echo $simbolo . ' ' . number_format( $precio_unit, 2 ); ?></td>
                        <td class="text-gray"><?php echo intval( $item->cantidad ); ?></td>
                        <td class="text-gray"><?php echo !empty($item->tiempo_entrega) ? esc_html( mb_strtoupper( $item->tiempo_entrega, 'UTF-8' ) ) : 'INMEDIATA'; ?></td>
                        <td class="text-gray"><?php echo $simbolo . ' ' . number_format( $subtotal_item, 2 ); ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <hr class="separator-elegant">

            <table class="totales-table">
                <tr>
                    <td class="text-gray">Subtotal:</td>
                    <td class="text-black-bold" style="width: 130px;"><?php echo $simbolo . ' ' . $subtotal_fmt; ?></td>
                </tr>
                <?php if ( $descuento > 0 ): ?>
                <tr>
                    <td class="text-gray">Descuento:</td>
                    <td class="text-gray">- <?php echo $simbolo . ' ' . number_format( $descuento, 2 ); ?></td>
                </tr>
                <?php endif; ?>
                <tr>
                    <td class="text-gray">I.V.A. (16%):</td>
                    <td class="text-black-bold"><?php echo $simbolo . ' ' . $iva_fmt; ?></td>
                </tr>
                <tr class="grand-total">
                    <td>TOTAL:</td>
                    <td><?php echo $simbolo . ' ' . $total_fmt; ?></td>
                </tr>
            </table>

            <div style="clear: both;"></div>

            <hr class="separator-elegant">

            <div class="footer text-gray">
                Gracias por su preferencia. Esta cotizaci√≥n est√° sujeta a disponibilidad de inventario.
            </div>
        </body>
        </html>
        <?php
        exit;
    }
}



/**
 * 4. Endpoint para Obtener Detalles de Cotizaci√≥n (Acci√≥n: Clonar)
 */
class Suite_Ajax_Quote_Details extends Suite_AJAX_Controller {
    protected $action_name = 'suite_get_quote_details_ajax';
    protected $required_capability = 'read';

    protected function process() {
        global $wpdb;
        $quote_id = isset( $_POST['id'] ) ? intval( $_POST['id'] ) : 0;

        if ( ! $quote_id ) {
            $this->send_error( 'ID de cotizaci√≥n inv√°lido.' );
        }

        $user = wp_get_current_user();
        $is_admin = current_user_can( 'manage_options' ) || in_array( 'suite_gerente', (array) $user->roles );
        $user_id = get_current_user_id();

        $cotizacion = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_cotizaciones WHERE id = %d", $quote_id ) );

        if ( ! $cotizacion ) {
            $this->send_error( 'Cotizaci√≥n no encontrada.' );
        }

        // Validaci√≥n RLS: Zero-Trust para clonaci√≥n
        if ( ! $is_admin && intval( $cotizacion->vendedor_id ) !== $user_id ) {
            $this->send_error( 'Acceso denegado. No puede clonar una cotizaci√≥n que no le pertenece.', 403 );
        }

        $items = $wpdb->get_results( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_cotizaciones_items WHERE cotizacion_id = %d", $quote_id ) );
        $cliente = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM {$wpdb->prefix}suite_clientes WHERE id = %d", $cotizacion->cliente_id ) );

        $this->send_success( [
            'cotizacion' => $cotizacion,
            'items'      => $items,
            'cliente'    => $cliente
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-quotes.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-roles.php ---
<?php
/**
 * Controlador AJAX: Gesti√≥n de Roles y Permisos Din√°micos (FASE 2-B)
 *
 * Maneja las peticiones del frontend para listar, crear, editar y eliminar 
 * roles personalizados (RBAC) bas√°ndose en las Capacidades (Capabilities).
 *
 * @package SuiteEmpleados\Controllers\Ajax
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * 1. Obtener Lista de Roles y el Diccionario de Capacidades
 */
class Suite_Ajax_Role_List extends Suite_AJAX_Controller {

    protected $action_name = 'suite_get_roles';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can( 'manage_options' ) && ! current_user_can( 'suite_manage_team' ) ) {
            $this->send_error( 'Acceso denegado', 403 );
        }

        $model = new Suite_Model_Roles();

        $this->send_success( [
            'roles'       => $model->get_all_roles(),
            'diccionario' => $model->get_capabilities_dictionary()
        ] );
    }
}

/**
 * 2. Crear o Actualizar un Rol (y sus Capacidades)
 */
class Suite_Ajax_Role_Save extends Suite_AJAX_Controller {

    protected $action_name = 'suite_save_role';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can( 'manage_options' ) && ! current_user_can( 'suite_manage_team' ) ) {
            $this->send_error( 'Acceso denegado', 403 );
        }

        $role_key     = isset( $_POST['role_key'] ) ? sanitize_key( $_POST['role_key'] ) : '';
        $display_name = isset( $_POST['display_name'] ) ? sanitize_text_field( $_POST['display_name'] ) : '';
        // AJAX puede enviar arrays si se estructuran correctamente en el FormData o Payload
        $capabilities = isset( $_POST['capabilities'] ) && is_array( $_POST['capabilities'] ) ? $_POST['capabilities'] : [];

        if ( empty( $role_key ) || empty( $display_name ) ) {
            $this->send_error( 'El identificador del rol y el nombre a mostrar son obligatorios.' );
        }

        $model = new Suite_Model_Roles();
        $result = $model->create_or_update_role( $role_key, $display_name, $capabilities );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message() );
        }

        $this->send_success( 'Rol guardado y permisos actualizados correctamente.' );
    }
}

/**
 * 3. Eliminar un Rol
 */
class Suite_Ajax_Role_Delete extends Suite_AJAX_Controller {

    protected $action_name = 'suite_delete_role';
    protected $required_capability = 'read';

    protected function process() {
        // Zero-Trust Security: Barrera estricta de capacidades
        if ( ! current_user_can( 'manage_options' ) && ! current_user_can( 'suite_manage_team' ) ) {
            $this->send_error( 'Acceso denegado', 403 );
        }

        $role_key = isset( $_POST['role_key'] ) ? sanitize_key( $_POST['role_key'] ) : '';

        if ( empty( $role_key ) ) {
            $this->send_error( 'Identificador del rol no v√°lido.' );
        }

        $model = new Suite_Model_Roles();
        $result = $model->delete_role( $role_key );

        if ( is_wp_error( $result ) ) {
            $this->send_error( $result->get_error_message(), 403 ); // 403 si intent√≥ borrar rol protegido
        }

        $this->send_success( 'Rol eliminado del sistema.' );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/class-suite-ajax-roles.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Ajax/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Controllers/Ajax/index.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/class-api-stats.php ---
<?php
/**
 * Archivo: includes/Controllers/Api/class-api-stats.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Controllers/Api/class-api-stats.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/class-suite-api-stats.php ---
<?php
/**
 * Controlador API REST: Estad√≠sticas, Marketing e Inteligencia Artificial
 *
 * Expone endpoints estandarizados para integraciones con PowerBI, Python (Pandas/Prophet)
 * y herramientas de an√°lisis de Marketing.
 *
 * @package SuiteEmpleados\Controllers\Api
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_API_Stats {

    /**
     * Registra las rutas REST al inicializar la API
     */
    public function __construct() {
        add_action( 'rest_api_init', [ $this, 'register_routes' ] );
    }

    /**
     * Define el namespace y los endpoints
     */
    public function register_routes() {
        $namespace = 'suite/v1';

        // Endpoint 1: Rendimiento de Canales de Venta (Marketing)
        register_rest_route( $namespace, '/ventas-vs-alcance', [
            'methods'             => WP_REST_Server::READABLE, // GET
            'callback'            => [ $this, 'get_ventas_vs_alcance' ],
            'permission_callback' => [ $this, 'check_permissions' ]
        ] );

        // Endpoint 2: Exportaci√≥n de Series de Tiempo para Machine Learning (Prophet)
        register_rest_route( $namespace, '/export-prophet', [
            'methods'             => WP_REST_Server::READABLE, // GET
            'callback'            => [ $this, 'export_prophet_data' ],
            'permission_callback' => [ $this, 'check_permissions' ]
        ] );
    }

    /**
     * Middleware de Seguridad: Control de Accesos
     * Solo permite a Administradores o al nuevo rol 'suite_marketing'
     *
     * @return bool|WP_Error
     */
	public function check_permissions() {
        if ( ! is_user_logged_in() ) {
            return new WP_Error( 'rest_unauthorized', 'Debe iniciar sesi√≥n para acceder a la API.', [ 'status' => 401 ] );
        }

        $user = wp_get_current_user();
        $roles = (array) $user->roles;

        // VERIFICACI√ìN CORREGIDA: Usa current_user_can() para Admin, y validaci√≥n de rol para marketing
        if ( current_user_can( 'manage_options' ) || in_array( 'suite_marketing', $roles ) ) {
            return true;
        }

        return new WP_Error( 'rest_forbidden', 'Acceso denegado. Se requiere rol de Marketing o Administrador.', [ 'status' => 403 ] );
    }

    /**
     * Endpoint: Agrupa las ventas cerradas por Fecha y Canal de Venta (√öltimos 30 d√≠as)
     * Ideal para graficar en Chart.js o cruzar con inversi√≥n publicitaria (CPA/ROAS).
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function get_ventas_vs_alcance( $request ) {
        global $wpdb;
        $tabla_cot = $wpdb->prefix . 'suite_cotizaciones';

        // Consulta SQL para agrupar ventas efectivas
        $sql = "
            SELECT 
                DATE(fecha_emision) as fecha, 
                canal_venta, 
                COUNT(id) as cantidad_operaciones, 
                SUM(total_usd) as volumen_usd
            FROM {$tabla_cot}
            WHERE estado IN ('pagado', 'despachado') 
            AND fecha_emision >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
            GROUP BY DATE(fecha_emision), canal_venta
            ORDER BY fecha ASC
        ";

        $resultados = $wpdb->get_results( $sql );

        // Formatear nulos a canales "No Definidos" y castear tipos para JSON
        foreach ( $resultados as $r ) {
            $r->canal_venta = empty( $r->canal_venta ) ? 'Org√°nico / No definido' : $r->canal_venta;
            $r->cantidad_operaciones = intval( $r->cantidad_operaciones );
            $r->volumen_usd = floatval( $r->volumen_usd );
        }

        return rest_ensure_response( [
            'success' => true,
            'periodo' => '√öltimos 30 d√≠as',
            'data'    => $resultados
        ] );
    }

    /**
     * Endpoint: Extrae el Data Lake para Pandas / Facebook Prophet
     * Usa la nomenclatura estricta 'ds' (Datestamp) e 'y' (Variable objetivo)
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function export_prophet_data( $request ) {
        global $wpdb;
        $tabla_historico = $wpdb->prefix . 'suite_inventario_historico';

        // Facebook Prophet requiere obligatoriamente que la fecha se llame 'ds'
        // y la m√©trica a predecir se llame 'y'. En este caso, predeciremos la ca√≠da de stock (demanda).
        $sql = "
            SELECT 
                fecha_snapshot as ds, 
                stock_disponible as y, 
                sku, 
                precio, 
                categoria
            FROM {$tabla_historico}
            ORDER BY ds ASC, sku ASC
        ";

        $resultados = $wpdb->get_results( $sql );

        // Casteo estricto para que Pandas no falle al procesar JSON
        foreach ( $resultados as $r ) {
            $r->y = intval( $r->y );
            $r->precio = floatval( $r->precio );
        }

        return rest_ensure_response( [
            'success' => true,
            'model'   => 'Facebook Prophet Compatible',
            'data'    => $resultados
        ] );
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Api/class-suite-api-stats.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/class-suite-api-sync.php ---
<?php
/**
 * Controlador API REST: Sincronizaci√≥n Segura de Archivos (FASE 1)
 *
 * Endpoint que recibe y valida los archivos CSV generados por el servidor
 * externo de procesamiento de datos, asegurando la integridad del ecosistema WordPress.
 *
 * @package SuiteEmpleados\Controllers\Api
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_API_Sync {

    /**
     * Constructor: Registra la inicializaci√≥n de la API REST
     */
    public function __construct() {
        add_action( 'rest_api_init', [ $this, 'register_routes' ] );
    }

    /**
     * Define el namespace y el endpoint
     */
    public function register_routes() {
        register_rest_route( 'suite/v1', '/sync-csv', [
            'methods'             => WP_REST_Server::CREATABLE, // Equivalente a POST
            'callback'            => [ $this, 'process_sync' ],
            'permission_callback' => [ $this, 'check_permissions' ]
        ] );
    }

    /**
     * Middleware de Seguridad: Validaci√≥n de Token
     * Protege el endpoint validando un header personalizado (Zero-Trust)
     *
     * @param WP_REST_Request $request
     * @return true|WP_Error
     */
    public function check_permissions( WP_REST_Request $request ) {
        // La API de WordPress normaliza los headers a min√∫sculas
        $token_enviado = $request->get_header( 'x-suite-sync-token' );

        if ( ! defined( 'SUITE_SYNC_SECRET' ) ) {
            return new WP_Error( 
                'rest_forbidden', 
                'Configuraci√≥n incompleta: La constante SUITE_SYNC_SECRET no est√° definida en el servidor wp-config.php.', 
                [ 'status' => 500 ] 
            );
        }

        if ( empty( $token_enviado ) ) {
            return new WP_Error( 
                'rest_unauthorized', 
                'Acceso Denegado: Header X-Suite-Sync-Token ausente.', 
                [ 'status' => 401 ] 
            );
        }

        // Validaci√≥n blindada contra ataques de tiempo (Timing Attacks)
        if ( ! hash_equals( SUITE_SYNC_SECRET, $token_enviado ) ) {
            // Logueamos la intrusi√≥n para auditor√≠a
            if ( function_exists('suite_record_log') ) {
                suite_record_log( 'violacion_api', 'Intento de acceso al endpoint sync-csv con token inv√°lido desde IP: ' . $_SERVER['REMOTE_ADDR'] );
            }

            return new WP_Error( 
                'rest_unauthorized', 
                'Acceso Denegado: Token de sincronizaci√≥n inv√°lido.', 
                [ 'status' => 401 ] 
            );
        }

        return true;
    }

    /**
     * L√≥gica de Procesamiento: Validaci√≥n estricta y guardado de archivos
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function process_sync( WP_REST_Request $request ) {
        $files = $request->get_file_params();

        // 1. Validar presencia de archivos
        if ( empty( $files['reporte_final'] ) || empty( $files['precios'] ) ) {
            return new WP_REST_Response( [
                'success' => false,
                'message' => 'Faltan archivos requeridos. Se esperan los campos "reporte_final" y "precios".'
            ], 400 );
        }

        $file_reporte = $files['reporte_final'];
        $file_precios = $files['precios'];

        // 2. Validar estructura, mime type y extensiones
        $val_reporte = $this->validate_csv( $file_reporte );
        if ( is_wp_error( $val_reporte ) ) {
            return new WP_REST_Response( [ 'success' => false, 'message' => 'Error en reporte_final: ' . $val_reporte->get_error_message() ], 400 );
        }

        $val_precios = $this->validate_csv( $file_precios );
        if ( is_wp_error( $val_precios ) ) {
            return new WP_REST_Response( [ 'success' => false, 'message' => 'Error en precios: ' . $val_precios->get_error_message() ], 400 );
        }

        // 3. Preparar el directorio de destino
        $output_dir = SUITE_PATH . 'output/';
        if ( ! file_exists( $output_dir ) ) {
            wp_mkdir_p( $output_dir );
            
            // Prevenci√≥n de ejecuci√≥n (Defense in Depth)
            file_put_contents( $output_dir . 'index.php', '<?php // Silence is golden.' );
            file_put_contents( $output_dir . '.htaccess', 'Deny from all' );
        }

        // 4. Guardar archivos (Sobrescribiendo cualquier nombre original para evitar Directory Traversal)
        // Al forzar el nombre de destino ("reporte_final.csv"), anulamos inyecciones como "../../../script.php"
        $path_reporte = $output_dir . 'reporte_final.csv';
        $path_precios = $output_dir . 'precios.csv';

        $move_reporte = move_uploaded_file( $file_reporte['tmp_name'], $path_reporte );
        $move_precios = move_uploaded_file( $file_precios['tmp_name'], $path_precios );

        if ( $move_reporte && $move_precios ) {
            return new WP_REST_Response( [
                'success' => true,
                'message' => 'Sincronizaci√≥n de CSVs ejecutada correctamente.'
            ], 200 );
        } else {
            return new WP_REST_Response( [
                'success' => false,
                'message' => 'Error de sistema de archivos al intentar guardar los CSVs.'
            ], 500 );
        }
    }

    /**
     * Validador estricto de archivos CSV
     * Previene subida de c√≥digo malicioso enmascarado
     *
     * @param array $file Array del archivo desde $_FILES
     * @return true|WP_Error
     */
    private function validate_csv( $file ) {
        // Chequeo de error de subida de PHP
        if ( $file['error'] !== UPLOAD_ERR_OK ) {
            return new WP_Error( 'upload_error', 'C√≥digo de error interno: ' . $file['error'] );
        }

        // Validaci√≥n de Extensi√≥n
        $ext = strtolower( pathinfo( $file['name'], PATHINFO_EXTENSION ) );
        if ( $ext !== 'csv' ) {
            return new WP_Error( 'invalid_ext', 'La extensi√≥n del archivo debe ser .csv' );
        }

        // Validaci√≥n de Tipo MIME Real (Leyendo los bytes del archivo, no la cabecera HTTP)
        if ( function_exists( 'finfo_open' ) ) {
            $finfo = finfo_open( FILEINFO_MIME_TYPE );
            $mime_real = finfo_file( $finfo, $file['tmp_name'] );
            finfo_close( $finfo );

            $mimes_permitidos = [ 'text/csv', 'text/plain', 'application/csv', 'application/vnd.ms-excel' ];
            if ( ! in_array( $mime_real, $mimes_permitidos, true ) ) {
                return new WP_Error( 'invalid_mime', 'Fallo de seguridad: El contenido real del archivo no coincide con texto plano o CSV. (Detectado: ' . $mime_real . ')' );
            }
        }

        return true;
    }
}
--- FIN DEL ARCHIVO: includes/Controllers/Api/class-suite-api-sync.php ---

--- INICIO DEL ARCHIVO: includes/Controllers/Api/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Controllers/Api/index.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-activator.php ---
<?php
// SEGURIDAD: Evitar acceso directo
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * Funci√≥n de Instalaci√≥n de Base de Datos
 * Crea las tablas cr√≠ticas: Inventario, Clientes, Cotizaciones, Items, etc.
 */
if ( ! function_exists( 'suite_install_db' ) ) {
    function suite_install_db() {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();

        require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );

        // 1. Tabla Inventario (Cache)
        $sql_inventario = "CREATE TABLE {$wpdb->prefix}suite_inventario_cache (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            sku VARCHAR(100) NOT NULL,
            nombre_producto VARCHAR(255),
            stock_gale INT DEFAULT 0,
            stock_mille INT DEFAULT 0,
            stock_transito INT DEFAULT 0,
            status_alerta VARCHAR(50),
            velocidad_ventas FLOAT DEFAULT 0,
            precio DECIMAL(10,2) DEFAULT 0,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            UNIQUE KEY idx_sku (sku)
        ) $charset_collate;";

        // 2. Tabla Clientes (CRM)
        $sql_clientes = "CREATE TABLE {$wpdb->prefix}suite_clientes (
            id bigint(20) NOT NULL AUTO_INCREMENT,
			vendedor_id bigint(20) DEFAULT 0,
            nombre_razon VARCHAR(255) NOT NULL,
            rif_ci VARCHAR(50) NOT NULL,
            direccion TEXT,
            ciudad VARCHAR(100),
            estado VARCHAR(100),
            telefono VARCHAR(50),
            email VARCHAR(100),
            contacto_persona VARCHAR(150),
            notas TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            UNIQUE KEY idx_rif (rif_ci)
        ) $charset_collate;";

        // 3. Tabla Cotizaciones
        $sql_cotizaciones = "CREATE TABLE {$wpdb->prefix}suite_cotizaciones (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            codigo_cotizacion VARCHAR(20) NOT NULL,
            cliente_nombre VARCHAR(255),
            cliente_rif VARCHAR(50),
            cliente_id bigint(20) NOT NULL DEFAULT 0,
            direccion_entrega TEXT,
            fecha_emision DATETIME DEFAULT CURRENT_TIMESTAMP,
            validez_dias INT DEFAULT 10,
            moneda VARCHAR(5) DEFAULT 'USD',
            vendedor_id bigint(20),
            total_bs DECIMAL(15,2),
            total_usd DECIMAL(15,2),
            tasa_bcv DECIMAL(10,2),
            estado VARCHAR(20) DEFAULT 'emitida',
            canal_venta VARCHAR(100),
            metodo_pago VARCHAR(100),
            metodo_entrega VARCHAR(100),
            url_captura_pago TEXT,
            recibo_loyverse VARCHAR(100),
            pod_url TEXT,
            PRIMARY KEY  (id)
        ) $charset_collate;";

        // 4. Tabla Libro Mayor de Comisiones (Ledger)
        $sql_comisiones = "CREATE TABLE {$wpdb->prefix}suite_comisiones_ledger (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            quote_id bigint(20) NOT NULL,
            vendedor_id bigint(20) NOT NULL,
            monto_base_usd DECIMAL(15,2) DEFAULT 0,
            comision_ganada_usd DECIMAL(15,2) DEFAULT 0,
            estado_pago VARCHAR(20) DEFAULT 'pendiente',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            KEY idx_vendedor (vendedor_id)
        ) $charset_collate;";

        // 5. Tabla Gamificaci√≥n y Premios
        $sql_premios = "CREATE TABLE {$wpdb->prefix}suite_premios_mensuales (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            vendedor_id bigint(20) NOT NULL,
            mes INT NOT NULL,
            anio INT NOT NULL,
            premio_nombre VARCHAR(100) NOT NULL,
            monto_premio DECIMAL(10,2) DEFAULT 0,
            asignado_manualmente TINYINT(1) DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            KEY idx_mes_anio (mes, anio)
        ) $charset_collate;";

        // 6. Tabla Items (Detalle)
        $sql_items = "CREATE TABLE {$wpdb->prefix}suite_cotizaciones_items (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            cotizacion_id bigint(20) NOT NULL,
            sku VARCHAR(100),
            producto_nombre VARCHAR(255),
            cantidad INT,
            precio_unitario_usd DECIMAL(15,2),
            tiempo_entrega VARCHAR(100),
            subtotal_usd DECIMAL(15,2),
            PRIMARY KEY  (id),
            KEY idx_cotizacion (cotizacion_id)
        ) $charset_collate;";

        // 7. Tabla de Auditor√≠a (Logs)
        $sql_logs = "CREATE TABLE {$wpdb->prefix}suite_logs (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            usuario_id bigint(20) NOT NULL,
            accion VARCHAR(50) NOT NULL,
            detalle TEXT,
            ip VARCHAR(45),
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            KEY idx_usuario (usuario_id)
        ) $charset_collate;";

        // 8. Tabla Data Lake / Inventario Hist√≥rico (M√≥dulo 5 - IA)
        $sql_historico = "CREATE TABLE {$wpdb->prefix}suite_inventario_historico (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            fecha_snapshot DATE NOT NULL,
            sku VARCHAR(100) NOT NULL,
            stock_disponible INT DEFAULT 0,
            precio DECIMAL(10,2) DEFAULT 0,
            categoria VARCHAR(100) DEFAULT 'General',
            PRIMARY KEY  (id),
            KEY idx_fecha (fecha_snapshot),
            KEY idx_sku (sku)
        ) $charset_collate;";

        // --- EJECUCI√ìN √öNICA DE DB-DELTA ---
        dbDelta( $sql_inventario );
        dbDelta( $sql_clientes );
        dbDelta( $sql_cotizaciones );
        dbDelta( $sql_items );
        dbDelta( $sql_comisiones );
        dbDelta( $sql_premios );
        dbDelta( $sql_logs );
        dbDelta( $sql_historico ); // Data Lake agregado correctamente

        // Ajuste de Auto-Increment para Cotizaciones (Inicio en 15000)
        $count = $wpdb->get_var( "SELECT COUNT(*) FROM {$wpdb->prefix}suite_cotizaciones" );
        if ( $count == 0 ) {
            $wpdb->query( "ALTER TABLE {$wpdb->prefix}suite_cotizaciones AUTO_INCREMENT = 15000" );
        }
		
		// --- PARCHE EN CALIENTE: A√±adir vendedor_id si el plugin ya estaba instalado ---
        $column_check = $wpdb->get_results( "SHOW COLUMNS FROM {$wpdb->prefix}suite_clientes LIKE 'vendedor_id'" );
        if ( empty( $column_check ) ) {
            $wpdb->query( "ALTER TABLE {$wpdb->prefix}suite_clientes ADD vendedor_id bigint(20) DEFAULT 0 AFTER id" );
        }

        // --- CREACI√ìN DE ROLES (Ejecutar una vez) ---
        add_role('suite_vendedor', 'Vendedor Suite', array('read' => true, 'suite_access' => true));
        add_role('suite_logistica', 'Log√≠stica Suite', array('read' => true, 'suite_access' => true));
        add_role('suite_marketing', 'Marketing y An√°lisis', array('read' => true, 'suite_access' => true));

        $admin = get_role('administrator');
        if ( $admin ) {
            $admin->add_cap('suite_access'); // Asegurar que admin tenga acceso
        }
    }
}
--- FIN DEL ARCHIVO: includes/Core/class-activator.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-logger.php ---
<?php
/**
 * Archivo: includes/Core/class-logger.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Core/class-logger.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-security.php ---
<?php
/**
 * Archivo: includes/Core/class-security.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: includes/Core/class-security.php ---

--- INICIO DEL ARCHIVO: includes/Core/class-suite-cron-jobs.php ---
<?php
/**
 * Clase Gestora de Tareas Programadas (Cron Jobs)
 * 
 * M√≥dulo 5: Data Lake y Cerebro de Demanda.
 * Recopila series de tiempo (Time Series) para modelos predictivos.
 *
 * @package SuiteEmpleados\Core
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Cron_Jobs {

    /**
     * Constructor: Engancha los m√©todos a los hooks de WP-Cron
     */
    public function __construct() {
        add_action( 'suite_daily_inventory_snapshot', [ $this, 'take_inventory_snapshot' ] );
    }

    /**
     * Registra el evento recurrente en WordPress.
     * Debe llamarse durante el init del plugin.
     */
    public function schedule_events() {
        if ( ! wp_next_scheduled( 'suite_daily_inventory_snapshot' ) ) {
            // Programar para que corra diariamente. 'midnight' asegura que la foto
            // sea consistente a nivel estad√≠stico (cierre del d√≠a).
            wp_schedule_event( strtotime( 'midnight' ), 'daily', 'suite_daily_inventory_snapshot' );
        }
    }

    /**
     * Limpia los eventos al desactivar el plugin.
     */
    public function clear_events() {
        $timestamp = wp_next_scheduled( 'suite_daily_inventory_snapshot' );
        if ( $timestamp ) {
            wp_unschedule_event( $timestamp, 'suite_daily_inventory_snapshot' );
        }
    }

    /**
     * ETL (Extract, Transform, Load) Diario.
     * Lee el stock actual e inserta el snapshot en el Data Lake.
     */
    public function take_inventory_snapshot() {
        global $wpdb;

        $tabla_cache     = $wpdb->prefix . 'suite_inventario_cache';
        $tabla_historico = $wpdb->prefix . 'suite_inventario_historico';
        $hoy             = date( 'Y-m-d' );

        // 1. Control de Idempotencia: Evitar snapshots duplicados si el cron se dispara doble
        $existe_hoy = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM {$tabla_historico} WHERE fecha_snapshot = %s",
            $hoy
        ) );

        if ( $existe_hoy > 0 ) {
            return; 
        }

        // 2. Extraer el inventario por lotes (Chunking) para evitar Memory Leaks
        $limit = 500;
        $offset = 0;

        while ( true ) {
            $inventario = $wpdb->get_results( $wpdb->prepare(
                "SELECT sku, stock_gale, precio FROM {$tabla_cache} LIMIT %d OFFSET %d",
                $limit, $offset
            ) );

            if ( empty( $inventario ) ) {
                break; // Fin de los registros
            }

            // 3. Transformaci√≥n y Carga en Base de Datos
            foreach ( $inventario as $item ) {
                $sku = strtoupper( sanitize_text_field( $item->sku ) );

                $categoria = 'General';
                if ( strpos( $sku, 'UT' ) === 0 ) {
                    $categoria = 'UNI-T';
                } elseif ( strpos( $sku, 'HM' ) === 0 || strpos( $sku, 'HIK' ) === 0 || strpos( $sku, 'DS' ) === 0 ) {
                    $categoria = 'HIKMICRO';
                } elseif ( strpos( $sku, 'RV' ) === 0 ) {
                    $categoria = 'RV TECH';
                }

                $wpdb->insert(
                    $tabla_historico,
                    [
                        'fecha_snapshot'   => $hoy,
                        'sku'              => $sku,
                        'stock_disponible' => intval( $item->stock_gale ),
                        'precio'           => floatval( $item->precio ),
                        'categoria'        => $categoria
                    ],
                    [ '%s', '%s', '%d', '%f', '%s' ]
                );
            }
            // Avanzar al siguiente lote liberando memoria
            $offset += $limit;
        }

        // 4. Auditor√≠a
        if ( function_exists( 'suite_record_log' ) ) {
            suite_record_log( 'cron_snapshot_ia', "Time Series generada exitosamente para la fecha: {$hoy}" );
        }
    }
}
--- FIN DEL ARCHIVO: includes/Core/class-suite-cron-jobs.php ---

--- INICIO DEL ARCHIVO: includes/Core/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Core/index.php ---

--- INICIO DEL ARCHIVO: includes/Helpers/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Helpers/index.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-base.php ---
<?php
/**
 * Clase Abstracta: Modelo Base de Base de Datos
 *
 * Centraliza la interacci√≥n con $wpdb, proporcionando m√©todos CRUD
 * blindados contra inyecciones SQL y estandarizados para todos los m√≥dulos.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

abstract class Suite_Model_Base {

    /**
     * Instancia global de WordPress DB
     * @var wpdb
     */
    protected $wpdb;

    /**
     * Nombre completo de la tabla (incluyendo el prefijo wp_)
     * @var string
     */
    protected $table_name;

    /**
     * Llave primaria de la tabla (por defecto 'id')
     * @var string
     */
    protected $primary_key = 'id';

    /**
     * Constructor. Inicializa la conexi√≥n a DB y define el nombre de la tabla.
     */
    public function __construct() {
        global $wpdb;
        $this->wpdb = $wpdb;
        
        // $this->set_table_name() debe ser definido obligatoriamente por la clase hija
        $this->table_name = $this->wpdb->prefix . $this->set_table_name();
    }

    /**
     * Define el nombre de la tabla sin el prefijo de WordPress.
     * Ej: return 'suite_clientes';
     *
     * @return string
     */
    abstract protected function set_table_name();

    /**
     * Obtiene un registro espec√≠fico por su ID.
     *
     * @param int $id El ID del registro.
     * @return object|null Objeto con los datos o null si no existe.
     */
    public function get( $id ) {
        $sql = $this->wpdb->prepare( 
            "SELECT * FROM {$this->table_name} WHERE {$this->primary_key} = %d", 
            intval( $id ) 
        );
        return $this->wpdb->get_row( $sql );
    }

    /**
     * Obtiene una lista de registros con l√≠mite y offset (paginaci√≥n b√°sica).
     *
     * @param int $limit L√≠mite de resultados.
     * @param int $offset Punto de inicio.
     * @return array Array de objetos.
     */
    public function get_all( $limit = 100, $offset = 0 ) {
        $sql = $this->wpdb->prepare( 
            "SELECT * FROM {$this->table_name} ORDER BY {$this->primary_key} DESC LIMIT %d OFFSET %d", 
            intval( $limit ), 
            intval( $offset ) 
        );
        return $this->wpdb->get_results( $sql );
    }

    /**
     * Inserta un nuevo registro de forma segura.
     *
     * @param array $data Array asociativo [ 'columna' => 'valor' ].
     * @return int|false El ID insertado o false en caso de error.
     */
    public function insert( $data ) {
        $inserted = $this->wpdb->insert( $this->table_name, $data );
        if ( $inserted ) {
            return $this->wpdb->insert_id;
        }
        return false;
    }

    /**
     * Actualiza un registro existente de forma segura.
     *
     * @param int   $id   El ID del registro a actualizar.
     * @param array $data Array asociativo [ 'columna' => 'valor' ].
     * @return bool True si se actualiz√≥, false en caso de error.
     */
    public function update( $id, $data ) {
        $updated = $this->wpdb->update( 
            $this->table_name, 
            $data, 
            [ $this->primary_key => intval( $id ) ] 
        );
        
        // $updated devuelve false en error, o el n√∫mero de filas afectadas (puede ser 0 si los datos eran id√©nticos)
        return $updated !== false;
    }

    /**
     * Elimina un registro por su ID de forma segura.
     *
     * @param int $id El ID del registro a eliminar.
     * @return bool True en √©xito, false en error.
     */
    public function delete( $id ) {
        $deleted = $this->wpdb->delete( 
            $this->table_name, 
            [ $this->primary_key => intval( $id ) ] 
        );
        return $deleted !== false;
    }

}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-base.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-client.php ---
<?php
/**
 * Modelo de Base de Datos: Clientes (CRM)
 *
 * Maneja las consultas espec√≠ficas de la tabla suite_clientes.
 * Hereda de Suite_Model_Base los m√©todos gen√©ricos.
 * ACTUALIZADO: M√≥dulo 1 (Zero-Trust) y Anti-Secuestro de Cartera.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Client extends Suite_Model_Base {

    protected function set_table_name() {
        return 'suite_clientes';
    }

    /**
     * Override del m√©todo Base: Devuelve clientes respetando la seguridad RLS
     */
    public function get_all( $limit = 100, $offset = 0 ) {
        $user = wp_get_current_user();
        $is_admin = current_user_can('manage_options');
        $is_gerente = in_array('suite_gerente', (array)$user->roles) || in_array('gerente', (array)$user->roles);
        
        $sql = "SELECT * FROM {$this->table_name}";
        
        // Zero-Trust: Filtro estricto si es vendedor regular
        if ( ! $is_admin && ! $is_gerente ) {
            $sql .= $this->wpdb->prepare(" WHERE vendedor_id = %d", get_current_user_id());
        }
        
        $sql .= $this->wpdb->prepare(" ORDER BY id DESC LIMIT %d OFFSET %d", intval($limit), intval($offset));
        return $this->wpdb->get_results( $sql );
    }

    /**
     * Busca clientes por Nombre/Raz√≥n Social o por RIF/CI con Seguridad RLS.
     */
    public function search_clients( $term ) {
        $user = wp_get_current_user();
        $is_admin = current_user_can('manage_options');
        $is_gerente = in_array('suite_gerente', (array)$user->roles) || in_array('gerente', (array)$user->roles);
        
        $term_clean = strtoupper( preg_replace( '/[^A-Z0-9]/', '', $term ) );
        $term_name = $term;

        // Construcci√≥n SQL Base con par√©ntesis para aislar el OR
        $sql = "SELECT * FROM {$this->table_name} WHERE (nombre_razon LIKE %s OR rif_ci LIKE %s)";
        
        // Zero-Trust: El vendedor solo puede buscar dentro de sus propios clientes
        if ( ! $is_admin && ! $is_gerente ) {
            $sql .= $this->wpdb->prepare(" AND vendedor_id = %d", get_current_user_id());
        }
        
        $sql .= " LIMIT 10";

        // Preparar y ejecutar
        $prepared_sql = $this->wpdb->prepare(
            $sql, 
            '%' . $this->wpdb->esc_like( $term_name ) . '%', 
            '%' . $this->wpdb->esc_like( $term_clean ) . '%'
        );

        return $this->wpdb->get_results( $prepared_sql );
    }

    /**
     * Obtiene los KPIs y estad√≠sticas de compras de un cliente espec√≠fico.
     * ACTUALIZADO: Solo contabiliza las compras hechas con EL VENDEDOR ACTUAL (RLS).
     */
    public function get_client_stats( $client_id ) {
        $user = wp_get_current_user();
        $is_admin = current_user_can('manage_options');
        $is_gerente = in_array('suite_gerente', (array)$user->roles) || in_array('gerente', (array)$user->roles);

        $tabla_cotizaciones = $this->wpdb->prefix . 'suite_cotizaciones';

        $sql = $this->wpdb->prepare( 
            "SELECT 
                SUM(total_usd) as total, 
                COUNT(id) as count, 
                MIN(fecha_emision) as first, 
                MAX(fecha_emision) as last 
            FROM {$tabla_cotizaciones} 
            WHERE cliente_id = %d", 
            intval( $client_id ) 
        );

        // Zero-Trust
        if ( ! $is_admin && ! $is_gerente ) {
            $sql .= $this->wpdb->prepare(" AND vendedor_id = %d", get_current_user_id());
        }

        return $this->wpdb->get_row( $sql );
    }

    /**
     * Historial RLS: Un vendedor solo ve las compras que ESE cliente hizo con √âL.
     */
    public function get_client_history( $client_id ) {
        $user = wp_get_current_user();
        $is_admin = current_user_can('manage_options');
        $is_gerente = in_array('suite_gerente', (array)$user->roles) || in_array('gerente', (array)$user->roles);
        
        $tabla_cotizaciones = $this->wpdb->prefix . 'suite_cotizaciones';
        
        $sql = $this->wpdb->prepare(
            "SELECT id, codigo_cotizacion as codigo, fecha_emision as fecha, total_usd as total, estado 
             FROM {$tabla_cotizaciones} 
             WHERE cliente_id = %d", 
             intval($client_id)
        );
        
        // Zero-Trust
        if ( ! $is_admin && ! $is_gerente ) {
            $sql .= $this->wpdb->prepare(" AND vendedor_id = %d", get_current_user_id());
        }
        
        $sql .= " ORDER BY id DESC LIMIT 10";
        
        return $this->wpdb->get_results( $sql );
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-client.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-commission.php ---
<?php
/**
 * Modelo de Base de Datos: Comisiones, Metas y Gamificaci√≥n (M√≥dulo 4)
 *
 * Maneja el c√°lculo inmutable del 1.5% de comisi√≥n y determina a los 
 * ganadores de los premios mensuales ("Pez Gordo", "Deja pa' los dem√°s").
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Commission extends Suite_Model_Base {

    /**
     * Define la tabla principal del modelo (Ledger de Comisiones)
     */
    protected function set_table_name() {
        return 'suite_comisiones_ledger';
    }


    /**
     * Calcula y registra la comisi√≥n dividiendo equitativamente entre los beneficiarios.
     * ARCHIVO: includes/Models/class-suite-model-commission.php
     * 
     * @param int $quote_id ID de la cotizaci√≥n
     * @param int $vendedor_id ID del vendedor titular
     * @param float $total_usd Monto total de la venta
     * @param array $colaboradores Array con los IDs de los vendedores secundarios
     * @return true|false
     */
    public function calculate_and_save_commission( $quote_id, $vendedor_id, $total_usd, $colaboradores = [] ) {
        // Regla de Negocio: Comisi√≥n Fija del 1.5%
        $porcentaje = 0.015;
        $comision_total = floatval( $total_usd ) * $porcentaje;

        if ( $comision_total <= 0 ) return false;

        // 1. Armar el pool unificado de beneficiarios (Titular + Colaboradores)
        $beneficiarios = [ intval( $vendedor_id ) ];
        
        if ( is_array( $colaboradores ) && !empty( $colaboradores ) ) {
            foreach ( $colaboradores as $colab_id ) {
                $colab_id = intval( $colab_id );
                // Evitar IDs inv√°lidos o duplicar al titular
                if ( $colab_id > 0 && ! in_array( $colab_id, $beneficiarios ) ) {
                    $beneficiarios[] = $colab_id;
                }
            }
        }

        // 2. Ejecutar divisi√≥n financiera
        $cantidad_vendedores = count( $beneficiarios );
        $base_dividida       = round( floatval( $total_usd ) / $cantidad_vendedores, 2 );
        $comision_dividida   = round( $comision_total / $cantidad_vendedores, 2 );

        // 3. Insertar registro en el Ledger por cada vendedor
        foreach ( $beneficiarios as $ben_id ) {
            $this->insert( [
                'quote_id'            => intval( $quote_id ),
                'vendedor_id'         => $ben_id,
                'monto_base_usd'      => $base_dividida,
                'comision_ganada_usd' => $comision_dividida,
                'estado_pago'         => 'pendiente' // Se liquida a fin de mes
            ] );
        }

        return true;
    }

    /**
     * Analiza la base de datos para determinar los ganadores de la Gamificaci√≥n.
     * Solo cuenta ventas efectivamente cerradas ('pagado', 'despachado').
     *
     * @param int $mes  Mes a evaluar (1-12)
     * @param int $anio A√±o a evaluar (ej. 2024)
     * @return array    Array asociativo con los datos de los ganadores
     */
    public function get_gamification_winners( $mes, $anio ) {
        $tabla_cot  = $this->wpdb->prefix . 'suite_cotizaciones';
        $tabla_user = $this->wpdb->prefix . 'users';

        // 1. Ganador "Pez Gordo" ($20): Mayor volumen acumulado en d√≥lares
        $pez_gordo = $this->wpdb->get_row( $this->wpdb->prepare( "
            SELECT c.vendedor_id, u.display_name, SUM(c.total_usd) as total_vendido
            FROM {$tabla_cot} c
            INNER JOIN {$tabla_user} u ON c.vendedor_id = u.ID
            WHERE MONTH(c.fecha_emision) = %d AND YEAR(c.fecha_emision) = %d
            AND c.estado IN ('pagado', 'despachado')
            GROUP BY c.vendedor_id
            ORDER BY total_vendido DESC
            LIMIT 1
        ", intval( $mes ), intval( $anio ) ) );

        // 2. Ganador "Deja pa' los dem√°s" ($20): Mayor cantidad de ventas cerradas
        $deja_pa_los_demas = $this->wpdb->get_row( $this->wpdb->prepare( "
            SELECT c.vendedor_id, u.display_name, COUNT(c.id) as cantidad_ventas
            FROM {$tabla_cot} c
            INNER JOIN {$tabla_user} u ON c.vendedor_id = u.ID
            WHERE MONTH(c.fecha_emision) = %d AND YEAR(c.fecha_emision) = %d
            AND c.estado IN ('pagado', 'despachado')
            GROUP BY c.vendedor_id
            ORDER BY cantidad_ventas DESC
            LIMIT 1
        ", intval( $mes ), intval( $anio ) ) );

        return [
            'pez_gordo'         => $pez_gordo,
            'deja_pa_los_demas' => $deja_pa_los_demas
        ];
    }

    /**
     * Asignaci√≥n manual de un premio por parte del Administrador (Ej: "Dale play").
     *
     * @param int    $vendedor_id   ID del vendedor premiado
     * @param string $premio_nombre Nombre del premio (Ej: "Dale play")
     * @param float  $monto         Monto en d√≥lares a premiar (Ej: 10.00)
     * @param int    $mes           Mes correspondiente
     * @param int    $anio          A√±o correspondiente
     * @return int|false
     */
    public function assign_manual_prize( $vendedor_id, $premio_nombre, $monto, $mes, $anio ) {
        $tabla_premios = $this->wpdb->prefix . 'suite_premios_mensuales';

        $inserted = $this->wpdb->insert( $tabla_premios, [
            'vendedor_id'          => intval( $vendedor_id ),
            'mes'                  => intval( $mes ),
            'anio'                 => intval( $anio ),
            'premio_nombre'        => sanitize_text_field( $premio_nombre ),
            'monto_premio'         => floatval( $monto ),
            'asignado_manualmente' => 1
        ] );

        return $inserted ? $this->wpdb->insert_id : false;
    }
	

	
	
	/**
     * Obtiene las estad√≠sticas financieras (Billetera) de un vendedor.
     * 
     * @param int $vendedor_id ID del vendedor.
     * @param int|null $mes Mes a consultar.
     * @param int|null $anio A√±o a consultar.
     * @return array Billetera estructurada (Totales y √öltimas 10 Transacciones)
     */
    public function get_vendedor_stats( $vendedor_id, $mes = null, $anio = null ) {
        $mes = $mes ? intval( $mes ) : intval( date( 'm' ) );
        $anio = $anio ? intval( $anio ) : intval( date( 'Y' ) );

        $tabla_ledger = $this->table_name;
        $tabla_cot    = $this->wpdb->prefix . 'suite_cotizaciones';

        // 1. Agrupaci√≥n Contable (Totales por Estado)
        $sql_totales = $this->wpdb->prepare("
            SELECT estado_pago, SUM(comision_ganada_usd) as total
            FROM {$tabla_ledger}
            WHERE vendedor_id = %d AND MONTH(created_at) = %d AND YEAR(created_at) = %d
            GROUP BY estado_pago
        ", $vendedor_id, $mes, $anio);

        $resultados_totales = $this->wpdb->get_results( $sql_totales );

        $totales = [ 'pendiente' => 0.00, 'pagado' => 0.00 ];
        foreach ( $resultados_totales as $row ) {
            if ( isset( $totales[ $row->estado_pago ] ) ) {
                $totales[ $row->estado_pago ] = floatval( $row->total );
            }
        }

        // 2. Historial de Transacciones (√öltimas 10 del mes)
        $sql_historial = $this->wpdb->prepare("
            SELECT l.comision_ganada_usd, l.estado_pago, l.created_at, c.codigo_cotizacion, c.total_usd
            FROM {$tabla_ledger} l
            LEFT JOIN {$tabla_cot} c ON l.quote_id = c.id
            WHERE l.vendedor_id = %d AND MONTH(l.created_at) = %d AND YEAR(l.created_at) = %d
            ORDER BY l.id DESC
            LIMIT 10
        ", $vendedor_id, $mes, $anio);

        $historial = $this->wpdb->get_results( $sql_historial );

        return [
            'totales'   => $totales,
            'historial' => $historial
        ];
    }	
	
	
	
	
	
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-commission.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-employee.php ---
<?php
/**
 * Modelo de Base de Datos: Gestor de Empleados (Usuarios)
 *
 * Act√∫a como un Wrapper de las funciones nativas de WordPress para la gesti√≥n 
 * de usuarios (WP_User, wp_insert_user, get_users). Maneja la l√≥gica de negocio
 * del CRUD de empleados del ERP.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Employee {

    /**
     * Obtiene todos los empleados registrados en el ERP.
     * Excluye a los usuarios con rol 'subscriber' puro y trae el tel√©fono de los metadatos.
     *
     * @return array Lista de empleados con sus datos formateados.
     */
	public function get_all_employees() {
        // Obtenemos todos los usuarios excepto los suscriptores y clientes gen√©ricos
        $args = [
            'role__not_in' => [ 'subscriber', 'customer' ],
            'orderby'      => 'display_name',
            'order'        => 'ASC'
        ];

        $users = get_users( $args );
        $employees = [];

        foreach ( $users as $u ) {
            // Obtener el meta_key 'suite_telefono'. Si no existe, buscamos el fallback 'billing_phone'.
            $telefono = get_user_meta( $u->ID, 'suite_telefono', true );
            if ( empty( $telefono ) ) {
                $telefono = get_user_meta( $u->ID, 'billing_phone', true );
            }

            $employees[] = [
                'id'         => $u->ID,
                'nombre'     => $u->display_name,
                'email'      => $u->user_email,
                'telefono'   => ! empty( $telefono ) ? $telefono : '-',
                'roles'      => array_values( $u->roles ), // CORRECCI√ìN: Forzamos un array indexado limpio para JS
            ];
        }

        return $employees;
    }

    /**
     * Obtiene los datos detallados de un empleado en espec√≠fico.
     *
     * @param int $id ID del usuario.
     * @return array|false Datos del empleado o false si no existe.
     */
    public function get_employee( $id ) {
        $user = get_userdata( intval( $id ) );

        if ( ! $user ) {
            return false;
        }

        $telefono = get_user_meta( $user->ID, 'suite_telefono', true );
        if ( empty( $telefono ) ) {
            $telefono = get_user_meta( $user->ID, 'billing_phone', true );
        }

        return [
            'id'         => $user->ID,
            'nombre'     => $user->display_name,
            'first_name' => $user->first_name,
            'last_name'  => $user->last_name,
            'email'      => $user->user_email,
            'telefono'   => $telefono,
            'roles'      => $user->roles
        ];
    }

    /**
     * Crea o actualiza un empleado en la base de datos de WordPress.
     *
     * @param array $data Array con los campos: ID (opcional), email, password, first_name, last_name, role, telefono.
     * @return int|WP_Error El ID del usuario guardado o un objeto de error.
     */
    public function save_employee( $data ) {
        $id         = isset( $data['ID'] ) ? intval( $data['ID'] ) : 0;
        $email      = sanitize_email( $data['email'] );
        $password   = isset( $data['password'] ) ? $data['password'] : '';
        $first_name = isset( $data['first_name'] ) ? sanitize_text_field( $data['first_name'] ) : '';
        $last_name  = isset( $data['last_name'] ) ? sanitize_text_field( $data['last_name'] ) : '';
        $role       = isset( $data['role'] ) ? sanitize_text_field( $data['role'] ) : '';
        $telefono   = isset( $data['telefono'] ) ? sanitize_text_field( $data['telefono'] ) : '';

        if ( empty( $email ) ) {
            return new WP_Error( 'empty_email', 'El correo electr√≥nico es obligatorio.' );
        }

        // Preparar arreglo para wp_insert_user / wp_update_user
        $user_data = [
            'user_email' => $email,
            'first_name' => $first_name,
            'last_name'  => $last_name,
            'role'       => $role
        ];

        // Construir Display Name autom√°ticamente si hay datos
        $display_name = trim( $first_name . ' ' . $last_name );
        if ( ! empty( $display_name ) ) {
            $user_data['display_name'] = $display_name;
        }

        // L√≥gica dividida: Actualizaci√≥n vs Creaci√≥n
        if ( $id > 0 ) {
            $user_data['ID'] = $id;

            // Seguridad: Prevenir que un Administrador se quite su propio rol por accidente
            $current_user_id = get_current_user_id();
            if ( $id === $current_user_id && $role !== 'administrator' ) {
                $user_obj = get_userdata( $id );
                if ( in_array( 'administrator', (array) $user_obj->roles, true ) ) {
                    return new WP_Error( 'self_demotion', 'Seguridad: No puedes quitarte el rol de Administrador a ti mismo.' );
                }
            }

            // Solo actualizamos la contrase√±a si se envi√≥ una nueva
            if ( ! empty( $password ) ) {
                $user_data['user_pass'] = $password;
            }

        } else {
            // Es un usuario nuevo
            if ( username_exists( $email ) || email_exists( $email ) ) {
                return new WP_Error( 'user_exists', 'El correo electr√≥nico ya est√° registrado en el sistema.' );
            }

            if ( empty( $password ) ) {
                return new WP_Error( 'empty_password', 'La contrase√±a es obligatoria para crear nuevos usuarios.' );
            }

            // Usamos el email como nombre de usuario de login
            $user_data['user_login'] = $email;
            $user_data['user_pass']  = $password;
        }

        // wp_insert_user maneja tanto INSERT como UPDATE (si se env√≠a el 'ID' en el array)
        $user_id = wp_insert_user( $user_data );

        if ( is_wp_error( $user_id ) ) {
            return $user_id; // Retorna el error al controlador
        }

        // Guardar la Meta Data (Tel√©fono usado en impresiones PDF del ERP)
        update_user_meta( $user_id, 'suite_telefono', $telefono );
        
        // Opcional: Respaldar en 'billing_phone' por compatibilidad con c√≥digo Legacy
        update_user_meta( $user_id, 'billing_phone', $telefono );

        return $user_id;
    }

    /**
     * Elimina a un empleado del sistema.
     *
     * @param int $id ID del usuario a eliminar.
     * @param int|null $reassign ID de otro usuario al que se le reasignar√°n los posts/datos (opcional).
     * @return true|WP_Error
     */
    public function delete_employee( $id, $reassign = null ) {
        $id = intval( $id );

        // Seguridad: Evitar auto-eliminaci√≥n
        if ( $id === get_current_user_id() ) {
            return new WP_Error( 'self_deletion', 'Seguridad: No puedes eliminar tu propia cuenta activa.' );
        }

        // wp_delete_user requiere incluir manualmente el archivo de administraci√≥n de usuarios en el frontend o AJAX
        if ( ! function_exists( 'wp_delete_user' ) ) {
            require_once ABSPATH . 'wp-admin/includes/user.php';
        }

        $deleted = wp_delete_user( $id, $reassign );

        if ( $deleted ) {
            return true;
        }

        return new WP_Error( 'delete_failed', 'Fallo interno al intentar eliminar al empleado.' );
    }

}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-employee.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-inventory.php ---
<?php
/**
 * Modelo de Base de Datos: Inventario y Log√≠stica (M√≥dulo 3)
 *
 * Maneja las consultas de la tabla suite_inventario_cache.
 * Provee m√©todos para el descuento de stock y reservas temporales.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Inventory extends Suite_Model_Base {

    /**
     * Define el nombre de la tabla (sin el prefijo wp_)
     */
    protected function set_table_name() {
        return 'suite_inventario_cache';
    }

    /**
     * Descuenta el stock f√≠sico de los productos vendidos.
     * Por defecto, descuenta del almac√©n principal (stock_gale).
     *
     * @param array $items Array asociativo con 'sku' y 'cantidad'
     * @return void
     */
    public function discount_stock( $items ) {
        if ( empty( $items ) || ! is_array( $items ) ) {
            return;
        }

        foreach ( $items as $item ) {
            $sku = isset( $item['sku'] ) ? sanitize_text_field( $item['sku'] ) : '';
            $qty = isset( $item['cantidad'] ) ? intval( $item['cantidad'] ) : 0;

            // Ignorar productos manuales o gen√©ricos que no est√°n en el cat√°logo
            if ( empty( $sku ) || $qty <= 0 || in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                continue;
            }

            // Consulta directa para restar el stock at√≥micamente a nivel de base de datos
            // Esto previene condiciones de carrera si dos usuarios compran al mismo exacto milisegundo
            $sql = $this->wpdb->prepare(
                "UPDATE {$this->table_name} 
                 SET stock_gale = stock_gale - %d 
                 WHERE sku = %s",
                $qty,
                $sku
            );

            $this->wpdb->query( $sql );
            
            // Log de auditor√≠a (Opcional, si tienes suite_record_log global)
            if ( function_exists('suite_record_log') ) {
                suite_record_log('descuento_inventario', "Se descontaron {$qty} unidades del SKU: {$sku}");
            }
        }
    }

    /**
     * Reserva stock temporalmente (Hard Commit) para clientes "En Espera de Pago".
     * TODO: [M√≥dulo 3 - Log√≠stica] Requiere la creaci√≥n de la tabla wp_suite_reservas.
     *
     * @param string $sku   El c√≥digo del producto
     * @param int    $qty   Cantidad a reservar
     * @param int    $hours Tiempo de vida de la reserva en horas
     * @return bool
     */
    public function reserve_stock_temporal( $sku, $qty, $hours = 24 ) {
        /*
        $expiration = date('Y-m-d H:i:s', strtotime("+{$hours} hours"));
        
        return $this->wpdb->insert( $this->wpdb->prefix . 'suite_reservas', [
            'sku'        => sanitize_text_field($sku),
            'cantidad'   => intval($qty),
            'expira_en'  => $expiration
        ] );
        */
        
        return true; // Placeholder hasta construir la tabla
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-inventory.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-product.php ---
<?php
/**
 * Modelo de Base de Datos: Productos y Precios
 *
 * Extrae la metadata de WooCommerce y la cruza con los precios (precios.csv)
 * y el inventario en tiempo real (reporte_final.csv).
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Product {

    public function get_products_with_csv_prices( $term = '' ) {
        global $wpdb;

        // 1. CONSULTA SQL OPTIMIZADA A WOOCOMMERCE
        $sql = "SELECT p.ID, p.post_title AS nombre, pm.meta_value AS sku
                FROM {$wpdb->posts} p
                LEFT JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id AND pm.meta_key = '_sku'
                WHERE p.post_type = 'product' AND p.post_status = 'publish'";

        if ( ! empty( $term ) ) {
            $like = '%' . $wpdb->esc_like( $term ) . '%';
            $sql .= $wpdb->prepare( " AND (p.post_title LIKE %s OR pm.meta_value LIKE %s)", $like, $like );
        }

        $sql .= " LIMIT 50"; // L√≠mite de seguridad
        $woo_products = $wpdb->get_results( $sql );

        if ( empty( $woo_products ) ) {
            return [];
        }

        // 2. PROCESAMIENTO DEL CSV DE PRECIOS
        $csv_prices = [];
        $csv_path_precios = SUITE_PATH . 'output/precios.csv';

        if ( file_exists( $csv_path_precios ) && ( $handle = fopen( $csv_path_precios, 'r' ) ) !== false ) {
            fgetcsv( $handle, 1000, ',' ); // Saltamos la cabecera

            while ( ( $data = fgetcsv( $handle, 1000, ',' ) ) !== false ) {
                $sku = isset( $data[0] ) ? trim( $data[0] ) : '';
                
                // Limpieza num√©rica estricta (Convierte "12.018,00" -> 12018.00)
                $precio_raw = isset( $data[1] ) ? trim( $data[1] ) : '0';
                $precio_raw = str_replace( '"', '', $precio_raw ); 
                $precio_raw = str_replace( '.', '', $precio_raw ); 
                $precio_raw = str_replace( ',', '.', $precio_raw ); 
                $precio_float = floatval( $precio_raw );

                if ( ! empty( $sku ) ) {
                    $csv_prices[ strtoupper( $sku ) ] = $precio_float;
                }
            }
            fclose( $handle );
        }

        // 3. PROCESAMIENTO DEL CSV DE INVENTARIO (reporte_final.csv)
        $csv_inventory = [];
        $csv_path_inventario = SUITE_PATH . 'output/reporte_final.csv';

        if ( file_exists( $csv_path_inventario ) && ( $handle2 = fopen( $csv_path_inventario, 'r' ) ) !== false ) {
            fgetcsv( $handle2, 1000, ',' ); // Saltamos la cabecera

            while ( ( $data2 = fgetcsv( $handle2, 1000, ',' ) ) !== false ) {
                $sku = isset( $data2[0] ) ? trim( $data2[0] ) : '';
                
                // Extraemos Stock Total (Columna 3) y Disponibilidad Galer√≠as (Columna 8)
                $stock_total = isset( $data2[3] ) ? trim( $data2[3] ) : '0';
                $stock_gale  = isset( $data2[8] ) ? trim( $data2[8] ) : '0';

                if ( ! empty( $sku ) ) {
                    // Usamos intval(floatval()) para manejar casos donde el CSV diga "20.0" limpi√°ndolo a "20"
                    $csv_inventory[ strtoupper( $sku ) ] = [
                        'total' => intval( floatval( $stock_total ) ),
                        'gale'  => intval( floatval( $stock_gale ) )
                    ];
                }
            }
            fclose( $handle2 );
        }

        // 4. EL CRUCE TRIPLE (MERGE) EN MEMORIA
        $final_products = [];

        foreach ( $woo_products as $prod ) {
            $sku_clean = ! empty( $prod->sku ) ? strtoupper( trim( $prod->sku ) ) : '';

            // Regla de Negocio de Precios: Si existe en CSV usar precio, si no, es 0.00
            $precio = ( $sku_clean && isset( $csv_prices[ $sku_clean ] ) ) ? $csv_prices[ $sku_clean ] : 0.00;

            // Regla de Negocio de Inventario: Si existe el SKU extraemos stocks, sino 'N/D'
            $stock_total = ( $sku_clean && isset( $csv_inventory[ $sku_clean ] ) ) ? $csv_inventory[ $sku_clean ]['total'] : 'N/D';
            $stock_gale  = ( $sku_clean && isset( $csv_inventory[ $sku_clean ] ) ) ? $csv_inventory[ $sku_clean ]['gale']  : 'N/D';

            $final_products[] = [
                'id'          => $prod->ID,
                'nombre'      => esc_html( $prod->nombre ),
                'sku'         => $sku_clean ? $sku_clean : 'N/A',
                'precio'      => number_format( $precio, 2, '.', '' ),
                'stock_gale'  => (string) $stock_gale,
                'stock_total' => (string) $stock_total
            ];
        }

        return $final_products;
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-product.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-quote.php ---
<?php
/**
 * Modelo de Base de Datos: Cotizaciones y Pedidos
 *
 * Maneja transacciones de ventas, Kanban y reglas de inmutabilidad.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Quote extends Suite_Model_Base {

    protected function set_table_name() {
        return 'suite_cotizaciones';
    }

    /**
     * Crea una cotizaci√≥n completa usando Transacciones SQL Seguras y 
     * validaci√≥n cruzada de precios para evitar vulnerabilidades.
     */
    public function create_quote( $client_data, $items, $meta ) {
        // 1. Iniciar Transacci√≥n
        $this->wpdb->query( 'START TRANSACTION' );

        try {
            // --- GESTI√ìN DEL CLIENTE ---
            $client_model = new Suite_Model_Client();
            
            $rif_limpio = strtoupper( preg_replace( '/[^A-Z0-9]/', '', $client_data['rif_ci'] ) );
            if ( empty( $rif_limpio ) ) throw new Exception( 'El RIF proporcionado no es v√°lido.' );
            $client_data['rif_ci'] = $rif_limpio;

            $existing_client = $this->wpdb->get_row( $this->wpdb->prepare( "SELECT id FROM {$this->wpdb->prefix}suite_clientes WHERE rif_ci = %s", $rif_limpio ) );

            $cliente_id = 0;
            if ( $existing_client ) {
                $cliente_id = $existing_client->id;
            } else {
                $cliente_id = $client_model->insert( $client_data );
                if ( ! $cliente_id ) throw new Exception( 'Fallo al registrar el nuevo cliente.' );
            }

            // --- GENERACI√ìN DE C√ìDIGO ---
            $hoy_start = date( 'Y-m-d 00:00:00' ); 
            $hoy_end   = date( 'Y-m-d 23:59:59' );
            $count = $this->wpdb->get_var( "SELECT COUNT(*) FROM {$this->table_name} WHERE fecha_emision BETWEEN '$hoy_start' AND '$hoy_end'" );
            $codigo = date( 'Y' ) . str_pad( $count + 1, 2, '0', STR_PAD_LEFT ) . date( 'd' ) . date( 'm' );

            // --- INSERCI√ìN CABECERA ---
            $quote_id = $this->insert( [
                'codigo_cotizacion' => $codigo,
                'cliente_id'        => $cliente_id,
                'cliente_nombre'    => $client_data['nombre_razon'],
                'cliente_rif'       => $rif_limpio,
                'direccion_entrega' => $client_data['direccion'],
                'vendedor_id'       => $meta['vendedor_id'],
                'tasa_bcv'          => floatval( $meta['tasa'] ),
                'validez_dias'      => intval( $meta['validez'] ),
                'moneda'            => sanitize_text_field( $meta['moneda'] ),
                'total_usd'         => 0, // Se actualizar√° luego del loop
                'fecha_emision'     => current_time( 'mysql' ),
                'estado'            => 'emitida'
            ] );

            if ( ! $quote_id ) throw new Exception( 'Fallo al generar la cabecera.' );

            // --- INSERCI√ìN DETALLE (Optimizaci√≥n N+1) ---
            $total_usd = 0;
            $table_items = $this->wpdb->prefix . 'suite_cotizaciones_items';
            $table_inv   = $this->wpdb->prefix . 'suite_inventario_cache';

            // 1. Pre-cargar todos los precios en 1 sola consulta
            $skus_a_buscar = [];
            foreach ( $items as $item ) {
                if ( ! in_array( strtoupper( $item['sku'] ), ['MANUAL', 'GENERICO'] ) ) {
                    $skus_a_buscar[] = sanitize_text_field( $item['sku'] );
                }
            }
            
            $precios_db = [];
            if ( ! empty( $skus_a_buscar ) ) {
                $placeholders = implode( ',', array_fill( 0, count( $skus_a_buscar ), '%s' ) );
                $sql_precios = $this->wpdb->prepare( "SELECT sku, precio FROM {$table_inv} WHERE sku IN ($placeholders)", ...$skus_a_buscar );
                $resultados_precios = $this->wpdb->get_results( $sql_precios );
                foreach ( $resultados_precios as $rp ) {
                    $precios_db[ strtoupper($rp->sku) ] = floatval( $rp->precio );
                }
            }

            // 2. Procesar inserciones en memoria
			foreach ( $items as $item ) {
                $sku = sanitize_text_field( $item['sku'] );
                $qty = intval( $item['qty'] );
                $safe_price = floatval( $item['price'] ); // Precio introducido por el vendedor

                if ( ! in_array( strtoupper( $sku ), ['MANUAL', 'GENERICO'] ) ) {
                    if ( isset( $precios_db[ strtoupper($sku) ] ) ) {
                        
                        $precio_minimo_db = floatval( $precios_db[ strtoupper($sku) ] );
                        
                        // CANDADO INTELIGENTE: 
                        // Solo forzamos el precio de la BD si el vendedor lo puso m√°s barato.
                        // Si el vendedor lo puso m√°s caro, se respeta su $safe_price original.
                        if ( $safe_price < $precio_minimo_db ) {
                            $safe_price = $precio_minimo_db;
                        }

                    } else {
                        throw new Exception( "El producto con SKU '{$sku}' no existe en el cat√°logo." );
                    }
                }

                $sub = $qty * $safe_price;
                $total_usd += $sub;

                $this->wpdb->insert( $table_items, [
                    'cotizacion_id'       => $quote_id,
                    'sku'                 => $sku,
                    'producto_nombre'     => sanitize_text_field( $item['name'] ),
                    'cantidad'            => $qty,
                    'precio_unitario_usd' => $safe_price,
                    'tiempo_entrega'      => isset( $item['time'] ) ? sanitize_text_field( $item['time'] ) : 'Inmediata',
                    'subtotal_usd'        => $sub
                ] );
            }

            // --- ACTUALIZAR TOTALES ---
            $this->update( $quote_id, [
                'total_usd' => $total_usd,
                'total_bs'  => $total_usd * floatval( $meta['tasa'] )
            ] );

            $this->wpdb->query( 'COMMIT' );
            return [ 'id' => $codigo, 'internal_id' => $quote_id ];

        } catch ( Exception $e ) {
            $this->wpdb->query( 'ROLLBACK' );
            return new WP_Error( 'db_error', $e->getMessage() );
        }
    }

    /**
     * Obtiene el historial de cotizaciones (Tabla)
     */
    public function get_vendor_history( $user_id, $limit = 50, $is_admin = false ) {
        $tabla_cli = $this->wpdb->prefix . 'suite_clientes';
        $sql = "SELECT c.*, cli.telefono as cliente_telefono, cli.nombre_razon as cliente_nombre_real 
                FROM {$this->table_name} c 
                LEFT JOIN {$tabla_cli} cli ON c.cliente_id = cli.id";
        
        if ( ! $is_admin ) $sql .= $this->wpdb->prepare( " WHERE c.vendedor_id = %d", $user_id );
        
        $sql .= $this->wpdb->prepare( " ORDER BY c.id DESC LIMIT %d", $limit );
        return $this->wpdb->get_results( $sql );
    }

    /**
     * Obtiene los pedidos agrupados por estado (Kanban)
     */
	public function get_kanban_orders( $vendedor_id = null, $is_admin = false ) {
        // --- INICIO: REGLA 3 ZERO-TRUST (Visibilidad del Kanban) ---
        $user = wp_get_current_user();
        $roles = (array) $user->roles;
        
        $is_admin_real = current_user_can( 'manage_options' );
        $is_gerente = in_array( 'suite_gerente', $roles ) || in_array( 'gerente', $roles );
        $is_logistica = in_array( 'suite_logistica', $roles );
        
        // El acceso global se otorga si tiene el rol gerencial/log√≠stico, o si el par√°metro legacy es true
        $tiene_acceso_global = ( $is_admin_real || $is_gerente || $is_logistica || $is_admin );
        $current_vendedor_id = get_current_user_id();
        // --- FIN: ZERO-TRUST ---

        $tabla_cli = $this->wpdb->prefix . 'suite_clientes';
        
        $sql = "SELECT c.id, c.codigo_cotizacion, c.total_usd, c.fecha_emision, c.estado, c.vendedor_id, cli.nombre_razon AS cliente_nombre 
                FROM {$this->table_name} c 
                LEFT JOIN {$tabla_cli} cli ON c.cliente_id = cli.id";
        
        // APLICACI√ìN RLS: Si no tiene acceso global, forzamos a que solo vea lo suyo
        if ( ! $tiene_acceso_global ) {
            $sql .= $this->wpdb->prepare( " WHERE c.vendedor_id = %d", intval( $current_vendedor_id ) );
        } elseif ( $vendedor_id ) {
            // Si tiene acceso global pero pidi√≥ ver el de un vendedor espec√≠fico (ej. filtro en la vista)
            $sql .= $this->wpdb->prepare( " WHERE c.vendedor_id = %d", intval( $vendedor_id ) );
        }

        $sql .= " ORDER BY c.fecha_emision DESC LIMIT 200";
        
        $resultados = $this->wpdb->get_results( $sql );
        
        // AGREGADO: √önicamente la llave 'por_enviar' (Protegido de tu versi√≥n original)
        $kanban_data = [ 'emitida' => [], 'proceso' => [], 'pagado' => [], 'por_enviar' => [], 'despachado' => [] ];
        
        foreach ( $resultados as $row ) {
            $estado = empty( $row->estado ) ? 'emitida' : strtolower( $row->estado );
            if ( ! isset( $kanban_data[ $estado ] ) ) $kanban_data[ $estado ] = [];

            $row->total_fmt = number_format( floatval( $row->total_usd ), 2 );
            $row->fecha_fmt = date( 'd/m', strtotime( $row->fecha_emision ) );

            // PREVENCI√ìN XSS: Escapar variables sensibles antes de enviarlas al JSON de Vue/Vanilla JS
            $row->cliente_nombre    = esc_html( $row->cliente_nombre );
            $row->codigo_cotizacion = esc_html( $row->codigo_cotizacion );

            $kanban_data[ $estado ][] = $row;
        }

        return $kanban_data;
    }

    /**
     * M√ìDULO 2 Y 3: Inmutabilidad y Descuento de Inventario
     * Actualiza el estado del pedido y ejecuta reglas de negocio financieras y log√≠sticas.
     */
    public function update_order_status( $quote_id, $new_status ) {
        $new_status = strtolower( sanitize_text_field( $new_status ) );
        
        // 1. Obtener estado actual del pedido
        $current_order = $this->get( $quote_id );
        if ( ! $current_order ) {
            return new WP_Error( 'not_found', 'El pedido no existe.' );
        }

        $current_status = strtolower( $current_order->estado );
        $protected_statuses = [ 'pagado', 'despachado' ];

        // 2. CANDADO DE INMUTABILIDAD (M√≥dulo 2)
        $is_admin = current_user_can( 'manage_options' );
        if ( in_array( $current_status, $protected_statuses ) && ! $is_admin ) {
            return new WP_Error( 'immutable_lock', 'Candado de Inmutabilidad: Este pedido ya ha sido procesado (Pagado/Enviado) y no puede ser modificado por su nivel de acceso.' );
        }

        // 3. Actualizar el estado en Base de Datos de forma AT√ìMICA (Bloqueo Optimista)
        $sql_update = $this->wpdb->prepare(
            "UPDATE {$this->table_name} SET estado = %s WHERE id = %d AND estado = %s",
            $new_status, intval($quote_id), $current_status
        );
        $filas_afectadas = $this->wpdb->query( $sql_update );

        // Si filas_afectadas es 0, otro proceso ya cambi√≥ el estado en este milisegundo (Race Condition)
        if ( ! $filas_afectadas ) {
            return new WP_Error( 'race_condition', 'Conflicto de concurrencia: El pedido ya fue procesado por otro usuario.' );
        }

        // 4. DESCUENTO DE INVENTARIO (M√≥dulo 3)
        if ( in_array( $new_status, $protected_statuses ) && ! in_array( $current_status, $protected_statuses ) ) {
            $this->process_inventory_discount( $quote_id );
        }

        return true;
    }

    /**
     * M√ìDULO 3: Helper para el descuento de inventario.
     */
    private function process_inventory_discount( $quote_id ) {
        // 1. Obtener los √≠tems de este pedido
        $table_items = $this->wpdb->prefix . 'suite_cotizaciones_items';
        $items = $this->wpdb->get_results( $this->wpdb->prepare(
            "SELECT sku, cantidad FROM {$table_items} WHERE cotizacion_id = %d",
            $quote_id
        ), ARRAY_A );

        if ( empty( $items ) ) return;

        // 2. Instanciar el modelo de Inventario y descontar
        $inventory_model = new Suite_Model_Inventory();
        $inventory_model->discount_stock( $items );
    }
}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-quote.php ---

--- INICIO DEL ARCHIVO: includes/Models/class-suite-model-roles.php ---
<?php
/**
 * Modelo de Base de Datos: Gestor Din√°mico de Roles y Permisos
 *
 * Act√∫a como un Wrapper (envoltura) de la clase global WP_Roles de WordPress.
 * Permite gestionar roles personalizados y asignar capacidades (Capabilities)
 * de forma din√°mica para el ERP.
 *
 * @package SuiteEmpleados\Models
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class Suite_Model_Roles {

    /**
     * Devuelve el diccionario maestro de capacidades del ERP agrupadas por m√≥dulos.
     * Este array alimenta la matriz de checkboxes en la interfaz de usuario.
     *
     * @return array
     */
    public function get_capabilities_dictionary() {
        return [
            'crm' => [
                'suite_view_crm'       => 'Ver Clientes y Cotizar',
                'suite_manage_clients' => 'Crear, Editar y Eliminar Clientes',
                'suite_change_status'  => 'Cambiar Estados (Kanban)'
            ],
            'logistica' => [
                'suite_view_logistics' => 'Ver Almac√©n y Despacho',
                'suite_print_picking'  => 'Imprimir Hoja de Picking',
                'suite_upload_pod'     => 'Subir Comprobante de Entrega (POD)'
            ],
            'admin' => [
                'suite_export_data'    => 'Exportar a Excel/CSV',
                'suite_view_marketing' => 'Ver Anal√≠ticas y Marketing (BI)',
                'suite_manage_team'    => 'Gestionar Empleados y Roles'
            ]
        ];
    }

    /**
     * Obtiene todos los roles registrados en el sistema WordPress.
     *
     * @return array Array de roles.
     */
    public function get_all_roles() {
        global $wp_roles;
        
        // Asegurar que la clase global est√© instanciada
        if ( ! isset( $wp_roles ) ) {
            $wp_roles = wp_roles();
        }

        return $wp_roles->roles;
    }

    /**
     * Crea un rol nuevo o actualiza uno existente (Nombre y Capacidades).
     *
     * @param string $role_key Identificador √∫nico (slug) del rol (ej. 'vendedor_senior').
     * @param string $display_name Nombre p√∫blico del rol (ej. 'Vendedor Senior').
     * @param array $capabilities_array Array simple con los keys de las capacidades activadas.
     * @return true|WP_Error
     */
    public function create_or_update_role( $role_key, $display_name, $capabilities_array ) {
        global $wp_roles;

        if ( ! isset( $wp_roles ) ) {
            $wp_roles = wp_roles();
        }

        $role_key     = sanitize_key( $role_key );
        $display_name = sanitize_text_field( $display_name );
        $role_obj     = get_role( $role_key );

        if ( ! $role_obj ) {
            // 1. CREACI√ìN: El rol no existe, usar add_role
            $role_obj = add_role( $role_key, $display_name );
            if ( ! $role_obj ) {
                return new WP_Error( 'role_creation_failed', 'Error interno al intentar crear el rol.' );
            }
        } else {
            // 2. ACTUALIZACI√ìN DE NOMBRE: WordPress no tiene funci√≥n nativa para renombrar. 
            // Se debe actualizar directamente en el array global y guardar en la BD.
            $wp_roles->roles[ $role_key ]['name'] = $display_name;
            $wp_roles->role_names[ $role_key ]    = $display_name;
            update_option( $wp_roles->role_key, $wp_roles->roles );
        }

        // 3. LIMPIEZA DE CAPACIDADES: Revocar todas las capacidades espec√≠ficas de la Suite
        // Esto garantiza que si el usuario desmarc√≥ un checkbox, el permiso se elimine.
        $dictionary = $this->get_capabilities_dictionary();
        foreach ( $dictionary as $group => $caps ) {
            foreach ( $caps as $cap_key => $cap_label ) {
                $role_obj->remove_cap( $cap_key );
            }
        }

        // 4. ASIGNACI√ìN: Otorgar las capacidades recibidas en el payload
        if ( is_array( $capabilities_array ) && ! empty( $capabilities_array ) ) {
            foreach ( $capabilities_array as $cap ) {
                $role_obj->add_cap( sanitize_key( $cap ) );
            }
        }

        // 5. PERMISOS BASE OBLIGATORIOS
        $role_obj->add_cap( 'read' );         // Necesario para entrar al wp-admin/intranet
        $role_obj->add_cap( 'suite_access' ); // Bandera general de pertenencia al ERP

        return true;
    }

    /**
     * Elimina un rol del sistema.
     * Posee una barrera de seguridad para no destruir roles cr√≠ticos.
     *
     * @param string $role_key Identificador √∫nico del rol.
     * @return true|WP_Error
     */
    public function delete_role( $role_key ) {
        $role_key = sanitize_key( $role_key );

        // BARRERA DE SEGURIDAD: Prohibido borrar roles cr√≠ticos
        $protected_roles = [ 'administrator', 'subscriber', 'editor', 'author', 'contributor' ];
        
        if ( in_array( $role_key, $protected_roles, true ) ) {
            return new WP_Error( 'protected_role', 'Seguridad: No se permite eliminar los roles nativos del n√∫cleo de WordPress.' );
        }

        $role_obj = get_role( $role_key );
        
        if ( ! $role_obj ) {
            return new WP_Error( 'role_not_found', 'El rol que intenta eliminar no existe.' );
        }

        // TODO: (Opcional Arquitect√≥nico) Verificar si existen usuarios con este rol antes de borrarlo
        // y pasarlos a un rol "subscriber" temporal.

        remove_role( $role_key );

        return true;
    }

}
--- FIN DEL ARCHIVO: includes/Models/class-suite-model-roles.php ---

--- INICIO DEL ARCHIVO: includes/Models/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: includes/Models/index.php ---

--- INICIO DEL ARCHIVO: languages/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: languages/index.php ---

--- INICIO DEL ARCHIVO: views/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: views/index.php ---

--- INICIO DEL ARCHIVO: views/app/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: views/app/index.php ---

--- INICIO DEL ARCHIVO: views/app/tab-clientes.php ---
<?php
/**
 * Vista: Pesta√±a de Clientes (CRM) y Modales
 * 
 * Espera recibir las variables:
 * @var array $clientes Array de objetos con los datos de los clientes.
 * @var bool  $es_admin Booleano que indica si el usuario tiene privilegios de administrador.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<!-- ========================================================= -->
<!-- 1. PESTA√ëA PRINCIPAL (TABLA DE CLIENTES)                  -->
<!-- ========================================================= -->
<div id="TabCli" class="suite-tab-content active"> <!-- Le a√±adimos 'active' temporalmente para la prueba -->
    
    <!-- Barra de Herramientas Superior -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; position:relative;">
        
        <!-- Buscador DataTables -->
        <div style="width: 320px; position:relative;">
            <span class="dashicons dashicons-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></span>
            <input type="text" id="clients-table-search" placeholder="Buscar cliente por RIF o Nombre..." style="width:100%; padding: 10px 15px 10px 45px; border-radius: 8px; border: 1px solid #cbd5e1;">
        </div>
        
        <!-- Botones de Acci√≥n (Solo Admin) -->
        <?php if ( $es_admin ) : ?>
            <div>
                <!-- Nota: openModal asumimos que vive en main.js o lo dejamos como helper global en UI -->
                <button class="btn-modern-action" onclick="jQuery('#modal-add-client').fadeIn();">‚ûï Nuevo Cliente</button>
                <button class="btn-modern-action" onclick="jQuery('#modal-import-clients').fadeIn();">üì• Importar CSV</button>
            </div>
        <?php endif; ?>
    </div>

    <!-- Contenedor de la Tabla -->
    <div class="suite-table-responsive">
        <table id="clientsTable" class="suite-modern-table display nowrap">
            <thead>
                <tr>
                    <th>RIF</th>
                    <th>Nombre / Raz√≥n Social</th>
                    <th>Contacto</th>
                    <th>Ubicaci√≥n</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <?php if ( isset( $clientes ) && ! empty( $clientes ) ) : ?>
					<?php foreach ( $clientes as $c ) : ?>
						<tr>
                            <td class="font-mono"><?php echo esc_html( $c->rif_ci ); ?></td>
                            <td><strong><?php echo esc_html( $c->nombre_razon ); ?></strong></td>
                            
                            <td>
                                <?php echo esc_html( $c->telefono ); ?><br>
                                <small style="color: #64748b;"><?php echo esc_html( $c->email ); ?></small>
                            </td>
                            
                            <td><?php echo esc_html( ucwords( strtolower( $c->ciudad ) ) ); ?></td>
                            
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-modern-action small" onclick="SuiteCRM.openProfile(<?php echo intval( $c->id ); ?>)">üìÇ Expediente</button>
                                    
                                    <?php 
                                    $wa_phone = preg_replace('/[^0-9]/', '', $c->telefono);
                                    if ( ! empty( $wa_phone ) ) : 
                                        if ( strlen( $wa_phone ) === 11 && strpos( $wa_phone, '0' ) === 0 ) {
                                            $wa_phone = '58' . substr( $wa_phone, 1 );
                                        } elseif ( strlen( $wa_phone ) === 10 ) {
                                            $wa_phone = '58' . $wa_phone;
                                        }
                                    ?>
                                        <a href="https://api.whatsapp.com/send?phone=<?php echo esc_attr( $wa_phone ); ?>" target="_blank" class="btn-modern-action small" style="color: #059669; border-color: #a7f3d0; background: #ecfdf5; text-decoration: none;">üì± WA</a>
                                    <?php endif; ?>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- ========================================================= -->
<!-- 2. MODALES ESPEC√çFICOS DEL CRM                            -->
<!-- ========================================================= -->

<!-- Modal: Crear Nuevo Cliente -->
<div id="modal-add-client" class="suite-modal" style="display: none;">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('.suite-modal').fadeOut();">√ó</span>
        <h3 style="margin-top:0; color:#0f172a;">‚ûï Nuevo Cliente</h3>
        
        <div class="form-group-row">
            <div style="flex:1">
                <label>RIF/CI *</label>
                <input type="text" id="new-cli-rif" class="widefat" placeholder="Ej: J123456789">
            </div>
            <div style="flex:2">
                <label>Nombre/Raz√≥n Social *</label>
                <input type="text" id="new-cli-nombre" class="widefat">
            </div>
        </div>
        
        <div class="form-group-row">
            <div style="flex:1"><label>Tel√©fono</label><input type="text" id="new-cli-tel" class="widefat"></div>
            <div style="flex:1"><label>Email</label><input type="email" id="new-cli-email" class="widefat"></div>
        </div>
        
        <label>Direcci√≥n</label>
        <input type="text" id="new-cli-dir" class="widefat">
        
        <div class="form-group-row">
            <div style="flex:1"><label>Ciudad</label><input type="text" id="new-cli-ciudad" class="widefat"></div>
            <div style="flex:1"><label>Estado</label><input type="text" id="new-cli-estado" class="widefat"></div>
        </div>
        
        <button class="btn-save-big" id="btn-create-client" style="margin-top:15px;">Guardar Cliente</button>
    </div>
</div>

<!-- Modal: Importar Clientes Masivamente -->
<div id="modal-import-clients" class="suite-modal" style="display: none;">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('.suite-modal').fadeOut();">√ó</span>
        <h3 style="margin-top:0; color:#0f172a;">üì• Importar Clientes</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Orden exacto del CSV: <strong>Nombre, RIF, Tel√©fono, Email, Direcci√≥n</strong>
        </p>
        <input type="file" id="csv-clients-file" accept=".csv" class="widefat" style="padding:10px; background:#f8fafc;">
        <button class="btn-save-big" id="btn-run-import-cli" style="margin-top:10px;">Procesar Importaci√≥n</button>
    </div>
</div>

<!-- Modal: Expediente / Perfil de Cliente -->
<style>
/* =========================================================
   RECUPERACI√ìN: MODAL INMERSIVO DEL PERFIL DEL CLIENTE
   ========================================================= */
#modal-client-profile .suite-modal-content.large {
    max-width: 1200px;
    width: 95%;
    height: 90vh; /* Pantalla completa */
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
    background: #f8fafc;
    border-radius: 16px;
}

#modal-client-profile .modal-header-fixed {
    padding: 20px 30px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    position: relative;
    border-radius: 16px 16px 0 0;
}

#modal-client-profile .close-modal-float {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 32px;
    font-weight: bold;
    color: #94a3b8;
    cursor: pointer;
    transition: all 0.2s;
    line-height: 1;
}

#modal-client-profile .close-modal-float:hover {
    color: #dc2626;
    transform: scale(1.1);
}

#modal-client-profile .modal-body-scroll {
    display: flex;
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    gap: 30px;
}

/* Columna Izquierda */
#modal-client-profile .profile-left {
    flex: 0 0 380px;
    background: #ffffff;
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
}

/* Columna Derecha */
#modal-client-profile .profile-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* Tarjetas KPI */
#modal-client-profile .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

#modal-client-profile .kpi-card {
    padding: 25px;
    border-radius: 16px;
    color: white;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

#modal-client-profile .kpi-card.kpi-total { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
#modal-client-profile .kpi-card.kpi-count { background: linear-gradient(135deg, #0284c7 0%, #3b82f6 100%); }
#modal-client-profile .kpi-card.kpi-last  { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }

#modal-client-profile .kpi-card small {
    font-size: 13px;
    text-transform: uppercase;
    font-weight: 600;
    opacity: 0.9;
    margin-bottom: 5px;
    display: block;
}

#modal-client-profile .kpi-card strong {
    font-size: 34px;
    font-weight: 800;
    letter-spacing: -1px;
    line-height: 1.2;
}

/* Historial */
#modal-client-profile .history-container {
    flex: 1;
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#modal-client-profile .history-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    font-weight: 700;
    color: #0f172a;
    font-size: 15px;
}

#modal-client-profile .history-scroll {
    flex: 1;
    overflow-y: auto;
}

@media (max-width: 900px) {
    #modal-client-profile .modal-body-scroll { flex-direction: column; }
    #modal-client-profile .profile-left { flex: auto; }
    #modal-client-profile .suite-modal-content.large { height: 100%; width: 100%; border-radius: 0; max-height: 100vh; }
}
</style>

<div id="modal-client-profile" class="suite-modal" style="display: none;">
    <div class="suite-modal-content large">

        <div class="modal-header-fixed">
            <h3 id="cli-profile-name" style="margin:0; color:#0f172a; font-size: 22px;">üìÇ Expediente del Cliente</h3>
            <span class="close-modal-float" onclick="jQuery('#modal-client-profile').fadeOut();">&times;</span>
        </div>

        <div class="modal-body-scroll">
            <div class="profile-left">
                <h4 style="margin:0 0 15px 0; color:#475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; font-size: 14px;">üìã Informaci√≥n de Contacto</h4>

                <input type="hidden" id="prof-id">

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>RIF/CI</label>
                        <input type="text" id="prof-rif" class="widefat" readonly style="background-color: #f1f5f9; cursor: not-allowed;" title="El RIF no puede ser modificado">
                    </div>
                    <div style="flex: 2;">
                        <label>Raz√≥n Social</label>
                        <input type="text" id="prof-nombre" class="widefat">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Tel√©fono</label>
                        <input type="text" id="prof-tel" class="widefat">
                    </div>
                    <div style="flex: 1;">
                        <label>Email</label>
                        <input type="email" id="prof-email" class="widefat">
                    </div>
                </div>

                <label>Direcci√≥n F√≠sica</label>
                <input type="text" id="prof-dir" class="widefat">

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Ciudad</label>
                        <input type="text" id="prof-ciudad" class="widefat">
                    </div>
                    <div style="flex: 1;">
                        <label>Estado</label>
                        <input type="text" id="prof-estado" class="widefat">
                    </div>
                </div>

                <label>Persona de Contacto</label>
                <input type="text" id="prof-contacto" class="widefat">

                <label>üìù Notas Internas</label>
                <textarea id="prof-notas" class="widefat" rows="3" placeholder="A√±adir observaciones sobre este cliente..."></textarea>

                <div style="display:flex; gap:10px; margin-top: auto; padding-top: 15px;">
                    <button id="btn-update-profile" class="btn-save-big" style="flex:2;">üíæ Guardar Cambios</button>
                    <?php if ( $es_admin ) : ?>
                    <button id="btn-delete-profile" class="btn-modern-action" style="flex:1; color:#dc2626; border-color:#fca5a5; justify-content: center; background:#fef2f2;">üóëÔ∏è Eliminar</button>
                    <?php endif; ?>
                </div>
            </div>

            <div class="profile-right">
                <div class="kpi-row" id="cli-profile-kpi-compras">
                    <div class="kpi-card kpi-total">
                        <small>üí∞ Total Gastado</small>
                        <strong id="kpi-total">$0.00</strong>
                    </div>
                    <div class="kpi-card kpi-count">
                        <small>üõí Total Operaciones</small>
                        <strong id="kpi-count">0</strong>
                    </div>
                    <div class="kpi-card kpi-last">
                        <small>üìÖ √öltima Compra</small>
                        <strong id="kpi-last">-</strong>
                    </div>
                </div>

                <div class="history-container">
                    <div class="history-header">
                        üìú Historial de Cotizaciones y Pedidos
                    </div>
                    <div class="history-scroll">
                        <table class="suite-modern-table" id="cli-history-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="position: sticky; top: 0; z-index: 2; background: #f8fafc;">Fecha</th>
                                    <th style="position: sticky; top: 0; z-index: 2; background: #f8fafc;">C√≥digo</th>
                                    <th style="position: sticky; top: 0; z-index: 2; background: #f8fafc;">Total</th>
                                    <th style="position: sticky; top: 0; z-index: 2; background: #f8fafc;">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="prof-history-body">
                                <tr><td colspan="4" style="text-align: center; padding: 30px; color: #94a3b8;">Cargando datos del cliente...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-clientes.php ---

--- INICIO DEL ARCHIVO: views/app/tab-comisiones.php ---
<?php
/**
 * Vista: Dashboard de Comisiones y Gamificaci√≥n (M√≥dulo 4)
 * 
 * Muestra las ganancias en tiempo real del vendedor y el ranking 
 * de los premios mensuales para fomentar la competencia.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}


// Instanciar Modelo y solicitar datos del usuario actual
$vendedor_id = get_current_user_id();
$commission_model = new Suite_Model_Commission();
$stats_billetera = $commission_model->get_vendedor_stats( $vendedor_id );

// Validar si el usuario tiene privilegios gerenciales (Zero-Trust UI)
$user_obj = wp_get_current_user();
$roles = (array) $user_obj->roles;
$is_gerencia = current_user_can('manage_options') || in_array('suite_gerente', $roles) || in_array('gerente', $roles);
?>

<div id="TabComisiones" class="suite-tab-content" style="display: none;">
    <div class="suite-header-modern">
        <h2 style="margin:0; font-size: 22px; color: #0f172a;">üèÜ Comisiones y Rendimiento</h2>
    </div>

    <div style="padding: 25px;">
        
        <!-- ==========================================
             PANEL GERENCIAL (Solo visible para Admin/Gerencia)
             ========================================== -->
        <?php if ( $is_gerencia ) : ?>
        <div style="margin-bottom: 30px; padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="color: #991b1b; margin: 0 0 5px 0; font-size: 16px;">‚öôÔ∏è Cierre Contable de Mes</h3>
                <p style="color: #7f1d1d; font-size: 13px; margin: 0;">Liquide las comisiones pendientes. Esta acci√≥n pasar√° el Ledger a estado "pagado" y lo congelar√° permanentemente.</p>
            </div>
            <button id="btn-cierre-mes" class="btn-save-big" style="background-color: #dc2626; width: auto; padding: 10px 20px;">üîí Ejecutar Cierre de Mes</button>
        </div>
        <?php endif; ?>

        <!-- ==========================================
             BILLETERA DEL VENDEDOR
             ========================================== -->
        <h3 style="color: #0f172a; margin-bottom: 15px; font-size: 18px;">üíº Mi Billetera (Mes Actual)</h3>
        <div style="display: flex; gap: 20px; margin-bottom: 25px;">
            <div class="kpi-card" style="flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; color: white;">
                <small style="display:block; text-transform:uppercase; font-weight:bold; opacity: 0.9;">‚è≥ Comisiones Pendientes</small>
                <strong style="font-size: 32px;">$<?php echo number_format($stats_billetera['totales']['pendiente'], 2); ?></strong>
            </div>
            <div class="kpi-card" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white;">
                <small style="display:block; text-transform:uppercase; font-weight:bold; opacity: 0.9;">‚úÖ Comisiones Pagadas (Liquidado)</small>
                <strong style="font-size: 32px;">$<?php echo number_format($stats_billetera['totales']['pagado'], 2); ?></strong>
            </div>
        </div>

        <h4 style="color: #475569; margin-bottom: 10px;">üìÑ √öltimas Transacciones</h4>
        <div class="suite-table-responsive" style="margin-bottom: 30px;">
            <table class="suite-modern-table" style="width: 100%; text-align: left;">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Orden</th>
                        <th>Venta Total</th>
                        <th>Mi Comisi√≥n</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if ( empty($stats_billetera['historial']) ) : ?>
                        <tr><td colspan="5" style="text-align:center; padding: 20px; color:#64748b;">No hay comisiones registradas este mes.</td></tr>
                    <?php else : ?>
                        <?php foreach ( $stats_billetera['historial'] as $tx ) : 
                            $badge_bg = $tx->estado_pago === 'pagado' ? '#d1fae5' : '#fef3c7';
                            $badge_cl = $tx->estado_pago === 'pagado' ? '#065f46' : '#92400e';
                        ?>
                            <tr>
                                <td><?php echo date('d/m/Y', strtotime($tx->created_at)); ?></td>
                                <td>#<?php echo esc_html($tx->codigo_cotizacion); ?></td>
                                <td>$<?php echo number_format($tx->total_usd, 2); ?></td>
                                <td style="color:#059669;"><strong>+$<?php echo number_format($tx->comision_ganada_usd, 2); ?></strong></td>
                                <td><span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; background:<?php echo $badge_bg; ?>; color:<?php echo $badge_cl; ?>;"><?php echo strtoupper($tx->estado_pago); ?></span></td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>

    <!-- 2. SECCI√ìN: GAMIFICACI√ìN Y PREMIOS -->
    <h3 style="border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; color: #111827; display: flex; align-items: center; gap: 10px;">
        üèÜ Premios del Mes
    </h3>
    
    <div class="kpi-row" style="display: flex; flex-wrap: wrap; gap: 20px;">
        
        <!-- Tarjeta 1: Pez Gordo -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #f59e0b; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">ü¶à Pez Gordo</h4>
                <span class="pill-warn" style="font-size: 12px; font-weight: bold;">Premio: $20</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Al vendedor con mayor volumen ($) facturado.</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                <small style="color: #94a3b8; text-transform: uppercase; font-weight: bold; font-size: 10px;">L√≠der Actual</small>
                <strong id="pez-gordo-name" style="font-size: 18px; display: block; color: #1e293b; margin-top: 4px;">Calculando...</strong>
                <span id="pez-gordo-amount" style="color: #059669; font-weight: 800; font-size: 15px;">$0.00</span>
            </div>
        </div>

        <!-- Tarjeta 2: Deja pa' los dem√°s -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #3b82f6; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">üèÉ Deja pa' los dem√°s</h4>
                <span class="pill-info" style="font-size: 12px; font-weight: bold; background: #dbeafe; color: #1d4ed8;">Premio: $20</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Al vendedor con mayor cantidad de ventas (N¬∞).</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                <small style="color: #94a3b8; text-transform: uppercase; font-weight: bold; font-size: 10px;">L√≠der Actual</small>
                <strong id="deja-pa-name" style="font-size: 18px; display: block; color: #1e293b; margin-top: 4px;">Calculando...</strong>
                <span id="deja-pa-count" style="color: #2563eb; font-weight: 800; font-size: 15px;">0 ventas</span>
            </div>
        </div>

        <!-- Tarjeta 3: Dale Play -->
        <div class="kpi-card" style="flex: 1; min-width: 250px; border-top: 4px solid #8b5cf6; text-align: left; background: #faf5ff;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h4 style="margin: 0; color: #0f172a; font-size: 16px;">‚ñ∂Ô∏è Dale Play</h4>
                <span style="font-size: 12px; font-weight: bold; background: #ede9fe; color: #6d28d9; padding: 4px 10px; border-radius: 99px;">Premio: $10</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Por proactividad y cumplimiento en proyectos.</p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd6fe; text-align: center;">
                <span style="font-size: 32px; display: block; margin-bottom: 5px;">üéØ</span>
                <strong style="color: #5b21b6; font-size: 13px;">Asignaci√≥n Manual (Admin)</strong>
                <p style="font-size: 11px; color: #7c3aed; margin-top: 2px;">Evaluado a fin de mes seg√∫n Kanban de Proyectos.</p>
            </div>
        </div>

    </div>
</div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-comisiones.php ---

--- INICIO DEL ARCHIVO: views/app/tab-cotizador.php ---
<?php
/**
 * Vista: Pesta√±a del Cotizador (Punto de Venta) - V11 Mobile-First
 * @package SuiteEmpleados\Views\App
 */
if ( ! defined( 'ABSPATH' ) ) exit;

$tasa_bcv_actual = get_option( 'suite_tasa_bcv', 1.00 ); 
?>
<div id="TabPos" class="suite-tab-content" style="display: none;">
    <div style="display: flex; flex-wrap: wrap; gap: 25px;">
        
        <!-- COLUMNA IZQUIERDA: PRODUCTOS Y CARRITO -->
        <div style="flex: 2 1 400px; display: flex; flex-direction: column; gap: 20px;">
            <div class="suite-header-modern" style="border-radius: 8px; padding: 15px 20px; background: #fff; border: 1px solid #e2e8f0;">
                <h2 style="margin:0; font-size: 18px; color: #0f172a;">üõí B√∫squeda y Carrito</h2>
            </div>
            
            <div style="display: flex; gap: 10px; position: relative;">
                <input type="text" id="pos-product-search" class="widefat" placeholder="üîç Buscar producto por SKU o Nombre..." style="margin: 0; flex: 1; height: 48px; border-radius: 8px;">
                <button type="button" id="btn-add-manual-item" class="btn-modern-action" style="height: 48px;">‚ûï √çtem Manual</button>
                <div id="pos-search-results" class="pos-dropdown" style="display:none; position: absolute; top: 55px; left: 0; width: 100%; z-index: 100; border: 1px solid #cbd5e1; background: #fff; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-height: 350px; overflow-y: auto;"></div>
            </div>

            <!-- Contenedor del Carrito Responsivo (Mobile-First Cards) -->
            <div id="pos-cart-container" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; min-height: 300px;">
                <div id="pos-cart-body" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Los items se inyectar√°n aqu√≠ v√≠a JS -->
                    <div style="text-align: center; color: #94a3b8; padding: 40px 0;">El carrito est√° vac√≠o. Busque un producto para comenzar.</div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: CLIENTE Y TOTALES -->
        <div style="flex: 1 1 320px; display: flex; flex-direction: column; gap: 20px;">
            
            <!-- Bloque de Cliente -->
            <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    üë§ Datos del Cliente
                    <button type="button" id="btn-clear-client" class="btn-modern-action small" style="display: none; color: #dc2626; border-color: #fca5a5;">Limpiar</button>
                </h3>

                <div id="cli-form-wrapper">
                    <!-- Buscador Predictivo de Clientes -->
                    <div style="position: relative; margin-bottom: 15px;">
                        <input type="text" id="cli-search-predictive" class="widefat" placeholder="üîç Buscar cliente existente (Nombre o RIF)..." style="background: #f0fdf4; border-color: #a7f3d0; margin-bottom: 5px;">
                        <div id="cli-search-results" class="pos-dropdown" style="display:none; position: absolute; top: 45px; left: 0; width: 100%; z-index: 100; border: 1px solid #cbd5e1; background: #fff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto;"></div>
                    </div>

                    <!-- RIF At√≥mico -->
                    <label style="font-size: 12px; font-weight: bold; color: #475569;">RIF / CI *</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <select id="cli-rif-prefix" class="widefat" style="width: 80px; margin-bottom: 0;">
                            <option value="J">J</option>
                            <option value="V">V</option>
                            <option value="E">E</option>
                            <option value="G">G</option>
                            <option value="P">P</option>
                            <option value="C">C</option>
                        </select>
                        <input type="text" id="cli-rif-number" class="widefat" placeholder="Ej: 12345678" style="flex: 1; margin-bottom: 0;">
                    </div>

                    <label style="font-size: 12px; font-weight: bold; color: #475569;">Nombre / Raz√≥n Social *</label>
                    <input type="text" id="cli-nombre" class="widefat">

                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: bold; color: #475569;">Tel√©fono</label>
                            <input type="text" id="cli-tel" class="widefat">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: bold; color: #475569;">Email</label>
                            <input type="email" id="cli-email" class="widefat">
                        </div>
                    </div>

                    <label style="font-size: 12px; font-weight: bold; color: #475569;">Direcci√≥n</label>
                    <input type="text" id="cli-dir" class="widefat">

                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: bold; color: #475569;">Ciudad</label>
                            <input type="text" id="cli-ciudad" class="widefat">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; font-weight: bold; color: #475569;">Estado</label>
                            <input type="text" id="cli-estado" class="widefat">
                        </div>
                    </div>
                    
                    <label style="font-size: 12px; font-weight: bold; color: #475569;">Atenci√≥n a (Contacto)</label>
                    <input type="text" id="cli-contacto" class="widefat">
                </div>
            </div>

            <!-- Bloque de Configuraci√≥n y Totales -->
            <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">‚öôÔ∏è Configuraci√≥n y Totales</h3>
                
				<div style="display: flex; gap: 15px; margin-bottom: 30px;">
                    
                    <div style="flex: 1;">
                        <label style="font-size: 12px; font-weight: bold; color: #475569;">Moneda PDF</label>
                        <select id="pos-moneda" class="widefat" style="margin-bottom:0; cursor: pointer;">
                            <option value="USD">D√≥lares ($)</option>
                            <option value="BS">Bol√≠vares (Bs.)</option>
                        </select>
                    </div>

                    <div style="flex: 1;">
                        <label style="font-size: 12px; font-weight: bold; color: #475569;">Validez</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="pos-validez" class="widefat" value="5" min="1" style="margin-bottom:0;">
                            <span style="font-size: 11px; color: #64748b;">D√≠as</span>
                        </div>
                    </div>

                    <div style="flex: 1;">
                        <label style="font-size: 12px; font-weight: bold; color: #475569;">Tasa BCV</label>
                        <div style="position: relative;">
                            <input type="number" step="0.0001" id="pos-tasa-bcv" class="widefat" value="<?php echo esc_attr( $tasa_bcv_actual ); ?>" style="margin-bottom:0;">
                            <small id="bcv-update-date" style="font-size: 10.5px; color: #64748b; position: absolute; bottom: -18px; left: 0; white-space: nowrap; font-weight: bold;">
                                Buscando API...
                            </small>
                        </div>
                    </div>
                    
                </div>

                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #64748b; font-weight: bold;">TOTAL COTIZACI√ìN</div>
                    <div id="pos-total-usd" style="font-size: 32px; font-weight: 800; color: #059669; line-height: 1.2;">$0.00</div>
                    <div id="pos-total-bs" style="font-size: 14px; color: #475569; font-weight: bold;">Ref. Bs: 0.00</div>
                </div>

                <button type="button" id="btn-save-quote" class="btn-save-big">üíæ Guardar Cotizaci√≥n</button>
            </div>
        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-cotizador.php ---

--- INICIO DEL ARCHIVO: views/app/tab-equipo.php ---
<?php
/**
 * Vista: Pesta√±a de Gesti√≥n de Equipo y Roles (RBAC) - Fase 3
 * 
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>
<style>
/* =========================================================
   ESTILOS: SUB-PESTA√ëAS Y MATRIZ DE PERMISOS (RBAC)
   ========================================================= */
.equipo-subtabs {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e2e8f0;
}

.equipo-subtab-btn {
    padding: 12px 20px;
    cursor: pointer;
    background: none;
    border: none;
    font-weight: 600;
    font-size: 14px;
    color: #64748b;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.3s;
}

.equipo-subtab-btn:hover {
    color: #0f172a;
}

.equipo-subtab-btn.active {
    color: #0073aa;
    border-bottom-color: #0073aa;
}

.equipo-section {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.equipo-section.active {
    display: block;
}

/* MATRIZ DE CAPABILIDADES (GRID) */
.cap-matrix-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin-top: 10px;
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px;
}

.cap-group {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
}

.cap-group h4 {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: #0f172a;
    text-transform: uppercase;
    border-bottom: 1px solid #cbd5e1;
    padding-bottom: 6px;
}

.cap-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 13px;
    color: #475569;
}

.cap-item:last-child {
    margin-bottom: 0;
}

.cap-item input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: #0073aa;
}

.role-tags-container span {
    display: inline-block;
    background: #e0f2fe;
    color: #0369a1;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin: 2px;
    font-weight: 600;
}
</style>

<!-- CONTENEDOR PRINCIPAL DE LA PESTA√ëA -->
<div id="TabEquipo" class="suite-tab-content" style="display: none;">
    
    <div class="suite-header-modern" style="padding-bottom: 0; border-bottom: none;">
        <h2 style="margin:0; font-size: 22px; color: #0f172a;">üë• Gesti√≥n de Equipo y Permisos</h2>
    </div>
    
    <!-- SUB-PESTA√ëAS -->
    <div class="equipo-subtabs" style="padding: 0 25px;">
        <button class="equipo-subtab-btn active" onclick="toggleEquipoView('empleados', this)">üë• Lista de Empleados</button>
        <button class="equipo-subtab-btn" onclick="toggleEquipoView('roles', this)">üõ°Ô∏è Perfiles y Permisos</button>
    </div>
    
    <div style="padding: 0 25px 25px 25px;">
        
        <!-- ==========================================
             SECCI√ìN 1: EMPLEADOS
             ========================================== -->
        <div id="sec-empleados" class="equipo-section active">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;">
                <p style="margin: 0; color: #64748b; font-size: 14px;">Administre los accesos de su equipo de trabajo al ERP.</p>
                <button class="btn-save-big" style="width: auto; padding: 10px 20px;" onclick="jQuery('#modal-employee').fadeIn();">‚ûï Nuevo Empleado</button>
            </div>
            
            <div class="suite-table-responsive">
                <table class="suite-modern-table" id="employeesTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email / Usuario</th>
                            <th>Tel√©fono</th>
                            <th>Rol Asignado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="employees-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ==========================================
             SECCI√ìN 2: ROLES (RBAC)
             ========================================== -->
        <div id="sec-roles" class="equipo-section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;">
                <p style="margin: 0; color: #64748b; font-size: 14px;">Cree perfiles personalizados y asigne capacidades espec√≠ficas de los m√≥dulos.</p>
                <button class="btn-save-big" style="width: auto; padding: 10px 20px;" onclick="jQuery('#modal-role').fadeIn();">‚ûï Crear Nuevo Perfil</button>
            </div>
            
            <div class="suite-table-responsive">
                <table class="suite-modern-table" id="rolesTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Perfil</th>
                            <th style="width: 55%;">Permisos Activos</th>
                            <th style="width: 20%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="roles-tbody">
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- ==========================================
     MODAL: CRUD DE EMPLEADOS
     ========================================== -->
<div id="modal-employee" class="suite-modal">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('#modal-employee').fadeOut();">&times;</span>
        <h3 id="emp-modal-title" style="margin-top:0; color:#0f172a;">A√±adir Empleado</h3>
        
        <input type="hidden" id="emp-id" value="0">
        
        <div class="form-group-row">
            <div>
                <label>Nombre</label>
                <input type="text" id="emp-first-name" class="widefat" placeholder="Ej: Juan">
            </div>
            <div>
                <label>Apellido</label>
                <input type="text" id="emp-last-name" class="widefat" placeholder="Ej: P√©rez">
            </div>
        </div>
        
        <label>Correo Electr√≥nico (Usuario de Acceso) *</label>
        <input type="email" id="emp-email" class="widefat" placeholder="juan@mitiendaunit.com">
        
        <div class="form-group-row">
            <div>
                <label>Tel√©fono (Para PDF) *</label>
                <input type="text" id="emp-phone" class="widefat" placeholder="Ej: +58 412 1234567">
            </div>
            <div>
                <label>Contrase√±a <small style="font-weight:normal; color:#64748b;">(Dejar en blanco para no cambiar)</small></label>
                <input type="password" id="emp-password" class="widefat" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
        </div>
        
        <label>Rol / Perfil de Acceso *</label>
        <select id="emp-role" class="widefat">
            <option value="">Seleccione un rol...</option>
            <!-- JS inyectar√° opciones aqu√≠ -->
        </select>
        
        <button type="button" id="btn-save-employee" class="btn-save-big" style="margin-top: 15px;">üíæ Guardar Empleado</button>
    </div>
</div>

<!-- ==========================================
     MODAL: CRUD DE ROLES (MATRIZ DE PERMISOS)
     ========================================== -->
<div id="modal-role" class="suite-modal">
    <div class="suite-modal-content" style="max-width: 700px;">
        <span class="close-modal" onclick="jQuery('#modal-role').fadeOut();">&times;</span>
        <h3 id="role-modal-title" style="margin-top:0; color:#0f172a;">Crear Nuevo Perfil</h3>
        
        <!-- El Key original se usa de referencia para actualizar, o se deja vac√≠o para crear uno nuevo -->
        <input type="hidden" id="role-key-hidden" value="">
        
        <div class="form-group-row">
            <div>
                <label>Nombre del Perfil *</label>
                <input type="text" id="role-display-name" class="widefat" placeholder="Ej: Vendedor Senior">
            </div>
            <div>
                <label>Identificador del Sistema (Key) *</label>
                <input type="text" id="role-key" class="widefat" placeholder="ej: vendedor_senior" title="Solo min√∫sculas y guiones bajos" oninput="this.value = this.value.replace(/[^a-z_]/g, '')">
            </div>
        </div>
        
        <label style="margin-top: 10px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px;">Asignaci√≥n de Permisos (Capabilities)</label>
        
        <!-- CONTENEDOR DIN√ÅMICO DE CHECKBOXES -->
        <div id="role-capabilities-matrix" class="cap-matrix-grid">
            <div style="color: #94a3b8; font-size: 13px;">Cargando matriz de permisos...</div>
        </div>
        
        <button type="button" id="btn-save-role" class="btn-save-big" style="margin-top: 25px;">üõ°Ô∏è Guardar Perfil y Permisos</button>
    </div>
</div>

<!-- Peque√±o script inline para el manejo exclusivo visual de las Sub-pesta√±as -->
<script>
function toggleEquipoView(section, btn) {
    // Manejo de botones
    jQuery('.equipo-subtab-btn').removeClass('active');
    jQuery(btn).addClass('active');
    
    // Manejo de secciones
    jQuery('.equipo-section').removeClass('active').hide();
    jQuery('#sec-' + section).fadeIn().addClass('active');
}
</script>
--- FIN DEL ARCHIVO: views/app/tab-equipo.php ---

--- INICIO DEL ARCHIVO: views/app/tab-historial.php ---
<?php
/**
 * Vista: Historial de Cotizaciones
 */
if ( ! defined( 'ABSPATH' ) ) { exit; }
?>

<div id="TabHistorial" class="suite-tab-content" style="display: none;">
    <div class="suite-header-modern">
        <h2 style="margin:0; font-size: 22px; color: #0f172a;">üìú Historial de Cotizaciones</h2>
        <p style="color:#64748b; font-size:14px; margin-top:5px;">Revise, imprima o clone sus cotizaciones y pedidos anteriores.</p>
    </div>
    
    <div style="padding: 25px;">
        <div class="suite-table-responsive">
            <table class="suite-modern-table" id="historyTable" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>C√≥digo</th>
                        <th>Cliente</th>
                        <th>Total ($)</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- El JS se encarga del renderizado din√°mico -->
                </tbody>
            </table>
        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-historial.php ---

--- INICIO DEL ARCHIVO: views/app/tab-kanban.php ---
<?php
/**
 * Vista: Tablero Kanban de Pedidos (M√≥dulo 1)
 * 
 * Contiene la interfaz interactiva Drag & Drop para la gesti√≥n visual de cotizaciones y pedidos.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<style>
    /* Estilos espec√≠ficos del Kanban */
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        align-items: start;
        margin-top: 15px;
    }
    .kanban-column-wrapper {
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        max-height: 80vh;
    }
    .kanban-column-header {
        padding: 15px;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 700;
        color: #0f172a;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* Acentos de color por columna */
    .col-emitida .kanban-column-header { border-bottom-color: #f59e0b; }
    .col-proceso .kanban-column-header { border-bottom-color: #3b82f6; }
    .col-pagado .kanban-column-header { border-bottom-color: #10b981; }
	.col-por_enviar .kanban-column-header { border-bottom-color: #f97316; }
    .col-despachado .kanban-column-header { border-bottom-color: #8b5cf6; }

    .kanban-column-body {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 150px;
    }
    .kanban-card {
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        cursor: grab;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .kanban-card:active {
        cursor: grabbing;
    }
    .kanban-ghost {
        opacity: 0.4;
        background: #e2e8f0;
    }
    .kanban-card-title {
        font-size: 15px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
    }
    .kanban-card-client {
        font-size: 13px;
        color: #475569;
        margin-bottom: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px dashed #e2e8f0;
        padding-top: 10px;
        margin-top: 10px;
    }
    .kanban-wa-btn {
        background: #25d366;
        color: #fff !important;
        font-size: 11px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: background 0.2s;
    }
    .kanban-wa-btn:hover { background: #1ebc59; }
</style>

<div id="TabKanban" class="suite-tab-content" style="display: none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
        <h2>üì¶ Portal de Pedidos</h2>
        <button class="btn-modern-action" onclick="SuiteKanban.loadBoard()">üîÑ Refrescar Tablero</button>
    </div>

    <div class="kanban-board">
        
        <!-- Columna 1: Pendientes -->
        <div class="kanban-column-wrapper col-emitida">
            <div class="kanban-column-header">
                <span>üü° Pendiente</span>
                <span class="count-badge pill-neutral" id="count-emitida">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-emitida" data-status="emitida">
                <!-- JS insertar√° tarjetas aqu√≠ -->
            </div>
        </div>

        <!-- Columna 2: En Proceso -->
        <div class="kanban-column-wrapper col-proceso">
            <div class="kanban-column-header">
                <span>üîµ En Proceso</span>
                <span class="count-badge pill-neutral" id="count-proceso">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-proceso" data-status="proceso"></div>
        </div>

        <!-- Columna 3: Facturado / Pagado -->
        <div class="kanban-column-wrapper col-pagado">
            <div class="kanban-column-header">
                <span>üü¢ Facturado</span>
                <span class="count-badge pill-neutral" id="count-pagado">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-pagado" data-status="pagado"></div>
        </div>
		
        <!-- Columna Nueva: Facturado / Pagado -->
		<div class="kanban-column-wrapper col-por_enviar">
            <div class="kanban-column-header">
                <span>üü† Por Enviar</span>
                <span class="count-badge pill-neutral" id="count-por_enviar">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-por_enviar" data-status="por_enviar"></div>
        </div>
		
        <!-- Columna 4: Despachado -->
        <div class="kanban-column-wrapper col-despachado">
            <div class="kanban-column-header">
                <span>üü£ Enviado</span>
                <span class="count-badge pill-neutral" id="count-despachado">0</span>
            </div>
            <div class="kanban-column-body" id="kb-col-despachado" data-status="despachado"></div>
        </div>

    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: CIERRE DE VENTA (M√ìDULO 4 - COMISIONES Y LOG√çSTICA)-->
<!-- ========================================================= -->
<div id="modal-cierre-venta" class="suite-modal" style="display: none;">
    <div class="suite-modal-content">
        <!-- El ID del bot√≥n de cierre es clave para el JS -->
        <span class="close-modal" id="close-modal-cierre">√ó</span>
        
        <h3 style="margin-top:0; color:#0f172a;">üí∞ Procesar Pago y Comisi√≥n</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Complete los datos operativos para registrar su comisi√≥n y autorizar el despacho.
        </p>

        <!-- Guardamos el ID del pedido arrastrado -->
        <input type="hidden" id="cierre-quote-id">

        <div class="form-group-row">
            <div style="flex:1">
                <label>Canal de Venta *</label>
                <select id="cierre-canal" class="widefat">
                    <option value="">Seleccione...</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Tienda Fisica">Tienda F√≠sica</option>
                    <option value="Llamada">Llamada Telef√≥nica</option>
                    <option value="Referido">Referido Comercial</option>
                </select>
            </div>
            <div style="flex:1">
                <label>M√©todo de Pago *</label>
                <select id="cierre-pago" class="widefat">
                    <option value="">Seleccione...</option>
                    <option value="Zelle">Zelle</option>
                    <option value="Efectivo USD">Efectivo USD</option>
                    <option value="Punto de Venta">Punto de Venta (Bs)</option>
                    <option value="Pago Movil">Pago M√≥vil</option>
                    <option value="Cashea">Cashea</option>
                    <option value="Transferencia">Transferencia USD/Bs</option>
                </select>
            </div>
        </div>

        <label>M√©todo de Entrega *</label>
        <select id="cierre-entrega" class="widefat">
            <option value="">Seleccione...</option>
            <option value="Retiro en Tienda">Retiro en Tienda</option>
            <option value="Delivery">Delivery (Caracas)</option>
            <option value="Encomienda MRW">Encomienda Nacional (MRW)</option>
            <option value="Encomienda Tealca">Encomienda Nacional (Tealca)</option>
            <option value="Encomienda Zoom">Encomienda Nacional (Zoom)</option>
        </select>
		
		

	
		<label>N¬∞ de Factura / Nota de Entrega *</label>
		<div style="display: flex; gap: 8px; margin-bottom: 10px;">
			<select id="cierre-recibo-prefijo" class="widefat" style="width: 80px; margin-bottom: 0;">
				<option value="F">F</option>
				<option value="NE">NE</option>
			</select>
			<input type="text" id="cierre-loyverse" class="widefat" placeholder="Ej: 1005 (Solo n√∫meros)" style="flex: 1; margin-bottom: 0;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
		</div>		

        <label>Link de Captura de Pago / Soporte</label>
        <input type="url" id="cierre-captura" class="widefat" placeholder="https://drive.google.com/... o Imgur">

		<!-- INICIO: Selector de Venta Compartida -->
		<label style="margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
			ü§ù ¬øVenta Compartida? (Colaboradores)
		</label>
		<select id="cierre-compartido" class="widefat" multiple="multiple" data-placeholder="Seleccione otros vendedores...">
			<?php
			// Poblar din√°micamente aislando al usuario actual
			$vendedores = get_users( ['role__not_in' => ['subscriber', 'customer']] );
			$current_user_id = get_current_user_id();
			foreach ( $vendedores as $vend ) {
				if ( $vend->ID != $current_user_id ) {
					echo '<option value="' . esc_attr( $vend->ID ) . '">' . esc_html( $vend->display_name ) . '</option>';
				}
			}
			?>
		</select>
		<small style="color:#64748b; font-size: 11px; display:block; margin-bottom: 15px;">
			Deje en blanco si la venta es individual.
		</small>
		<!-- FIN: Selector de Venta Compartida -->					
		
		
        <button class="btn-save-big" id="btn-confirmar-pago" style="margin-top:15px; background-color: #10b981;">
            Confirmar y Procesar Pago
        </button>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-kanban.php ---

--- INICIO DEL ARCHIVO: views/app/tab-logistica.php ---
<?php
/**
 * Vista: Panel de Log√≠stica y Despacho (M√≥dulo 3)
 * 
 * Muestra √∫nicamente los pedidos con estado 'pagado' listos para ser embalados y despachados.
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<div id="TabLogistica" class="suite-tab-content" style="display: none;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2 style="margin:0; color:#0f172a;">üöö Panel de Log√≠stica y Despacho</h2>
        <p style="color:#64748b; margin:0;">Pedidos facturados esperando recolecci√≥n o env√≠o.</p>
    </div>

    <!-- Tabla de Pedidos Pendientes de Despacho -->
    <div class="suite-table-responsive">
        <table class="suite-modern-table" id="logisticsTable">
            <thead>
                <tr>
                    <th>Orden</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>M√©todo Entrega</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <?php if ( ! empty( $pedidos_logistica ) ) : ?>
                    <?php foreach ( $pedidos_logistica as $p ) : ?>
                    <tr id="log-row-<?php echo intval( $p->id ); ?>">
                        <td><strong style="font-family: monospace; font-size: 14px;">#<?php echo esc_html( $p->codigo_cotizacion ); ?></strong></td>
                        <td><?php echo date( 'd/m/Y', strtotime( $p->fecha_emision ) ); ?></td>
                        <td><?php echo esc_html( $p->cliente_nombre ); ?></td>
                        <td>
                            <span class="pill-neutral" style="background: #e0f2fe; color: #0369a1;">
                                <?php echo esc_html( ! empty( $p->metodo_entrega ) ? $p->metodo_entrega : 'Por definir' ); ?>
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <!-- Bot√≥n Hoja de Picking (Impresi√≥n protegida) -->
                                <a href="<?php echo esc_url( admin_url( 'admin-ajax.php?action=suite_print_picking&id=' . $p->id . '&nonce=' . wp_create_nonce('suite_quote_nonce') ) ); ?>" 
                                   target="_blank" class="btn-modern-action small" style="color: #475569;">
                                   üñ®Ô∏è Hoja de Picking
                                </a>
                                
                                <!-- Bot√≥n Confirmar Despacho (Abre Modal) -->
                                <button class="btn-modern-action small" style="background: #ecfdf5; border-color: #a7f3d0; color: #059669;" 
                                        onclick="SuiteLogistics.openModal(<?php echo intval( $p->id ); ?>)">
                                    üì¶ Confirmar Despacho
                                </button>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAL: CONFIRMACI√ìN DE DESPACHO / SUBIDA DE POD           -->
<!-- ========================================================= -->
<div id="modal-confirmar-despacho" class="suite-modal" style="display: none;">
    <div class="suite-modal-content">
        <span class="close-modal" onclick="jQuery('#modal-confirmar-despacho').fadeOut();">√ó</span>
        
        <h3 style="margin-top:0; color:#0f172a;">üì¶ Confirmar Despacho</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">
            Sube la foto de la gu√≠a de encomienda o el comprobante de entrega firmado (Proof of Delivery).
        </p>

        <input type="file" id="log-pod-file" class="widefat" accept="image/*,.pdf" style="padding: 15px; background: #f8fafc;">
        
        <button id="btn-procesar-despacho" class="btn-save-big" style="margin-top:15px; background-color: #3b82f6;">
            Subir y Marcar Despachado
        </button>
    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-logistica.php ---

--- INICIO DEL ARCHIVO: views/app/tab-marketing.php ---
<?php
/**
 * Vista: Cerebro de Demanda y Marketing (M√≥dulo 5)
 * 
 * Muestra visualizaciones de BI (Business Intelligence) utilizando Chart.js 
 * y aliment√°ndose del Data Lake (REST API).
 *
 * @package SuiteEmpleados\Views\App
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}
?>

<div id="TabMarketing" class="suite-tab-content" style="display: none;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
        <div>
            <h2 style="margin:0; color:#0f172a; font-size: 24px; font-weight: 800;">üìà Cerebro de Demanda (BI & Marketing)</h2>
            <p style="color:#64748b; margin-top:5px; font-size: 14px;">An√°lisis de ventas efectivas e impacto publicitario (√öltimos 30 d√≠as).</p>
        </div>
        <button class="btn-modern-action" onclick="SuiteMarketing.loadDashboard()">üîÑ Refrescar Datos</button>
    </div>

    <!-- Grid de Gr√°ficos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        
        <!-- Tarjeta 1: Gr√°fico Doughnut (Canales de Venta) -->
        <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <h3 style="margin-top: 0; color: #1e293b; font-size: 15px; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                Distribuci√≥n por Canal de Venta (Volumen USD)
            </h3>
            <div style="position: relative; height: 320px; width: 100%; margin-top: 15px;">
                <canvas id="chart-canales-venta"></canvas>
            </div>
        </div>

        <!-- Tarjeta 2: Gr√°fico Lineal (Tendencia de Operaciones) -->
        <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <h3 style="margin-top: 0; color: #1e293b; font-size: 15px; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                Tendencia de Cierres de Venta en el Tiempo
            </h3>
            <div style="position: relative; height: 320px; width: 100%; margin-top: 15px;">
                <canvas id="chart-tendencia-ventas"></canvas>
            </div>
        </div>

    </div>
</div>
--- FIN DEL ARCHIVO: views/app/tab-marketing.php ---

--- INICIO DEL ARCHIVO: views/components/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: views/components/index.php ---

--- INICIO DEL ARCHIVO: views/components/modal-cliente.php ---
<?php
/**
 * Archivo: views/components/modal-cliente.php
 * Proposito: Modal inmersivo a pantalla completa (Legacy Layout)
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
?>
<style>
/* =========================================================
   RECUPERACI√ìN: MODAL INMERSIVO DEL PERFIL DEL CLIENTE 
   ========================================================= */
#modal-client-profile .suite-modal-content.large {
    max-width: 1200px;
    width: 95%;
    height: 90vh; /* Pantalla completa */
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
    background: #f8fafc;
    border-radius: 16px;
}

#modal-client-profile .modal-header-fixed {
    padding: 20px 30px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    position: relative;
    border-radius: 16px 16px 0 0;
}

/* Bot√≥n flotante y visible de cerrar */
#modal-client-profile .close-modal-float {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 32px;
    font-weight: bold;
    color: #94a3b8;
    cursor: pointer;
    transition: all 0.2s;
    line-height: 1;
}

#modal-client-profile .close-modal-float:hover {
    color: #dc2626;
    transform: scale(1.1);
}

/* Layout a 2 columnas con Flexbox */
#modal-client-profile .modal-body-scroll {
    display: flex;
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    gap: 30px;
}

/* Columna Izquierda: Datos y Acciones */
#modal-client-profile .profile-left {
    flex: 0 0 380px;
    background: #ffffff;
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
}

/* Columna Derecha: KPIs e Historial */
#modal-client-profile .profile-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* Tarjetas KPI (Estilo Legacy Recuperado) */
#modal-client-profile .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

#modal-client-profile .kpi-card {
    padding: 25px;
    border-radius: 16px;
    color: white;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

/* Fondos Degradados */
#modal-client-profile .kpi-card.kpi-total { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
#modal-client-profile .kpi-card.kpi-count { background: linear-gradient(135deg, #0284c7 0%, #3b82f6 100%); }
#modal-client-profile .kpi-card.kpi-last  { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }

#modal-client-profile .kpi-card small { 
    font-size: 13px; 
    text-transform: uppercase; 
    font-weight: 600; 
    opacity: 0.9; 
    margin-bottom: 5px; 
    display: block;
}

#modal-client-profile .kpi-card strong { 
    font-size: 34px; 
    font-weight: 800; 
    letter-spacing: -1px; 
    line-height: 1.2;
}

/* Contenedor del Historial */
#modal-client-profile .history-container {
    flex: 1;
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#modal-client-profile .history-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    font-weight: 700;
    color: #0f172a;
    font-size: 15px;
}

#modal-client-profile .history-scroll {
    flex: 1;
    overflow-y: auto;
}

/* Mobile Responsive */
@media (max-width: 900px) {
    #modal-client-profile .modal-body-scroll { flex-direction: column; }
    #modal-client-profile .profile-left { flex: auto; }
    #modal-client-profile .suite-modal-content.large { height: 100%; width: 100%; border-radius: 0; max-height: 100vh; }
}
</style>

<!-- El ID corresponde estrictamente con el archivo crm.js de la V12 -->
<div id="modal-client-profile" class="suite-modal" style="display: none;">
    <div class="suite-modal-content large">
        
        <!-- CABECERA -->
        <div class="modal-header-fixed">
            <h3 id="cli-profile-name" style="margin:0; color:#0f172a; font-size: 22px;">üìÇ Expediente del Cliente</h3>
            <span class="close-modal-float" onclick="jQuery('#modal-client-profile').fadeOut();">&times;</span>
        </div>
        
        <div class="modal-body-scroll">
            <!-- COLUMNA IZQUIERDA: DATOS DE CONTACTO (Formulario Mapeado a crm.js) -->
            <div class="profile-left">
                <h4 style="margin:0 0 15px 0; color:#475569; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; font-size: 14px;">üìã Informaci√≥n de Contacto</h4>
                
                <input type="hidden" id="prof-id">
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>RIF/CI</label>
                        <input type="text" id="prof-rif" class="widefat" readonly style="background-color: #f1f5f9; cursor: not-allowed;" title="El RIF no puede ser modificado">
                    </div>
                    <div style="flex: 2;">
                        <label>Raz√≥n Social</label>
                        <input type="text" id="prof-nombre" class="widefat">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Tel√©fono</label>
                        <input type="text" id="prof-tel" class="widefat">
                    </div>
                    <div style="flex: 1;">
                        <label>Email</label>
                        <input type="email" id="prof-email" class="widefat">
                    </div>
                </div>
                
                <label>Direcci√≥n F√≠sica</label>
                <input type="text" id="prof-dir" class="widefat">
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Ciudad</label>
                        <input type="text" id="prof-ciudad" class="widefat">
                    </div>
                    <div style="flex: 1;">
                        <label>Estado</label>
                        <input type="text" id="prof-estado" class="widefat">
                    </div>
                </div>
                
                <label>Persona de Contacto</label>
                <input type="text" id="prof-contacto" class="widefat">
                
                <label>üìù Notas Internas</label>
                <textarea id="prof-notas" class="widefat" rows="3" placeholder="A√±adir observaciones sobre este cliente..."></textarea>
                
                <div style="display:flex; gap:10px; margin-top: auto; padding-top: 15px;">
                    <button id="btn-update-profile" class="btn-save-big" style="flex:2;">üíæ Guardar Cambios</button>
                    <button id="btn-delete-profile" class="btn-modern-action" style="flex:1; color:#dc2626; border-color:#fca5a5; justify-content: center;">üóëÔ∏è Eliminar</button>
                </div>
            </div>

            <!-- COLUMNA DERECHA: KPIs Y TABLA -->
            <div class="profile-right">
                
                <!-- Tarjetas KPI Gigantes -->
                <div class="kpi-row" id="cli-profile-kpi-compras">
                    <div class="kpi-card kpi-total">
                        <small>üí∞ Total Gastado</small>
                        <strong id="kpi-total">$0.00</strong>
                    </div>
                    <div class="kpi-card kpi-count">
                        <small>üõí Total Operaciones</small>
                        <strong id="kpi-count">0</strong>
                    </div>
                    <div class="kpi-card kpi-last">
                        <small>üìÖ √öltima Compra</small>
                        <strong id="kpi-last">-</strong>
                    </div>
                </div>
                
                <!-- Pesta√±a de Historial -->
                <div class="history-container">
                    <div class="history-header">
                        üìú Historial de Cotizaciones y Pedidos
                    </div>
                    <div class="history-scroll">
                        <table class="suite-modern-table" id="cli-history-table">
                            <thead>
                                <tr>
                                    <th style="position: sticky; top: 0; z-index: 2;">Fecha</th>
                                    <th style="position: sticky; top: 0; z-index: 2;">C√≥digo</th>
                                    <th style="position: sticky; top: 0; z-index: 2;">Total</th>
                                    <th style="position: sticky; top: 0; z-index: 2;">Acci√≥n</th>
                                </tr>
                            </thead>
                            <!-- El tbody coincide estrictamente con la inyecci√≥n de crm.js -->
                            <tbody id="prof-history-body">
                                <tr><td colspan="4" style="text-align: center; padding: 30px; color: #94a3b8;">Cargando datos del cliente...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
--- FIN DEL ARCHIVO: views/components/modal-cliente.php ---

--- INICIO DEL ARCHIVO: views/components/table-skeleton.php ---
<?php
/**
 * Archivo: views/components/table-skeleton.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/components/table-skeleton.php ---

--- INICIO DEL ARCHIVO: views/pdf/index.php ---
<?php
// Silence is golden.
--- FIN DEL ARCHIVO: views/pdf/index.php ---

--- INICIO DEL ARCHIVO: views/pdf/layout-cotizacion.php ---
<?php
/**
 * Archivo: views/pdf/layout-cotizacion.php
 * Proposito: ...
 */

if ( ! defined( 'ABSPATH' ) ) { exit; }
--- FIN DEL ARCHIVO: views/pdf/layout-cotizacion.php ---

